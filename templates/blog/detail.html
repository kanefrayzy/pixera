{% extends "base.html" %}
{% load static %}
{% load i18n %}

{# ───── META/SEO ───── #}
{% block meta_title %}{{ post.seo_title|default:post.title }} | Блог Pixera{% endblock %}
{% block meta_description %}{{ post.seo_description|default:post.excerpt|default:"" }}{% endblock %}
{% block canonical %}{{ request.scheme }}://{{ request.get_host }}{{ post.get_absolute_url }}{% endblock %}
{% block robots %}index, follow{% endblock %}

{% block extra_meta %}
  {# rel=alternate hreflang — если передадим alt_langs = [{'code':'en','url':'/en/...'},...] #}
  {% if alt_langs %}
    {% for alt in alt_langs %}
      <link rel="alternate" hreflang="{{ alt.code }}" href="{{ request.scheme }}://{{ request.get_host }}{{ alt.url }}">
    {% endfor %}
    <link rel="alternate" hreflang="x-default" href="{{ request.scheme }}://{{ request.get_host }}{{ post.get_absolute_url }}">
  {% endif %}

  <meta property="og:type" content="article">
  <meta property="og:title" content="{{ post.og_title_fallback|default:post.seo_title|default:post.title }}">
  <meta property="og:description" content="{{ post.og_description_fallback|default:post.seo_description|default:post.excerpt|default:'' }}">
  {% if post.og_image_url or post.cover %}
    <meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% if post.og_image_url %}{{ post.og_image_url }}{% else %}{{ post.cover.url }}{% endif %}">
  {% endif %}

  {# JSON-LD: Article #}
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Article",
    "headline": "{{ post.seo_title|default:post.title|escapejs }}",
    "description": "{{ post.seo_description|default:post.excerpt|default:''|escapejs }}",
    "image": "{% if post.og_image_url %}{{ request.scheme }}://{{ request.get_host }}{{ post.og_image_url }}{% elif post.cover %}{{ request.scheme }}://{{ request.get_host }}{{ post.cover.url }}{% else %}{{ request.scheme }}://{{ request.get_host }}/static/img/og-default.jpg{% endif %}",
    "datePublished": "{{ post.published_at|date:'c' }}",
    "dateModified": "{{ post.updated_at|date:'c' }}",
    "mainEntityOfPage": "{{ request.scheme }}://{{ request.get_host }}{{ post.get_absolute_url }}",
    "inLanguage": "{{ request.LANGUAGE_CODE|default:'ru' }}",
    "author": {% if post.author_name %}{"@type":"Person","name":"{{ post.author_name|escapejs }}"}{% else %}{"@type":"Organization","name":"Pixera"}{% endif %}
  }
  </script>

  {# JSON-LD: Breadcrumbs #}
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Главная","item":"{{ request.scheme }}://{{ request.get_host }}{% url 'pages:home' %}"},
      {"@type":"ListItem","position":2,"name":"Блог","item":"{{ request.scheme }}://{{ request.get_host }}{% url 'blog:index' %}"},
      {"@type":"ListItem","position":3,"name":"{{ post.title|escapejs }}","item":"{{ request.scheme }}://{{ request.get_host }}{{ post.get_absolute_url }}"}
    ]
  }
  </script>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">

  <!-- Breadcrumbs -->
  <nav class="py-4 border-b border-[var(--bord)] mb-8" aria-label="Хлебные крошки">
    <ol class="flex items-center gap-2 text-sm">
      <li>
        <a href="{% url 'pages:home' %}" class="text-[var(--muted)] hover:text-[var(--text)] transition">Главная</a>
      </li>
      <li class="text-[var(--muted)]">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </li>
      <li>
        <a href="{% url 'blog:index' %}" class="text-[var(--muted)] hover:text-[var(--text)] transition">Блог</a>
      </li>
      <li class="text-[var(--muted)]">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </li>
      <li aria-current="page" class="font-medium">{{ post.title|truncatechars:50 }}</li>
    </ol>
  </nav>

  <!-- Article -->
  <article class="space-y-8" itemscope itemtype="https://schema.org/Article">

    <!-- Header -->
    <header class="space-y-6">
      <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
        <div class="flex-1 space-y-4">
          <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold leading-tight" itemprop="headline">
            {{ post.title }}
          </h1>

          <!-- Meta Information -->
          <div class="flex flex-wrap items-center gap-4 text-sm text-[var(--muted)]">
            {% if post.published_at %}
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                <time itemprop="datePublished" datetime="{{ post.published_at|date:'c' }}">
                  {{ post.published_at|date:"d.m.Y" }}
                </time>
              </div>
            {% endif %}

            {% if post.updated_at and post.updated_at > post.published_at %}
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                <time itemprop="dateModified" datetime="{{ post.updated_at|date:'c' }}">
                  обновлено {{ post.updated_at|date:"d.m.Y" }}
                </time>
              </div>
            {% endif %}

            {% if post.author_name %}
              <div class="flex items-center gap-2" itemprop="author" itemscope itemtype="https://schema.org/Person">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <span itemprop="name">{{ post.author_name }}</span>
              </div>
            {% endif %}

            {% if post.read_minutes %}
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span>{{ post.read_minutes }} мин чтения</span>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Admin Tools -->
        {% if request.user.is_authenticated and request.user.is_staff %}
          <div class="flex items-center gap-3">
            <a class="btn btn-ghost" href="{% url 'blog:edit' post.slug %}">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
              Изменить
            </a>
            <a class="btn btn-ghost text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20" href="{% url 'blog:delete' post.slug %}">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
              </svg>
              Удалить
            </a>
          </div>
        {% endif %}
      </div>
    </header>

    <!-- Cover Image -->
    {% if post.cover %}
      <figure class="relative" itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
        <div class="relative overflow-hidden rounded-3xl bg-gray-100 dark:bg-gray-800">
          <img src="{{ post.cover.url }}"
               alt="{{ post.title }}"
               class="w-full aspect-[16/9] object-cover"
               onerror="this.src='data:image/svg+xml;utf8,&lt;svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 800 450%22&gt;&lt;rect width=%22800%22 height=%22450%22 fill=%22%23e5e7eb%22/&gt;&lt;text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%2394a3b8%22 font-family=%22Inter%22 font-size=%2224%22&gt;Cover Image&lt;/text&gt;&lt;/svg&gt;';">
        </div>
        <meta itemprop="url" content="{{ post.cover.url }}">
      </figure>
    {% endif %}

    <!-- Excerpt -->
    {% if post.excerpt %}
      <div class="card p-6 bg-primary/5 border-primary/20">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-primary mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
            <path d="M13 9H11V7H13M13 17H11V15H13M12 2A10 10 0 0 0 2 12A10 10 0 0 0 12 22A10 10 0 0 0 22 12A10 10 0 0 0 12 2Z"/>
          </svg>
          <div>
            <div class="font-medium text-primary mb-2">Краткое содержание</div>
            <p class="text-lg leading-relaxed" itemprop="description">{{ post.excerpt }}</p>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Article Body -->
    {% if post.body %}
      <div class="prose prose-lg max-w-none" itemprop="articleBody">
        {{ post.body|safe }}
      </div>
    {% endif %}

    <!-- Tags -->
    {% if post.tags.exists %}
      <div class="pt-6 border-t border-[var(--bord)]">
        <div class="flex flex-wrap gap-2">
          {% for t in post.tags.all %}
            <a class="pill hover:bg-primary/10 hover:border-primary/30 hover:text-primary transition"
               href="{% url 'blog:index' %}?tag={{ t.slug }}" aria-label="Тег {{ t.name }}">
              <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
              </svg>
              {{ t.name }}
            </a>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </article>

  <!-- Navigation -->
  {% if prev_post or next_post %}
    <nav class="py-8 border-t border-[var(--bord)] mt-12" aria-label="Другие статьи">
      <div class="flex flex-col sm:flex-row justify-between gap-6">
        <div class="flex-1">
          {% if prev_post %}
            <a class="group block card p-6 hover:shadow-lg transition-shadow" href="{{ prev_post.get_absolute_url }}">
              <div class="flex items-center gap-3 text-[var(--muted)] text-sm mb-2">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                <span>Предыдущая статья</span>
              </div>
              <div class="font-semibold group-hover:text-primary transition">
                {{ prev_post.title|truncatechars:60 }}
              </div>
            </a>
          {% endif %}
        </div>

        <div class="flex-1">
          {% if next_post %}
            <a class="group block card p-6 hover:shadow-lg transition-shadow text-right" href="{{ next_post.get_absolute_url }}">
              <div class="flex items-center justify-end gap-3 text-[var(--muted)] text-sm mb-2">
                <span>Следующая статья</span>
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
              </div>
              <div class="font-semibold group-hover:text-primary transition">
                {{ next_post.title|truncatechars:60 }}
              </div>
            </a>
          {% endif %}
        </div>
      </div>
    </nav>
  {% endif %}

  <!-- Back to Blog -->
  <div class="text-center py-8">
    <a class="btn btn-ghost" href="{% url 'blog:index' %}">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
      </svg>
      Вернуться к блогу
    </a>
  </div>
</div>

<style>
/* Typography improvements for article content */
.prose {
  color: var(--text);
  line-height: 1.7;
}

.prose h1,
.prose h2,
.prose h3,
.prose h4,
.prose h5,
.prose h6 {
  color: var(--text);
  font-weight: 600;
  line-height: 1.25;
  margin-top: 2rem;
  margin-bottom: 1rem;
}

.prose h1 {
  font-size: 2.25rem;
}

.prose h2 {
  font-size: 1.875rem;
  padding-top: 1rem;
  border-top: 1px solid var(--bord);
}

.prose h3 {
  font-size: 1.5rem;
}

.prose h4 {
  font-size: 1.25rem;
}

.prose p {
  margin-bottom: 1.5rem;
}

.prose a {
  color: rgb(1 209 251);
  text-decoration: none;
  font-weight: 500;
}

.prose a:hover {
  text-decoration: underline;
}

.prose img {
  border-radius: 1rem;
  width: 100%;
  height: auto;
  margin: 2rem 0;
}

.prose blockquote {
  border-left: 4px solid rgb(1 209 251);
  padding-left: 1.5rem;
  margin: 2rem 0;
  font-style: italic;
  color: var(--muted);
}

.prose code {
  background-color: var(--card);
  border: 1px solid var(--bord);
  border-radius: 0.375rem;
  padding: 0.125rem 0.375rem;
  font-size: 0.875rem;
  font-family: ui-monospace, 'Courier New', monospace;
}

.prose pre {
  background-color: rgb(15 23 42);
  color: rgb(226 232 240);
  border-radius: 0.75rem;
  padding: 1.5rem;
  overflow-x: auto;
  margin: 2rem 0;
  font-size: 0.875rem;
  line-height: 1.5;
}

.prose pre code {
  background: none;
  border: none;
  padding: 0;
  color: inherit;
}

.prose ul,
.prose ol {
  margin: 1.5rem 0;
  padding-left: 1.5rem;
}

.prose li {
  margin: 0.5rem 0;
}

.prose ul li {
  list-style-type: disc;
}

.prose ol li {
  list-style-type: decimal;
}

.prose table {
  width: 100%;
  border-collapse: collapse;
  margin: 2rem 0;
  border-radius: 0.75rem;
  overflow: hidden;
  border: 1px solid var(--bord);
}

.prose th,
.prose td {
  padding: 0.75rem 1rem;
  text-align: left;
  border-bottom: 1px solid var(--bord);
}

.prose th {
  background-color: var(--card);
  font-weight: 600;
}

.prose tr:last-child td {
  border-bottom: none;
}

/* Dark theme adjustments */
[data-theme="dark"] .prose pre {
  background-color: rgb(15 23 42);
}

[data-theme="dark"] .prose blockquote {
  border-left-color: rgb(1 209 251);
}

/* Mobile optimizations */
@media (max-width: 640px) {
  .prose {
    font-size: 1rem;
  }

  .prose h1 {
    font-size: 1.875rem;
  }

  .prose h2 {
    font-size: 1.5rem;
  }

  .prose h3 {
    font-size: 1.25rem;
  }

  .prose pre {
    padding: 1rem;
    font-size: 0.8rem;
  }

  .prose table {
    font-size: 0.875rem;
  }

  .prose th,
  .prose td {
    padding: 0.5rem;
  }
}

/* Smooth scroll for anchor links */
html {
  scroll-behavior: smooth;
}

/* Focus states for accessibility */
.prose a:focus {
  outline: 2px solid rgb(1 209 251);
  outline-offset: 2px;
  border-radius: 0.25rem;
}

/* Print styles */
@media print {
  .prose {
    color: black;
  }

  .prose a {
    color: black;
    text-decoration: underline;
  }

  .prose blockquote {
    border-left-color: black;
  }
}
</style>

{% endblock %}
