{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Сменить пароль — AI Gallery{% endblock %}
{% block meta_description %}Смена пароля аккаунта AI Gallery: текущий пароль, новый пароль и подтверждение.{% endblock %}

{% block hero %}
<!-- Hero Section -->
<section class="py-12 sm:py-16 mt-8">
  <div class="container text-center">
    <div class="w-16 h-16 rounded-2xl bg-primary/15 flex items-center justify-center mx-auto mb-6">
      <svg class="w-8 h-8 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
      </svg>
    </div>
    <h1 class="text-3xl font-bold mb-4">Изменить пароль</h1>
    <p class="text-[var(--muted)] max-w-2xl mx-auto">
      Для безопасности используйте длинный пароль и не повторяйте его на других сайтах.
    </p>
  </div>
</section>
{% endblock %}

{% block content %}
<div class="max-w-md mx-auto">
  {% include "includes/messages.html" %}

  <div class="card p-6 sm:p-8">
    <form method="post" action="{% url 'account_change_password' %}" novalidate class="space-y-6">
      {% csrf_token %}

      <!-- Non-field errors -->
      {% if form and form.non_field_errors %}
        <div class="card p-4 border-red-200 dark:border-red-800 bg-red-50 dark:bg-red-900/20" role="alert">
          <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
              <path d="M13 14H11V9H13M13 18H11V16H13M1 21H23L12 2L1 21Z"/>
            </svg>
            <div class="text-sm text-red-700 dark:text-red-300">
              {% for e in form.non_field_errors %}{{ e }}{% endfor %}
            </div>
          </div>
        </div>
      {% endif %}

      <!-- Current Password -->
      <div>
        <label class="block text-sm font-medium mb-2" for="{{ form.oldpassword.id_for_label|default:'id_oldpassword' }}">
          Текущий пароль <span class="text-red-500">*</span>
        </label>
        <div class="relative">
          {% if form and form.oldpassword %}
            <input type="password"
                   id="{{ form.oldpassword.id_for_label }}"
                   name="{{ form.oldpassword.name }}"
                   class="field pr-12"
                   required
                   autocomplete="current-password"
                   placeholder="Введите текущий пароль">
          {% else %}
            <input type="password"
                   id="id_oldpassword"
                   name="oldpassword"
                   class="field pr-12"
                   required
                   autocomplete="current-password"
                   placeholder="Введите текущий пароль">
          {% endif %}

          <button type="button"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition"
                  onclick="togglePassword(this)">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
          </button>
        </div>

        {% if form and form.oldpassword.errors %}
          <div class="mt-2 text-sm text-red-600 dark:text-red-400" role="alert">
            {% for error in form.oldpassword.errors %}{{ error }}{% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- New Password -->
      <div>
        <label class="block text-sm font-medium mb-2" for="{{ form.password1.id_for_label|default:'id_password1' }}">
          Новый пароль <span class="text-red-500">*</span>
        </label>
        <div class="relative">
          {% if form and form.password1 %}
            <input type="password"
                   id="{{ form.password1.id_for_label }}"
                   name="{{ form.password1.name }}"
                   class="field pr-12"
                   required
                   autocomplete="new-password"
                   placeholder="Создайте новый пароль"
                   oninput="checkPasswordStrength(this)">
          {% else %}
            <input type="password"
                   id="id_password1"
                   name="password1"
                   class="field pr-12"
                   required
                   autocomplete="new-password"
                   placeholder="Создайте новый пароль"
                   oninput="checkPasswordStrength(this)">
          {% endif %}

          <button type="button"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition"
                  onclick="togglePassword(this)">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
          </button>
        </div>

        <!-- Password Strength Indicator -->
        <div class="mt-2">
          <div class="flex gap-1 mb-2">
            <div class="flex-1 h-1 bg-gray-200 dark:bg-gray-700 rounded-full">
              <div id="strength-bar" class="h-1 rounded-full transition-all duration-300" style="width: 0%;"></div>
            </div>
          </div>
          <div id="strength-text" class="text-xs text-gray-500"></div>
        </div>

        {% if form and form.password1.errors %}
          <div class="mt-2 text-sm text-red-600 dark:text-red-400" role="alert">
            {% for error in form.password1.errors %}{{ error }}{% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Confirm Password -->
      <div>
        <label class="block text-sm font-medium mb-2" for="{{ form.password2.id_for_label|default:'id_password2' }}">
          Новый пароль (ещё раз) <span class="text-red-500">*</span>
        </label>
        <div class="relative">
          {% if form and form.password2 %}
            <input type="password"
                   id="{{ form.password2.id_for_label }}"
                   name="{{ form.password2.name }}"
                   class="field pr-12"
                   required
                   autocomplete="new-password"
                   placeholder="Повторите новый пароль"
                   oninput="checkPasswordMatch(this)">
          {% else %}
            <input type="password"
                   id="id_password2"
                   name="password2"
                   class="field pr-12"
                   required
                   autocomplete="new-password"
                   placeholder="Повторите новый пароль"
                   oninput="checkPasswordMatch(this)">
          {% endif %}

          <button type="button"
                  class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition"
                  onclick="togglePassword(this)">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
          </button>
        </div>

        <div id="match-indicator" class="mt-2 text-xs hidden"></div>

        {% if form and form.password2.errors %}
          <div class="mt-2 text-sm text-red-600 dark:text-red-400" role="alert">
            {% for error in form.password2.errors %}{{ error }}{% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Security Tips -->
      <div class="p-4 rounded-2xl bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
            <path d="M13 9H11V7H13M13 17H11V15H13M12 2A10 10 0 0 0 2 12A10 10 0 0 0 12 22A10 10 0 0 0 22 12A10 10 0 0 0 12 2Z"/>
          </svg>
          <div class="text-sm">
            <div class="font-medium text-blue-800 dark:text-blue-200 mb-1">Советы для безопасного пароля</div>
            <ul class="text-blue-700 dark:text-blue-300 space-y-1">
              <li>• Минимум 8 символов (лучше 12+)</li>
              <li>• Используйте буквы разного регистра</li>
              <li>• Добавьте цифры и символы</li>
              <li>• Не используйте личную информацию</li>
              <li>• Уникальный пароль для каждого сайта</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row gap-3">
        <button class="btn btn-primary flex-1" type="submit" id="submit-btn" disabled>
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Изменить пароль
        </button>
        <a class="btn btn-ghost flex-1 text-center" href="{% url 'account_reset_password' %}">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Забыли пароль?
        </a>
      </div>
    </form>
  </div>

  <!-- Additional Security Info -->
  <div class="mt-8 card p-6 border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/20">
    <div class="flex items-start gap-3">
      <svg class="w-5 h-5 text-amber-600 dark:text-amber-400 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 1L9 9L1 9L7 14L5 22L12 18L19 22L17 14L23 9L15 9L12 1Z"/>
      </svg>
      <div class="text-sm">
        <div class="font-medium text-amber-800 dark:text-amber-200 mb-2">Дополнительная безопасность</div>
        <div class="text-amber-700 dark:text-amber-300 space-y-2">
          <p>После смены пароля вы останетесь в системе на этом устройстве, но будете выходить из других устройств.</p>
          <p>Рекомендуем использовать менеджер паролей для создания и хранения уникальных паролей.</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Password visibility toggle
function togglePassword(button) {
  const input = button.parentElement.querySelector('input');
  const icon = button.querySelector('svg');

  if (input.type === 'password') {
    input.type = 'text';
    icon.innerHTML = `
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"/>
    `;
  } else {
    input.type = 'password';
    icon.innerHTML = `
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
    `;
  }
}

// Password strength checker
function checkPasswordStrength(input) {
  const password = input.value;
  const strengthBar = document.getElementById('strength-bar');
  const strengthText = document.getElementById('strength-text');

  let score = 0;
  let feedback = [];

  // Length check
  if (password.length >= 8) score += 25;
  else feedback.push('минимум 8 символов');

  // Uppercase check
  if (/[A-Z]/.test(password)) score += 25;
  else feedback.push('заглавные буквы');

  // Lowercase check
  if (/[a-z]/.test(password)) score += 25;
  else feedback.push('строчные буквы');

  // Number or symbol check
  if (/[\d\W]/.test(password)) score += 25;
  else feedback.push('цифры или символы');

  // Update strength bar
  strengthBar.style.width = score + '%';

  if (score < 50) {
    strengthBar.className = 'h-1 rounded-full transition-all duration-300 bg-red-500';
    strengthText.textContent = 'Слабый пароль';
    strengthText.className = 'text-xs text-red-600 dark:text-red-400';
  } else if (score < 75) {
    strengthBar.className = 'h-1 rounded-full transition-all duration-300 bg-amber-500';
    strengthText.textContent = 'Средний пароль';
    strengthText.className = 'text-xs text-amber-600 dark:text-amber-400';
  } else {
    strengthBar.className = 'h-1 rounded-full transition-all duration-300 bg-green-500';
    strengthText.textContent = 'Надёжный пароль';
    strengthText.className = 'text-xs text-green-600 dark:text-green-400';
  }

  if (feedback.length > 0 && password.length > 0) {
    strengthText.textContent += ' (нужно: ' + feedback.join(', ') + ')';
  }

  checkFormValidity();
}

// Password match checker
function checkPasswordMatch(input) {
  const password1 = document.querySelector('input[name="password1"]').value;
  const password2 = input.value;
  const matchIndicator = document.getElementById('match-indicator');

  if (password2.length === 0) {
    matchIndicator.classList.add('hidden');
    return;
  }

  matchIndicator.classList.remove('hidden');

  if (password1 === password2) {
    matchIndicator.textContent = '✓ Пароли совпадают';
    matchIndicator.className = 'mt-2 text-xs text-green-600 dark:text-green-400';
  } else {
    matchIndicator.textContent = '✗ Пароли не совпадают';
    matchIndicator.className = 'mt-2 text-xs text-red-600 dark:text-red-400';
  }

  checkFormValidity();
}

// Form validation
function checkFormValidity() {
  const oldPassword = document.querySelector('input[name="oldpassword"]').value;
  const password1 = document.querySelector('input[name="password1"]').value;
  const password2 = document.querySelector('input[name="password2"]').value;
  const submitBtn = document.getElementById('submit-btn');

  const isValid = oldPassword.length > 0 &&
                  password1.length >= 8 &&
                  password1 === password2 &&
                  /[A-Z]/.test(password1) &&
                  /[a-z]/.test(password1) &&
                  /[\d\W]/.test(password1);

  if (isValid) {
    submitBtn.disabled = false;
    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
  } else {
    submitBtn.disabled = true;
    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
}

// Initialize form validation
document.addEventListener('DOMContentLoaded', () => {
  // Add event listeners
  document.querySelector('input[name="oldpassword"]').addEventListener('input', checkFormValidity);
  document.querySelector('input[name="password1"]').addEventListener('input', function() {
    checkPasswordStrength(this);
    // Recheck match if password2 has content
    const password2Input = document.querySelector('input[name="password2"]');
    if (password2Input.value.length > 0) {
      checkPasswordMatch(password2Input);
    }
  });

  // Initial validation check
  checkFormValidity();
});
</script>


{% endblock %}
