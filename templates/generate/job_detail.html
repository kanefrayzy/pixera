{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load generate_extras %}

{% block title %}Ваша обработка — Pixera{% endblock %}

{# ── SEO / Social ── #}
{% block head_extra %}
  <link rel="canonical" href="{{ request.build_absolute_uri }}">
  {% if image_url %}
    {% with abs_img=request.scheme|add:"://"|add:request.get_host|add:image_url %}
      <meta property="og:type" content="website">
      <meta property="og:title" content="AI-генерация — результат">
      <meta property="og:description" content="{{ job.prompt|default:'AI image'|truncatechars:180 }}">
      <meta property="og:image" content="{{ abs_img }}">
      <meta name="twitter:card" content="summary_large_image">
      <meta name="twitter:title" content="AI-генерация — результат">
      <meta name="twitter:description" content="{{ job.prompt|default:'AI image'|truncatechars:180 }}">
      <meta name="twitter:image" content="{{ abs_img }}">
    {% endwith %}
  {% endif %}

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "ImageObject",
    "name": "AI-generated image",
    "description": "{{ job.prompt|default:'AI image'|truncatechars:180|escapejs }}",
    "contentUrl": "{% if image_url %}{{ request.scheme }}://{{ request.get_host }}{{ image_url }}{% else %}{{ request.build_absolute_uri }}{% endif %}",
    "dateCreated": "{{ job.created_at|date:'c' }}"
  }
  </script>
{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-8" itemscope itemtype="https://schema.org/CreativeWork"
     data-estimate-ms="{{ estimate_ms|default:60000 }}"
     data-poll-url="{{ poll_url }}"
     data-image-url="{{ image_url|default_if_none:'' }}"
     data-job-id="{{ job.id }}">

  {% include "includes/messages.html" %}

  <!-- Header -->
  <div class="card p-6 sm:p-8">
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
      <div class="flex-1 min-w-0">
        <h1 class="text-2xl sm:text-3xl font-bold mb-3" itemprop="name">Ваша обработка</h1>
        {% with p=job.original_prompt|default:job.prompt|default:'' %}
        {% if p %}
          <div class="relative p-4 rounded-2xl border border-white/10 dark:border-white/10 bg-black text-white shadow-sm" itemprop="description">
            <div class="text-xs uppercase tracking-wide text-white/60 mb-1">Промпт</div>
            <pre class="whitespace-pre-wrap break-words font-medium text-sm leading-relaxed pr-10" title="{{ p }}">{{ p }}</pre>
            <button type="button"
                    class="absolute top-2 right-2 inline-flex items-center justify-center w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 active:scale-95 transition"
                    data-prompt="{{ p|escapejs }}"
                    aria-label="Копировать промпт"
                    onclick="try{navigator.clipboard&&navigator.clipboard.writeText(this.dataset.prompt);}catch(_){}this.classList.add('ring-2','ring-white/60');setTimeout(()=>this.classList.remove('ring-2','ring-white/60'),700)">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v12h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
            </button>
          </div>
        {% endif %}
        {% endwith %}
      </div>

      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
        <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-primary/10 text-primary" id="statusBadge" aria-live="polite">
          <div class="w-2 h-2 bg-current rounded-full animate-pulse"></div>
          <span class="text-sm font-medium">{{ job.status|default:"Обработка..." }}</span>
        </div>
        <a class="btn btn-ghost" href="{% url 'generate:new' %}">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
          Сделать ещё
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="grid lg:grid-cols-3 gap-8">

    <!-- Image/Video Section -->
    <div class="lg:col-span-2">
      <div class="card overflow-hidden">
        <figure class="relative">
          {% if job.generation_type == 'video' and job.result_video_url %}
            {# Video generation #}
            <video id="resultVideo"
                   class="w-full aspect-square object-cover transition-all duration-500"
                   controls
                   preload="metadata"
                   playsinline>
              <source src="{{ job.result_video_url }}" type="video/mp4">
              Ваш браузер не поддерживает видео.
            </video>
          {% elif image_url %}
            {# Image generation with URL #}
            <img id="resultImg"
                 class="w-full aspect-square object-cover transition-all duration-500 blur-sm"
                 src="{{ image_url }}"
                 alt="Результат генерации"
                 loading="eager"
                 decoding="async">
          {% else %}
            {# Image generation without URL #}
            <img id="resultImg"
                 class="w-full aspect-square object-cover transition-all duration-500 blur-sm"
                 src="{% url 'generate:job_image' pk=job.pk slug=job.prompt|safe_slugify %}"
                 alt="Результат генерации"
                 loading="eager"
                 decoding="async">
          {% endif %}

          <!-- Model Badge -->
          <div class="absolute top-3 left-3">
            <div class="px-2 py-1 rounded-full bg-black/60 text-white text-xs font-medium backdrop-blur-sm whitespace-normal break-words">
              {{ job|model_display }}
            </div>
          </div>

          <!-- Loading Overlay -->
          <div id="loadingOverlay" class="absolute inset-0 bg-black/20 flex items-center justify-center">
            <div class="card p-6 text-center">
              <div class="w-16 h-16 mx-auto mb-4 relative">
                <div class="absolute inset-0 rounded-full border-4 border-[var(--bord)]"></div>
                <div class="absolute inset-0 rounded-full border-4 border-primary border-t-transparent animate-spin" id="loadingSpinner"></div>
              </div>
              <div class="text-sm text-[var(--muted)]">Генерируем ваше изображение...</div>
            </div>
          </div>
        </figure>

        <div class="p-4">
          <div class="flex items-center justify-between text-sm text-[var(--muted)]">
            {% if job.created_at %}
              <span>Создано: {{ job.created_at|date:"d.m.Y, H:i" }}</span>
            {% endif %}
            <span id="dimensionsInfo"></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Progress Sidebar -->
    <div class="space-y-6">

      <!-- Actions -->
      <div class="card p-6">
        <h3 class="font-semibold mb-4">Действия</h3>
        <div class="space-y-3">
          {% if job.generation_type == 'video' and job.result_video_url %}
            {# Video actions #}
            <a id="openLink"
               class="btn btn-primary w-full"
               href="{{ job.result_video_url }}"
               target="_blank"
               rel="nofollow noopener">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
              </svg>
              Открыть видео
            </a>

            <a href="{{ job.result_video_url }}"
               download="ai-video-{{ job.id }}.mp4"
               class="btn btn-ghost w-full">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              Скачать видео
            </a>
          {% else %}
            {# Image actions #}
            <a id="openLink"
               class="btn btn-primary w-full {% if not image_url %}opacity-50 pointer-events-none{% endif %}"
               href="{{ image_url|default:'#' }}"
               {% if not image_url %}aria-disabled="true"{% endif %}
               target="_blank"
               rel="nofollow noopener">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
              </svg>
              Открыть изображение
            </a>

            <button id="downloadBtn"
                    class="btn btn-ghost w-full {% if not image_url %}opacity-50 pointer-events-none{% endif %}"
                    {% if not image_url %}disabled{% endif %}>
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
              </svg>
              Скачать
            </button>
          {% endif %}

          <a class="btn btn-ghost w-full" href="{% url 'generate:new' %}">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
            Создать новое
          </a>
        </div>
      </div>

      <!-- Tips -->
      <div class="card p-6">
        <div class="flex items-start gap-3">
          <svg class="w-5 h-5 text-amber-500 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2l3.09 6.26L22 9l-5 4.87L18.18 21 12 17.77 5.82 21 7 13.87 2 9l6.91-.74L12 2z"/>
          </svg>
          <div>
            <div class="font-medium text-sm mb-2">Совет для лучших результатов</div>
            <div class="text-sm text-[var(--muted)]" id="tipLine">
              Совет: добавляйте детали освещения — "soft studio light", "rim light".
            </div>
          </div>
        </div>
      </div>

      <!-- Technical Info -->
      <div class="card p-6">
        <h3 class="font-semibold mb-4">Техническая информация</h3>
        <div class="space-y-3 text-sm">
          <div class="flex justify-between">
            <span class="text-[var(--muted)]">Job ID:</span>
            <span class="font-mono">{{ job.id }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-[var(--muted)]">Модель:</span>
            <span>{{ job|model_display|default:"" }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-[var(--muted)]">Размер:</span>
            <span id="imageDimensions">1024×1024</span>
          </div>
          {% if job.created_at %}
            <div class="flex justify-between">
              <span class="text-[var(--muted)]">Создано:</span>
              <span>{{ job.created_at|date:"H:i" }}</span>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <!-- Job Comments -->
  <div id="comments" class="mt-8">
    <div class="card p-6">
      {% with p=job.original_prompt|default:job.prompt|default:'' %}
      {% if p %}
      <div class="mb-4 rounded-xl border border-white/10 dark:border-white/10 bg-black text-white shadow-sm">
        <div class="relative px-3 py-2 sm:px-4 sm:py-3">
          <div class="text-xs uppercase tracking-wide text-white/60 mb-1">Промпт</div>
          <pre class="whitespace-pre-wrap break-words font-medium text-sm leading-relaxed pr-10">{{ p }}</pre>
          <button type="button"
                  class="absolute top-2 right-2 inline-flex items-center justify-center w-8 h-8 rounded-lg bg-white/10 hover:bg-white/20 active:scale-95 transition js-copy-prompt"
                  data-prompt="{{ p|escapejs }}"
                  aria-label="Копировать промпт"
                  onclick="try{navigator.clipboard&&navigator.clipboard.writeText(this.dataset.prompt);}catch(_){}this.classList.add('ring-2','ring-white/60');setTimeout(()=>this.classList.remove('ring-2','ring-white/60'),700)">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M16 1H4c-1.1 0-2 .9-2 2v12h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
          </button>
        </div>
      </div>
      {% endif %}
      {% endwith %}
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold">Комментарии</h3>
        <button type="button"
                class="btn btn-ghost px-3 py-1.5 like-toggle"
                data-url="{% url 'generate:job_like' job.id %}"
                aria-pressed="{{ job_liked|yesno:'true,false' }}">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="{% if job_liked %}currentColor{% else %}none{% endif %}" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
          </svg>
          <span id="job-like-count" class="text-sm font-medium">{{ job_like_count }}</span>
        </button>
      </div>

      {% if request.user.is_authenticated %}
      <form method="post" action="{% url 'generate:job_comment' job.id %}" data-comment-form class="flex gap-2 mb-6">
        {% csrf_token %}
        <input type="text" name="text" class="field flex-1" placeholder="Напишите комментарий…" autocomplete="off">
        <button class="btn btn-primary" type="submit">Отправить</button>
      </form>
      {% else %}
        <div class="text-sm text-[var(--muted)] mb-4">Войдите, чтобы оставить комментарий.</div>
      {% endif %}

      <div class="space-y-4" id="commentList">
        {% for c in comments %}
        <div id="c{{ c.id }}" class="p-3 rounded-xl border border-[var(--bord)]">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              {% if c.user and c.user.profile and c.user.profile.avatar %}
                <img src="{{ c.user.profile.avatar.url }}" alt="{{ c.user.username }}" class="w-7 h-7 rounded-full object-cover">
              {% else %}
                <div class="w-7 h-7 rounded-full bg-[var(--bord)] flex items-center justify-center text-xs text-[var(--muted)]">?</div>
              {% endif %}
              <div class="text-sm font-medium">{{ c.user.username|default:"Гость" }}</div>
            </div>
            <div class="flex items-center gap-3">
              <button class="js-like-comment text-[var(--muted)] hover:text-red-500 transition"
                      data-url="{% url 'generate:job_comment_like' c.id %}"
                      data-count-id="jc-like-{{ c.id }}"
                      aria-pressed="{% if c.id in liked_comment_ids %}true{% else %}false{% endif %}">
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="{% if c.id in liked_comment_ids %}currentColor{% else %}none{% endif %}" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                </svg>
                <span id="jc-like-{{ c.id }}" class="text-xs">{{ c.likes_count }}</span>
              </button>
            </div>
          </div>
          <div class="mt-2">{{ c.text|linebreaksbr }}</div>

          {% if c.replies.all %}
          <div class="mt-3 pl-4 border-l border-[var(--bord)] space-y-3">
            {% for r in c.replies.all %}
            <div id="c{{ r.id }}" class="text-sm">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                {% if r.user and r.user.profile and r.user.profile.avatar %}
                  <img src="{{ r.user.profile.avatar.url }}" alt="{{ r.user.username }}" class="w-6 h-6 rounded-full object-cover">
                {% else %}
                  <div class="w-6 h-6 rounded-full bg-[var(--bord)] flex items-center justify-center text-[10px] text-[var(--muted)]">?</div>
                {% endif %}
                <div class="font-medium">{{ r.user.username|default:"Гость" }}</div>
              </div>
              <button class="js-like-comment text-[var(--muted)] hover:text-red-500 transition"
                        data-url="{% url 'generate:job_comment_like' r.id %}"
                        data-count-id="jc-like-{{ r.id }}"
                        aria-pressed="{% if r.id in liked_comment_ids %}true{% else %}false{% endif %}">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="{% if r.id in liked_comment_ids %}currentColor{% else %}none{% endif %}" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  <span id="jc-like-{{ r.id }}" class="text-xs">{{ r.likes_count }}</span>
                </button>
              </div>
              <div class="mt-1">{{ r.text|linebreaksbr }}</div>
            </div>
            {% endfor %}
          </div>
          {% endif %}

          {% if request.user.is_authenticated %}
          <form method="post" action="{% url 'generate:job_comment_reply' c.id %}" data-comment-form class="mt-3 flex gap-2">
            {% csrf_token %}
            <input type="text" name="text" class="field flex-1" placeholder="Ответить…" autocomplete="off">
            <button class="btn btn-ghost" type="submit">Ответить</button>
          </form>
          {% endif %}
        </div>
        {% empty %}
        <div class="text-sm text-[var(--muted)]">Пока нет комментариев.</div>
        {% endfor %}
      </div>
    </div>
  </div>

</div>

<script>
(function(){
  // Получаем данные из data-атрибутов
  const container = document.querySelector('.max-w-5xl');
  const ESTIMATE_MS = parseInt(container.dataset.estimateMs) || 60000;
  const POLL_URL = container.dataset.pollUrl;
  const IMG_URL = container.dataset.imageUrl;
  const jobId = parseInt(container.dataset.jobId);

  const imgEl = document.getElementById('resultImg');
  const openLnk = document.getElementById('openLink');
  const downloadBtn = document.getElementById('downloadBtn');
  const badge = document.getElementById('statusBadge');
  const loadingOverlay = document.getElementById('loadingOverlay');
  const progressCircle = document.getElementById('progressCircle');

  const pctNum = document.getElementById('pctNum');
  const pctText = document.getElementById('pctText');
  const etaEl = document.getElementById('etaText');
  const tipEl = document.getElementById('tipLine');

  const tips = [
    "Совет: уточняйте освещение — \"soft studio light\", \"rim light\".",
    "Совет: указывайте объектив — \"35mm / 85mm, f/1.8\".",
    "Совет: добавляйте материалы — \"matte metal, velvet, glass reflections\".",
    "Совет: настроение — \"warm tones, high contrast, orange–teal\".",
    "Совет: детали композиции — \"close-up\", \"medium shot\", \"full body\".",
    "Совет: стиль фотографии — \"RAW photo\", \"HDR\", \"film grain\", \"Portra 400\"."
  ];

  // Video load handling
  const videoEl = document.getElementById('resultVideo');
  if (videoEl) {
    videoEl.addEventListener('loadedmetadata', () => {
      loadingOverlay.style.display = 'none';
      const dimensions = `${videoEl.videoWidth}×${videoEl.videoHeight}`;
      document.getElementById('imageDimensions').textContent = dimensions;
      const dimensionsInfo = document.getElementById('dimensionsInfo');
      if (dimensionsInfo) dimensionsInfo.textContent = dimensions;
    });
    // Hide loading overlay immediately for video
    loadingOverlay.style.display = 'none';
  }

  // Image load handling
  if (imgEl) {
    imgEl.addEventListener('load', () => {
      imgEl.classList.remove('blur-sm');
      loadingOverlay.style.display = 'none';

      // Update dimensions info
      const dimensions = `${imgEl.naturalWidth}×${imgEl.naturalHeight}`;
      document.getElementById('imageDimensions').textContent = dimensions;
      const dimensionsInfo = document.getElementById('dimensionsInfo');
      if (dimensionsInfo) dimensionsInfo.textContent = dimensions;
    });
  }

  // If result image is already available and loaded from cache, finalize immediately
  if (IMG_URL && imgEl.complete && imgEl.naturalWidth > 0) {
    try {
      imgEl.classList.remove('blur-sm');
      loadingOverlay.style.display = 'none';
      const dimensions = `${imgEl.naturalWidth}×${imgEl.naturalHeight}`;
      document.getElementById('imageDimensions').textContent = dimensions;
      const dimensionsInfo = document.getElementById('dimensionsInfo');
      if (dimensionsInfo) dimensionsInfo.textContent = dimensions;
    } catch(_) {}
  }

  // Download functionality
  downloadBtn.addEventListener('click', async () => {
    if (!IMG_URL && !openLnk.href.includes('http')) return;

    try {
      const response = await fetch(openLnk.href);
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ai-generation-${jobId}.jpg`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.warn('Download failed:', error);
      // Fallback: open in new tab
      window.open(openLnk.href, '_blank');
    }
  });

  // Progress animation
  let start = performance.now(), stop = false, raf;

  function setProgress(percentage) {
    percentage = Math.max(0, Math.min(100, percentage));
    const circumference = 2 * Math.PI * 40; // radius = 40
    const offset = circumference - (percentage / 100) * circumference;

    pctNum.textContent = Math.round(percentage);
    pctText.textContent = Math.round(percentage) + "%";
    progressCircle.style.strokeDashoffset = offset;
  }

  function setEta(ms) {
    if (ms <= 0) {
      etaEl.textContent = "~0:00";
      return;
    }
    const s = Math.ceil(ms / 1000);
    const minutes = Math.floor(s / 60);
    const seconds = s % 60;
    etaEl.textContent = `~${minutes}:${seconds.toString().padStart(2, "0")}`;
  }

  function updateStatus(status, isError = false) {
    const statusDot = badge.querySelector('.w-2');
    const statusText = badge.querySelector('span');

    if (isError) {
      badge.className = 'flex items-center gap-2 px-3 py-2 rounded-xl bg-red-500/10 text-red-600 dark:text-red-400';
      statusDot.className = 'w-2 h-2 bg-current rounded-full';
      statusText.textContent = status;
    } else if (status.toLowerCase().includes('готово') || status.toLowerCase().includes('done')) {
      badge.className = 'flex items-center gap-2 px-3 py-2 rounded-xl bg-green-500/10 text-green-600 dark:text-green-400';
      statusDot.className = 'w-2 h-2 bg-current rounded-full';
      statusText.textContent = status;
    } else {
      statusText.textContent = status;
    }
  }

  function tick() {
    const now = performance.now();
    const elapsed = now - start;

    // Smooth progress curve - slower at the end
    let percentage = (elapsed / ESTIMATE_MS) * 100;
    if (elapsed < ESTIMATE_MS) {
      percentage = Math.min(percentage, 95);
    } else {
      // Slow progress after estimate
      percentage = Math.min(98, 95 + (elapsed - ESTIMATE_MS) / 10000);
    }

    if (!stop) {
      setProgress(percentage);
      setEta(Math.max(0, ESTIMATE_MS - elapsed));
      raf = requestAnimationFrame(tick);
    }
  }

  // Tips rotator
  let tipIdx = 0;
  const tipTimer = setInterval(() => {
    tipEl.textContent = tips[(tipIdx++) % tips.length];
  }, 4000);

  // Start progress animation
  tick();

  // Polling function
  async function poll() {
    let delay = 900;

    while (true) {
      try {
        const response = await fetch(POLL_URL, {
          headers: { 'X-Requested-With': 'fetch' }
        });
        const data = await response.json();

        // Update status
        if (data.provider_status) {
          const niceStatus = String(data.provider_status)
            .replace(/_/g, ' ')
            .replace(/\b\w/g, c => c.toUpperCase());
          updateStatus("Статус: " + niceStatus);
        }

        // Handle failure
        if (data.failed) {
          updateStatus("Ошибка генерации", true);
          clearInterval(tipTimer);
          cancelAnimationFrame(raf);
          setProgress(0);
          alert(data.error || "Произошла ошибка при генерации изображения");
          return;
        }

        // Handle completion
        if (data.done && data.image && data.image.url) {
          stop = true;
          cancelAnimationFrame(raf);
          setProgress(100);
          setEta(0);
          updateStatus("Готово");
          clearInterval(tipTimer);

          // Update image and links
          const cacheBuster = data.image.url + (data.image.url.includes("?") ? "&" : "?") + "t=" + Date.now();
          imgEl.src = cacheBuster;
          openLnk.href = data.image.url;
          openLnk.classList.remove('opacity-50', 'pointer-events-none');
          openLnk.removeAttribute('aria-disabled');

          downloadBtn.classList.remove('opacity-50', 'pointer-events-none');
          downloadBtn.removeAttribute('disabled');

          return;
        }

        await new Promise(resolve => setTimeout(resolve, delay));
        delay = Math.min(2500, delay * 1.15);

      } catch (error) {
        console.warn('Polling error:', error);
        await new Promise(resolve => setTimeout(resolve, delay));
        delay = Math.min(5000, delay * 1.2);
      }
    }
  }

  // Start polling if not already complete
  if (!IMG_URL) {
    poll();
  } else {
    // Already complete
    setProgress(100);
    setEta(0);
    updateStatus("Готово");
    stop = true;
    cancelAnimationFrame(raf);
    clearInterval(tipTimer);

    // Ensure overlay is hidden and image is unblurred when already complete
    try { loadingOverlay.style.display = 'none'; imgEl.classList.remove('blur-sm'); } catch(_) {}

    openLnk.classList.remove('opacity-50', 'pointer-events-none');
    downloadBtn.classList.remove('opacity-50', 'pointer-events-none');
    downloadBtn.removeAttribute('disabled');
  }
})();
</script>



{% endblock %}
