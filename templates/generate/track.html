{# FILE: templates/generate/track.html #}
{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ‚Äî Pixera" %}{% endblock %}
{% block meta_title %}{% trans "–û–∂–∏–¥–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ ‚Äî Pixera" %}{% endblock %}
{% block meta_description %}{% trans "–ú—ã –Ω–∞—á–∞–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –û–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –æ–∫–æ–ª–æ –æ–¥–Ω–æ–π –º–∏–Ω—É—Ç—ã. –î–æ–∂–¥–∏—Ç–µ—Å—å –æ–∫–æ–Ω—á–∞–Ω–∏—è ‚Äî –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ—è–≤–∏—Ç—Å—è –Ω–∏–∂–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏." %}{% endblock %}

{% block content %}
<section class="container section" aria-labelledby="jobTitle">
  <div class="panel track" role="status" aria-live="polite">
    <div class="track-head">
      <h1 id="jobTitle" class="page-title">
        {% blocktrans with id=job.id %}–í–∞—à–µ –∑–∞–¥–∞–Ω–∏–µ ‚Ññ{{ id }}{% endblocktrans %}
      </h1>
      <div class="muted">
        {% trans "–°—Ç–∞—Ç—É—Å" %}: <span id="statusText">{{ job.status }}</span>
      </div>
    </div>

    <div class="track-body">
      <div class="result" aria-live="polite" aria-atomic="true">
        {% if image_url %}
          <div class="result-card">
            <img src="{{ image_url }}" alt="{% trans '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ' %}">
          </div>
        {% else %}
          <!-- –°–∫–µ–ª–µ—Ç–æ–Ω –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ -->
          <div class="result-card skeleton" aria-hidden="true">
            <div class="skeleton-media"></div>
          </div>
        {% endif %}
      </div>

      <div class="progress-box" aria-describedby="etaText">
        <div class="progress-ring" role="img" aria-label="{% trans '–ü—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏' %}">
          <svg viewBox="0 0 120 120" aria-hidden="true" focusable="false">
            <circle class="ring-bg" cx="60" cy="60" r="54"></circle>
            <circle class="ring-fg" id="ring" cx="60" cy="60" r="54" stroke-dasharray="339.292" stroke-dashoffset="339.292"></circle>
          </svg>
          <div class="progress-num" aria-live="polite"><span id="pct">0</span>%</div>
        </div>

        <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
          <span id="bar"></span>
        </div>

        <div class="muted" id="etaText">
          {% trans "–û–∂–∏–¥–∞–Ω–∏–µ ~1 –º–∏–Ω—É—Ç–∞. –ú—ã –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∏–ª—å, —Ä–µ—Å—É—Ä—Å—ã –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏‚Ä¶" %}
        </div>

        <ul class="muted tip-rotator" id="tipRotator" aria-live="polite">
          <li>{% trans "–°–æ–≤–µ—Ç: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫—É ‚Äî ¬´soft studio light, 85mm, orange accent¬ª." %}</li>
          <li>{% trans "–°–æ–≤–µ—Ç: –¥–æ–±–∞–≤–ª—è–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã ‚Äî ¬´matte metal, glass reflections, shallow DOF¬ª." %}</li>
          <li>{% trans "–°–æ–≤–µ—Ç: –∏–∑–±–µ–≥–∞–π—Ç–µ –¥–≤–æ–π–Ω—ã—Ö –æ—Ç—Ä–∏—Ü–∞–Ω–∏–π ‚Äî –ø—Ä–æ–º–ø—Ç –±—É–¥–µ—Ç –ø–æ–Ω—è—Ç–Ω–µ–µ." %}</li>
        </ul>
      </div>
    </div>

    <div class="track-actions" role="group" aria-label="{% trans '–î–µ–π—Å—Ç–≤–∏—è' %}">
      <a class="btn-ghost" href="{% url 'generate:photo' %}">{% trans "–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â—ë" %}</a>
      <a class="btn" href="{% url 'dashboard:my_jobs' %}">{% trans "–ú–æ–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏" %}</a>
    </div>
  </div>
</section>

<script>
(function(){
  const pollUrl    = "{{ poll_url }}";
  const ring       = document.getElementById('ring');
  const pctEl      = document.getElementById('pct');
  const bar        = document.getElementById('bar');
  const statusText = document.getElementById('statusText');
  const tipRotator = document.getElementById('tipRotator');
  const etaText    = document.getElementById('etaText');
  const progressBar= document.querySelector('.progress-bar');

  if (!ring || !pctEl || !bar || !statusText) return;

  const CIRC = 2 * Math.PI * 54; // 339.292
  const START = Date.now();
  const EST = Number({{ estimate_ms|default:60000 }}) || 60000; // ~1 –º–∏–Ω
  const CAP_BEFORE_DONE = 0.90; // –¥–æ 90% –µ–¥–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏

  function setProgress(p){
    p = Math.max(0, Math.min(1, p));
    const off = CIRC * (1 - p);
    ring.style.strokeDashoffset = off.toFixed(2);
    const val = Math.round(p*100);
    pctEl.textContent = val;
    bar.style.width = val + '%';
    progressBar?.setAttribute('aria-valuenow', String(val));
  }

  function easeOut(t){ return 1 - Math.pow(1 - t, 3); }

  // –†–æ—Ç–∞—Ü–∏—è —Å–æ–≤–µ—Ç–æ–≤
  let tips = Array.from(tipRotator?.querySelectorAll('li') || []);
  let tipIdx = 0;
  function rotateTip(){
    tips.forEach((li,i)=> li.style.display = i === tipIdx ? 'list-item' : 'none');
    tipIdx = (tipIdx + 1) % (tips.length || 1);
  }
  if (tips.length) {
    rotateTip();
    var tipTimer = setInterval(rotateTip, 4500);
  }

  // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
  function tick(){
    const dt = Date.now() - START;
    const t = Math.min(dt/EST, 1);
    if (statusText.dataset.done !== '1'){
      setProgress(easeOut(t) * CAP_BEFORE_DONE);
      requestAnimationFrame(tick);
    }
  }
  requestAnimationFrame(tick);

  function applyStatus(data){
    if (!data) return;
    if (typeof data.status === 'string') statusText.textContent = data.status;

    if (data.status === 'done' && data.image && (data.image.url || data.image.src || data.url)) {
      statusText.dataset.done = '1';
      setProgress(1);
      etaText.textContent = "{{ _('–ì–æ—Ç–æ–≤–æ! üéâ') if False else '–ì–æ—Ç–æ–≤–æ! üéâ' }}"; // —Å—Ç—Ä–æ–∫–∞ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ JS-—Ç–µ–≥–∏
      const url = data.image.url || data.image.src || data.url;
      const result = document.querySelector('.result');
      if (result) {
        result.innerHTML = `
          <div class="result-card">
            <img src="${url}" alt="${(data.image.alt || '').replace(/"/g, '&quot;') || 'Generated image'}">
          </div>`;
      }
      if (pollTimer){ clearInterval(pollTimer); }
      if (tipTimer){ clearInterval(tipTimer); }
    } else if (data.status === 'failed' || data.error) {
      statusText.dataset.done = '1';
      etaText.textContent = "{{ _('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –ø—Ä–æ–º–ø—Ç.') if False else '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –ø—Ä–æ–º–ø—Ç.' }}";
      setProgress(1);
      if (pollTimer){ clearInterval(pollTimer); }
      if (tipTimer){ clearInterval(tipTimer); }
    }
  }

  async function poll(){
    if (!pollUrl) return;
    try{
      const r = await fetch(pollUrl, {cache:'no-store', headers: {'Accept': 'application/json'}});
      if (!r.ok) throw new Error('HTTP ' + r.status);
      const json = await r.json();
      applyStatus(json);
    }catch(e){
      // —Ç–∏—Ö–æ –ø–æ–≤—Ç–æ—Ä–∏–º –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑
    }
  }

  // —Å—Ä–∞–∑—É –æ–ø—Ä–æ—Å + –∫–∞–∂–¥—ã–µ 2s
  poll();
  var pollTimer = setInterval(poll, 2000);
})();
</script>
{% endblock %}
