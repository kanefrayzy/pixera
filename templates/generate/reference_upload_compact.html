{% comment %}
Compact Reference Images Upload Component for Parameters Section
Responsive, dark/light theme support, dynamic slot count
Usage: {% include 'generate/reference_upload_compact.html' with target_id='image' %}
{% endcomment %}

<div class="reference-upload-compact" data-target="{{ target_id|default:'image' }}" data-max-refs="5">
  <!-- Header with Beautiful Icon and Description -->
  <div class="flex items-start gap-3 mb-3">
    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500/10 to-blue-500/5 flex items-center justify-center">
      <svg class="w-5 h-5 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
    </div>
    <div class="flex-1">
      <label class="block text-sm font-semibold text-[var(--text)] mb-1">
        Референсные изображения <span class="text-[var(--muted)] font-normal text-xs">(до <span class="ref-max-count">5</span>)</span>
      </label>
      <p class="text-xs text-[var(--muted)] leading-relaxed">Загрузите образцы для задания стиля, композиции или конкретных элементов будущего изображения.</p>
    </div>
  </div>

  <!-- Compact Upload Zone -->
  <div class="ref-compact-zone">
    <input type="file"
           class="ref-file-input-compact"
           accept="image/jpeg,image/jpg,image/png,image/webp"
           data-target="{{ target_id|default:'image' }}"
           multiple
           title="Выберите фото">

    <div class="ref-drop-compact">
      <div class="flex flex-col items-center gap-2">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-blue-500/10 to-blue-500/5 flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
          </svg>
        </div>
        <div class="text-center">
          <p class="text-sm font-medium text-[var(--text)]">Нажмите для выбора</p>
          <p class="text-xs text-[var(--muted)] mt-0.5">или перетащите файлы сюда</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Compact Preview Grid -->
  <div class="ref-preview-compact hidden mt-2"></div>

  <!-- Compact Info -->
  <div class="flex items-center gap-1.5 mt-3 text-xs text-[var(--muted)]">
    <svg class="w-3.5 h-3.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <path d="M12 16v-4M12 8h.01"/>
    </svg>
    <span>JPG, PNG, WEBP • Макс. 10MB на файл • Рекомендуется 1024x1024</span>
  </div>
</div>

<style>
/* Compact Reference Upload - Tailwind-style with CSS Variables */
.reference-upload-compact {
  width: 100%;
}

/* Hidden File Input */
.ref-file-input-compact {
  position: absolute;
  width: 0.1px;
  height: 0.1px;
  opacity: 0;
  overflow: hidden;
  z-index: -1;
}

/* Compact Upload Zone */
.ref-compact-zone {
  position: relative;
  width: 100%;
}

.ref-drop-compact {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  padding: 1.5rem 1rem;
  border: 2px dashed var(--bord);
  border-radius: 0.75rem;
  background-color: var(--bg-card);
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Hover States */
.ref-drop-compact:hover {
  border-color: #3b82f6;
  background-color: rgba(59, 130, 246, 0.05);
  transform: translateY(-1px);
}

html[data-theme="dark"] .ref-drop-compact:hover {
  border-color: #3b82f6;
  background-color: rgba(59, 130, 246, 0.1);
}

/* Drag Over State */
.ref-drop-compact.drag-over {
  border-color: #3b82f6;
  background-color: rgba(59, 130, 246, 0.1);
  transform: scale(1.02);
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

html[data-theme="dark"] .ref-drop-compact.drag-over {
  background-color: rgba(59, 130, 246, 0.15);
}

/* Compact Preview Grid */
.ref-preview-compact {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  gap: 0.5rem;
}

.ref-preview-compact.hidden {
  display: none;
}

/* Preview Item */
.ref-preview-item-compact {
  position: relative;
  aspect-ratio: 1;
  border-radius: 0.375rem;
  overflow: hidden;
  border: 1.5px solid #e5e7eb;
  background-color: #f3f4f6;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

html[data-theme="dark"] .ref-preview-item-compact {
  border-color: #374151;
  background-color: #1f2937;
}

.ref-preview-item-compact:hover {
  border-color: #6366f1;
  transform: scale(1.05);
}

.ref-preview-img-compact {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Remove Button */
.ref-remove-btn-compact {
  position: absolute;
  top: 0.125rem;
  right: 0.125rem;
  width: 1.25rem;
  height: 1.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(0, 0, 0, 0.75);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 9999px;
  color: white;
  cursor: pointer;
  opacity: 0;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.ref-preview-item-compact:hover .ref-remove-btn-compact {
  opacity: 1;
}

.ref-remove-btn-compact:hover {
  background-color: rgba(239, 68, 68, 0.9);
  transform: scale(1.15);
}

.ref-remove-btn-compact svg {
  width: 0.75rem;
  height: 0.75rem;
}

/* Responsive Adjustments */
@media (min-width: 480px) {
  .ref-preview-compact {
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
  }

  .ref-drop-compact {
    padding: 0.875rem 1.125rem;
  }
}

@media (min-width: 640px) {
  .ref-preview-compact {
    grid-template-columns: repeat(5, 1fr);
    gap: 0.625rem;
  }

  .ref-remove-btn-compact {
    width: 1.5rem;
    height: 1.5rem;
  }

  .ref-remove-btn-compact svg {
    width: 0.875rem;
    height: 0.875rem;
  }
}

@media (max-width: 375px) {
  .ref-drop-compact {
    padding: 0.625rem 0.75rem;
    gap: 0.5rem;
  }

  .ref-preview-compact {
    grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
    gap: 0.375rem;
  }
}

@media (max-width: 320px) {
  .ref-drop-compact {
    padding: 0.5rem 0.625rem;
    gap: 0.375rem;
  }

  .ref-drop-compact svg {
    width: 1rem;
    height: 1rem;
  }

  .ref-preview-compact {
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
  }
}
</style>

<script>
(function() {
  'use strict';

  function initCompactReferenceUpload(container) {
    if (container.dataset.initialized === 'true') {
      return;
    }
    container.dataset.initialized = 'true';

    const targetId = container.dataset.target || 'image';
    const fileInput = container.querySelector('.ref-file-input-compact');
    const dropArea = container.querySelector('.ref-drop-compact');
    const previewGrid = container.querySelector('.ref-preview-compact');
    const maxCountSpan = container.querySelector('.ref-max-count');

    let MAX_FILES = parseInt(container.dataset.maxRefs) || 5;
    const MAX_SIZE = 10 * 1024 * 1024; // 10MB
    let files = [];

    // Update max count display
    if (maxCountSpan) {
      maxCountSpan.textContent = MAX_FILES;
    }

    // Click to upload
    dropArea.addEventListener('click', () => {
      fileInput.click();
    });

    // File selection
    fileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files.length > 0) {
        handleFiles(Array.from(e.target.files));
      }
    });

    // Drag & Drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => {
        dropArea.classList.add('drag-over');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => {
        dropArea.classList.remove('drag-over');
      }, false);
    });

    dropArea.addEventListener('drop', (e) => {
      const droppedFiles = Array.from(e.dataTransfer.files);
      handleFiles(droppedFiles);
    }, false);

    function handleFiles(newFiles) {
      const validFiles = newFiles.filter(file => {
        if (!file.type.match(/^image\/(jpeg|jpg|png|webp)$/)) {
          showError(`${file.name}: неподдерживаемый формат`);
          return false;
        }
        if (file.size > MAX_SIZE) {
          showError(`${file.name}: превышен размер (макс. 10MB)`);
          return false;
        }
        return true;
      });

      if (validFiles.length === 0) return;

      const totalCount = files.length + validFiles.length;
      if (totalCount > MAX_FILES) {
        const canAdd = MAX_FILES - files.length;
        if (canAdd > 0) {
          showError(`Можно добавить ещё ${canAdd} фото (макс. ${MAX_FILES})`);
          files = files.concat(validFiles.slice(0, canAdd));
        } else {
          showError(`Достигнут лимит: ${MAX_FILES} фото`);
          return;
        }
      } else {
        files = files.concat(validFiles);
      }

      updatePreview();
      dispatchChange();
    }

    function updatePreview() {
      if (files.length === 0) {
        previewGrid.classList.add('hidden');
        previewGrid.innerHTML = '';
        return;
      }

      previewGrid.classList.remove('hidden');
      previewGrid.innerHTML = '';

      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const item = document.createElement('div');
          item.className = 'ref-preview-item-compact';
          item.innerHTML = `
            <img src="${e.target.result}" alt="Референс ${index + 1}" class="ref-preview-img-compact">
            <button type="button" class="ref-remove-btn-compact" data-index="${index}" aria-label="Удалить">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M6 6l12 12M18 6L6 18"/>
              </svg>
            </button>
          `;

          item.querySelector('.ref-remove-btn-compact').addEventListener('click', (e) => {
            e.stopPropagation();
            removeFile(index);
          });

          previewGrid.appendChild(item);
        };
        reader.readAsDataURL(file);
      });
    }

    function removeFile(index) {
      files.splice(index, 1);
      updatePreview();
      dispatchChange();
    }

    function dispatchChange() {
      container.dispatchEvent(new CustomEvent('referenceFilesChanged', {
        detail: { files, targetId },
        bubbles: true
      }));
    }

    function showError(message) {
      alert(message);
    }

    // Public API
    container.getReferenceFiles = () => files;
    container.clearReferenceFiles = () => {
      files = [];
      updatePreview();
      fileInput.value = '';
    };
    container.updateMaxRefs = (newMax) => {
      MAX_FILES = newMax;
      container.dataset.maxRefs = newMax;
      if (maxCountSpan) {
        maxCountSpan.textContent = newMax;
      }
      // Trim files if needed
      if (files.length > MAX_FILES) {
        files = files.slice(0, MAX_FILES);
        updatePreview();
        dispatchChange();
      }
    };
  }

  function init() {
    document.querySelectorAll('.reference-upload-compact').forEach(initCompactReferenceUpload);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  document.addEventListener('referenceUploadCompactInit', init);
})();
</script>
