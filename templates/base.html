{% load static i18n %}
<!doctype html>
{% get_current_language as CUR_LANG %}
<html lang="{{ CUR_LANG|default:'ru' }}" class="scroll-smooth" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="format-detection" content="telephone=no,email=no,address=no">
  <meta name="color-scheme" content="dark light">

  <title>{% block meta_title %}{% block title %}{% trans "Pixera — ИИ-галерея и генерация" %}{% endblock %}{% endblock %}</title>
  <meta name="description" content="{% block meta_description %}{% trans "Pixera — современная галерея и генерация изображений ИИ. Тёмная/светлая тема, быстрый поиск, теги и тренды." %}{% endblock %}">
  <link rel="canonical" href="{% block canonical %}{{ request.build_absolute_uri }}{% endblock %}">

  <!-- БЛОКИРОВКА ИНДЕКСАЦИИ -->
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="bingbot" content="noindex, nofollow">
  <meta name="yandex" content="noindex, nofollow">

  <meta id="themeColor" name="theme-color" content="#0B0E14">
  <meta name="referrer" content="strict-origin-when-cross-origin">


  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Pixera">
  <meta property="og:title" content="{% block og_title %}{% trans "Pixera — генерация и галерея" %}{% endblock %}">
  <meta property="og:description" content="{% block og_description %}{% trans "Минималистичный UI, плавные градиенты и качественная генерация изображений ИИ." %}{% endblock %}">
  <meta property="og:url" content="{{ request.build_absolute_uri }}">
  <meta property="og:image" content="{% block og_image %}{{ request.scheme }}://{{ request.get_host }}{% static 'img/og-default.jpg' %}{% endblock %}">
  <meta name="twitter:card" content="summary_large_image">


  <link rel="icon" href="{% static 'img/favicon/favicon.svg' %}" type="image/svg+xml">
  <link rel="icon" href="{% static 'img/favicon/favicon.ico' %}" sizes="any">
  <link rel="apple-touch-icon" href="{% static 'img/favicon/apple-touch-icon.png' %}">
  <link rel="manifest" href="{% static 'img/favicon/site.webmanifest' %}">


  <link rel="dns-prefetch" href="//api.runware.ai">
  <link rel="preconnect" href="https://api.runware.ai" crossorigin>


  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">


  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="{% static 'css/tailwind.min.css' %}">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="{% static 'css/components.css' %}">
  <link rel="stylesheet" href="{% static 'css/gallery.css' %}">
  <link rel="stylesheet" href="{% static 'css/checkbox-fix.css' %}">
  <link rel="stylesheet" href="{% static 'css/admin-forms-dark.css' %}">

  {% block extra_css %}{% endblock %}


  <style>
    #site-header {
      background-color: transparent !important; /* прозрачный фон самого header */
      -webkit-backdrop-filter: none !important; /* без blur, чтобы оттенок не зависел от контента */
      backdrop-filter: none !important;
      will-change: auto;
    }
    /* Псевдо-фон: повторяет фон сайта (noise + радиальные градиенты + базовый цвет),
       но закреплён за самим header и не зависит от контента под ним */
    #site-header::before {
      content: "";
      position: absolute;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.035'/%3E%3C/svg%3E") repeat,
        radial-gradient(ellipse at top, rgba(1,209,251,.25), transparent 60%),
        radial-gradient(ellipse at bottom, rgba(236,72,153,.16), transparent 65%),
        var(--bg);
      background-blend-mode: normal;
    }

    /* Dark theme: replace red tint with brand blue in navbar */
    html[data-theme="dark"] #site-header::before {
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.035'/%3E%3C/svg%3E") repeat,
        radial-gradient(ellipse at top, rgba(1,209,251,.25), transparent 60%),
        radial-gradient(ellipse at bottom, rgba(1,209,251,.16), transparent 65%),
        var(--bg);
      background-blend-mode: normal;
    }

    /* Header divider refinement for dark theme:
       - remove bright white bottom border
       - keep a very subtle separation via inset shadow
       Light theme keeps a soft dark divider. */
    html[data-theme="dark"] #site-header {
      border-bottom-color: transparent !important;
      box-shadow: inset 0 -1px 0 0 rgba(255, 255, 255, 0.04);
    }
    html[data-theme="light"] #site-header {
      border-bottom-color: rgba(0, 0, 0, 0.06);
    }
    @media (min-width: 1024px) {
      html[data-theme="dark"] #site-header {
        box-shadow: inset 0 -1px 0 0 rgba(255, 255, 255, 0.035);
      }
    }
  </style>

  <!-- Mobile fallback to prevent first-paint overlap when header is fixed.
       Ensures all pages start below the navbar even before JS sets --nav-h. -->
  <style>
    @media (max-width: 1023.98px) {
      body {
        padding-top: calc(var(--nav-h, 64px) + env(safe-area-inset-top, 0px));
      }
    }
  </style>

  <script>
    (function () {
      try {
        const saved = localStorage.getItem('theme');
        const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || "{{ DEFAULT_THEME|default:'dark' }}" || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
        const meta = document.getElementById('themeColor');
        if (meta) meta.setAttribute('content', theme === 'dark' ? '#0B0E14' : '#F7F8FA');
      } catch(e) {}
    })();
  </script>


  <script>
  (function () {
    const FP_COOKIE = "{{ FP_COOKIE_NAME|default:'aid_fp' }}";
    const FP_HEADER = "{{ FP_HEADER_NAME|default:'X-Device-Fingerprint' }}";
    const FP_PARAM  = "{{ FP_PARAM_NAME|default:'fp' }}";
    const GID_COOKIE = "gid";
    const FIVE_YEARS = 60*60*24*365*5;

    function getCookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.$?*|{}()[\]\\/+^])/g,'\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }
    function setCookie(name, val, maxAgeSec){
      try{
        const secure = location.protocol === 'https:' ? '; Secure' : '';
        document.cookie = name + '=' + encodeURIComponent(val)
          + '; Path=/; SameSite=Lax; Max-Age=' + (maxAgeSec||FIVE_YEARS) + secure;
      }catch(e){}
    }
    function randId(){
      try{
        const a = new Uint8Array(16); crypto.getRandomValues(a);
        return Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch(_){
        return (Date.now().toString(16) + Math.random().toString(16).slice(2)).slice(0,32);
      }
    }
    async function sha256(s){
      try{
        const buf = new TextEncoder().encode(s);
        const h = await crypto.subtle.digest('SHA-256', buf);
        return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch(_){
        let h=5381; for(let i=0;i<s.length;i++){ h=((h<<5)+h) ^ s.charCodeAt(i); }
        return ('00000000'+(h>>>0).toString(16)).slice(-8);
      }
    }
    function canvasFp(){
      try{
        const c=document.createElement('canvas'); c.width=240; c.height=80;
        const x=c.getContext('2d'); x.textBaseline='top'; x.font='16px Arial';
        x.fillStyle='#f60'; x.fillText(navigator.userAgent, 4, 4);
        x.strokeStyle='#09f'; x.strokeRect(10, 10, 180, 30);
        x.fillStyle='#222'; x.globalAlpha=0.7; x.fillRect(20,20,110,20);
        return c.toDataURL();
      }catch(e){ return 'nocanvas'; }
    }
    function webglInfo(){
      try{
        const c=document.createElement('canvas');
        const gl=c.getContext('webgl')||c.getContext('experimental-webgl');
        if(!gl) return 'nowebgl';
        const dbg=gl.getExtension('WEBGL_debug_renderer_info');
        const ven=dbg?gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL):'';
        const ren=dbg?gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL):'';
        return ven+'|'+ren;
      }catch(e){ return 'wgerr'; }
    }
    async function computeFP(){
      const data = [
        navigator.userAgent||'',
        navigator.platform||'',
        (navigator.languages||[]).join(','),
        Intl.DateTimeFormat().resolvedOptions().timeZone||'',
        screen && (screen.width+'x'+screen.height+'x'+screen.colorDepth),
        screen && (screen.availWidth+'x'+screen.availHeight),
        String(navigator.hardwareConcurrency||''),
        String(navigator.deviceMemory||''),
        'touch:' + ('ontouchstart' in window),
        'ls:' + ('localStorage' in window),
        'ss:' + ('sessionStorage' in window),
        (performance && performance.memory && performance.memory.jsHeapSizeLimit) || '',
        (navigator.plugins && Array.from(navigator.plugins).map(p=>p.name).join(',')) || '',
        canvasFp(),
        webglInfo()
      ].join('||');
      return await sha256(data);
    }

    (async function boot(){
      try{
        let gid = getCookie(GID_COOKIE);
        if(!gid){ gid = randId(); setCookie(GID_COOKIE, gid, FIVE_YEARS); }

        let fp = getCookie(FP_COOKIE) || (function(){ try{return localStorage.getItem(FP_COOKIE)||'';}catch(_){return '';} })();
        if(!fp){
          fp = await computeFP();
          setCookie(FP_COOKIE, fp, FIVE_YEARS);
          try{ localStorage.setItem(FP_COOKIE, fp); }catch(_){}
          try{ sessionStorage.setItem(FP_COOKIE, fp); }catch(_){}
        }

        window.__AIGID = gid; window.__AIFP = fp;
        const origFetch = window.fetch;
        if (origFetch) {
          window.fetch = function(input, init){
            init = init || {};
            let headers = init.headers || {};
            try{
              if (headers instanceof Headers) {
                headers.set(FP_HEADER, fp);
              } else if (Array.isArray(headers)) {
                headers.push([FP_HEADER, fp]);
              } else {
                headers[FP_HEADER] = fp;
              }
            }catch(_){}
            init.headers = headers;
            return origFetch.call(this, input, init);
          };
        }
        if (window.XMLHttpRequest) {
          const open = XMLHttpRequest.prototype.open;
          const send = XMLHttpRequest.prototype.send;
          XMLHttpRequest.prototype.open = function(){ this.___fp_ready = true; return open.apply(this, arguments); };
          XMLHttpRequest.prototype.send = function(){
            try{ this.setRequestHeader(FP_HEADER, fp); }catch(_){}
            return send.apply(this, arguments);
          };
        }

        document.addEventListener('submit', function(e){
          const form = e.target && e.target.closest && e.target.closest('form');
          if(!form) return;
          if((form.getAttribute('method')||'GET').toUpperCase()!=='POST') return;
          if(form.querySelector('input[name="'+FP_PARAM+'"]')) return;
          try{
            const inp=document.createElement('input');
            inp.type='hidden'; inp.name=FP_PARAM; inp.value=fp;
            form.appendChild(inp);
          }catch(_){}
        });
      }catch(e) {}
    })();
  })();
  </script>

  <link rel="preload" as="image" href="{% static 'img/bg.webp' %}" type="image/webp" />
  <link rel="preload" as="image" href="{% static 'img/bg.png' %}" />
  {% block head_extra %}{% endblock %}
</head>
<body>

  <a class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 z-50 btn btn-primary" href="#main">{% trans "Перейти к содержанию" %}</a>


  <div aria-hidden="true" class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-noise"></div>
    <div class="absolute -inset-x-32 -top-24 h-[28rem] bg-[radial-gradient(ellipse_at_top,_rgba(1,209,251,.25),_transparent_60%)]"></div>
    <div class="absolute -inset-x-40 top-[28rem] h-[26rem] bg-[radial-gradient(ellipse_at_bottom,_rgba(236,72,153,.16),_transparent_65%)]"></div>
  </div>

  {% url 'pages:home' as home_href1 %}
  {% url 'home' as home_href2 %}
  {% url 'account_login' as account_login_url %}
  {% url 'account_signup' as account_signup_url %}
  {% url 'generate:new' as gen_url %}
  {% url 'dashboard:notifications' as notifications_url %}
  {% url 'dashboard:my_jobs' as my_jobs_url %}


  <header id="site-header" class="fixed lg:sticky top-0 left-0 right-0 z-50 border-b border-[var(--bord)]/20" role="banner">
    <div class="container flex h-16 items-center justify-between px-3 lg:px-4">

      <a href="{% if home_href1 %}{{ home_href1 }}{% elif home_href2 %}{{ home_href2 }}{% else %}/{% endif %}"
         rel="home" class="flex items-center gap-2.5 group" aria-label="{% trans 'На главную' %}">
        <img src="{% static 'img/logo.png' %}" alt="Pixera" class="h-10 w-auto transition-transform group-hover:scale-105" loading="eager">
        <span class="text-lg font-semibold text-[var(--text)]">Pixera.net</span>
      </a>


      <nav class="hidden lg:flex items-center gap-6 xl:gap-7" role="navigation" aria-label="{% trans 'Главное меню' %}">
        {% if request.user.is_authenticated %}
        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="{% url 'profile_short' request.user.username %}">{% trans "Мой профиль" %}</a>
        {% else %}
        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="/">{% trans "Главная" %}</a>
        {% endif %}
        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="{% url 'gallery:index' %}">{% trans "Галерея" %}</a>
        {% if not request.user.is_authenticated %}
        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="{% url 'gallery:trending' %}">{% trans "Тренды" %}</a>
        {% endif %}
        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="{% url 'generate:new' %}">{% trans "Генерация" %}</a>
        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="{% url 'blog:index' %}">{% trans "Блог" %}</a>
        {% if request.user.is_staff %}
        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="{% url 'dashboard:slider:list' %}">{% trans "Примеры слайдера" %}</a>
        {% endif %}
      </nav>


      <div class="hidden lg:flex items-center gap-2">

        {% if not request.user.is_authenticated %}
        <details class="relative" id="langSwitch">
          <summary class="btn btn-ghost p-2 rounded-2xl border-0 cursor-pointer" aria-controls="langMenu" aria-haspopup="menu" aria-expanded="false" aria-label="{% trans 'Выбрать язык' %}">
            <img id="currentLangFlag" class="w-6 h-6 rounded-full object-cover" src="{% static 'img/flags/ru.svg' %}" alt="">
          </summary>
          <div class="absolute right-0 top-full mt-2 rounded-3xl border border-[var(--bord)] bg-white dark:bg-gray-800 shadow-[0_8px_30px_rgba(0,0,0,0.18)] p-2 min-w-48 z-50" id="langMenu" role="menu" aria-label="{% trans 'Выбрать язык' %}">
            <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/10 flex items-center gap-2" type="button" data-lang="en" role="menuitemradio" aria-checked="false">
              <img class="w-4 h-4 rounded" src="{% static 'img/flags/gb.svg' %}" alt="English">
              <span class="text-sm">English</span>
            </button>
            <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/10 flex items-center gap-2" type="button" data-lang="ru" role="menuitemradio" aria-checked="false">
              <img class="w-4 h-4 rounded" src="{% static 'img/flags/ru.svg' %}" alt="Русский">
              <span class="text-sm">{% trans "Русский" %}</span>
            </button>
            <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/10 flex items-center gap-2" type="button" data-lang="de" role="menuitemradio" aria-checked="false">
              <img class="w-4 h-4 rounded" src="{% static 'img/flags/de.svg' %}" alt="Deutsch">
              <span class="text-sm">Deutsch</span>
            </button>
            <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/10 flex items-center gap-2" type="button" data-lang="es" role="menuitemradio" aria-checked="false">
              <img class="w-4 h-4 rounded" src="{% static 'img/flags/es.svg' %}" alt="Español">
              <span class="text-sm">Españол</span>
            </button>
            <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/10 flex items-center gap-2" type="button" data-lang="pt" role="menuitemradio" aria-checked="false">
              <img class="w-4 h-4 rounded" src="{% static 'img/flags/pt.svg' %}" alt="Português">
              <span class="text-sm">Português</span>
            </button>
          </div>
        </details>

        <button id="themeToggle" class="btn btn-ghost p-2 rounded-2xl border-0" type="button" aria-label="{% trans 'Переключить тему' %}" aria-pressed="false">
          <svg id="iconSun" class="h-5 w-5 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.6 4.6l2.1 2.1M17.3 17.3l2.1 2.1M4.6 19.4l2.1-2.1M17.3 6.7l2.1-2.1"></path>
          </svg>
          <svg id="iconMoon" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M21 12.6A9 9 0 1 1 11.4 3a7 7 0 0 0 9.6 9.6Z"></path>
          </svg>
          <span class="sr-only">{% trans "Тема" %}</span>
        </button>
        {% endif %}

        {% if request.user.is_authenticated %}
          <a class="btn btn-ghost p-2.5 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0 group"
             href="{% url 'gallery:trending' %}" aria-label="{% trans 'Поиск и тренды' %}">
            <svg class="w-5 h-5 text-[var(--text)] group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
              <path d="M8 11h6"></path>
            </svg>
          </a>

          <button class="btn btn-ghost p-2.5 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0 relative group"
                  type="button" aria-label="{% trans 'Уведомления' %}" id="notifBtn" aria-haspopup="true" aria-expanded="false">
            <svg class="w-5 h-5 text-[var(--text)] group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
              <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
            </svg>
            <span id="notifDot" class="absolute top-1.5 right-1.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-[var(--bg)] hidden"></span>
            <span id="notifTiny" class="absolute -top-1 -right-1 rounded-full bg-red-500 text-[10px] leading-none text-white px-1.5 py-0.5 font-bold shadow-sm hidden"></span>
          </button>

          <a href="{% url 'dashboard:index' %}" class="btn btn-ghost p-1.5 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0 group" id="cabinetBtn">
            <span class="flex items-center gap-2">
              <span class="w-8 h-8 rounded-full overflow-hidden ring-2 ring-transparent group-hover:ring-primary/30 transition-all">
                {% if user_profile and user_profile.avatar %}
                  <img
                    src="{{ user_profile.avatar.url }}"
                    alt="{{ request.user.username }}"
                    class="js-avatar-img w-full h-full object-cover"
                    loading="lazy"
                    decoding="async"
                  />
                {% else %}
                  <span class="js-avatar-fallback w-full h-full rounded-full bg-gradient-to-br from-primary to-blue-600 grid place-items-center text-white font-bold text-sm">
                    {{ request.user.first_name|first|default:request.user.username|first|upper }}
                  </span>
                {% endif %}
              </span>
              <span class="text-sm font-medium text-[var(--text)] group-hover:text-primary transition-colors max-w-[80px] truncate">{{ request.user.username }}</span>
            </span>
          </a>

          {% if account_logout_url %}<a href="{{ account_logout_url }}" class="btn btn-ghost px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0 text-sm font-medium">{% trans "" %}</a>{% endif %}
        {% else %}
            {% if account_login_url %}<a href="{{ account_login_url }}" class="btn btn-ghost p-2 rounded-2xl border-0" rel="nofollow">{% trans "Войти" %}</a>{% endif %}
            {% if account_signup_url %}<a href="{{ account_signup_url }}" class="btn btn-primary p-2 rounded-2xl" rel="nofollow">{% trans "Начать бесплатно" %}</a>{% endif %}
        {% endif %}
      </div>

  <div class="lg:hidden flex items-center gap-0.5 ml-auto">
    {% if request.user.is_authenticated %}
      <a class="btn btn-ghost p-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0"
         href="{% url 'generate:new' %}" aria-label="{% trans 'Генерация' %}">
        <svg class="w-[18px] h-[18px] text-[var(--text)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
        </svg>
      </a>

      <a class="btn btn-ghost p-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0"
         href="{% url 'gallery:trending' %}" aria-label="{% trans 'Поиск и тренды' %}">
        <svg class="w-[18px] h-[18px] text-[var(--text)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
          <path d="M8 11h6"></path>
        </svg>
      </a>

      <button class="btn btn-ghost p-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0 relative"
              type="button" aria-label="{% trans 'Уведомления' %}" id="notifBtnM">
        <svg class="w-[18px] h-[18px] text-[var(--text)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
          <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
        </svg>
        <span id="notifDotM" class="absolute top-0.5 right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-[var(--bg)] hidden"></span>
        <span id="notifTinyM" class="absolute -top-1 -right-1 rounded-full bg-red-500 text-[10px] leading-none text-white px-1.5 py-0.5 font-bold shadow-sm hidden"></span>
      </button>

      <button class="btn btn-ghost border-0 p-1 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" type="button" data-open-dashboard="1" aria-label="{% trans 'Открыть меню' %}">
        <span class="w-7 h-7 rounded-full overflow-hidden ring-2 ring-transparent hover:ring-primary/30 transition-all">
          {% if user_profile and user_profile.avatar %}
            <img
              src="{{ user_profile.avatar.url }}"
              alt="{{ request.user.username }}"
              class="js-avatar-img w-full h-full object-cover"
              loading="lazy"
              decoding="async"
            />
          {% else %}
            <span class="js-avatar-fallback w-full h-full rounded-full bg-gradient-to-br from-primary to-blue-600 grid place-items-center text-white font-bold text-xs">
              {{ request.user.first_name|first|default:request.user.username|first|upper }}
            </span>
          {% endif %}
        </span>
      </button>
    {% else %}
      <a class="btn btn-ghost p-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0"
         href="{% url 'generate:new' %}" aria-label="{% trans 'Генерация' %}">
        <svg class="w-[18px] h-[18px] text-[var(--text)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
        </svg>
      </a>


      <button class="btn btn-ghost border-0 p-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" type="button" data-open-dashboard="1" aria-label="{% trans 'Открыть меню' %}">
        <svg class="w-[18px] h-[18px] text-[var(--text)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    {% endif %}
  </div>
    </div>




  </header>

  {% include "includes/dashboard_drawer.html" %}

  {% block hero %}{% endblock %}
  {% block breadcrumbs %}{% endblock %}


  <main id="main" class="container py-6 pt-8 md:pt-6" style="margin-top:30px;" role="main">
    {% include "includes/messages.html" %}
    {% block content %}{% endblock %}
  </main>


  <footer class="border-t border-[var(--bord)] bg-[var(--bg)]/80 backdrop-blur-sm pt-12 mt-10">
    <div class="container py-10">
      <div class="grid grid-auto-fit gap-6">
        <div>
          <div class="flex items-center gap-2">
            <img src="{% static 'img/logo.png' %}" alt="Pixera" class="h-9 w-auto" loading="lazy">
            <span class="text-lg font-semibold">Pixera.net</span>
          </div>
          <p class="mt-3 text-sm text-[var(--muted)]">{% trans "Галерея и генерация ИИ-изображений. Адаптив до 320 px, тёмная/светлая тема." %}</p>
        </div>
        <div>
          <h4 class="text-sm font-semibold">{% trans "Разделы" %}</h4>
          <ul class="mt-3 space-y-2 text-sm text-[var(--muted)]">
            <li><a href="{% if home_href1 %}{{ home_href1 }}{% elif home_href2 %}{{ home_href2 }}{% else %}/{% endif %}" class="hover:text-[var(--text)] transition">{% trans "Главная" %}</a></li>
            <li><a href="{% url 'gallery:index' %}" class="hover:text-[var(--text)] transition">{% trans "Галерея" %}</a></li>
            <li><a href="{% url 'gallery:trending' %}" class="hover:text-[var(--text)] transition">{% trans "Тренды" %}</a></li>
            <li><a href="{% url 'generate:new' %}" class="hover:text-[var(--text)] transition">{% trans "Генерация" %}</a></li>
            <li class="lg:hidden"><a href="{% url 'blog:index' %}" class="hover:text-[var(--text)] transition">{% trans "Блог" %}</a></li>
          </ul>
        </div>
        <div>
          <h4 class="text-sm font-semibold">{% trans "Компания" %}</h4>
          <ul class="mt-3 space-y-2 text-sm text-[var(--muted)]">
            <li><a href="{% url 'pages:about' %}" class="hover:text-[var(--text)] transition">{% trans "О нас" %}</a></li>
            <li><a href="{% url 'pages:contact' %}" class="hover:text-[var(--text)] transition">{% trans "Связаться с нами" %}</a></li>
            <li><a href="{% url 'pages:privacy' %}" class="hover:text-[var(--text)] transition">{% trans "Политика конфиденциальности" %}</a></li>
          </ul>
        </div>
        <div>
          <h4 class="text-sm font-semibold">{% trans "Разработчикам" %}</h4>
          <ul class="mt-3 space-y-2 text-sm text-[var(--muted)]">
            <li><a href="{% url 'dashboard:api:documentation' %}" class="hover:text-[var(--text)] transition">{% trans "API Документация" %}</a></li>
            {% if request.user.is_authenticated %}
            <li><a href="{% url 'dashboard:api:dashboard' %}" class="hover:text-[var(--text)] transition">{% trans "API Управление" %}</a></li>
            {% endif %}
          </ul>
        </div>
      </div>
      <div class="mt-8 flex flex-wrap items-center justify-between gap-3 border-t border-[var(--bord)] pt-6 text-xs text-[var(--muted)]">
        <span>© {% now "Y" %} Pixera — {% trans "все права защищены" %}.</span>
        <div class="flex items-center gap-4">
          <a href="{% url 'pages:privacy' %}" class="hover:text-[var(--text)] transition">Terms</a>
          <a href="{% url 'pages:privacy' %}" class="hover:text-[var(--text)] transition">Privacy</a>
          <a href="{% url 'pages:contact' %}" class="hover:text-[var(--text)] transition">Security</a>
        </div>
      </div>
    </div>
  </footer>

  {% include "includes/age_gate.html" %}


  <form id="setlang-fallback" class="sr-only" action="{% url 'set_language' %}" method="post" aria-hidden="true">
    {% csrf_token %}
    <input type="hidden" name="next" value="{{ request.get_full_path }}">
    <input type="hidden" name="language" value="">
  </form>


  <script src="{% static 'js/main.js' %}"></script>
  <script src="{% static 'js/language-switcher.js' %}"></script>
  <script src="{% static 'js/interactions.js' %}"></script>
  <script src="{% static 'js/trending.js' %}"></script>
  <script src="{% static 'js/video-viewer.js' %}" defer></script>
  <script>
    (function(){
      var notifHref = "{{ notifications_url|default:'/dashboard/notifications' }}";
      var UNREAD_URL = "{% url 'dashboard:api:notifications_unread_count' %}";
      var lastUnread = null;
      var notifAudioCtx = null;
      var notifSoundUnlocked = false;

      function unlockNotifSound(){
        if (notifSoundUnlocked) return;
        try{
          if (!notifAudioCtx) {
            notifAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
          }
          var p = notifAudioCtx.resume();
          if (p && typeof p.then === 'function') {
            p.then(function(){ notifSoundUnlocked = true; }).catch(function(){});
          } else {
            notifSoundUnlocked = true;
          }
        }catch(_){}
      }

      function playBeep(){
        try{
          if (!notifAudioCtx) {
            notifAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
          }
          if (notifAudioCtx.state === 'suspended') {
            notifAudioCtx.resume().catch(function(){});
          }
          var ctx = notifAudioCtx;
          var now = ctx.currentTime;

          var osc1 = ctx.createOscillator();
          var osc2 = ctx.createOscillator();
          var gain = ctx.createGain();

          osc1.type = 'sine';
          osc2.type = 'sine';

          // тот же "лунный" двухтональный звон, что и на странице уведомлений
          osc1.frequency.setValueAtTime(880, now);
          osc2.frequency.setValueAtTime(1320, now + 0.02);

          gain.gain.setValueAtTime(0.0, now);
          gain.gain.linearRampToValueAtTime(0.6, now + 0.03);
          gain.gain.exponentialRampToValueAtTime(0.001, now + 0.9);

          osc1.connect(gain);
          osc2.connect(gain);
          gain.connect(ctx.destination);

          osc1.start(now);
          osc2.start(now + 0.02);
          osc1.stop(now + 0.9);
          osc2.stop(now + 0.9);
        }catch(_){}
      }

      function playNotifSound(){
        if (!notifSoundUnlocked) return;
        playBeep();
      }

      function wire(id){
        var el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('click', function(e){
          e.preventDefault();
          try { window.location.href = notifHref; } catch(_) { window.location.assign(notifHref); }
        });
      }
      wire('notifBtn');
      wire('notifBtnM');

      function setBadge(count, dotEl, tinyEl){
        if(!dotEl || !tinyEl) return;
        if(count > 0){
          dotEl.classList.remove('hidden');
          tinyEl.classList.remove('hidden');
          var n = Math.max(1, parseInt(count, 10) || 0);
          tinyEl.textContent = '+' + (n > 99 ? '99' : String(n));
        }else{
          dotEl.classList.add('hidden');
          tinyEl.classList.add('hidden');
        }
      }

      async function refreshUnread(){
        try{
          const r = await fetch(UNREAD_URL, { credentials: 'same-origin' });
          const j = await r.json();
          const c = (j && j.ok) ? (parseInt(j.unread, 10) || 0) : 0;
          setBadge(c, document.getElementById('notifDot'), document.getElementById('notifTiny'));
          setBadge(c, document.getElementById('notifDotM'), document.getElementById('notifTinyM'));

          if (lastUnread !== null && c > lastUnread) {
            playNotifSound();
          }
          lastUnread = c;
        }catch(_){
          // ignore network errors
        }
      }

      // initial + polling
      document.addEventListener('click', unlockNotifSound, { once: true });
      refreshUnread();
      setInterval(refreshUnread, 30000);
    })();
  </script>

  <script>
    // Dynamic header offset: prevent navbar from overlapping first block on all pages.
    (function () {
      function updateNavOffset() {
        try {
          var h = document.getElementById('site-header');
          if (!h) return;
          var pos = getComputedStyle(h).position;
          var needsOffset = pos === 'fixed';
          var height = h.offsetHeight || 0;
          document.documentElement.style.setProperty('--nav-h', needsOffset ? (height + 'px') : '0px');
        } catch (_) {}
      }
      // Initial and reactive updates
      updateNavOffset();
      window.addEventListener('resize', updateNavOffset, { passive: true });
      window.addEventListener('orientationchange', updateNavOffset);
      // If Tailwind responsive classes switch position on breakpoint changes
      window.matchMedia('(min-width: 1024px)').addEventListener('change', updateNavOffset);
      // Recalculate after fonts/styles load which may affect header height
      window.addEventListener('load', updateNavOffset);
    })();
  </script>

  {% include "includes/video_viewer_modal.html" %}
  {% include "includes/likers_modal.html" %}
  {% block extra_js %}{% endblock %}

  {% block scripts_extra %}{% endblock %}
</body>
</html>
