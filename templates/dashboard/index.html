{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block meta_title %}Кабинет — Pixera{% endblock %}
{% block meta_description %}Личный кабинет: баланс токенов и быстрые ссылки на разделы сервиса.{% endblock %}
{% block canonical %}{{ request.scheme }}://{{ request.get_host }}{% url 'dashboard:index' %}{% endblock %}
{% block robots %}noindex, nofollow{% endblock %}

{% block hero %}
<!-- Hero Section -->
<section class="relative py-8 sm:py-12 lg:py-16 mt-4 sm:mt-8">
  <div class="container">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 sm:gap-4">
      <div class="min-w-0">
        <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold truncate">Добро пожаловать, {{ request.user.first_name|default:request.user.username }}!</h1>
        <p class="text-[var(--muted)] mt-1 sm:mt-2 text-sm sm:text-base">Управляйте своим аккаунтом и создавайте удивительные изображения</p>
      </div>
      <div class="flex items-center gap-2 sm:gap-3 flex-shrink-0">
        <a class="btn btn-primary text-sm sm:text-base whitespace-nowrap" href="{% url 'generate:new' %}">
          <svg class="w-4 h-4 sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          <span class="hidden sm:inline">Создать изображение</span>
          <span class="sm:hidden">Создать</span>
        </a>
        <a class="btn btn-ghost text-sm sm:text-base" href="{% url 'gallery:index' %}">Галерея</a>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block breadcrumbs %}
<!-- Breadcrumbs -->
<nav class="container py-2 sm:py-3 border-b border-[var(--bord)]" aria-label="Хлебные крошки">
  <ol class="flex items-center gap-2 text-xs sm:text-sm">
    <li>
      <a href="{% url 'pages:home' %}" class="text-[var(--muted)] hover:text-[var(--text)] transition">Главная</a>
    </li>
    <li class="text-[var(--muted)]">
      <svg class="w-3 h-3 sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
    </li>
    <li aria-current="page" class="font-medium">Кабинет</li>
  </ol>
</nav>

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"BreadcrumbList",
  "itemListElement":[
    {"@type":"ListItem","position":1,"name":"Главная","item":"{{ request.scheme }}://{{ request.get_host }}{% url 'pages:home' %}"},
    {"@type":"ListItem","position":2,"name":"Кабинет","item":"{{ request.scheme }}://{{ request.get_host }}{% url 'dashboard:index' %}"}
  ]
}
</script>
{% endblock %}

{% block content %}
<div class="container py-4 sm:py-6">
  {% include "includes/messages.html" %}

  <!-- Dashboard Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 sm:gap-6">

    <div class="lg:col-span-8 space-y-4 sm:space-y-6 min-w-0">
      <!-- Followers/Following/Posts counters -->
      <section id="followStats" class="card p-4 sm:p-5 md:p-6 overflow-hidden" aria-label="{% trans 'Статистика профиля' %}">
        <div class="max-w-2xl mx-auto w-full">
          <div class="grid grid-cols-3 gap-3 sm:gap-4 md:gap-5 w-full">
            <!-- Followers -->
            <button id="btnFollowers" type="button"
                    class="group flex flex-col items-center justify-center rounded-xl sm:rounded-2xl border-2 border-[var(--bord)] bg-gradient-to-b from-transparent to-black/[.02] dark:to-white/[.02] hover:border-primary/30 hover:bg-primary/[.03] active:scale-[0.97] transition-all duration-200 p-3 sm:p-4 md:p-5 min-h-[85px] sm:min-h-[95px] md:min-h-[105px] focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60 focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]"
                    aria-label="{% trans 'Подписчики' %}">
              <div class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-extrabold tabular-nums leading-none text-[var(--text)] mb-1.5 sm:mb-2" id="dashFollowers">{{ follow_stats.followers|default:0 }}</div>
              <div class="text-[10px] sm:text-xs md:text-sm text-[var(--muted)] text-center leading-tight font-semibold uppercase tracking-wide">{% trans "Подписчики" %}</div>
            </button>

            <!-- Following -->
            <button id="btnFollowing" type="button"
                    class="group flex flex-col items-center justify-center rounded-xl sm:rounded-2xl border-2 border-[var(--bord)] bg-gradient-to-b from-transparent to-black/[.02] dark:to-white/[.02] hover:border-primary/30 hover:bg-primary/[.03] active:scale-[0.97] transition-all duration-200 p-3 sm:p-4 md:p-5 min-h-[85px] sm:min-h-[95px] md:min-h-[105px] focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60 focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]"
                    aria-label="{% trans 'Подписки' %}">
              <div class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-extrabold tabular-nums leading-none text-[var(--text)] mb-1.5 sm:mb-2" id="dashFollowing">{{ follow_stats.following|default:0 }}</div>
              <div class="text-[10px] sm:text-xs md:text-sm text-[var(--muted)] text-center leading-tight font-semibold uppercase tracking-wide">{% trans "Подписки" %}</div>
            </button>

            <!-- Posts (published only) -->
            <a id="btnPosts" href="{% url 'dashboard:my_jobs' %}?only=published"
               class="group flex flex-col items-center justify-center rounded-xl sm:rounded-2xl border-2 border-[var(--bord)] bg-gradient-to-b from-transparent to-black/[.02] dark:to-white/[.02] hover:border-primary/30 hover:bg-primary/[.03] active:scale-[0.97] transition-all duration-200 p-3 sm:p-4 md:p-5 min-h-[85px] sm:min-h-[95px] md:min-h-[105px] focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/60 focus-visible:ring-offset-2 focus-visible:ring-offset-[var(--bg)]"
               aria-label="{% trans 'Публикации' %}">
              <div class="text-xl sm:text-2xl md:text-3xl lg:text-4xl font-extrabold tabular-nums leading-none text-[var(--text)] mb-1.5 sm:mb-2" id="dashPosts">{{ follow_stats.posts|default:0 }}</div>
              <div class="text-[10px] sm:text-xs md:text-sm text-[var(--muted)] text-center leading-tight font-semibold uppercase tracking-wide">{% trans "Публикации" %}</div>
            </a>
          </div>
        </div>
      </section>

      <!-- Follow Modal -->
      <div id="followModal" class="modal hidden fixed inset-0 z-50 flex items-center justify-center p-3 sm:p-4">
        <div class="modal-backdrop absolute inset-0 bg-black/70 dark:bg-black/80 backdrop-blur-sm" onclick="Modal.close('followModal')"></div>
        <div class="relative w-full max-w-[min(95vw,480px)] rounded-2xl bg-[var(--bg)] border-2 border-[var(--bord)] shadow-2xl overflow-hidden max-h-[min(90vh,680px)] flex flex-col">
          <!-- Header -->
          <div class="flex items-center justify-between p-4 sm:p-5 border-b-2 border-[var(--bord)] flex-shrink-0 bg-gradient-to-b from-black/[.02] dark:from-white/[.02] to-transparent">
            <h3 id="followModalTitle" class="text-base sm:text-lg md:text-xl font-bold text-[var(--text)]"></h3>
            <button type="button" class="btn btn-ghost p-2 hover:bg-black/10 dark:hover:bg-white/10 rounded-xl transition-all flex-shrink-0 active:scale-95" onclick="Modal.close('followModal')" aria-label="Close">
              <svg class="w-5 h-5 text-[var(--muted)] hover:text-[var(--text)] transition" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>

          <!-- Tabs -->
          <nav class="flex justify-center p-3 sm:p-4 border-b border-[var(--bord)] flex-shrink-0">
            <div class="inline-flex rounded-xl bg-black/5 dark:bg-white/5 p-1 gap-1 w-full max-w-sm">
              <button id="fmTabFollowers" type="button" class="flex-1 px-4 py-2 rounded-lg text-sm font-semibold text-[var(--muted)] hover:text-[var(--text)] transition-all">
                Подписчики
              </button>
              <button id="fmTabFollowing" type="button" class="flex-1 px-4 py-2 rounded-lg text-sm font-semibold text-[var(--muted)] hover:text-[var(--text)] transition-all">
                Подписки
              </button>
            </div>
          </nav>

          <!-- Body -->
          <div id="followModalBody" class="overflow-y-auto flex-1 min-h-0" style="max-height: calc(min(90vh,680px) - 150px);">
            <div class="text-[var(--muted)] text-sm py-12 text-center">
              <div class="inline-flex items-center gap-2">
                <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>Загрузка...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script>
      (function(){
        const elFollowers = document.getElementById('btnFollowers');
        const elFollowing = document.getElementById('btnFollowing');
        const modalId = 'followModal';
        const titleEl = document.getElementById('followModalTitle');
        const bodyEl = document.getElementById('followModalBody');
        const urls = {
          followers: "{% url 'dashboard:api:follow_list_followers' %}",
          following: "{% url 'dashboard:api:follow_list_following' %}",
          recs: "{% url 'dashboard:api:follow_recommendations' %}?limit=12"
        };
        const currentUser = "{{ request.user.username }}";

        function renderUsers(users){
          if (!users || !users.length){
            return '<div class="text-sm text-[var(--muted)] py-12 text-center">Список пуст</div>';
          }
          return '<ul class="divide-y divide-[var(--bord)]">' + users.map(u => `
            <li class="py-3 px-4 flex items-center gap-3 hover:bg-black/[.03] dark:hover:bg-white/[.03] transition-colors">
              ${u.avatar_url ?
                `<img src="${u.avatar_url}" alt="" class="w-11 h-11 sm:w-12 sm:h-12 rounded-full object-cover flex-shrink-0 ring-2 ring-[var(--bord)]">` :
                `<div class="w-11 h-11 sm:w-12 sm:h-12 rounded-full bg-gradient-to-br from-primary/20 to-blue-500/20 flex-shrink-0 ring-2 ring-[var(--bord)] flex items-center justify-center">
                  <svg class="w-5 h-5 sm:w-6 sm:h-6 text-primary/40" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                </div>`
              }
              <div class="min-w-0 flex-1">
                <a href="/dashboard/profile/${encodeURIComponent(u.username)}" class="font-semibold text-[var(--text)] truncate hover:underline block text-sm sm:text-base leading-tight">${u.name || u.username}</a>
                <div class="text-xs text-[var(--muted)] truncate mt-0.5">@${u.username}</div>
              </div>
              <button class="btn ${u.is_following ? 'btn-ghost' : 'btn-primary'} text-xs sm:text-sm font-semibold whitespace-nowrap px-4 py-2 flex-shrink-0 min-w-[90px] rounded-lg" data-follow-toggle="1" data-username="${u.username}">
                ${u.is_following ? 'Отписаться' : 'Подписаться'}
              </button>
            </li>`).join('') + '</ul>';
        }

        function renderRecommendations(recs){
          if (!recs || !recs.length) return '';
          return `
            <div class="mt-3 pt-4 border-t-2 border-[var(--bord)] bg-gradient-to-b from-black/[.01] dark:from-white/[.01] to-transparent">
              <div class="flex items-center gap-2 mb-3 px-4">
                <svg class="w-4 h-4 text-primary" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <div class="text-sm font-bold text-[var(--text)]">Рекомендуем подписаться</div>
              </div>
              <ul class="divide-y divide-[var(--bord)]">
                ${recs.map(u => `
                  <li class="py-3 px-4 flex items-center gap-3 hover:bg-black/[.03] dark:hover:bg-white/[.03] transition-colors">
                    ${u.avatar_url ?
                      `<img src="${u.avatar_url}" alt="" class="w-10 h-10 sm:w-11 sm:h-11 rounded-full object-cover flex-shrink-0 ring-2 ring-[var(--bord)]">` :
                      `<div class="w-10 h-10 sm:w-11 sm:h-11 rounded-full bg-gradient-to-br from-primary/20 to-blue-500/20 flex-shrink-0 ring-2 ring-[var(--bord)] flex items-center justify-center">
                        <svg class="w-5 h-5 text-primary/40" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                      </div>`
                    }
                    <div class="min-w-0 flex-1">
                      <a href="/dashboard/profile/${encodeURIComponent(u.username)}" class="font-semibold text-[var(--text)] truncate hover:underline block text-sm leading-tight">${u.name || u.username}</a>
                      <div class="text-xs text-[var(--muted)] truncate mt-0.5">@${u.username}</div>
                    </div>
                    <button class="btn btn-primary text-xs font-semibold whitespace-nowrap px-4 py-2 flex-shrink-0 min-w-[90px] rounded-lg" data-follow-toggle="1" data-username="${u.username}">
                      Подписаться
                    </button>
                  </li>
                `).join('')}
              </ul>
            </div>
          `;
        }

        function setActiveTab(kind){
          const f1 = document.getElementById('fmTabFollowers');
          const f2 = document.getElementById('fmTabFollowing');
          const activeCls = ['bg-black/[.08]','dark:bg-white/10','text-[var(--text)]','shadow-sm'];
          const reset = (el)=>{ if(!el) return; el.classList.remove(...activeCls); };
          const make = (el)=>{ if(!el) return; el.classList.add(...activeCls); };
          reset(f1); reset(f2);
          if (kind === 'followers') make(f1); else make(f2);
        }

        async function loadFollowList(kind){
          titleEl.textContent = kind === 'followers' ? 'Подписчики' : 'Подписки';
          bodyEl.innerHTML = '<div class="py-8 text-center text-sm text-[var(--muted)]">Загрузка...</div>';
          try{
            const res = await fetch(urls[kind], { headers: { 'X-Requested-With': 'fetch' }});
            const data = await res.json();
            if (data && data.ok){
              bodyEl.innerHTML = renderUsers(data.users);
            } else {
              bodyEl.innerHTML = '<div class="py-8 text-center text-sm text-red-500">Ошибка загрузки</div>';
            }
          } catch(e){
            bodyEl.innerHTML = '<div class="py-8 text-center text-sm text-red-500">Ошибка сети</div>';
          }

          // Рекомендации
          try {
            const recRes = await fetch(urls.recs, { headers: { 'X-Requested-With': 'fetch' }});
            const recData = await resRecToJson(recRes);
            if (recData && recData.ok && Array.isArray(recData.users) && recData.users.length) {
              bodyEl.insertAdjacentHTML('beforeend', renderRecommendations(recData.users));
            }
          } catch(e) { /* ignore */ }

          // Делегируем обработчик для кнопок подписки/отписки
          bodyEl.onclick = async function(ev) {
            const btn = ev.target.closest('[data-follow-toggle="1"]');
            if (!btn) return;
            ev.preventDefault();
            ev.stopPropagation();
            const username = btn.getAttribute('data-username');
            if (!username) return;

            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '...';

            try {
              const fd = new FormData();
              fd.append('username', username);
              const csrf = (document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/) || [])[1] || '';
              const res = await fetch('/dashboard/api/follow/toggle/', {
                method: 'POST',
                headers: { 'X-CSRFToken': csrf, 'X-Requested-With': 'fetch' },
                body: fd
              });
              const j = await res.json();
              if (j && j.ok) {
                const nowFollowing = !!j.following;
                btn.textContent = nowFollowing ? 'Отписаться' : 'Подписаться';
                btn.classList.toggle('btn-primary', !nowFollowing);
                btn.classList.toggle('btn-ghost', nowFollowing);

                // Если отписались в разделе "Подписки" - убираем из списка
                if (kind === 'following' && !nowFollowing) {
                  const li = btn.closest('li');
                  if (li) li.remove();
                }

                // Обновляем счётчики
                const cRes = await fetch(`/dashboard/api/follow/${encodeURIComponent(currentUser)}/counters/`, {
                  headers: { 'X-Requested-With': 'fetch' }
                });
                const c = await cRes.json();
                if (c && c.ok) {
                  const dF = document.getElementById('dashFollowers');
                  const dFg = document.getElementById('dashFollowing');
                  const dP = document.getElementById('dashPosts');
                  if (dF) dF.textContent = c.followers;
                  if (dFg) dFg.textContent = c.following;
                  if (dP) dP.textContent = c.posts;
                }
              } else {
                btn.textContent = originalText;
              }
            } catch (e) {
              btn.textContent = originalText;
            } finally {
              btn.disabled = false;
            }
          };
        }

        async function resRecToJson(res){
          try { return await res.json(); } catch(_) { return null; }
        }

        async function openModal(kind){
          setActiveTab(kind);
          await loadFollowList(kind);

          const f1 = document.getElementById('fmTabFollowers');
          const f2 = document.getElementById('fmTabFollowing');
          if (f1) f1.onclick = async () => { setActiveTab('followers'); await loadFollowList('followers'); };
          if (f2) f2.onclick = async () => { setActiveTab('following'); await loadFollowList('following'); };

          if (typeof Modal !== 'undefined') {
            Modal.open(modalId);
          }
        }

        elFollowers?.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openModal('followers'); });
        elFollowing?.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openModal('following'); });
      })();
      </script>

      <!-- Balance Card -->
      <section class="card p-4 sm:p-6 lg:p-8" aria-labelledby="balanceTitle">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4 sm:mb-6">
          <div class="min-w-0">
            <h2 class="text-lg sm:text-xl font-bold mb-1 sm:mb-2 text-[var(--text)]" id="balanceTitle">Ваш баланс</h2>
            <p class="text-[var(--muted)] text-sm sm:text-base">Текущее количество токенов для генерации</p>
          </div>

          <!-- Balance Display -->
          <div class="flex items-center gap-3 sm:gap-4">
            <div class="text-center">
              <div class="flex items-center justify-center gap-2 mb-1">
                <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-xl bg-primary/15 flex items-center justify-center flex-shrink-0">
                  <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-primary" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V19A2 2 0 0 0 5 21H19A2 2 0 0 0 21 19V9M19 9H14V4H15.83L19 7.17V9Z"/>
                  </svg>
                </div>
                <div class="text-xl sm:text-2xl font-bold text-[var(--text)]">{{ wallet.balance|default:0 }}</div>
                <div class="text-xs sm:text-sm text-[var(--muted)]">TOK</div>
              </div>
              <div class="text-[10px] sm:text-xs text-[var(--muted)]">
                ≈ {% widthratio wallet.balance|default:0 10 1 %} обработок
              </div>
            </div>
          </div>
        </div>

        <!-- Balance Actions -->
        <div class="flex flex-wrap gap-2 sm:gap-3">
          <a class="btn btn-primary text-sm sm:text-base" href="{% url 'dashboard:billing' %}">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
            Пополнить баланс
          </a>
          <a class="btn btn-ghost text-sm sm:text-base" href="{% url 'generate:new' %}">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            Начать генерацию
          </a>
        </div>

        <!-- Balance Info -->
        <div class="mt-4 sm:mt-6 p-3 sm:p-4 rounded-xl sm:rounded-2xl bg-black/[.02] dark:bg-white/[.02] border border-[var(--bord)]">
          <div class="flex items-start gap-2 sm:gap-3">
            <svg class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
              <path d="M13 9H11V7H13M13 17H11V15H13M12 2A10 10 0 0 0 2 12A10 10 0 0 0 12 22A10 10 0 0 0 22 12A10 10 0 0 0 12 2Z"/>
            </svg>
            <div class="text-xs sm:text-sm min-w-0">
              <div class="font-medium mb-1 text-[var(--text)]">Как работают токены</div>
              <p class="text-[var(--muted)]">
                1 обработка = {{ TOKENS_PRICE_PER_GEN|default:10 }} TOK.
                Гостевой остаток автоматически переносится в ваш аккаунт при входе.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Recent Activity -->
      <section class="card p-4 sm:p-6" aria-labelledby="activityTitle">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4 sm:mb-6">
          <h2 class="text-lg sm:text-xl font-bold text-[var(--text)]" id="activityTitle">Последняя активность</h2>
          <a class="btn btn-ghost text-xs sm:text-sm w-full sm:w-auto" href="{% url 'dashboard:my_jobs' %}">
            Посмотреть все
            <svg class="w-3 h-3 sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
        </div>

        {% if recent_jobs %}
          <div class="space-y-2 sm:space-y-3">
            {% for j in recent_jobs %}
              <a class="flex items-center gap-3 sm:gap-4 p-3 rounded-xl border border-[var(--bord)] hover:bg-black/[.02] dark:hover:bg-white/[.02] transition" href="{{ j.detail_url }}">
                {% if j.img_url %}
                  <img class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg sm:rounded-xl object-cover flex-shrink-0" src="{{ j.img_url }}" alt="{{ j.title|default:'Обработка' }}">
                {% else %}
                  <div class="w-10 h-10 sm:w-12 sm:h-12 rounded-lg sm:rounded-xl bg-gradient-to-br from-primary to-blue-600 flex-shrink-0"></div>
                {% endif %}
                <div class="flex-1 min-w-0">
                  <div class="font-medium truncate text-sm sm:text-base text-[var(--text)]">{{ j.title|default:"Без названия" }}</div>
                  <div class="text-xs sm:text-sm text-[var(--muted)]">
                    {{ j.created_at|date:'d.m.Y H:i' }} • {{ j.status_label }}
                  </div>
                </div>
                <div class="pill text-[10px] sm:text-xs flex-shrink-0">
                  {% if j.status_kind == 'done' %}Готово{% elif j.status_kind == 'fail' %}Ошибка{% elif j.status_kind == 'run' %}Обработка{% elif j.status_kind == 'queue' %}В очереди{% else %}—{% endif %}
                </div>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-6 sm:py-8">
            <div class="w-12 h-12 sm:w-16 sm:h-16 mx-auto mb-3 sm:mb-4 rounded-xl sm:rounded-2xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
              <svg class="w-6 h-6 sm:w-8 sm:h-8 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
            </div>
            <h3 class="font-semibold mb-2 text-sm sm:text-base text-[var(--text)]">Пока нет обработок</h3>
            <p class="text-[var(--muted)] mb-3 sm:mb-4 text-xs sm:text-sm">Создайте первое изображение, чтобы увидеть историю здесь</p>
            <a class="btn btn-primary text-sm sm:text-base" href="{% url 'generate:new' %}">Создать изображение</a>
          </div>
        {% endif %}
      </section>
    </div>

    <!-- Sidebar -->
    <aside class="lg:col-span-4 space-y-4 sm:space-y-6 min-w-0">

      <!-- Quick Actions -->
      <section class="card p-4 sm:p-6" aria-labelledby="quickTitle">
        <h2 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-[var(--text)]" id="quickTitle">Быстрые действия</h2>
        <nav class="space-y-1.5 sm:space-y-2">
          <a class="flex items-center gap-2 sm:gap-3 p-2.5 sm:p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group" href="{% url 'dashboard:my_jobs' %}">
            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-blue-500/15 flex items-center justify-center group-hover:bg-blue-500/25 transition flex-shrink-0">
              <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
              </svg>
            </div>
            <span class="font-medium text-sm sm:text-base text-[var(--text)]">Мои обработки</span>
          </a>

          <a class="flex items-center gap-2 sm:gap-3 p-2.5 sm:p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group" href="{% url 'gallery:index' %}">
            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-purple-500/15 flex items-center justify-center group-hover:bg-purple-500/25 transition flex-shrink-0">
              <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-purple-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
              </svg>
            </div>
            <span class="font-medium text-sm sm:text-base text-[var(--text)]">Галерея</span>
          </a>

          <a class="flex items-center gap-2 sm:gap-3 p-2.5 sm:p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group" href="{% url 'generate:new' %}">
            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-green-500/15 flex items-center justify-center group-hover:bg-green-500/25 transition flex-shrink-0">
              <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
            </div>
            <span class="font-medium text-sm sm:text-base text-[var(--text)]">Новая генерация</span>
          </a>

          <a class="flex items-center gap-2 sm:gap-3 p-2.5 sm:p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group" href="{% url 'dashboard:tips' %}">
            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-amber-500/15 flex items-center justify-center group-hover:bg-amber-500/25 transition flex-shrink-0">
              <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-amber-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
              </svg>
            </div>
            <span class="font-medium text-sm sm:text-base text-[var(--text)]">Подсказки</span>
          </a>
        </nav>
      </section>

      <!-- Account Settings -->
      <section class="card p-4 sm:p-6" aria-labelledby="settingsTitle">
        <h2 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-[var(--text)]" id="settingsTitle">Настройки аккаунта</h2>
        <nav class="space-y-1.5 sm:space-y-2">
          <a class="flex items-center gap-2 sm:gap-3 p-2.5 sm:p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group" href="{% url 'account_change_password' %}">
            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-orange-500/15 flex items-center justify-center group-hover:bg-orange-500/25 transition flex-shrink-0">
              <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-orange-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
              </svg>
            </div>
            <span class="font-medium text-sm sm:text-base text-[var(--text)]">Сменить пароль</span>
          </a>

          <a class="flex items-center gap-2 sm:gap-3 p-2.5 sm:p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group text-red-600 dark:text-red-400" href="{% url 'account_logout' %}">
            <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-red-500/15 flex items-center justify-center group-hover:bg-red-500/25 transition flex-shrink-0">
              <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
              </svg>
            </div>
            <span class="font-medium text-sm sm:text-base">Выйти из аккаунта</span>
          </a>
        </nav>
      </section>

      <!-- Usage Stats -->
      <section class="card p-4 sm:p-6" aria-labelledby="statsTitle">
        <h2 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-[var(--text)]" id="statsTitle">Статистика</h2>
        <div class="space-y-3 sm:space-y-4">
          <div class="flex items-center justify-between text-sm sm:text-base">
            <span class="text-[var(--muted)]">Всего обработок</span>
            <span class="font-semibold text-[var(--text)]">42</span>
          </div>
          <div class="flex items-center justify-between text-sm sm:text-base">
            <span class="text-[var(--muted)]">Этот месяц</span>
            <span class="font-semibold text-[var(--text)]">8</span>
          </div>
          <div class="flex items-center justify-between text-sm sm:text-base">
            <span class="text-[var(--muted)]">Лайков получено</span>
            <span class="font-semibold text-[var(--text)]">156</span>
          </div>
          <div class="pt-3 border-t border-[var(--bord)]">
            <div class="flex items-center justify-between text-sm sm:text-base">
              <span class="text-[var(--muted)]">Участник с</span>
              <span class="font-semibold text-[var(--text)]">{{ request.user.date_joined|date:"M Y" }}</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Quick Tips -->
      <section class="card p-4 sm:p-6" aria-labelledby="tipsTitle">
        <h2 class="text-base sm:text-lg font-semibold mb-3 sm:mb-4 text-[var(--text)]" id="tipsTitle">Полезные советы</h2>
        <div class="space-y-3">
          <div class="p-3 rounded-xl bg-primary/5 border border-primary/20">
            <div class="text-xs sm:text-sm font-medium text-primary mb-1">💡 Совет дня</div>
            <p class="text-[10px] sm:text-xs text-[var(--muted)]">
              Добавляйте детали освещения в промпт: "soft rim light", "golden hour" для более реалистичных результатов.
            </p>
          </div>

          <div class="text-center">
            <a class="btn btn-ghost text-xs sm:text-sm w-full" href="{% url 'dashboard:tips' %}">
              Больше советов
              <svg class="w-3 h-3 sm:w-4 sm:h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
          </div>
        </div>
      </section>
    </aside>
  </div>
</div>

{% endblock %}
