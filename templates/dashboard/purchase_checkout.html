{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Оплата — {{ plan.title }} — Pixera{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto space-y-8" itemscope itemtype="https://schema.org/BuyAction">
  <meta itemprop="name" content="Оплата тарифа — {{ plan.title|default:'План' }}">

  <!-- Header -->
  <div class="text-center">
    <h1 class="text-3xl font-bold">Завершение заказа</h1>
    <p class="text-[var(--muted)] mt-2">Осталось подтвердить покупку и получить токены</p>
  </div>

  <!-- Current Balance Card -->
  <div class="card p-6">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold mb-2">Текущий баланс</h2>
        {% if wallet %}
          {% widthratio wallet.balance 10 1 as gens_left_auth %}
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-primary/15 flex items-center justify-center">
              <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V19A2 2 0 0 0 5 21H19A2 2 0 0 0 21 19V9M19 9H14V4H15.83L19 7.17V9Z"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold">{{ wallet.balance|default:0 }} <span class="text-lg text-[var(--muted)]">TOK</span></div>
              <div class="text-sm text-[var(--muted)]">≈ {{ gens_left_auth|default:0 }} обработок</div>
            </div>
          </div>
        {% else %}
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-primary/15 flex items-center justify-center">
              <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V19A2 2 0 0 0 5 21H19A2 2 0 0 0 21 19V9M19 9H14V4H15.83L19 7.17V9Z"/>
              </svg>
            </div>
            <div>
              <div class="text-2xl font-bold">Гостевой режим</div>
              <div class="text-sm text-[var(--muted)]">Создайте аккаунт для покупки</div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Messages -->
  {% if messages %}
    <div class="space-y-3" role="status" aria-live="polite">
      {% for m in messages %}
        <div class="card p-4 border-l-4 {% if m.tags == 'error' %}border-red-500 bg-red-50 dark:bg-red-900/20{% elif m.tags == 'success' %}border-green-500 bg-green-50 dark:bg-green-900/20{% else %}border-blue-500 bg-blue-50 dark:bg-blue-900/20{% endif %}">
          <div class="flex items-start gap-3">
            {% if m.tags == 'error' %}
              <svg class="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                <path d="M13 14H11V9H13M13 18H11V16H13M1 21H23L12 2L1 21Z"/>
              </svg>
            {% elif m.tags == 'success' %}
              <svg class="w-5 h-5 text-green-500 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
              </svg>
            {% else %}
              <svg class="w-5 h-5 text-blue-500 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
                <path d="M13 9H11V7H13M13 17H11V15H13M12 2A10 10 0 0 0 2 12A10 10 0 0 0 12 22A10 10 0 0 0 22 12A10 10 0 0 0 12 2Z"/>
              </svg>
            {% endif %}
            <div class="text-sm">{{ m }}</div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Order Summary -->
  <div class="card overflow-hidden" itemscope itemprop="object" itemtype="https://schema.org/Offer">
    <!-- Header -->
    <div class="bg-gradient-to-r from-primary/10 via-blue-500/10 to-purple-500/10 p-6 border-b border-[var(--bord)]">
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 rounded-2xl bg-primary/20 flex items-center justify-center">
          {% if plan.tokens %}
            <svg class="w-8 h-8 text-primary" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V19A2 2 0 0 0 5 21H19A2 2 0 0 0 21 19V9M19 9H14V4H15.83L19 7.17V9Z"/>
            </svg>
          {% else %}
            <svg class="w-8 h-8 text-primary" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2L15.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z"/>
            </svg>
          {% endif %}
        </div>
        <div>
          <h2 class="text-xl font-bold" itemprop="name">{{ plan.title|default:'План' }}</h2>
          <p class="text-[var(--muted)]">Выбранный тариф</p>
        </div>
      </div>
    </div>

    <!-- Price -->
    <div class="p-6 border-b border-[var(--bord)]">
      <div class="flex items-center justify-between">
        <span class="text-lg">Стоимость:</span>
        <div class="flex items-baseline gap-1" itemprop="priceSpecification" itemscope itemtype="https://schema.org/PriceSpecification">
          <span class="text-3xl font-bold" itemprop="price">${{ plan.price_usd|default:"0" }}</span>
          <span class="text-[var(--muted)]" itemprop="priceCurrency">USD</span>
        </div>
      </div>
    </div>

    <!-- What You Get -->
    <div class="p-6">
      <h3 class="font-semibold mb-4">Что вы получите:</h3>
      <div class="space-y-3">
        {% if plan.tokens %}
          {% widthratio plan.tokens 10 1 as gens_for_pack %}
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-green-500/15 flex items-center justify-center">
              <svg class="w-4 h-4 text-green-600" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V19A2 2 0 0 0 5 21H19A2 2 0 0 0 21 19V9M19 9H14V4H15.83L19 7.17V9Z"/>
              </svg>
            </div>
            <div>
              <div class="font-medium">{{ plan.tokens }} токенов</div>
              <div class="text-sm text-[var(--muted)]">Будет зачислено на ваш баланс</div>
            </div>
          </div>
          
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-blue-500/15 flex items-center justify-center">
              <svg class="w-4 h-4 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 9l4-6h10l4 6-9 12L3 9zm4.5-4l-2.5 4h4l2-4h-3.5zm5.5 0l-2 4h4l-2-4zm2 4h4l-2.5-4H15z"/>
              </svg>
            </div>
            <div>
              <div class="font-medium">≈ {{ gens_for_pack }} обработок</div>
              <div class="text-sm text-[var(--muted)]">1 обработка = 10 TOK</div>
            </div>
          </div>
        {% else %}
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-purple-500/15 flex items-center justify-center">
              <svg class="w-4 h-4 text-purple-600" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L15.09 8.26L22 9L17 14L18.18 21L12 17.77L5.82 21L7 14L2 9L8.91 8.26L12 2Z"/>
              </svg>
            </div>
            <div>
              <div class="font-medium">Безлимит генераций</div>
              <div class="text-sm text-[var(--muted)]">На период действия плана</div>
            </div>
          </div>
          
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-amber-500/15 flex items-center justify-center">
              <svg class="w-4 h-4 text-amber-600" viewBox="0 0 24 24" fill="currentColor">
                <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
            </div>
            <div>
              <div class="font-medium">Приоритетная очередь</div>
              <div class="text-sm text-[var(--muted)]">Быстрая обработка запросов</div>
            </div>
          </div>
        {% endif %}
        
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-lg bg-green-500/15 flex items-center justify-center">
            <svg class="w-4 h-4 text-green-600" viewBox="0 0 24 24" fill="currentColor">
              <path d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
          </div>
          <div>
            <div class="font-medium">Мгновенное зачисление</div>
            <div class="text-sm text-[var(--muted)]">Токены поступят сразу после оплаты</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="p-6 bg-black/[.02] dark:bg-white/[.02]">
      <form method="post" action="{% url 'dashboard:purchase_pay' plan_id %}" class="space-y-4">
        {% csrf_token %}
        <button class="btn btn-primary w-full text-lg py-4" type="submit" itemprop="url">
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"/>
          </svg>
          Оплатить ${{ plan.price_usd|default:"0" }} (Demo)
        </button>
        
        <a class="btn btn-ghost w-full" href="{% url 'dashboard:tariffs' %}">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
          </svg>
          Назад к тарифам
        </a>
      </form>
    </div>
  </div>

  <!-- Demo Notice -->
  <div class="card p-6 border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/20">
    <div class="flex items-start gap-3">
      <svg class="w-6 h-6 text-amber-600 dark:text-amber-400 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
        <path d="M13 14H11V9H13M13 18H11V16H13M1 21H23L12 2L1 21Z"/>
      </svg>
      <div>
        <div class="font-medium text-amber-800 dark:text-amber-200 mb-2">Демо-режим</div>
        <p class="text-sm text-amber-700 dark:text-amber-300">
          Реальный платёжный провайдер ещё не подключён. Кнопка «Оплатить» сразу зачислит токены на баланс для демонстрации функциональности системы.
        </p>
      </div>
    </div>
  </div>

  <!-- Security Features -->
  <div class="card p-6">
    <h3 class="font-semibold mb-4">Безопасность платежа</h3>
    <div class="grid sm:grid-cols-3 gap-4 text-center">
      <div>
        <div class="w-12 h-12 rounded-2xl bg-green-500/15 flex items-center justify-center mx-auto mb-3">
          <svg class="w-6 h-6 text-green-600" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1M10 17L6 13L7.41 11.59L10 14.17L16.59 7.58L18 9L10 17Z"/>
          </svg>
        </div>
        <div class="text-sm font-medium">SSL шифрование</div>
        <div class="text-xs text-[var(--muted)]">256-bit защита</div>
      </div>
      
      <div>
        <div class="w-12 h-12 rounded-2xl bg-blue-500/15 flex items-center justify-center mx-auto mb-3">
          <svg class="w-6 h-6 text-blue-600" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 12L11 14L15 10M21 12C21 16.97 16.97 21 12 21C7.03 21 3 16.97 3 12C3 7.03 7.03 3 12 3C16.97 3 21 7.03 21 12Z"/>
          </svg>
        </div>
        <div class="text-sm font-medium">PCI DSS</div>
        <div class="text-xs text-[var(--muted)]">Стандарт безопасности</div>
      </div>
      
      <div>
        <div class="w-12 h-12 rounded-2xl bg-purple-500/15 flex items-center justify-center mx-auto mb-3">
          <svg class="w-6 h-6 text-purple-600" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 17A2 2 0 0 0 14 15C14 13.89 13.1 13 12 13C10.89 13 10 13.89 10 15A2 2 0 0 0 12 17M18 8A2 2 0 0 1 20 10V20A2 2 0 0 1 18 22H6A2 2 0 0 1 4 20V10C4 8.89 4.9 8 6 8H7V6A5 5 0 0 1 12 1A5 5 0 0 1 17 6V8H18M12 3A3 3 0 0 0 9 6V8H15V6A3 3 0 0 0 12 3Z"/>
          </svg>
        </div>
        <div class="text-sm font-medium">Fraud Protection</div>
        <div class="text-xs text-[var(--muted)]">Защита от мошенничества</div>
      </div>
    </div>
  </div>

  <!-- Money Back Guarantee -->
  <div class="text-center">
    <div class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-green-500/10 text-green-600 dark:text-green-400 text-sm">
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
      </svg>
      <span>30-дневная гарантия возврата средств</span>
    </div>
  </div>
</div>

<!-- JSON-LD Schema -->
<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@type":"BuyAction",
  "name":"Оплата тарифа — {{ plan.title|default:'План' }}",
  "price":"{{ plan.price_usd|default:'0' }}",
  "priceCurrency":"USD",
  "object":{
    "@type":"Offer",
    "name":"{{ plan.title|default:'План' }}",
    "price":"{{ plan.price_usd|default:'0' }}",
    "priceCurrency":"USD"
    {% if plan.tokens %},"itemOffered":{"@type":"Service","name":"{{ plan.tokens }} TOK"}{% endif %}
  }
}
</script>

<style>
/* Smooth button interactions */
.btn {
  transition: all 0.2s ease;
}

.btn:hover {
  transform: translateY(-1px);
}

.btn:active {
  transform: translateY(0);
}

/* Gradient border animation */
@keyframes gradient-border {
  0%, 100% { 
    background-position: 0% 50%; 
  }
  50% { 
    background-position: 100% 50%; 
  }
}

.bg-gradient-to-r.from-primary\/10.via-blue-500\/10.to-purple-500\/10 {
  background: linear-gradient(-45deg, 
    rgba(1, 209, 251, 0.1), 
    rgba(59, 130, 246, 0.1), 
    rgba(168, 85, 247, 0.1),
    rgba(1, 209, 251, 0.1));
  background-size: 400% 400%;
  animation: gradient-border 8s ease infinite;
}

/* Card hover effects */
.card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* Form enhancement */
form button[type="submit"] {
  position: relative;
  overflow: hidden;
}

form button[type="submit"]:before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

form button[type="submit"]:hover:before {
  left: 100%;
}

/* Mobile optimizations */
@media (max-width: 640px) {
  .text-3xl {
    font-size: 2rem;
  }
  
  .btn {
    min-height: 48px;
  }
  
  .grid.sm\\:grid-cols-3 {
    grid-template-columns: 1fr;
    gap: 1rem;
  }
}
</style>

{% endblock %}