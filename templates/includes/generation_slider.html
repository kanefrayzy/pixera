{% load static %}

<!-- Generation Slider Component -->
<div class="generation-slider" id="generationSlider">
  <!-- Navigation arrows -->
  <button class="slider-nav slider-nav-prev" id="prevSlide" aria-label="Предыдущий пример">
    <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
    </svg>
  </button>
  <button class="slider-nav slider-nav-next" id="nextSlide" aria-label="Следующий пример">
    <svg class="w-6 h-6 sm:w-7 sm:h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
      <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
    </svg>
  </button>

  <!-- Slides container -->
  <div class="slider-container" id="sliderContainer">
    <!-- Loading state -->
    <div class="slide active flex items-center justify-center aspect-[4/5] bg-gray-100 dark:bg-gray-800 rounded-2xl sm:rounded-3xl">
      <div class="text-center">
        <div class="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-2"></div>
        <p class="text-sm text-[var(--muted)]">Загрузка...</p>
      </div>
    </div>
  </div>

  <!-- Indicators -->
  <div class="slider-indicators" id="sliderIndicators"></div>
</div>

<script>
(function() {
  const DATA_URL = '{% static "data/slider_examples.json" %}';
  const container = document.getElementById('sliderContainer');
  const indicators = document.getElementById('sliderIndicators');
  const LS_KEY = 'image_slider_examples_v2';

  function buildSlides(data){
    if (!container || !indicators) return;
    container.innerHTML = '';
    indicators.innerHTML = '';
    const arr = Array.isArray(data) ? data : [];
    if (!arr.length){
      container.innerHTML = `
        <div class="slide active flex items-center justify-center aspect-[4/5] bg-gray-100 dark:bg-gray-800 rounded-2xl sm:rounded-3xl">
          <div class="text-center">
            <div class="w-8 h-8 mx-auto mb-2 rounded-full bg-gradient-to-r from-primary to-blue-500"></div>
            <p class="text-sm text-[var(--muted)]">Нет примеров</p>
          </div>
        </div>`;
      return;
    }
    arr.forEach((slide, index) => {
      const slideEl = document.createElement('div');
      slideEl.className = `slide ${index === 0 ? 'active' : ''}`;
      slideEl.dataset.slide = index;
      const img = (slide.image || '').replace(/"/g,'"');
      const alt = (slide.alt || slide.title || 'AI Generation').replace(/"/g,'"');
      slideEl.innerHTML = `
        <img class="slide-image w-full rounded-2xl sm:rounded-3xl object-cover aspect-[4/5]"
             src="${img}"
             alt="${alt}"
             loading="${index === 0 ? 'eager' : 'lazy'}"
             onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 500%22><rect width=%22400%22 height=%22500%22 fill=%22%23e5e7eb%22/><text x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%2394a3b8%22 font-family=%22Inter%22 font-size=%2216%22>AI Generation</text></svg>';">
        <div class="slide-info">
          <div class="card p-2 sm:p-3 backdrop-blur-sm bg-white/90 dark:bg-black/90">
            <div class="text-xs sm:text-sm font-medium mb-1">${slide.title || ''}</div>
            <div class="text-xs text-[var(--muted)]">${slide.description || ''}</div>
          </div>
        </div>`;
      container.appendChild(slideEl);

      const indicator = document.createElement('button');
      indicator.className = `indicator ${index === 0 ? 'active' : ''}`;
      indicator.dataset.slide = index;
      indicator.setAttribute('aria-label', `Слайд ${index + 1}`);
      indicators.appendChild(indicator);
    });

    window.sliderExamples = arr;
    document.dispatchEvent(new CustomEvent('sliderDataLoaded', {
      detail: { data: arr, totalSlides: arr.length }
    }));
    if (typeof initSlider === 'function') { initSlider(); }
  }

  // 0) Server-preloaded (fastest)
  try {
    const pre = window.sliderExamplesPreloaded;
    if (Array.isArray(pre) && pre.length) {
      buildSlides(pre);
      try { localStorage.setItem(LS_KEY, JSON.stringify(pre)); } catch(_){}
      return;
    }
  } catch(_){}

  // 1) LocalStorage cache
  try {
    const cached = localStorage.getItem(LS_KEY);
    if (cached) {
      const data = JSON.parse(cached);
      if (Array.isArray(data) && data.length) {
        buildSlides(data);
      }
    }
  } catch(_){}

  // 2) Без сетевого запроса: только админские данные (preloaded) и локальный кэш
  try {
    if (!Array.isArray(window.sliderExamples) || !window.sliderExamples.length) {
      buildSlides([]);
    }
  } catch(_) {
    buildSlides([]);
  }
})();
</script>
