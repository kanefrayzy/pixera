{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Галерея — AI Gallery{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8">


  <!-- My Generations Section -->
  <section class="card p-6" aria-labelledby="mygen-title">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <div>
        <h2 class="text-xl font-bold" id="mygen-title">Мои генерации</h2>
        {% if request.user.is_authenticated %}
          <p class="text-sm text-[var(--muted)]">Ваши последние созданные изображения</p>
        {% else %}
          <p class="text-sm text-[var(--muted)]">Ваши последние генерации в этом браузере</p>
        {% endif %}
      </div>

      {% if request.user.is_authenticated %}
        <a class="btn btn-ghost" href="{% url 'dashboard:my_jobs' %}">
          Посмотреть все
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </a>
      {% else %}
        <div class="text-xs text-[var(--muted)]">
          <a class="link" href="{% url 'account_login' %}">Войдите</a>, чтобы сохранить генерации навсегда
        </div>
      {% endif %}
    </div>

    {% if my_thumbs %}
      <div class="grid grid-cols-3 sm:grid-cols-4 lg:grid-cols-6 gap-3" role="list">
        {% for j in my_thumbs|slice:":6" %}
          {% load generate_extras %}
          {% with s=j.prompt|safe_slugify|default:"image" %}
            <a role="listitem"
               class="group aspect-square rounded-2xl overflow-hidden bg-gray-100 dark:bg-gray-800"
               href="{% url 'generate:job_image' j.pk s %}"
               target="_blank"
               rel="noopener"
               title="Открыть изображение в новой вкладке">
              <img class="w-full h-full object-cover transition duration-300 group-hover:scale-105"
                   loading="lazy"
                   src="{% url 'generate:job_image' j.pk s %}"
                   alt="{{ j.prompt|default:'Моя генерация' }}">
            </a>
          {% endwith %}
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-8">
        <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
          <svg class="w-8 h-8 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        </div>
        <h3 class="font-semibold mb-2">Пока нет генераций</h3>
        <p class="text-[var(--muted)] mb-4">Создайте первое изображение, чтобы увидеть его здесь</p>
        <a class="btn btn-primary" href="{% url 'generate:new' %}">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          Сгенерировать первое фото
        </a>
      </div>
    {% endif %}
  </section>

  <!-- Categories Section -->
  <section class="card p-6" id="cats">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <div>
        <h2 class="text-xl font-bold">Категории</h2>
        <p class="text-sm text-[var(--muted)]">Исследуйте изображения по тематикам</p>
      </div>

      <div class="flex items-center gap-3">
        <a class="btn btn-ghost" href="{% url 'gallery:trending' %}">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
          </svg>
          Тренды
        </a>
      </div>
    </div>

    <!-- Category Pills -->
    <div class="flex flex-wrap gap-2 mb-6" role="tablist" aria-label="Категории">
      <a class="pill {% if not active_category %}bg-primary/15 text-primary border-primary/30{% endif %}"
         href="{% url 'gallery:index' %}"
         role="tab"
         aria-selected="{{ active_category|yesno:'false,true' }}">
        Все
      </a>

      {% for c in categories %}
        <span class="flex items-center gap-1">
          <a class="pill {% if active_category and active_category.slug == c.slug %}bg-primary/15 text-primary border-primary/30{% endif %}"
             href="{% url 'gallery:index' %}?cat={{ c.slug|urlencode }}"
             role="tab"
             aria-selected="{% if active_category and active_category.slug == c.slug %}true{% else %}false{% endif %}">
            {{ c.name }}
          </a>

          {% if request.user.is_staff %}
            <form method="post" action="" class="inline" onsubmit="return confirm('Удалить категорию «{{ c.name }}»?');">
              {% csrf_token %}
              <input type="hidden" name="action" value="del_category">
              <input type="hidden" name="cat_id" value="{{ c.id }}">
              <button type="submit" class="w-6 h-6 rounded-full bg-red-500/10 text-red-600 dark:text-red-400 hover:bg-red-500/20 flex items-center justify-center text-xs transition" title="Удалить категорию" aria-label="Удалить категорию">×</button>
            </form>
          {% endif %}
        </span>
      {% empty %}
        <span class="text-[var(--muted)] text-sm">Категории ещё не созданы.</span>
      {% endfor %}
    </div>

    <!-- Admin Category Management -->
    {% if request.user.is_staff %}
      <div class="p-4 rounded-2xl bg-black/[.02] dark:bg-white/[.02] border border-[var(--bord)]">
        <form method="post" action="" class="flex flex-wrap gap-3" autocomplete="off">
          {% csrf_token %}
          <input type="hidden" name="action" value="add_category">
          <input class="field flex-1 min-w-48" name="cat_name" placeholder="Новая категория" required>
          <input class="field flex-1 min-w-36" name="cat_slug" placeholder="slug (опц.)" pattern="[-a-z0-9_]+" title="только латиница, цифры, - и _">
          <button class="btn btn-primary" type="submit">Добавить</button>
        </form>
      </div>
    {% endif %}
  </section>

  <!-- Gallery Grid -->
  <section class="space-y-6">
    {% if public_photos %}
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for p in public_photos %}
          {% url 'gallery:photo_detail' p.pk as detail_url %}
          {% url 'gallery:photo_edit' p.pk as edit_url %}
          {% url 'gallery:photo_delete' p.pk as delete_url %}

          <article class="group" itemscope itemtype="https://schema.org/ImageObject">
            <div class="card overflow-hidden">
              <!-- Image -->
              <a class="block relative" href="{{ detail_url }}" title="{{ p.title|default:'Фото' }}" itemprop="contentUrl">
                {% if p.image %}
                  <img class="w-full aspect-[4/5] object-cover transition duration-300 group-hover:scale-[1.02]"
                       loading="lazy"
                       src="{{ p.image.url }}"
                       alt="{{ p.title|default:'Фото' }}"
                       itemprop="thumbnailUrl">
                {% else %}
                  <div class="w-full aspect-[4/5] bg-gray-200 dark:bg-gray-700 flex items-center justify-center" aria-hidden="true">
                    <svg class="w-8 h-8 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                  </div>
                {% endif %}

                <!-- View Count Overlay -->
                <div class="absolute top-3 right-3 flex items-center gap-1 px-2 py-1 rounded-full bg-black/50 text-white text-xs">
                  <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 5c-5.5 0-9.5 4.7-10 6 .5 1.3 4.5 6 10 6s9.5-4.7 10-6c-.5-1.3-4.5-6-10-6zm0 10a4 4 0 1 1 .001-8.001A4 4 0 0 1 12 15z"/>
                  </svg>
                  <span>{{ p.view_count|default:0 }}</span>
                </div>

                <!-- Admin Controls -->
                {% if request.user.is_staff %}
                  <div class="absolute top-3 left-3 flex gap-1">
                    <a class="w-8 h-8 rounded-lg bg-black/50 text-white hover:bg-black/70 flex items-center justify-center text-xs transition"
                       href="{{ edit_url }}?next={{ request.get_full_path|urlencode }}"
                       onclick="event.stopPropagation();"
                       title="Редактировать">
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                      </svg>
                    </a>
                    <a class="w-8 h-8 rounded-lg bg-red-500/80 text-white hover:bg-red-600 flex items-center justify-center text-xs transition"
                       href="{{ delete_url }}?next={{ request.get_full_path|urlencode }}"
                       onclick="event.stopPropagation();"
                       title="Удалить"
                       aria-label="Удалить">
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                      </svg>
                    </a>
                  </div>
                {% endif %}
              </a>

              <!-- Card Content -->
              <div class="p-4">
                <h3 class="font-semibold mb-3 line-clamp-1" itemprop="name">
                  {{ p.title|default:"Без названия" }}
                </h3>

                <!-- Actions -->
                <div class="flex items-center justify-between">
                  <button type="button"
                          class="flex items-center gap-2 px-3 py-1.5 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition like-toggle {% if request.user.is_authenticated and p.pk in liked_photo_ids %}text-red-500{% else %}text-[var(--muted)]{% endif %}"
                          data-photo-id="{{ p.pk }}"
                          data-url="{% url 'gallery:photo_like' p.pk %}"
                          data-count-target="like-count-{{ p.pk }}"
                          aria-pressed="{% if request.user.is_authenticated and p.pk in liked_photo_ids %}true{% else %}false{% endif %}"
                          aria-label="Лайк">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="{% if request.user.is_authenticated and p.pk in liked_photo_ids %}currentColor{% else %}none{% endif %}" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                    </svg>
                    <span id="like-count-{{ p.pk }}" class="text-sm font-medium">{{ p.likes_count|default:0 }}</span>
                  </button>

                  <a class="flex items-center gap-2 px-3 py-1.5 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition text-[var(--muted)]"
                     href="{{ detail_url }}#comments"
                     title="Комментарии"
                     aria-label="Комментарии">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <span class="text-sm font-medium">{{ p.comments_count|default:0 }}</span>
                  </a>
                </div>
              </div>
            </div>
          </article>
        {% endfor %}
      </div>
    {% else %}
      <div class="card p-8 text-center">
        <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
          <svg class="w-8 h-8 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        </div>
        <h3 class="text-lg font-semibold mb-2">Пока нет фотографий</h3>
        <p class="text-[var(--muted)] mb-6">Станьте первым, кто поделится своим творением</p>
        <a class="btn btn-primary" href="{% url 'generate:new' %}">
          Создать изображение
        </a>
      </div>
    {% endif %}

    <!-- Pagination -->
    {% if page_obj and page_obj.paginator.num_pages > 1 %}
      <nav class="flex items-center justify-center" aria-label="Пагинация">
        <div class="flex items-center gap-1">
          {% if page_obj.has_previous %}
            <a class="btn btn-ghost px-3 py-2 text-sm" href="?page=1{% if cat_slug %}&cat={{ cat_slug|urlencode }}{% endif %}#cats">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
              </svg>
              Первая
            </a>
            <a class="btn btn-ghost px-3 py-2 text-sm" href="?page={{ page_obj.previous_page_number }}{% if cat_slug %}&cat={{ cat_slug|urlencode }}{% endif %}#cats">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
              Назад
            </a>
          {% endif %}

          {% with total=page_obj.paginator.num_pages current=page_obj.number %}
            {% for i in page_obj.paginator.page_range %}
              {% if i == 1 or i == total or i >= current|add:"-2" and i <= current|add:"2" %}
                {% if i == current %}
                  <span class="btn btn-primary px-3 py-2 text-sm" aria-current="page">{{ i }}</span>
                {% else %}
                  <a class="btn btn-ghost px-3 py-2 text-sm" href="?page={{ i }}{% if cat_slug %}&cat={{ cat_slug|urlencode }}{% endif %}#cats">{{ i }}</a>
                {% endif %}
              {% elif i == 2 and current > 4 %}
                <span class="px-3 py-2 text-sm text-[var(--muted)]" aria-hidden="true">…</span>
              {% elif i == total|add:"-1" and current < total|add:"-3" %}
                <span class="px-3 py-2 text-sm text-[var(--muted)]" aria-hidden="true">…</span>
              {% endif %}
            {% endfor %}
          {% endwith %}

          {% if page_obj.has_next %}
            <a class="btn btn-ghost px-3 py-2 text-sm" href="?page={{ page_obj.next_page_number }}{% if cat_slug %}&cat={{ cat_slug|urlencode }}{% endif %}#cats">
              Вперёд
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
            <a class="btn btn-ghost px-3 py-2 text-sm" href="?page={{ page_obj.paginator.num_pages }}{% if cat_slug %}&cat={{ cat_slug|urlencode }}{% endif %}#cats">
              Последняя
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
              </svg>
            </a>
          {% endif %}
        </div>
      </nav>
    {% endif %}
  </section>

  <!-- Admin Tools -->
  {% if request.user.is_staff %}
    <section class="card p-6 border-amber-200 dark:border-amber-800 bg-amber-50 dark:bg-amber-900/20" aria-labelledby="adminToolsTitle">
      <div class="flex items-start gap-3 mb-6">
        <svg class="w-6 h-6 text-amber-600 dark:text-amber-400 mt-0.5 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 1L9 9L1 9L7 14L5 22L12 18L19 22L17 14L23 9L15 9L12 1Z"/>
        </svg>
        <div>
          <h2 id="adminToolsTitle" class="text-lg font-semibold text-amber-800 dark:text-amber-200">Модерация · только для администратора</h2>
          <p class="text-sm text-amber-700 dark:text-amber-300 mt-1">Инструменты для управления галереей и контентом</p>
        </div>
      </div>

      <div class="flex flex-wrap gap-3 mb-6">
        <a class="btn btn-primary" href="{% url 'gallery:moderation' %}">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Модерация{% if pending_count %} ({{ pending_count }}){% endif %}
        </a>
      </div>

      <!-- Add Photo Form -->
      <div class="space-y-6">
        <div>
          <h3 class="font-semibold mb-4">Добавить фото в галерею</h3>
          <form method="post" action="" enctype="multipart/form-data" class="space-y-4">
            {% csrf_token %}
            <div class="grid sm:grid-cols-2 gap-4">
              <input name="photo_title" class="field" placeholder="Заголовок" required>
              <select name="photo_category" class="field" required>
                <option value="" disabled selected>Выберите категорию…</option>
                {% for c in categories %}
                  <option value="{{ c.id }}">{{ c.name }}</option>
                {% endfor %}
              </select>
            </div>

            <input name="photo_image" type="file" accept="image/*" class="field" required>
            <textarea name="photo_desc" class="field min-h-24 resize-none" placeholder="Короткое описание (опционально)"></textarea>

            <label class="flex items-center gap-2 text-sm">
              <input type="checkbox" name="photo_is_public" value="1" checked class="w-4 h-4 text-primary rounded">
              <span>Опубликовать сразу</span>
            </label>

            <button class="btn btn-primary" type="submit" name="action" value="add_photo">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
              </svg>
              Добавить фото
            </button>
          </form>
        </div>

        <div class="text-xs text-amber-700 dark:text-amber-300 bg-amber-100 dark:bg-amber-800/30 p-3 rounded-xl">
          Блок модерации подготовлен — логику подключения сделаем позже.
        </div>
      </div>
    </section>
  {% endif %}

</div>

<!-- Auto-slug for category creation -->
{% if request.user.is_staff %}
  <script>
  (function(){
    const nameEl = document.querySelector('input[name="cat_name"]');
    const slugEl = document.querySelector('input[name="cat_slug"]');
    if(!nameEl || !slugEl) return;

    const slugify = (s) => (s || "")
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^a-z0-9-_ ]+/g,'')
      .trim().replace(/\s+/g,'-').slice(0,80);

    nameEl.addEventListener('input', ()=>{
      if(slugEl.value.trim() === '' || slugEl.dataset.touched !== '1'){
        slugEl.value = slugify(nameEl.value);
      }
    });

    slugEl.addEventListener('input', ()=>{
      slugEl.dataset.touched = '1';
    });
  })();
  </script>
{% endif %}

<!-- Like functionality -->
<script>
(function(){
  function getCSRFCookie(){
    const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : "";
  }

  // Like toggle functionality
  document.addEventListener('click', async (e)=>{
    const btn = e.target.closest('.like-toggle');
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    if (btn.disabled || btn.dataset.loading === '1') return;
    btn.dataset.loading = '1';
    btn.disabled = true;

    const url = btn.dataset.url;
    const countId = btn.dataset.countTarget;
    const countEl = countId ? document.getElementById(countId) : null;

    try{
      const r = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRFCookie(),
          'X-Requested-With':'XMLHttpRequest'
        },
        credentials: 'same-origin'
      });

      const j = await r.json().catch(()=>null);
      if (!r.ok || !j || j.ok !== true) throw new Error('like failed');

      // Update button state
      const heart = btn.querySelector('svg');
      const isLiked = !!j.liked;

      btn.setAttribute('aria-pressed', isLiked ? 'true' : 'false');

      if (isLiked) {
        btn.classList.add('text-red-500');
        btn.classList.remove('text-[var(--muted)]');
        heart.setAttribute('fill', 'currentColor');
      } else {
        btn.classList.remove('text-red-500');
        btn.classList.add('text-[var(--muted)]');
        heart.setAttribute('fill', 'none');
      }

      if (countEl && typeof j.count === 'number'){
        countEl.textContent = j.count;
      }
    }catch(err){
      console.warn('Like failed:', err);
    }finally{
      delete btn.dataset.loading;
      btn.disabled = false;
    }
  });
})();
</script>

<style>
/* Line clamp utility */
.line-clamp-2 {
  display: -webkit-box;
  line-clamp: 2;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

  .line-clamp-1 {
    display: -webkit-box;
    line-clamp: 1;
    -webkit-line-clamp: 1;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: normal;
  }

/* Smooth transitions for like button */
.like-toggle {
  transition: color 0.2s ease, transform 0.1s ease;
}

.like-toggle:active {
  transform: scale(0.95);
}

/* Gallery grid responsive improvements */
@media (max-width: 640px) {
  .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-3.xl\:grid-cols-4 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1rem;
  }
}

/* Better touch targets on mobile */
@media (max-width: 768px) {
  .btn {
    min-height: 44px;
  }

  .like-toggle,
  .flex.items-center.gap-2.px-3.py-1\.5 {
    padding: 12px;
  }
}
</style>

{% endblock %}
