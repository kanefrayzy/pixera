{% extends "base.html" %}
{% load static %}
{% load i18n %}

{% block title %}Тренды — AI Gallery{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8">

  
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold">Тренды</h1>
      <p class="text-[var(--muted)] mt-2">Самые популярные изображения сообщества</p>
    </div>
    
    <div class="flex items-center gap-3">
      <a class="btn btn-ghost" href="{% url 'gallery:index' %}">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        Галерея
      </a>
      <a class="btn btn-primary" href="{% url 'generate:new' %}">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        Создать
      </a>
    </div>
  </div>

  
  <div class="card p-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h2 class="font-semibold mb-2">Сортировка</h2>
        <p class="text-sm text-[var(--muted)]">Выберите критерий для отображения популярного контента</p>
      </div>
      
      <nav class="flex flex-wrap gap-2" aria-label="Режим сортировки">
        {% with m=active_mode %}
          <a class="flex items-center gap-1 pill {% if m == 'views' %}bg-primary/15 text-primary border-primary/30{% endif %}" 
             href="{% url 'gallery:trending' %}?by=views">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
            </svg>
            По просмотрам
          </a>
          <a class="flex items-center gap-1 pill {% if m == 'likes' %}bg-primary/15 text-primary border-primary/30{% endif %}" 
             href="{% url 'gallery:trending' %}?by=likes">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
            </svg>
            По лайкам
          </a>
          <a class="flex items-center gap-1 pill {% if m == 'new' %}bg-primary/15 text-primary border-primary/30{% endif %}" 
             href="{% url 'gallery:trending' %}?by=new">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Новые (за месяц)
          </a>
        {% endwith %}
      </nav>
    </div>
  </div>

  
  {% if trending_photos %}
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
      {% for p in trending_photos %}
        {% url 'gallery:photo_detail' p.pk as detail_url %}
        {% url 'gallery:photo_edit' p.pk as edit_url %}
        {% url 'gallery:photo_delete' p.pk as delete_url %}

        <article class="group" itemscope itemtype="https://schema.org/ImageObject">
          <div class="card overflow-hidden">
            
            <a class="block relative" href="{{ detail_url }}" title="{{ p.title|default:'Фото' }}" itemprop="contentUrl">
              {% if p.image %}
                <img class="w-full aspect-[4/5] object-cover transition duration-300 group-hover:scale-[1.02]" 
                     loading="lazy" 
                     src="{{ p.image.url }}" 
                     alt="{{ p.title|default:'Фото' }}" 
                     itemprop="thumbnailUrl"
                     sizes="(max-width:480px) 100vw, (max-width:1024px) 50vw, 33vw">
              {% else %}
                <div class="w-full aspect-[4/5] bg-gray-200 dark:bg-gray-700 flex items-center justify-center" aria-hidden="true">
                  <svg class="w-8 h-8 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                  </svg>
                </div>
              {% endif %}

              
              <div class="absolute top-3 right-3 flex items-center gap-1 px-2 py-1 rounded-full bg-black/60 text-white text-xs font-medium">
                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 5c-5.5 0-9.5 4.7-10 6 .5 1.3 4.5 6 10 6s9.5-4.7 10-6c-.5-1.3-4.5-6-10-6zm0 10a4 4 0 1 1 .001-8.001A4 4 0 0 1 12 15z"/>
                </svg>
                <span>{{ p.view_count|default:0 }}</span>
              </div>

              
              {% if active_mode == 'likes' and p.likes_count > 50 %}
                <div class="absolute top-3 left-3">
                  <div class="flex items-center gap-1 px-2 py-1 rounded-full bg-red-500/90 text-white text-xs font-medium">
                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9l-5 4.87L18.18 21 12 17.77 5.82 21 7 13.87 2 9l6.91-.74L12 2z"/>
                    </svg>
                    Топ
                  </div>
                </div>
              {% elif active_mode == 'views' and p.view_count > 1000 %}
                <div class="absolute top-3 left-3">
                  <div class="flex items-center gap-1 px-2 py-1 rounded-full bg-blue-500/90 text-white text-xs font-medium">
                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                    </svg>
                    Хит
                  </div>
                </div>
              {% elif active_mode == 'new' %}
                <div class="absolute top-3 left-3">
                  <div class="flex items-center gap-1 px-2 py-1 rounded-full bg-green-500/90 text-white text-xs font-medium">
                    <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M12 2l3.09 6.26L22 9l-5 4.87L18.18 21 12 17.77 5.82 21 7 13.87 2 9l6.91-.74L12 2z"/>
                    </svg>
                    Новое
                  </div>
                </div>
              {% endif %}

              
              {% if request.user.is_staff %}
                <div class="absolute bottom-3 left-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                  <a class="w-8 h-8 rounded-lg bg-black/60 text-white hover:bg-black/80 flex items-center justify-center text-xs transition" 
                     href="{{ edit_url }}?next={{ request.get_full_path|urlencode }}" 
                     onclick="event.stopPropagation();"
                     title="Редактировать">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                  </a>
                  <a class="w-8 h-8 rounded-lg bg-red-500/80 text-white hover:bg-red-600 flex items-center justify-center text-xs transition" 
                     href="{{ delete_url }}?next={{ request.get_full_path|urlencode }}" 
                     onclick="event.stopPropagation();"
                     title="Удалить"
                     aria-label="Удалить">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                  </a>
                </div>
              {% endif %}
            </a>

            
            <div class="p-4">
              <h3 class="font-semibold mb-3 line-clamp-2" itemprop="name">
                {% with t=p.title|default:"Без названия" %}
                  {{ t|truncatewords:1 }}
                {% endwith %}
              </h3>

              
              <div class="flex items-center justify-between">
                <button type="button"
                        class="flex items-center gap-2 px-3 py-1.5 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition like-toggle {% if request.user.is_authenticated and p.pk in liked_photo_ids %}text-red-500{% else %}text-[var(--muted)]{% endif %}"
                        data-id="{{ p.pk }}"
                        data-url="{% url 'gallery:photo_like' p.pk %}"
                        aria-pressed="{% if request.user.is_authenticated and p.pk in liked_photo_ids %}true{% else %}false{% endif %}"
                        aria-label="Лайк">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="{% if request.user.is_authenticated and p.pk in liked_photo_ids %}currentColor{% else %}none{% endif %}" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
                  </svg>
                  <span id="like-count-{{ p.pk }}" class="text-sm font-medium">{{ p.likes_count|default:0 }}</span>
                </button>

                <a class="flex items-center gap-2 px-3 py-1.5 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition text-[var(--muted)]" 
                   href="{{ detail_url }}" 
                   title="Комментарии">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                  </svg>
                  <span class="text-sm font-medium">{{ p.comments_count|default:0 }}</span>
                </a>
              </div>
            </div>
          </div>
        </article>
      {% endfor %}
    </div>

    
    {% if page_obj and page_obj.paginator.num_pages > 1 %}
      <nav class="flex items-center justify-center" aria-label="Пагинация">
        <div class="flex items-center gap-1">
          {% if page_obj.has_previous %}
            <a class="btn btn-ghost px-3 py-2 text-sm" href="?by={{ active_mode }}&page=1">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/>
              </svg>
              Первая
            </a>
            <a class="btn btn-ghost px-3 py-2 text-sm" href="?by={{ active_mode }}&page={{ page_obj.previous_page_number }}">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
              </svg>
              Назад
            </a>
          {% endif %}

          {% with total=page_obj.paginator.num_pages current=page_obj.number %}
            {% for i in page_obj.paginator.page_range %}
              {% if i == 1 or i == total or i >= current|add:"-2" and i <= current|add:"2" %}
                {% if i == current %}
                  <span class="btn btn-primary px-3 py-2 text-sm" aria-current="page">{{ i }}</span>
                {% else %}
                  <a class="btn btn-ghost px-3 py-2 text-sm" href="?by={{ active_mode }}&page={{ i }}">{{ i }}</a>
                {% endif %}
              {% elif i == 2 and current > 4 %}
                <span class="px-3 py-2 text-sm text-[var(--muted)]" aria-hidden="true">…</span>
              {% elif i == total|add:"-1" and current < total|add:"-3" %}
                <span class="px-3 py-2 text-sm text-[var(--muted)]" aria-hidden="true">…</span>
              {% endif %}
            {% endfor %}
          {% endwith %}

          {% if page_obj.has_next %}
            <a class="btn btn-ghost px-3 py-2 text-sm" href="?by={{ active_mode }}&page={{ page_obj.next_page_number }}">
              Вперёд
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </a>
            <a class="btn btn-ghost px-3 py-2 text-sm" href="?by={{ active_mode }}&page={{ page_obj.paginator.num_pages }}">
              Последняя
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
              </svg>
            </a>
          {% endif %}
        </div>
      </nav>
    {% endif %}

  {% else %}
    
    <div class="card p-12 text-center">
      <div class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
        <svg class="w-10 h-10 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
        </svg>
      </div>
      
      <h2 class="text-xl font-semibold mb-3">Пока нет популярных работ</h2>
      <p class="text-[var(--muted)] mb-8 max-w-md mx-auto">
        Станьте первым, кто создаст трендовое изображение. Поделитесь своим творением и получите признание сообщества.
      </p>
      
      <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
        <a class="btn btn-primary" href="{% url 'generate:new' %}">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
          Создать изображение
        </a>
        <a class="btn btn-ghost" href="{% url 'gallery:index' %}">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
          Смотреть галерею
        </a>
      </div>
    </div>
  {% endif %}
</div>


<script>
(function(){
  function getCSRFCookie(){
    const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : "";
  }

  // Like toggle functionality
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.like-toggle');
    if (!btn) return;

    e.preventDefault();
    e.stopPropagation();

    if (btn.disabled || btn.dataset.loading === '1') return;
    btn.dataset.loading = '1';
    btn.disabled = true;

    const url = btn.dataset.url;
    const countId = 'like-count-' + btn.dataset.id;
    const countEl = document.getElementById(countId);

    try {
      const r = await fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCSRFCookie(),
          'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
      });
      
      const j = await r.json().catch(() => null);
      if (!r.ok || !j || j.ok !== true) throw new Error('like failed');

      // Update button state
      const heart = btn.querySelector('svg');
      const isLiked = !!j.liked;
      
      btn.setAttribute('aria-pressed', isLiked ? 'true' : 'false');
      
      if (isLiked) {
        btn.classList.add('text-red-500');
        btn.classList.remove('text-[var(--muted)]');
        heart.setAttribute('fill', 'currentColor');
      } else {
        btn.classList.remove('text-red-500');
        btn.classList.add('text-[var(--muted)]');
        heart.setAttribute('fill', 'none');
      }

      if (countEl && typeof j.count === 'number') {
        countEl.textContent = j.count;
      }
    } catch (err) {
      console.warn('Like failed:', err);
    } finally {
      delete btn.dataset.loading;
      btn.disabled = false;
    }
  });
})();
</script>

<style>
/* Line clamp utility */
.line-clamp-2 {
  display: -webkit-box;
  line-clamp: 2;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* Smooth transitions for like button */
.like-toggle {
  transition: color 0.2s ease, transform 0.1s ease;
}

.like-toggle:active {
  transform: scale(0.95);
}

/* Gallery grid responsive improvements */
@media (max-width: 640px) {
  .grid.grid-cols-1.sm\:grid-cols-2.lg\:grid-cols-3.xl\:grid-cols-4 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 1rem;
  }
}

/* Better touch targets on mobile */
@media (max-width: 768px) {
  .btn {
    min-height: 44px;
  }
  
  .like-toggle,
  .flex.items-center.gap-2.px-3.py-1\.5 {
    padding: 12px;
  }
  
  .pill {
    padding: 8px 12px;
    font-size: 0.875rem;
  }
}

/* Card hover effects */
.card {
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.group:hover .card {
  transform: translateY(-2px);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
}

[data-theme="dark"] .group:hover .card {
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
}

/* Badge animations */
.absolute.top-3.left-3 > div,
.absolute.top-3.right-3 {
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Improved filter pills */
.pill {
  transition: all 0.2s ease;
}

.pill:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

[data-theme="dark"] .pill:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}
</style>

{% endblock %}