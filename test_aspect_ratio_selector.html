<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–¢–µ—Å—Ç Aspect Ratio Selector</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .field { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 10px; }
        .field-container { margin-bottom: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        .grid { display: grid; gap: 10px; }
        .grid-cols-2 { grid-template-columns: 1fr 1fr; }
        button { padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .log { background: #000; color: #0f0; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>–¢–µ—Å—Ç Aspect Ratio Selector</h1>
    
    <div id="aspect-ratio-field" class="field-container" style="display: none;">
        <label>–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω</label>
        <select id="aspect-ratio-selector" name="aspect_ratio" class="field">
            <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω</option>
        </select>
    </div>

    <div id="custom-dimensions-field" class="field-container" style="display: none;">
        <label>–†–∞–∑–º–µ—Ä—ã (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è)</label>
        <div class="grid grid-cols-2">
            <div>
                <label style="font-weight: normal; font-size: 12px;">–®–∏—Ä–∏–Ω–∞ (px)</label>
                <input type="number" id="width-input" name="width" class="field" readonly>
            </div>
            <div>
                <label style="font-weight: normal; font-size: 12px;">–í—ã—Å–æ—Ç–∞ (px)</label>
                <input type="number" id="height-input" name="height" class="field" readonly>
            </div>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">
            –ò—Ç–æ–≥–æ: <span id="total-pixels">0</span> –ø–∏–∫—Å–µ–ª–µ–π
        </p>
    </div>

    <div id="resolution-field" class="field-container" style="display: none;">
        <label>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ (—Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥)</label>
        <select id="resolution-selector" name="resolution" class="field">
            <option value="1024x1024">1024√ó1024</option>
            <option value="2048x2048">2048√ó2048</option>
        </select>
    </div>

    <div style="margin: 20px 0;">
        <button onclick="testModel1()">–¢–µ—Å—Ç: –ú–æ–¥–µ–ª—å –° aspect ratios</button>
        <button onclick="testModel2()">–¢–µ—Å—Ç: –ú–æ–¥–µ–ª—å –ë–ï–ó aspect ratios</button>
        <button onclick="clearLog()">–û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
    </div>

    <h3>–ö–æ–Ω—Å–æ–ª—å:</h3>
    <div id="log" class="log"></div>

    <script>
        // –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ div
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const logDiv = document.getElementById('log');
            logDiv.innerHTML += args.join(' ') + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
        };

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        // Simplified ImageFieldManager (—Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞)
        class ImageFieldManager {
            constructor() {
                this.currentModel = null;
                this.initializeAspectRatioHandler();
            }

            initializeAspectRatioHandler() {
                const aspectRatioSelect = document.getElementById('aspect-ratio-selector');
                if (aspectRatioSelect) {
                    aspectRatioSelect.addEventListener('change', (e) => {
                        const selectedRatio = e.target.value;
                        if (selectedRatio && this.currentModel) {
                            this.calculateDimensions(selectedRatio);
                        }
                    });
                }
            }

            calculateDimensions(aspectRatioStr) {
                const parts = aspectRatioStr.replace('_', ':').split(':').map(p => parseFloat(p));
                if (parts.length !== 2 || parts[0] <= 0 || parts[1] <= 0) {
                    console.log('‚ùå Invalid aspect ratio:', aspectRatioStr);
                    return;
                }

                const [ratioW, ratioH] = parts;
                const ratio = ratioW / ratioH;
                const constraints = this.getModelConstraints();

                let width, height;
                
                if (ratio >= 1) {
                    width = constraints.maxWidth;
                    height = Math.round(width / ratio);
                    if (height > constraints.maxHeight) {
                        height = constraints.maxHeight;
                        width = Math.round(height * ratio);
                    }
                } else {
                    height = constraints.maxHeight;
                    width = Math.round(height * ratio);
                    if (width > constraints.maxWidth) {
                        width = constraints.maxWidth;
                        height = Math.round(width / ratio);
                    }
                }
                
                width = Math.max(constraints.minWidth, Math.min(constraints.maxWidth, width));
                height = Math.max(constraints.minHeight, Math.min(constraints.maxHeight, height));

                this.updateDimensionsUI(width, height);
                console.log(`üìê ${aspectRatioStr} ‚Üí ${width}√ó${height} (${width * height} pixels)`);
            }

            getModelConstraints() {
                if (!this.currentModel) {
                    return { minWidth: 512, maxWidth: 4096, minHeight: 512, maxHeight: 4096 };
                }
                return {
                    minWidth: this.currentModel.min_width || 512,
                    maxWidth: this.currentModel.max_width || 4096,
                    minHeight: this.currentModel.min_height || 512,
                    maxHeight: this.currentModel.max_height || 4096
                };
            }

            updateDimensionsUI(width, height) {
                const widthInput = document.getElementById('width-input');
                const heightInput = document.getElementById('height-input');
                const totalPixelsSpan = document.getElementById('total-pixels');

                if (widthInput) widthInput.value = width;
                if (heightInput) heightInput.value = height;
                if (totalPixelsSpan) {
                    const total = width * height;
                    totalPixelsSpan.textContent = total.toLocaleString('ru-RU');
                }
            }

            updateFieldsForModel(model) {
                this.currentModel = model;
                console.log('üé® –ú–æ–¥–µ–ª—å:', model.name);
                this.updateModelParameters(model);
            }

            updateModelParameters(model) {
                if (model.available_aspect_ratios && model.available_aspect_ratios.length > 0) {
                    console.log('‚úÖ –ú–æ–¥–µ–ª—å –∏–º–µ–µ—Ç aspect ratios, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä');
                    this.updateAspectRatioOptions(model.available_aspect_ratios);
                    
                    const resField = document.getElementById('resolution-field');
                    const aspectField = document.getElementById('aspect-ratio-field');
                    const customDimField = document.getElementById('custom-dimensions-field');
                    
                    if (resField) {
                        resField.style.display = 'none';
                        console.log('   ‚Ä¢ –°–∫—Ä—ã–ª–∏ resolution-field');
                    }
                    if (aspectField) {
                        aspectField.style.display = '';
                        console.log('   ‚Ä¢ –ü–æ–∫–∞–∑–∞–ª–∏ aspect-ratio-field');
                    }
                    if (customDimField) {
                        customDimField.style.display = '';
                        console.log('   ‚Ä¢ –ü–æ–∫–∞–∑–∞–ª–∏ custom-dimensions-field');
                    }
                } else {
                    console.log('‚ùå –ú–æ–¥–µ–ª—å –ù–ï –∏–º–µ–µ—Ç aspect ratios, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ä—ã–π —Å–µ–ª–µ–∫—Ç–æ—Ä');
                    
                    const resField = document.getElementById('resolution-field');
                    const aspectField = document.getElementById('aspect-ratio-field');
                    const customDimField = document.getElementById('custom-dimensions-field');
                    
                    if (resField) {
                        resField.style.display = '';
                        console.log('   ‚Ä¢ –ü–æ–∫–∞–∑–∞–ª–∏ resolution-field');
                    }
                    if (aspectField) {
                        aspectField.style.display = 'none';
                        console.log('   ‚Ä¢ –°–∫—Ä—ã–ª–∏ aspect-ratio-field');
                    }
                    if (customDimField) {
                        customDimField.style.display = 'none';
                        console.log('   ‚Ä¢ –°–∫—Ä—ã–ª–∏ custom-dimensions-field');
                    }
                }
            }

            updateAspectRatioOptions(aspectRatios) {
                const aspectRatioSelect = document.getElementById('aspect-ratio-selector');
                if (!aspectRatioSelect) return;

                aspectRatioSelect.innerHTML = '<option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω</option>';

                const groups = {
                    square: '–ö–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ',
                    classic: '–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ',
                    modern: '–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ',
                    cinema: '–ö–∏–Ω–æ—Ñ–æ—Ä–º–∞—Ç—ã',
                    ultrawide: '–£–ª—å—Ç—Ä–∞—à–∏—Ä–æ–∫–∏–µ',
                    vertical: '–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ',
                    photo: '–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ'
                };

                const categorized = {
                    square: ['1:1'],
                    classic: ['4:3', '3:2', '5:4'],
                    modern: ['16:9', '16:10'],
                    vertical: ['9:16', '2:3', '3:4']
                };

                const addedRatios = new Set();
                Object.entries(categorized).forEach(([groupKey, ratios]) => {
                    const matchingRatios = aspectRatios.filter(r => {
                        const normalized = r.replace('_', ':');
                        return ratios.includes(normalized) && !addedRatios.has(r);
                    });

                    if (matchingRatios.length > 0) {
                        const optgroup = document.createElement('optgroup');
                        optgroup.label = groups[groupKey];
                        matchingRatios.forEach(ratio => {
                            const option = document.createElement('option');
                            option.value = ratio;
                            option.textContent = ratio.replace('_', ':');
                            optgroup.appendChild(option);
                            addedRatios.add(ratio);
                        });
                        aspectRatioSelect.appendChild(optgroup);
                    }
                });

                console.log(`üìã –î–æ–±–∞–≤–ª–µ–Ω–æ ${addedRatios.size} aspect ratios`);
                
                if (aspectRatios.length > 0) {
                    aspectRatioSelect.value = aspectRatios[0];
                    this.calculateDimensions(aspectRatios[0]);
                }
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        const manager = new ImageFieldManager();

        // –¢–µ—Å—Ç–æ–≤—ã–µ –º–æ–¥–µ–ª–∏
        function testModel1() {
            console.log('\n' + '='.repeat(60));
            console.log('–¢–ï–°–¢ 1: –ú–æ–¥–µ–ª—å –° aspect ratios');
            console.log('='.repeat(60));
            
            const model = {
                name: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è (runware:101@1)',
                available_aspect_ratios: ['1:1', '16:9', '9:16'],
                min_width: 512,
                max_width: 2048,
                min_height: 512,
                max_height: 2048
            };
            manager.updateFieldsForModel(model);
        }

        function testModel2() {
            console.log('\n' + '='.repeat(60));
            console.log('–¢–ï–°–¢ 2: –ú–æ–¥–µ–ª—å –ë–ï–ó aspect ratios');
            console.log('='.repeat(60));
            
            const model = {
                name: '–°—Ç–∞—Ä–∞—è –º–æ–¥–µ–ª—å (–±–µ–∑ aspect ratios)',
                available_aspect_ratios: [],
                available_resolutions: ['1024x1024', '2048x2048'],
                min_width: 512,
                max_width: 2048,
                min_height: 512,
                max_height: 2048
            };
            manager.updateFieldsForModel(model);
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –≥–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é');
            console.log('üìå –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ –≤—ã—à–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
        };
    </script>
</body>
</html>
