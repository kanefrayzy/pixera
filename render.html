

<!doctype html>

<html lang="en" class="scroll-smooth" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="format-detection" content="telephone=no,email=no,address=no">
  <meta name="color-scheme" content="dark light">

  <title>Генерация изображений — Pixera</title>
  <meta name="description" content="Pixera — современная галерея и генерация изображений ИИ. Тёмная/светлая тема, быстрый поиск, теги и тренды.">
  <link rel="canonical" href="https://pixera.net/en/generate/video">

  <!-- БЛОКИРОВКА ИНДЕКСАЦИИ -->
  <meta name="robots" content="noindex, nofollow, noarchive, nosnippet">
  <meta name="googlebot" content="noindex, nofollow">
  <meta name="bingbot" content="noindex, nofollow">
  <meta name="yandex" content="noindex, nofollow">

  <meta id="themeColor" name="theme-color" content="#0B0E14">
  <meta name="referrer" content="strict-origin-when-cross-origin">


  <meta property="og:type" content="website">
  <meta property="og:site_name" content="Pixera">
  <meta property="og:title" content="Pixera — генерация и галерея">
  <meta property="og:description" content="Minimal UI, smooth gradients and high-quality AI image generation.">
  <meta property="og:url" content="https://pixera.net/en/generate/video">
  <meta property="og:image" content="https://pixera.net/static/img/og-default.2b58fbbc3620.jpg">
  <meta name="twitter:card" content="summary_large_image">


  <link rel="icon" href="/static/img/favicon/favicon.906ebb9722ee.svg" type="image/svg+xml">
  <link rel="icon" href="/static/img/favicon/favicon.23fc851abdfd.ico" sizes="any">
  <link rel="apple-touch-icon" href="/static/img/favicon/apple-touch-icon.50b35b336439.png">
  <link rel="manifest" href="/static/img/favicon/site.4a2b4324a2d2.webmanifest">


  <link rel="dns-prefetch" href="//api.runware.ai">
  <link rel="preconnect" href="https://api.runware.ai" crossorigin>


  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">


  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="/static/css/tailwind.min.1b8cedfe413a.css">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="/static/css/main.7cc1f78dea6a.css">
  <link rel="stylesheet" href="/static/css/components.785ffb373eb6.css">
  <link rel="stylesheet" href="/static/css/gallery.e5a18f31401c.css">
  <link rel="stylesheet" href="/static/css/checkbox-fix.90edf26a7ae8.css">
  <link rel="stylesheet" href="/static/css/admin-forms-dark.281e4e0ea972.css">


<link rel="stylesheet" href="/static/css/generate.487d20644008.css">
<link rel="stylesheet" href="/static/css/showcase.9cc3e57b9f7e.css">
    <link rel="stylesheet" href="/static/css/moon-slider.cb19b5090603.css?v=">
<link rel="stylesheet" href="/static/css/video-generation-fix.553aeeaa5d1c.css?v=">
<link rel="preconnect" href="https://images.unsplash.com" crossorigin>
<link rel="dns-prefetch" href="//images.unsplash.com">
<link rel="preload" as="script" href="/static/js/generate-optimized.9b7dce9d5e20.js?v=">
<link rel="preload" as="script" href="/static/js/generate.7d1cd71a1170.js?v=">
<link rel="preload" as="script" href="/static/js/image-generation.b576fa884d2b.js?v=">
<link rel="preload" as="script" href="/static/js/image-models.e19718a652b6.js?v=">



<style>
/* Критические стили инлайн для мгновенного рендеринга */
.card{background:var(--bg-card);border-radius:1rem;border:1px solid var(--bord);padding:1.5rem}
.field{width:100%;padding:.625rem;border:1px solid var(--bord);border-radius:.5rem;background:var(--bg-card)}
/* removed global .hidden override to preserve Tailwind responsive display utilities on header */
/* .hidden{display:none!important} */
#showcaseGrid,#videoShowcaseGrid{content-visibility:visible}
/* Мгновенная загрузка изображений - убираем все задержки */
img{image-rendering:crisp-edges;image-rendering:-webkit-optimize-contrast}
.category-image-compact,.image-model-card img,.showcase-item img{will-change:transform;transform:translateZ(0);backface-visibility:hidden}
/* Предзагрузка фонов для категорий */
.category-image-wrapper-compact{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);will-change:contents}
.card-hero{background:linear-gradient(135deg,#1f2937 0%,#111827 100%);will-change:contents}
/* GPU ускорение для анимаций */
.category-card-compact,.image-model-card,.prompt-item-modal{transform:translateZ(0);will-change:transform}
/* Оптимизация скролла */
*{scroll-behavior:auto!important}
body{-webkit-overflow-scrolling:touch}
/* Отключаем transitions при первой загрузке для мгновенного рендеринга */
.preload-transitions *{transition:none!important;animation:none!important}
</style>
<script>
// Убираем класс после загрузки для включения анимаций
document.documentElement.classList.add('preload-transitions');
window.addEventListener('load',()=>{
requestAnimationFrame(()=>document.documentElement.classList.remove('preload-transitions'));
},{once:true,passive:true});
</script>




  <style>
    #site-header {
      background-color: transparent !important; /* прозрачный фон самого header */
      -webkit-backdrop-filter: none !important; /* без blur, чтобы оттенок не зависел от контента */
      backdrop-filter: none !important;
      will-change: auto;
    }
    /* Псевдо-фон: повторяет фон сайта (noise + радиальные градиенты + базовый цвет),
       но закреплён за самим header и не зависит от контента под ним */
    #site-header::before {
      content: "";
      position: absolute;
      inset: 0;
      z-index: -1;
      pointer-events: none;
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.035'/%3E%3C/svg%3E") repeat,
        radial-gradient(ellipse at top, rgba(1,209,251,.25), transparent 60%),
        radial-gradient(ellipse at bottom, rgba(236,72,153,.16), transparent 65%),
        var(--bg);
      background-blend-mode: normal;
    }

    /* Dark theme: replace red tint with brand blue in navbar */
    html[data-theme="dark"] #site-header::before {
      background:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='2' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='.035'/%3E%3C/svg%3E") repeat,
        radial-gradient(ellipse at top, rgba(1,209,251,.25), transparent 60%),
        radial-gradient(ellipse at bottom, rgba(1,209,251,.16), transparent 65%),
        var(--bg);
      background-blend-mode: normal;
    }

    /* Header divider refinement for dark theme:
       - remove bright white bottom border
       - keep a very subtle separation via inset shadow
       Light theme keeps a soft dark divider. */
    html[data-theme="dark"] #site-header {
      border-bottom-color: transparent !important;
      box-shadow: inset 0 -1px 0 0 rgba(255, 255, 255, 0.04);
    }
    html[data-theme="light"] #site-header {
      border-bottom-color: rgba(0, 0, 0, 0.06);
    }
    @media (min-width: 1024px) {
      html[data-theme="dark"] #site-header {
        box-shadow: inset 0 -1px 0 0 rgba(255, 255, 255, 0.035);
      }
    }
  </style>

  <!-- Mobile fallback to prevent first-paint overlap when header is fixed.
       Ensures all pages start below the navbar even before JS sets --nav-h. -->
  <style>
    @media (max-width: 1023.98px) {
      body {
        padding-top: calc(var(--nav-h, 64px) + env(safe-area-inset-top, 0px));
      }
    }
  </style>

  <script>
    (function () {
      try {
        const saved = localStorage.getItem('theme');
        const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || "dark" || (prefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
        const meta = document.getElementById('themeColor');
        if (meta) meta.setAttribute('content', theme === 'dark' ? '#0B0E14' : '#F7F8FA');
      } catch(e) {}
    })();
  </script>


  <script>
  (function () {
    const FP_COOKIE = "aid_fp";
    const FP_HEADER = "X-Device-Fingerprint";
    const FP_PARAM  = "fp";
    const GID_COOKIE = "gid";
    const FIVE_YEARS = 60*60*24*365*5;

    function getCookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.$?*|{}()[\]\\/+^])/g,'\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }
    function setCookie(name, val, maxAgeSec){
      try{
        const secure = location.protocol === 'https:' ? '; Secure' : '';
        document.cookie = name + '=' + encodeURIComponent(val)
          + '; Path=/; SameSite=Lax; Max-Age=' + (maxAgeSec||FIVE_YEARS) + secure;
      }catch(e){}
    }
    function randId(){
      try{
        const a = new Uint8Array(16); crypto.getRandomValues(a);
        return Array.from(a).map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch(_){
        return (Date.now().toString(16) + Math.random().toString(16).slice(2)).slice(0,32);
      }
    }
    async function sha256(s){
      try{
        const buf = new TextEncoder().encode(s);
        const h = await crypto.subtle.digest('SHA-256', buf);
        return Array.from(new Uint8Array(h)).map(b=>b.toString(16).padStart(2,'0')).join('');
      }catch(_){
        let h=5381; for(let i=0;i<s.length;i++){ h=((h<<5)+h) ^ s.charCodeAt(i); }
        return ('00000000'+(h>>>0).toString(16)).slice(-8);
      }
    }
    function canvasFp(){
      try{
        const c=document.createElement('canvas'); c.width=240; c.height=80;
        const x=c.getContext('2d'); x.textBaseline='top'; x.font='16px Arial';
        x.fillStyle='#f60'; x.fillText(navigator.userAgent, 4, 4);
        x.strokeStyle='#09f'; x.strokeRect(10, 10, 180, 30);
        x.fillStyle='#222'; x.globalAlpha=0.7; x.fillRect(20,20,110,20);
        return c.toDataURL();
      }catch(e){ return 'nocanvas'; }
    }
    function webglInfo(){
      try{
        const c=document.createElement('canvas');
        const gl=c.getContext('webgl')||c.getContext('experimental-webgl');
        if(!gl) return 'nowebgl';
        const dbg=gl.getExtension('WEBGL_debug_renderer_info');
        const ven=dbg?gl.getParameter(dbg.UNMASKED_VENDOR_WEBGL):'';
        const ren=dbg?gl.getParameter(dbg.UNMASKED_RENDERER_WEBGL):'';
        return ven+'|'+ren;
      }catch(e){ return 'wgerr'; }
    }
    async function computeFP(){
      const data = [
        navigator.userAgent||'',
        navigator.platform||'',
        (navigator.languages||[]).join(','),
        Intl.DateTimeFormat().resolvedOptions().timeZone||'',
        screen && (screen.width+'x'+screen.height+'x'+screen.colorDepth),
        screen && (screen.availWidth+'x'+screen.availHeight),
        String(navigator.hardwareConcurrency||''),
        String(navigator.deviceMemory||''),
        'touch:' + ('ontouchstart' in window),
        'ls:' + ('localStorage' in window),
        'ss:' + ('sessionStorage' in window),
        (performance && performance.memory && performance.memory.jsHeapSizeLimit) || '',
        (navigator.plugins && Array.from(navigator.plugins).map(p=>p.name).join(',')) || '',
        canvasFp(),
        webglInfo()
      ].join('||');
      return await sha256(data);
    }

    (async function boot(){
      try{
        let gid = getCookie(GID_COOKIE);
        if(!gid){ gid = randId(); setCookie(GID_COOKIE, gid, FIVE_YEARS); }

        let fp = getCookie(FP_COOKIE) || (function(){ try{return localStorage.getItem(FP_COOKIE)||'';}catch(_){return '';} })();
        if(!fp){
          fp = await computeFP();
          setCookie(FP_COOKIE, fp, FIVE_YEARS);
          try{ localStorage.setItem(FP_COOKIE, fp); }catch(_){}
          try{ sessionStorage.setItem(FP_COOKIE, fp); }catch(_){}
        }

        window.__AIGID = gid; window.__AIFP = fp;
        const origFetch = window.fetch;
        if (origFetch) {
          window.fetch = function(input, init){
            init = init || {};
            let headers = init.headers || {};
            try{
              if (headers instanceof Headers) {
                headers.set(FP_HEADER, fp);
              } else if (Array.isArray(headers)) {
                headers.push([FP_HEADER, fp]);
              } else {
                headers[FP_HEADER] = fp;
              }
            }catch(_){}
            init.headers = headers;
            return origFetch.call(this, input, init);
          };
        }
        if (window.XMLHttpRequest) {
          const open = XMLHttpRequest.prototype.open;
          const send = XMLHttpRequest.prototype.send;
          XMLHttpRequest.prototype.open = function(){ this.___fp_ready = true; return open.apply(this, arguments); };
          XMLHttpRequest.prototype.send = function(){
            try{ this.setRequestHeader(FP_HEADER, fp); }catch(_){}
            return send.apply(this, arguments);
          };
        }

        document.addEventListener('submit', function(e){
          const form = e.target && e.target.closest && e.target.closest('form');
          if(!form) return;
          if((form.getAttribute('method')||'GET').toUpperCase()!=='POST') return;
          if(form.querySelector('input[name="'+FP_PARAM+'"]')) return;
          try{
            const inp=document.createElement('input');
            inp.type='hidden'; inp.name=FP_PARAM; inp.value=fp;
            form.appendChild(inp);
          }catch(_){}
        });
      }catch(e) {}
    })();
  })();
  </script>

  <link rel="preload" as="image" href="/static/img/bg.e4821e66eee4.webp" type="image/webp" />
  <link rel="preload" as="image" href="/static/img/bg.63a0769c50f7.png" />

</head>
<body>

  <a class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 z-50 btn btn-primary" href="#main">Перейти к содержанию</a>


  <div aria-hidden="true" class="pointer-events-none fixed inset-0 -z-10">
    <div class="absolute inset-0 bg-noise"></div>
    <div class="absolute -inset-x-32 -top-24 h-[28rem] bg-[radial-gradient(ellipse_at_top,_rgba(1,209,251,.25),_transparent_60%)]"></div>
    <div class="absolute -inset-x-40 top-[28rem] h-[26rem] bg-[radial-gradient(ellipse_at_bottom,_rgba(236,72,153,.16),_transparent_65%)]"></div>
  </div>










  <header id="site-header" class="fixed lg:sticky top-0 left-0 right-0 z-50 border-b border-[var(--bord)]/20" role="banner">
    <div class="container flex h-16 items-center justify-between px-3 lg:px-4">

      <a href="/en/"
         rel="home" class="flex items-center gap-2.5 group" aria-label="Go to home">
        <img src="/static/img/logo.e58a21386e1e.png" alt="Pixera" class="h-9 w-auto transition-transform group-hover:scale-105" loading="eager">
        <span class="logo-text text-2xl text-[var(--text)]">pixera</span>
      </a>


      <nav class="hidden lg:flex items-center gap-6 xl:gap-7" role="navigation" aria-label="Main menu">

        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="/en/profile-admin">Мой профиль</a>

        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="/en/gallery/">Gallery</a>

        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="/en/generate/photo">Generate</a>
        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="/en/blog/">Блог</a>

        <a class="nav-link px-3 py-2 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" href="/en/dashboard/slider-examples/">Примеры слайдера</a>

      </nav>


      <div class="hidden lg:flex items-center gap-2">




          <a class="btn btn-ghost p-2.5 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0 group"
             href="/en/gallery/trending" aria-label="Поиск и тренды">
            <svg class="w-5 h-5 text-[var(--text)] group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
              <path d="M8 11h6"></path>
            </svg>
          </a>

          <button class="btn btn-ghost p-2.5 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0 relative group"
                  type="button" aria-label="Уведомления" id="notifBtn" aria-haspopup="true" aria-expanded="false">
            <svg class="w-5 h-5 text-[var(--text)] group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
              <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
            </svg>
            <span id="notifDot" class="absolute top-1.5 right-1.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-[var(--bg)] hidden"></span>
            <span id="notifTiny" class="absolute -top-1 -right-1 rounded-full bg-red-500 text-[10px] leading-none text-white px-1.5 py-0.5 font-bold shadow-sm hidden"></span>
          </button>

          <a href="/en/dashboard/" class="btn btn-ghost p-1.5 rounded-xl hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0 group" id="cabinetBtn">
            <span class="flex items-center gap-2">
              <span class="w-8 h-8 rounded-full overflow-hidden ring-2 ring-transparent group-hover:ring-primary/30 transition-all">

                  <span class="js-avatar-fallback w-full h-full rounded-full bg-gradient-to-br from-primary to-blue-600 grid place-items-center text-white font-bold text-sm">
                    A
                  </span>

              </span>
              <span class="text-sm font-medium text-[var(--text)] group-hover:text-primary transition-colors max-w-[80px] truncate">admin</span>
            </span>
          </a>



      </div>

  <div class="lg:hidden flex items-center gap-0.5 ml-auto">

      <a class="btn btn-ghost p-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0"
         href="/en/generate/photo" aria-label="Generate">
        <svg class="w-[18px] h-[18px] text-[var(--text)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
        </svg>
      </a>

      <a class="btn btn-ghost p-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0"
         href="/en/gallery/trending" aria-label="Поиск и тренды">
        <svg class="w-[18px] h-[18px] text-[var(--text)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
          <path d="M8 11h6"></path>
        </svg>
      </a>

      <button class="btn btn-ghost p-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200 border-0 relative"
              type="button" aria-label="Уведомления" id="notifBtnM">
        <svg class="w-[18px] h-[18px] text-[var(--text)]" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"></path>
          <path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"></path>
        </svg>
        <span id="notifDotM" class="absolute top-0.5 right-0.5 h-2 w-2 rounded-full bg-red-500 ring-2 ring-[var(--bg)] hidden"></span>
        <span id="notifTinyM" class="absolute -top-1 -right-1 rounded-full bg-red-500 text-[10px] leading-none text-white px-1.5 py-0.5 font-bold shadow-sm hidden"></span>
      </button>

      <button class="btn btn-ghost border-0 p-1 rounded-lg hover:bg-black/5 dark:hover:bg-white/5 transition-all duration-200" type="button" data-open-dashboard="1" aria-label="Open menu">
        <span class="w-7 h-7 rounded-full overflow-hidden ring-2 ring-transparent hover:ring-primary/30 transition-all">

            <span class="js-avatar-fallback w-full h-full rounded-full bg-gradient-to-br from-primary to-blue-600 grid place-items-center text-white font-bold text-xs">
              A
            </span>

        </span>
      </button>

  </div>
    </div>




  </header>



<div class="fixed inset-0 bg-black/50 dark:bg-black/60 backdrop-blur-sm z-40 opacity-0 pointer-events-none transition-opacity duration-300" id="dbBackdrop" hidden></div>

<aside
  id="dashboardDrawer"
  class="fixed top-0 right-0 h-full w-80 max-w-[85vw] z-50 transform translate-x-full transition-transform duration-300 ease-in-out"
  hidden
  role="dialog"
  aria-modal="true"
  aria-labelledby="dbDrawerTitle"
  tabindex="-1"
>
  <div class="h-full bg-[var(--bg)] border-l border-[var(--bord)] shadow-2xl overflow-y-auto overscroll-contain [-webkit-overflow-scrolling:touch]">

    <!-- Header for authenticated users -->

    <div class="relative p-4 border-b border-[var(--bord)]">
      <div id="dbDrawerTitle" class="sr-only">Профиль</div>

      <div class="flex items-center gap-3 mb-3">
        <a href="/profile-admin" class="flex-shrink-0 group" aria-label="Мой профиль">
          <span class="relative inline-block">
            <img
              src="#"
              alt="admin"
              class="js-avatar-img hidden w-14 h-14 rounded-full object-cover ring-2 ring-[var(--bord)] group-hover:ring-primary/50 bg-white/50 dark:bg-white/5 shadow-md transition-all"
              loading="lazy"
              decoding="async"
            />
            <span class="js-avatar-fallback  w-14 h-14 rounded-full bg-gradient-to-br from-primary to-blue-600 grid place-items-center text-white font-bold text-lg ring-2 ring-[var(--bord)] group-hover:ring-primary/50 shadow-md transition-all">
              A
            </span>
          </span>
        </a>

        <a href="/profile-admin" class="flex-1 min-w-0 group">
          <div class="font-semibold text-base text-[var(--text)] truncate group-hover:text-primary transition-colors">
            admin
          </div>
          <div class="flex items-center gap-1.5 text-xs text-primary font-medium mt-0.5">
            <svg class="w-3.5 h-3.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span class="group-hover:underline">Мой профиль</span>
            <svg class="w-3 h-3 opacity-60 group-hover:opacity-100 group-hover:translate-x-0.5 transition-all flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
            </svg>
          </div>
        </a>

        <button
            class="flex-shrink-0 w-8 h-8 rounded-lg hover:bg-black/10 dark:hover:bg-white/10 flex items-center justify-center transition focus:outline-none focus:ring-0 focus:border-none"
          id="dbDrawerClose"
          type="button"
          aria-label="Закрыть"
        >
          <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>


    <!-- Balance & Controls for authenticated users / Language + Theme for guests -->

    <div class="p-4 border-b border-[var(--bord)]">
      <div class="card p-4" aria-live="polite">
        <div class="flex items-center gap-3 mb-3">
          <div class="w-8 h-8 rounded-xl bg-primary/15 flex items-center justify-center">
            <svg class="w-4 h-4 text-primary" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V19A2 2 0 0 0 5 21H19A2 2 0 0 0 21 19V9M19 9H14V4H15.83L19 7.17V9Z"/>
            </svg>
          </div>
          <div class="flex-1">
            <div class="text-sm text-[var(--muted)]">Мой баланс</div>

              <div class="font-bold">Безлимит</div>
              <button
                type="button"
                id="adminTopupOpen"
                class="btn btn-primary w-full text-sm mt-2"
                aria-haspopup="dialog"
                aria-controls="adminTopupModal"
              >
                Пополнить
              </button>

          </div>
        </div>


      </div>

      <!-- Language + Theme controls under balance -->
      <section class="mt-4 sm:mt-5 mb-4 sm:mb-6">
        <div class="grid grid-cols-2 gap-2">
          <!-- Language -->
          <details class="relative" id="langSwitchDrawer">
            <summary class="btn btn-ghost w-full h-12 rounded-2xl border border-[var(--bord)] flex items-center justify-center"
                     aria-controls="langMenuDrawer" aria-haspopup="menu" aria-expanded="false"
                     aria-label="Choose language">
              <img id="currentLangFlagDrawer" class="w-6 h-6 rounded-full object-cover" src="/static/img/flags/ru.92731c4efa7d.svg" alt="">
            </summary>
            <div class="absolute left-0 top-full mt-1 rounded-xl border border-[var(--bord)] bg-[var(--bg)] shadow-lg p-1 min-w-[160px] z-50"
                 id="langMenuDrawer" role="menu" aria-label="Choose language">
              <button class="w-full text-left px-2.5 py-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 flex items-center gap-2 transition-colors" type="button" data-lang="en" role="menuitemradio" aria-checked="false">
                <img class="w-4 h-4 rounded-sm" src="/static/img/flags/gb.84275ee84996.svg" alt="English">
                <span class="text-sm">English</span>
              </button>
              <button class="w-full text-left px-2.5 py-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 flex items-center gap-2 transition-colors" type="button" data-lang="ru" role="menuitemradio" aria-checked="false">
                <img class="w-4 h-4 rounded-sm" src="/static/img/flags/ru.92731c4efa7d.svg" alt="Русский">
                <span class="text-sm">Русский</span>
              </button>
              <button class="w-full text-left px-2.5 py-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 flex items-center gap-2 transition-colors" type="button" data-lang="de" role="menuitemradio" aria-checked="false">
                <img class="w-4 h-4 rounded-sm" src="/static/img/flags/de.98dc593d47a9.svg" alt="Deutsch">
                <span class="text-sm">Deutsch</span>
              </button>
              <button class="w-full text-left px-2.5 py-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 flex items-center gap-2 transition-colors" type="button" data-lang="es" role="menuitemradio" aria-checked="false">
                <img class="w-4 h-4 rounded-sm" src="/static/img/flags/es.de69c2c19b7b.svg" alt="Español">
                <span class="text-sm">Español</span>
              </button>
              <button class="w-full text-left px-2.5 py-1.5 rounded-lg hover:bg-black/5 dark:hover:bg-white/10 flex items-center gap-2 transition-colors" type="button" data-lang="pt" role="menuitemradio" aria-checked="false">
                <img class="w-4 h-4 rounded-sm" src="/static/img/flags/pt.79cf16e3caf6.svg" alt="Português">
                <span class="text-sm">Português</span>
              </button>
            </div>
          </details>
          <!-- Theme -->
          <button id="themeToggleDrawer"
                  class="btn btn-ghost w-full h-12 rounded-2xl border border-[var(--bord)] flex items-center justify-center"
                  type="button" aria-label="Toggle theme" aria-pressed="false">
            <svg id="iconSunD" class="w-5 h-5 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.6 4.6l2.1 2.1M17.3 17.3l2.1 2.1M4.6 19.4l2.1-2.1M17.3 6.7l2.1-2.1"></path>
            </svg>
            <svg id="iconMoonD" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path d="M21 12.6A9 9 0 1 1 11.4 3a7 7 0 0 0 9.6 9.6Z"></path>
            </svg>
          </button>
        </div>
      </section>

      <!-- Profile Privacy Toggle -->
      <section class="mb-4 sm:mb-6">
        <div class="w-full rounded-2xl border border-[var(--bord)] bg-white/40 dark:bg-white/5 p-3 sm:p-4">
          <label class="flex items-center justify-between cursor-pointer group">
            <div class="flex items-center gap-2.5 sm:gap-3 min-w-0 flex-1">
              <div class="w-9 h-9 sm:w-10 sm:h-10 rounded-xl bg-primary/10 dark:bg-primary/15 flex items-center justify-center flex-shrink-0">
                <svg id="privacyIconDrawer" class="w-5 h-5 text-primary transition-all" viewBox="0 0 24 24" fill="currentColor">

                  <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>

                </svg>
              </div>
              <div class="min-w-0 flex-1">
                <div class="text-xs sm:text-sm font-semibold text-[var(--text)] leading-tight mb-0.5">
                  Тип аккаунта
                </div>
                <div id="privacyStatusDrawer" class="text-[10px] sm:text-xs text-[var(--muted)] leading-tight">
                  Закрытый аккаунт
                </div>
              </div>
            </div>
            <div class="relative flex-shrink-0">
              <input type="checkbox"
                     id="privacyToggleDrawer"
                     class="sr-only peer"
                     checked>
              <div class="w-11 h-6 sm:w-12 sm:h-7 bg-gray-300 dark:bg-gray-600 rounded-full peer peer-checked:bg-primary transition-all duration-300 peer-focus:ring-2 peer-focus:ring-primary/50"></div>
              <div class="absolute top-0.5 left-0.5 w-5 h-5 sm:w-6 sm:h-6 bg-white rounded-full shadow-md transition-all duration-300 peer-checked:translate-x-5 peer-checked:sm:translate-x-6"></div>
            </div>
          </label>
        </div>
      </section>
    </div>


    <!-- Navigation -->

    <nav class="p-4 space-y-1" aria-label="Меню профиля">
      <a class="flex items-center gap-3 p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group" href="/en/gallery/">
        <div class="w-8 h-8 rounded-lg bg-violet-500/15 flex items-center justify-center group-hover:bg-violet-500/25 transition">
          <svg class="w-4 h-4 text-violet-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        </div>
        <span class="font-medium">Gallery</span>
        <svg class="w-4 h-4 ml-auto text-[var(--muted)] group-hover:text-[var(--text)] transition" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </a>

      <a class="flex items-center gap-3 p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group" href="/en/dashboard/my-jobs">
        <div class="w-8 h-8 rounded-lg bg-blue-500/15 flex items-center justify-center group-hover:bg-blue-500/25 transition">
          <svg class="w-4 h-4 text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
          </svg>
        </div>
        <span class="font-medium">Мои обработки</span>
        <svg class="w-4 h-4 ml-auto text-[var(--muted)] group-hover:text-[var(--text)] transition" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </a>

      <a class="flex items-center gap-3 p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group" href="/en/dashboard/tips">
        <div class="w-8 h-8 rounded-lg bg-amber-500/15 flex items-center justify-center group-hover:bg-amber-500/25 transition">
          <svg class="w-4 h-4 text-amber-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
          </svg>
        </div>
        <span class="font-medium">Рекомендации</span>
        <svg class="w-4 h-4 ml-auto text-[var(--muted)] group-hover:text-[var(--text)] transition" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </a>

      <a class="flex items-center gap-3 p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group" href="/en/generate/photo">
        <div class="w-8 h-8 rounded-lg bg-green-500/15 flex items-center justify-center group-hover:bg-green-500/25 transition">
          <svg class="w-4 h-4 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
        </div>
        <span class="font-medium">Generate</span>
        <svg class="w-4 h-4 ml-auto text-[var(--muted)] group-hover:text-[var(--text)] transition" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </a>

      <a class="flex items-center gap-3 p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group" href="/en/dashboard/saved">
        <div class="w-8 h-8 rounded-lg bg-emerald-500/15 flex items-center justify-center group-hover:bg-emerald-500/25 transition">
          <svg class="w-4 h-4 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-4-7 4V5z"/>
          </svg>
        </div>
        <span class="font-medium">Сохранённое</span>
        <svg class="w-4 h-4 ml-auto text-[var(--muted)] group-hover:text-[var(--text)] transition" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </a>

      <div class="h-px bg-[var(--bord)] my-4"></div>

      <div class="text-xs font-medium text-[var(--muted)] px-3 mt-2 uppercase tracking-wide">
        Настройки
      </div>

      <a class="flex items-center gap-3 p-3 rounded-xl hover:bg-black/[.04] dark:hover:bg-white/10 transition group" href="/en/accounts/password/change/">
        <div class="w-8 h-8 rounded-lg bg-orange-500/15 flex items-center justify-center group-hover:bg-orange-500/25 transition">
          <svg class="w-4 h-4 text-orange-600" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
          </svg>
        </div>
        <span class="font-medium">Сменить пароль</span>
        <svg class="w-4 h-4 ml-auto text-[var(--muted)] group-hover:text-[var(--text)] transition" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </a>

      <a class="flex items-center gap-3 p-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/20 transition group text-red-600 dark:text-red-400" href="/en/accounts/logout/">
        <div class="w-8 h-8 rounded-lg bg-red-500/15 flex items-center justify-center group-hover:bg-red-500/25 transition">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
          </svg>
        </div>
        <span class="font-medium">Выйти из аккаунта</span>
        <svg class="w-4 h-4 ml-auto group-hover:text-red-500 transition" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </a>
    </nav>



    <div class="p-4 mt-auto border-t border-[var(--bord)] sm:hidden">
      <a class="btn btn-primary w-full text-sm" href="/en/generate/photo">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        Создать
      </a>
    </div>

  </div>
</aside>

<!-- Drawer: avatar upload/delete disabled; edit avatar only on profile page -->

<!-- Admin Top-up Modal (UI/UX only) -->
<div
  id="adminTopupModal"
  class="fixed inset-0 z-[60] hidden"
  role="dialog"
  aria-modal="true"
  aria-labelledby="adminTopupTitle"
>
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>

  <!-- Dialog -->
  <div
    class="relative mx-auto my-6 w-[92vw] max-w-md rounded-2xl border border-[var(--bord)] bg-[var(--bg-card)] shadow-2xl"
  >
    <div class="flex items-center justify-between p-4 sm:p-5 border-b border-[var(--bord)]">
      <h3 id="adminTopupTitle" class="text-base sm:text-lg font-semibold">
        Пополнить токены пользователю
      </h3>
      <button id="adminTopupClose" type="button" class="w-9 h-9 rounded-lg hover:bg-black/10 dark:hover:bg-white/10 flex items-center justify-center">
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <form id="adminTopupForm" class="p-4 sm:p-5 space-y-3" data-admin-topup-url="/dashboard/api/admin/topup/">
      <input type="hidden" name="csrfmiddlewaretoken" value="l8loxdnyNvSnvVrbCELsBqrG6yD1b4N723o86ogOCWrm9QnWm5rPGUGwByV2EyBx">
      <!-- Username -->
      <div>
        <label for="admUser" class="block text-sm font-medium mb-1">Имя пользователя</label>
        <div class="relative">
          <input
            id="admUser"
            name="username"
            type="text"
            class="field w-full pr-9"
            placeholder="username"
            autocomplete="off"
            required
          />
          <svg class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 w-4 h-4 text-[var(--muted)]" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35M10 18a8 8 0 1 1 0-16 8 8 0 0 1 0 16z"/>
          </svg>
        </div>
        <p class="mt-1 text-[10px] sm:text-xs text-[var(--muted)]">
          Введите username. Поиск выполняется на стороне сервера (UI-слой, логика уже в бекенде).
        </p>
      </div>

      <!-- Amount -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
          <label for="admAmount" class="block text-sm font-medium mb-1">Количество токенов</label>
          <input
            id="admAmount"
            name="amount"
            type="number"
            inputmode="numeric"
            min="1"
            step="1"
            class="field w-full"
            placeholder="500"
            required
          />
        </div>
        <div>
          <label for="admReason" class="block text-sm font-medium mb-1">Причина (опц.)</label>
          <input
            id="admReason"
            name="reason"
            type="text"
            class="field w-full"
            placeholder="например: бонус, компенсация"
          />
        </div>
      </div>

      <!-- Hints -->
      <div class="rounded-xl border border-[var(--bord)] bg-black/[.03] dark:bg-white/[.03] p-3">
        <ul class="list-disc ml-5 space-y-1 text-[10px] sm:text-xs text-[var(--muted)]">
          <li>Только для администраторов. Операция фиксируется в журнале.</li>
          <li>Поддерживается тёмная и светлая тема, интерфейс адаптивен до 320px.</li>
        </ul>
      </div>

      <!-- Actions -->
      <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 pt-1">
        <button type="submit" class="btn btn-primary flex-1">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
          </svg>
          Пополнить
        </button>
        <button type="button" id="adminTopupCancel" class="btn btn-ghost flex-1">Отмена</button>
      </div>
      <div id="admTopupMsg" class="text-[10px] sm:text-xs text-[var(--muted)]"></div>
    </form>
  </div>
</div>

<!-- Drawer Follow Modal -->
<div id="drFollowModal" class="modal hidden fixed inset-0 z-[70] flex items-center justify-center p-3 sm:p-4">
  <div class="modal-backdrop absolute inset-0 bg-black/70 dark:bg-black/80 backdrop-blur-sm" onclick="Modal.close('drFollowModal')"></div>
  <div class="relative w-full max-w-[min(95vw,420px)] rounded-2xl bg-[var(--bg)] border-2 border-[var(--bord)] shadow-2xl overflow-hidden max-h-[min(90vh,650px)] flex flex-col">
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b-2 border-[var(--bord)] flex-shrink-0 bg-gradient-to-b from-black/[.02] dark:from-white/[.02] to-transparent">
      <h3 id="drFollowModalTitle" class="text-base sm:text-lg font-bold text-[var(--text)]"></h3>
      <button type="button" class="btn btn-ghost p-2 hover:bg-black/10 dark:hover:bg-white/10 rounded-xl transition-all flex-shrink-0 active:scale-95" onclick="Modal.close('drFollowModal')" aria-label="Close">
        <svg class="w-5 h-5 text-[var(--muted)] hover:text-[var(--text)] transition" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <!-- Tabs (only for followers/following) -->
    <nav id="drFollowTabs" class="flex justify-center p-3 border-b border-[var(--bord)] flex-shrink-0 hidden">
      <div class="inline-flex rounded-xl bg-black/5 dark:bg-white/5 p-1 gap-1 w-full max-w-xs">
        <button id="drTabFollowers" type="button" class="flex-1 px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold text-[var(--muted)] hover:text-[var(--text)] transition-all">
          Подписчики
        </button>
        <button id="drTabFollowing" type="button" class="flex-1 px-3 py-1.5 rounded-lg text-xs sm:text-sm font-semibold text-[var(--muted)] hover:text-[var(--text)] transition-all">
          Подписки
        </button>
      </div>
    </nav>

    <!-- Body -->
    <div id="drFollowModalBody" class="overflow-y-auto flex-1 min-h-0" style="max-height: calc(min(90vh,650px) - 130px);">
      <div class="text-[var(--muted)] text-sm py-12 text-center">
        <div class="inline-flex items-center gap-2">
          <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span>Загрузка...</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  const isStaff = true;
  // Live update wallet balance in drawer (avoid stale 0 on first render)
  (function(){
    if (!isStaff) {
      try {
        const valEl = document.getElementById('dbBalanceValue');
        if (valEl) {
          fetch('/en/dashboard/api/wallet/info/', { headers: { 'X-Requested-With': 'fetch' }})
            .then(r => r.json()).then(j => {
              if (j && (j.ok !== false) && typeof j.balance !== 'undefined') {
                valEl.textContent = j.balance;
              }
            }).catch(()=>{});
        }
      } catch(e) {}
    }
  })();
  if (isStaff) {
    const openBtn = document.getElementById('adminTopupOpen');
    const modal = document.getElementById('adminTopupModal');
    const closeBtn = document.getElementById('adminTopupClose');
    const cancelBtn = document.getElementById('adminTopupCancel');
    const form = document.getElementById('adminTopupForm');
    const msg = document.getElementById('admTopupMsg');

    function open() {
      if (!modal) return;
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(() => {
        try { document.getElementById('admUser').focus(); } catch(e) {}
      }, 10);
    }
    function close() {
      if (!modal) return;
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      msg.textContent = '';
    }

    openBtn?.addEventListener('click', open);
    closeBtn?.addEventListener('click', close);
    cancelBtn?.addEventListener('click', close);
    modal?.addEventListener('click', (e) => { if (e.target === modal) close(); });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !modal.classList.contains('hidden')) close(); });

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = '';
      const fd = new FormData(form);
      const username = (fd.get('username') || '').toString().trim();
      const amount = parseInt((fd.get('amount') || '0').toString(), 10) || 0;
      const reason = (fd.get('reason') || '').toString().trim();
      if (!username || amount <= 0) {
        msg.textContent = 'Укажите username и положительную сумму токенов';
        return;
      }

      const url = form.dataset.adminTopupUrl || '/dashboard/api/admin/topup/';
      try {
        const r = await fetch(url, {
          method: 'POST',
          headers: { 'X-Requested-With': 'fetch', 'X-CSRFToken': (document.querySelector("[name=csrfmiddlewaretoken]")||{}).value || '' },
          body: fd
        });
        const j = await r.json().catch(()=>({}));
        if (r.ok && (j.ok !== false)) {
          msg.className = 'text-[10px] sm:text-xs text-emerald-500';
          msg.textContent = 'Успешно пополнено';
          setTimeout(close, 900);
        } else {
          msg.className = 'text-[10px] sm:text-xs text-red-500';
          msg.textContent = (j.error || 'Ошибка пополнения. Проверьте эндпоинт.');
        }
      } catch (err) {
        msg.className = 'text-[10px] sm:text-xs text-red-500';
        msg.textContent = 'Эндпоинт недоступен. UI готов, подключите серверный маршрут /dashboard/api/admin/topup/.';
      }
    });
  }

  // Drawer Follow Modal Logic
  const currentUser = "admin";
  const elFollowers = document.getElementById('drBtnFollowers');
  const elFollowing = document.getElementById('drBtnFollowing');
  const elPosts = document.getElementById('drBtnPosts');
  const modalId = 'drFollowModal';
  const titleEl = document.getElementById('drFollowModalTitle');
  const bodyEl = document.getElementById('drFollowModalBody');
  const tabsEl = document.getElementById('drFollowTabs');
  const urls = {
    followers: "/en/dashboard/api/follow/list/followers/",
    following: "/en/dashboard/api/follow/list/following/",
    recs: "/en/dashboard/api/follow/recommendations/?limit=5",
    myJobs: "/en/dashboard/my-jobs?only=published"
  };

  function renderUsers(users){
    if (!users || !users.length){
      return '<div class="text-sm text-[var(--muted)] py-12 text-center">Список пуст</div>';
    }
    return '<ul class="divide-y divide-[var(--bord)]">' + users.map(u => `
      <li class="py-2.5 px-3 flex items-center gap-2.5 hover:bg-black/[.03] dark:hover:bg-white/[.03] transition-colors">
        ${u.avatar_url ?
          `<img src="${u.avatar_url}" alt="" class="w-10 h-10 rounded-full object-cover flex-shrink-0 ring-2 ring-[var(--bord)]">` :
          `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary/20 to-blue-500/20 flex-shrink-0 ring-2 ring-[var(--bord)] flex items-center justify-center">
            <svg class="w-5 h-5 text-primary/40" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
            </svg>
          </div>`
        }
        <div class="min-w-0 flex-1">
          <a href="/dashboard/profile/${encodeURIComponent(u.username)}" class="font-semibold text-[var(--text)] truncate hover:underline block text-sm leading-tight">${u.name || u.username}</a>
          <div class="text-xs text-[var(--muted)] truncate mt-0.5">@${u.username}</div>
        </div>
        <button class="btn ${u.is_following ? 'btn-ghost' : 'btn-primary'} text-xs font-semibold whitespace-nowrap px-3 py-1.5 flex-shrink-0 min-w-[80px] rounded-lg" data-follow-toggle="1" data-username="${u.username}">
          ${u.is_following ? 'Отписаться' : 'Подписаться'}
        </button>
      </li>`).join('') + '</ul>';
  }

  function renderRecs(recs){
    if (!recs || !recs.length) return '';
    return `
      <div class="mt-2 pt-3 border-t-2 border-[var(--bord)] bg-gradient-to-b from-black/[.01] dark:from-white/[.01] to-transparent">
        <div class="flex items-center gap-2 mb-2 px-3">
          <svg class="w-4 h-4 text-primary" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
          </svg>
          <div class="text-xs sm:text-sm font-bold text-[var(--text)]">Рекомендации</div>
        </div>
        <ul class="divide-y divide-[var(--bord)]">
          ${recs.map(u => `
            <li class="py-2.5 px-3 flex items-center gap-2.5 hover:bg-black/[.03] dark:hover:bg-white/[.03] transition-colors">
              ${u.avatar_url ?
                `<img src="${u.avatar_url}" alt="" class="w-9 h-9 rounded-full object-cover flex-shrink-0 ring-2 ring-[var(--bord)]">` :
                `<div class="w-9 h-9 rounded-full bg-gradient-to-br from-primary/20 to-blue-500/20 flex-shrink-0 ring-2 ring-[var(--bord)] flex items-center justify-center">
                  <svg class="w-4 h-4 text-primary/40" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                  </svg>
                </div>`
              }
              <div class="min-w-0 flex-1">
                <a href="/dashboard/profile/${encodeURIComponent(u.username)}" class="font-semibold text-[var(--text)] truncate hover:underline block text-xs sm:text-sm leading-tight">${u.name || u.username}</a>
                <div class="text-xs text-[var(--muted)] truncate mt-0.5">@${u.username}</div>
              </div>
              <button class="btn btn-primary text-xs font-semibold whitespace-nowrap px-3 py-1.5 flex-shrink-0 min-w-[80px] rounded-lg" data-follow-toggle="1" data-username="${u.username}">
                Подписаться
              </button>
            </li>
          `).join('')}
        </ul>
      </div>
    `;
  }

  function setActiveTab(kind){
    const f1 = document.getElementById('drTabFollowers');
    const f2 = document.getElementById('drTabFollowing');
    const activeCls = ['bg-black/[.08]','dark:bg-white/10','text-[var(--text)]','shadow-sm'];
    const reset = (el)=>{ if(!el) return; el.classList.remove(...activeCls); };
    const make = (el)=>{ if(!el) return; el.classList.add(...activeCls); };
    reset(f1); reset(f2);
    if (kind === 'followers') make(f1); else make(f2);
  }

  async function loadFollowList(kind){
    titleEl.textContent = kind === 'followers' ? 'Подписчики' : 'Подписки';
    tabsEl.classList.remove('hidden');
    bodyEl.innerHTML = '<div class="py-8 text-center text-sm text-[var(--muted)]">Загрузка...</div>';
    try{
      const res = await fetch(urls[kind], { headers: { 'X-Requested-With': 'fetch' }});
      const data = await res.json();
      if (data && data.ok){
        bodyEl.innerHTML = renderUsers(data.users);
      } else {
        bodyEl.innerHTML = '<div class="py-8 text-center text-sm text-red-500">Ошибка загрузки</div>';
      }
    } catch(e){
      bodyEl.innerHTML = '<div class="py-8 text-center text-sm text-red-500">Ошибка сети</div>';
    }

    try {
      const recRes = await fetch(urls.recs, { headers: { 'X-Requested-With': 'fetch' }});
      const recData = await recRes.json().catch(()=>null);
      if (recData && recData.ok && Array.isArray(recData.users) && recData.users.length) {
        bodyEl.insertAdjacentHTML('beforeend', renderRecs(recData.users));
      }
    } catch(e) { /* ignore */ }

    bodyEl.onclick = async function(ev) {
      const btn = ev.target.closest('[data-follow-toggle="1"]');
      if (!btn) return;
      ev.preventDefault();
      ev.stopPropagation();
      const username = btn.getAttribute('data-username');
      if (!username) return;

      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '...';

      try {
        const fd = new FormData();
        fd.append('username', username);
        const csrf = (document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/) || [])[1] || '';
        const res = await fetch('/dashboard/api/follow/toggle/', {
          method: 'POST',
          headers: { 'X-CSRFToken': csrf, 'X-Requested-With': 'fetch' },
          body: fd
        });
        const j = await res.json();
        if (j && j.ok) {
          const nowFollowing = !!j.following;
          btn.textContent = nowFollowing ? 'Отписаться' : 'Подписаться';
          btn.classList.toggle('btn-primary', !nowFollowing);
          btn.classList.toggle('btn-ghost', nowFollowing);

          // Instagram logic: NEVER remove from list, just change button state
          // This matches Instagram's behavior in both tabs

          const cRes = await fetch(`/dashboard/api/follow/${encodeURIComponent(currentUser)}/counters/`, {
            headers: { 'X-Requested-With': 'fetch' }
          });
          const c = await cRes.json();
          if (c && c.ok) {
            const dF = document.getElementById('drFollowers');
            const dFg = document.getElementById('drFollowing');
            const dP = document.getElementById('drPosts');
            if (dF) dF.textContent = c.followers;
            if (dFg) dFg.textContent = c.following;
            if (dP) dP.textContent = c.posts;
          }
        } else {
          btn.textContent = originalText;
        }
      } catch (e) {
        btn.textContent = originalText;
      } finally {
        btn.disabled = false;
      }
    };
  }

  async function loadPosts(){
    titleEl.textContent = 'Мои публикации';
    tabsEl.classList.add('hidden');
    bodyEl.innerHTML = '<div class="py-8 text-center text-sm text-[var(--muted)]">Загрузка...</div>';

    // Redirect to my-jobs with filter
    window.location.href = urls.myJobs;
  }

  async function openModal(kind){
    if (kind === 'posts') {
      loadPosts();
      return;
    }

    setActiveTab(kind);
    await loadFollowList(kind);

    const f1 = document.getElementById('drTabFollowers');
    const f2 = document.getElementById('drTabFollowing');
    if (f1) f1.onclick = async () => { setActiveTab('followers'); await loadFollowList('followers'); };
    if (f2) f2.onclick = async () => { setActiveTab('following'); await loadFollowList('following'); };

    if (typeof Modal !== 'undefined') {
      Modal.open(modalId);
    }
  }

  elFollowers?.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openModal('followers'); });
  elFollowing?.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openModal('following'); });
  elPosts?.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openModal('posts'); });
})();

// Privacy Toggle Handler
(function(){
  const checkbox = document.getElementById('privacyToggleDrawer');
  const statusText = document.getElementById('privacyStatusDrawer');
  const icon = document.getElementById('privacyIconDrawer');

  if(!checkbox) return;

  checkbox.addEventListener('change', async function(){
    const isPrivate = this.checked;
    const originalChecked = this.checked;

    try {
      const csrf = (document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/) || [])[1] || '';
      const res = await fetch('/en/dashboard/profile/privacy/toggle', {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrf,
          'X-Requested-With': 'fetch'
        }
      });

      const data = await res.json();
      if(data && data.success){
        if(statusText) statusText.textContent = data.is_private ? 'Закрытый аккаунт' : 'Открытый аккаунт';
        if(icon){
          if(data.is_private){
            icon.innerHTML = '<path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>';
          } else {
            icon.innerHTML = '<path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h2c0-1.66 1.34-3 3-3s3 1.34 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10zm-6-3c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2z"/>';
          }
        }
      } else {
        this.checked = !originalChecked;
      }
    } catch(e){
      this.checked = !originalChecked;
    }
  });
})();
</script>






  <main id="main" class="container py-6 pt-8 md:pt-6" style="margin-top:30px;" role="main">




<div id="gen-root" class="max-w-7xl mx-auto space-y-8"
     data-user-key="u:1"
     data-api-submit-url="/en/generate/api/submit"
     data-api-status-tpl="/en/generate/api/status/12345"
     data-job-detail-tpl="/en/generate/job/12345"
     data-topup-url="/en/dashboard/tariffs"
     data-is-staff="true"
     data-is-auth="true"
     data-raw-cost="10">

  <!-- Header Section -->
  <div class="card p-6" itemscope itemtype="https://schema.org/WebPage">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold" id="page-title">Сгенерировать изображение</h1>
        <p class="mt-2 text-[var(--muted)] text-sm" id="page-subtitle">Создавайте уникальные изображения с помощью ИИ</p>
      </div>

      <!-- Переключатель Изображение / Видео -->
      <div class="inline-flex rounded-xl bg-[var(--bord)] p-1 gap-1">
        <button type="button" class="generation-mode-tab flex-1 sm:flex-initial px-3 py-2 rounded-lg transition-all duration-200 flex items-center justify-center gap-2 text-sm font-medium active" data-mode="image" title="Изображение">
          <svg class="mode-icon w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
        </button>
        <button type="button" class="generation-mode-tab flex-1 sm:flex-initial px-3 py-2 rounded-lg transition-all duration-200 flex items-center justify-center gap-2 text-sm font-medium " data-mode="video" title="Видео">
          <svg class="mode-icon w-5 h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path d="M23 7l-7 5 7 5V7z"/>
            <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Admin Panel for Image Models (только для админов) -->

    <div class="mt-6 p-4 rounded-xl border-2 border-primary/20 bg-gradient-to-br from-primary/5 to-primary/10" id="image-models-admin-panel">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
            <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
          </div>
          <div>
            <h3 class="font-bold text-base">Управление моделями изображений</h3>
            <p class="text-xs text-[var(--muted)]">Настройка параметров моделей Runware</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <a href="/en/generate/admin/image-models" class="group flex items-center gap-3 p-4 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] hover:border-primary/50 hover:bg-primary/5 transition-all">
          <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center group-hover:bg-blue-500/20 transition-colors">
            <svg class="w-5 h-5 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-sm">Список моделей</div>
            <div class="text-xs text-[var(--muted)]">Просмотр всех моделей</div>
          </div>
          <svg class="w-5 h-5 text-[var(--muted)] group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </a>

        <a href="/en/generate/admin/image-models/create" class="group flex items-center gap-3 p-4 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] hover:border-primary/50 hover:bg-primary/5 transition-all">
          <div class="w-10 h-10 rounded-lg bg-emerald-500/10 flex items-center justify-center group-hover:bg-emerald-500/20 transition-colors">
            <svg class="w-5 h-5 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-sm">Добавить модель</div>
            <div class="text-xs text-[var(--muted)]">Создать новую модель</div>
          </div>
          <svg class="w-5 h-5 text-[var(--muted)] group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </a>

        <a href="/admin/generate/imagemodelconfiguration/" target="_blank" class="group flex items-center gap-3 p-4 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] hover:border-primary/50 hover:bg-primary/5 transition-all">
          <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center group-hover:bg-amber-500/20 transition-colors">
            <svg class="w-5 h-5 text-amber-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-sm">Django Admin</div>
            <div class="text-xs text-[var(--muted)]">Расширенные настройки</div>
          </div>
          <svg class="w-5 h-5 text-[var(--muted)] group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
          </svg>
        </a>
      </div>
    </div>

    <!-- End Admin Panel for Image Models -->

<!-- Admin Panel for Video Models (только для админов) -->

    <div class="mt-6 p-4 rounded-xl border-2 border-primary/20 bg-gradient-to-br from-primary/5 to-primary/10" id="video-models-admin-panel" style="display:none">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center">
            <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <div>
            <h3 class="font-bold text-base">Управление видео моделями</h3>
            <p class="text-xs text-[var(--muted)]">Настройка параметров моделей Runware</p>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        <a href="/en/generate/admin/video-models" class="group flex items-center gap-3 p-4 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] hover:border-primary/50 hover:bg-primary/5 transition-all">
          <div class="w-10 h-10 rounded-lg bg-blue-500/10 flex items-center justify-center group-hover:bg-blue-500/20 transition-colors">
            <svg class="w-5 h-5 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-sm">Список моделей</div>
            <div class="text-xs text-[var(--muted)]">Просмотр всех моделей</div>
          </div>
          <svg class="w-5 h-5 text-[var(--muted)] group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </a>

        <a href="/en/generate/admin/video-models/create" class="group flex items-center gap-3 p-4 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] hover:border-primary/50 hover:bg-primary/5 transition-all">
          <div class="w-10 h-10 rounded-lg bg-emerald-500/10 flex items-center justify-center group-hover:bg-emerald-500/20 transition-colors">
            <svg class="w-5 h-5 text-emerald-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-sm">Добавить модель</div>
            <div class="text-xs text-[var(--muted)]">Создать новую модель</div>
          </div>
          <svg class="w-5 h-5 text-[var(--muted)] group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
          </svg>
        </a>

        <a href="/admin/generate/videomodelconfiguration/" target="_blank" class="group flex items-center gap-3 p-4 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] hover:border-primary/50 hover:bg-primary/5 transition-all">
          <div class="w-10 h-10 rounded-lg bg-amber-500/10 flex items-center justify-center group-hover:bg-amber-500/20 transition-colors">
            <svg class="w-5 h-5 text-amber-500" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-semibold text-sm">Django Admin</div>
            <div class="text-xs text-[var(--muted)]">Расширенные настройки</div>
          </div>
          <svg class="w-5 h-5 text-[var(--muted)] group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
          </svg>
        </a>
      </div>
    </div>


    <!-- Balance Section with proper spacing -->
    <div class="mt-6 sm:mt-8 mb-4">

      <div class="flex flex-wrap items-center justify-between gap-4 gap-y-4">
        <!-- Balance Display (left, smaller) -->
        <div class="flex-1 flex items-center">


              <div class="min-w-[80px] p-2">
                <div class="flex items-center gap-1 justify-start mb-1">
                  <span class="w-4 h-4 rounded-full bg-primary/20 flex items-center justify-center">
                    <span class="w-2 h-2 rounded-full bg-primary"></span>
                  </span>

                    <strong id="balance" data-infinite="1" class="text-base font-bold">∞</strong>

                  <span class="text-xs text-[var(--muted)] font-medium">TOK</span>
                </div>
                <div class="text-[10px] text-[var(--muted)] text-left">
                  Админ режим
                </div>
              </div>


        </div>
        <!-- Top Up Button -->
        <div class="flex-none">



        </div>
      </div>
    </div>

    <meta itemprop="name" content="Генерация изображений — Pixera">
    <meta itemprop="description" content="Онлайн-генератор изображений на ИИ: фотореализм, художественные стили и подсказки. Стоимость — токены, 1 обработка = 10 TOK.">
  </div>



  <!-- Generation Form -->
  <!-- Force initial CSS-mode from URL to prevent FOUC when opening video mode -->
  <style>
    html.mode-video form[method="post"],
    html.mode-video #image-generation-form { display: none !important; }
    html.mode-video #video-form-container { display: block !important; }
    html.mode-video #image-prompts-card,
    html.mode-video #promptCats,
    html.mode-video #showcaseSection { display: none !important; }
  </style>
  <script>
    (function() {
      try {
        var usp = new URLSearchParams(window.location.search);
        var t = usp.get('type');
        if (t === 'video') {
          document.documentElement.classList.add('mode-video');
          try { localStorage.setItem('gen.topMode','video'); } catch(_) {}
        } else if (t === 'image') {
          document.documentElement.classList.remove('mode-video');
          try { localStorage.setItem('gen.topMode','image'); } catch(_) {}
        }
      } catch(e) {}
    })();
  </script>
  <form id="image-generation-form" method="post" class="card p-6" novalidate itemprop="potentialAction" itemscope itemtype="https://schema.org/CreateAction" style="">
    <input type="hidden" name="csrfmiddlewaretoken" value="l8loxdnyNvSnvVrbCELsBqrG6yD1b4N723o86ogOCWrm9QnWm5rPGUGwByV2EyBx">
    <meta itemprop="name" content="Создать изображение по текстовому описанию">

    <div class="space-y-6">
      <!-- Prompt Input -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <label class="block text-sm font-medium" for="prompt">Описание изображения</label>
          <div class="inline-flex items-center gap-2">
            <span class="text-[11px] sm:text-xs text-[var(--muted)]">Автоперевод</span>
            <button
              type="button"
              id="img-auto-translate-toggle"
              class="relative inline-flex h-6 w-11 items-center rounded-full bg-[var(--bord)] ring-1 ring-[var(--bord)] transition focus:outline-none focus:ring-2 focus:ring-primary/50"
              aria-pressed="true"
              aria-label="Автоперевод">
              <span class="sr-only">Автоперевод</span>
              <span class="dot translate-x-5 inline-block h-5 w-5 transform rounded-full bg-white shadow transition"></span>
            </button>
          </div>
        </div>
        <div class="relative">
          <textarea
            id="prompt"
            name="prompt"
            class="field min-h-36 sm:min-h-32 resize-none"
            placeholder="Пример: cinematic portrait, soft studio light, 85mm, shallow DOF, orange accents"
            required
            aria-required="true"
            maxlength="1500"
            itemprop="actionOption"></textarea>

          <!-- Enhanced Prompt Generator - Simplified UI -->
          <div id="pg-image" class="mt-2 flex items-center justify-end gap-3">
            <span id="pg-image-status" class="text-xs text-[var(--muted)] hidden"></span>
            <button
              type="button"
              id="pg-image-btn"
              class="btn btn-primary text-sm"
              title="Улучшить промпт с помощью AI">
              <svg id="pg-image-loading" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"/>
                <path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor"/>
              </svg>
              <svg id="pg-image-icon" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
              </svg>
              <span>Улучшить промпт</span>
            </button>
          </div>
          <style>
            @keyframes spin { to { transform: rotate(360deg); } }
            .animate-spin { animation: spin 1s linear infinite; }
          </style>

          <script>
            (function() {
              // Shared helpers
              function copyToClipboard(text) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                  navigator.clipboard.writeText(text);
                } else {
                  const ta = document.createElement('textarea');
                  ta.value = text;
                  ta.style.position = 'fixed';
                  ta.style.opacity = '0';
                  document.body.appendChild(ta);
                  ta.select();
                  document.execCommand('copy');
                  document.body.removeChild(ta);
                }
              }
              function getCSRF() {
                return (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value || '';
              }

              // Backend-powered generation via X.AI Grok
              async function generateWithGrok(idea, mode) {
                const url = "/en/generate/api/prompt/ai";
                const headers = {
                  "Content-Type": "application/json",
                  "X-CSRFToken": getCSRF(),
                  "X-Requested-With": "fetch"
                };
                const body = JSON.stringify({ idea, mode });
                const r = await fetch(url, { method: "POST", headers, body });
                let j = {};
                try { j = await r.json(); } catch(_) {}
                if (!r.ok || j.ok === false) {
                  throw new Error(j.error || ("HTTP " + r.status));
                }
                // Return full payload to allow UI to show fallback warning if any
                return j;
              }

              function bindPromptGenerator(ns) {
                const root = document.getElementById(`pg-${ns}`);
                if (!root) return;

                const btn = document.getElementById(`pg-${ns}-btn`);
                const loading = document.getElementById(`pg-${ns}-loading`);
                const icon = document.getElementById(`pg-${ns}-icon`);
                const status = document.getElementById(`pg-${ns}-status`);

                const targetId = ns === 'image' ? 'prompt' : 'video-prompt';
                const promptField = () => document.getElementById(targetId);

                function setLoading(on) {
                  btn.disabled = on;
                  if (loading) loading.classList.toggle('hidden', !on);
                  if (icon) icon.classList.toggle('hidden', on);
                }

                btn?.addEventListener('click', async () => {
                  const field = promptField();
                  if (!field) return;

                  const currentText = (field.value || '').trim();
                  if (!currentText) {
                    field.focus();
                    if (status) {
                      status.textContent = 'Введите промпт для улучшения';
                      status.classList.remove('hidden');
                      setTimeout(() => status.classList.add('hidden'), 3000);
                    }
                    return;
                  }

                  setLoading(true);
                  if (status) status.classList.add('hidden');

                  try {
                    const res = await generateWithGrok(currentText, ns === 'video' ? 'video' : 'image');
                    const improvedPrompt = (res && res.text) ? res.text.trim() : '';

                    if (improvedPrompt) {
                      // Smoothly replace text in the same field
                      field.value = improvedPrompt;
                      field.dispatchEvent(new Event('input', { bubbles: true }));

                      // Show success message
                      if (status) {
                        status.textContent = '✓ Промпт улучшен';
                        status.classList.remove('hidden', 'text-[var(--muted)]');
                        status.classList.add('text-green-500');
                        setTimeout(() => {
                          status.classList.add('hidden');
                          status.classList.remove('text-green-500');
                          status.classList.add('text-[var(--muted)]');
                        }, 3000);
                      }

                      // Show warning if backend used local fallback
                      if (res && res.fallback) {
                        if (status) {
                          status.textContent = '⚠ Используем локальный fallback (нет кредитов)';
                          status.classList.remove('hidden', 'text-green-500');
                          status.classList.add('text-amber-500');
                        }
                      }
                    } else {
                      throw new Error('Пустой результат');
                    }
                  } catch (e) {
                    const msg = (e && e.message) ? String(e.message) : 'Неизвестная ошибка';
                    if (status) {
                      status.textContent = '✗ Ошибка: ' + msg;
                      status.classList.remove('hidden', 'text-[var(--muted)]');
                      status.classList.add('text-red-500');
                      setTimeout(() => {
                        status.classList.add('hidden');
                        status.classList.remove('text-red-500');
                        status.classList.add('text-[var(--muted)]');
                      }, 5000);
                    }
                  } finally {
                    setLoading(false);
                  }
                });
              }

              // Bind both image (this page) and, when present, video (in included template)
              document.addEventListener('DOMContentLoaded', () => {
                bindPromptGenerator('image');
                // Attempt late-bind for video when switching tabs dynamically
                const tryBindVideo = () => bindPromptGenerator('video');
                tryBindVideo();
                document.addEventListener('videoModeChanged', tryBindVideo);
              });
            })();
          </script>

        </div>

        <div class="mt-3 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 text-xs sm:text-sm">
          <!-- Короткий совет -->
          <div class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-[var(--bord)]/60">
            <svg class="w-4 h-4 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/>
            </svg>
            <span class="text-[var(--text)]">Совет: опишите сюжет, ключевые детали и свет в 1–2 фразах. Техпараметры укажите отдельными тегами.</span>
          </div>
          <!-- Стоимость с иконкой токена -->

        </div>


      </div>

      <!-- Image Models Selection -->
      <div class="space-y-2">
        <label class="block text-xs sm:text-sm font-medium mb-1.5">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 flex-shrink-0 text-primary dark:text-primary/90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
            <span class="text-xs sm:text-sm">Модель</span>
          </span>
        </label>

        <!-- Selected image model for submit -->
        <input type="hidden" id="image-model-id" value="runware:101@1">

        <!-- Cards container used by static/js/generate.js -->
        <div id="image-model-cards" class="grid grid-cols-1 xs:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3">

          <div class="image-model-card-wrap flex flex-col">

            <div class="h-5 sm:h-6 mb-1 flex items-center gap-1">
              <svg class="w-3.5 h-3.5 text-amber-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
              <span class="text-[11px] sm:text-xs font-medium text-amber-600 dark:text-amber-400">Премиум</span>
            </div>

            <button type="button" class="image-model-card h-full w-full block group relative rounded-xl overflow-hidden border-2 border-[var(--bord)] bg-[var(--bg-card)] hover:border-primary transition-all focus:outline-none"
                    data-model="runware:z-image@turbo"
                    data-selected="1"
                    data-config='{"id": 3, "name": "\u0421\u0442\u0430\u043d\u0434\u0430\u0440\u0442\u043d\u0430\u044f", "model_id": "runware:z-image@turbo", "description": "\u0431\u044b\u0441\u0442\u0440\u0430\u044f \u0438 \u043a\u0430\u0447\u0435\u0441\u0442\u0432\u0435\u043d\u043d\u0430\u044f \u043c\u043e\u0434\u0435\u043b\u044c \u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u0438 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0439, \u043a\u043e\u0442\u043e\u0440\u0443\u044e \u044f \u0440\u0435\u043a\u043e\u043c\u0435\u043d\u0434\u0443\u044e \u0434\u043b\u044f \u0441\u043e\u0437\u0434\u0430\u043d\u0438\u044f \u0432\u0438\u0437\u0443\u0430\u043b\u044c\u043d\u043e\u0433\u043e \u043a\u043e\u043d\u0442\u0435\u043d\u0442\u0430 \u043f\u0440\u044f\u043c\u043e \u043d\u0430 \u0441\u0430\u0439\u0442\u0435.", "token_cost": 2, "optional_fields": {"seed": true, "steps": true, "prompt": true, "cfg_scale": true, "scheduler": true, "resolution": true, "auto_translate": true, "number_results": true, "negative_prompt": false, "prompt_generator": true, "reference_images": false}, "available_resolutions": [], "available_aspect_ratios": [], "min_width": 512, "max_width": 2048, "min_height": 512, "max_height": 2048, "min_steps": 1, "max_steps": 50, "default_steps": 9, "min_cfg_scale": 1.0, "max_cfg_scale": 50.0, "default_cfg_scale": 1.0, "max_reference_images": 1, "max_number_results": 20, "supports_steps": true, "supports_cfg_scale": true, "supports_scheduler": true, "supports_seed": true, "supports_negative_prompt": false, "supports_reference_images": false, "supports_multiple_results": true}'
                    aria-label="Выбрать модель Стандартная">
              <div class="card-hero relative aspect-[16/9] overflow-hidden bg-gradient-to-br from-gray-800 to-gray-900" style="aspect-ratio:16/9; min-height:180px;">

                <img src="/media/image_models/runware-z-image-turbo_qYtD4Cp.jpg" alt="Стандартная" class="absolute inset-0 w-full h-full object-cover" loading="eager" decoding="sync" >

                <div class="card-overlay absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-black/20 pointer-events-none"></div>
                <div class="absolute top-2 right-2 z-10">
                  <span class="px-2 py-1 rounded-full text-[10px] sm:text-xs font-semibold bg-primary/90 text-white shadow">
                    2 TOK
                  </span>
                </div>
                <div class="absolute inset-0 card-content flex flex-col items-center justify-center px-2 sm:px-4 text-center gap-1.5 sm:gap-2">
                  <h3 class="text-white font-bold text-base sm:text-lg mb-2 drop-shadow-lg">Стандартная</h3>

                  <p class="text-white/90 text-xs sm:text-sm leading-snug drop-shadow-md line-clamp-2">
                    быстрая и качественная модель генерации изображений, которую я рекомендую для создания визуального контента прямо на сайте.
                  </p>

                </div>
              </div>
            </button>
          </div>

          <div class="image-model-card-wrap flex flex-col">

            <div class="h-5 sm:h-6 mb-1 flex items-center gap-1">
              <svg class="w-3.5 h-3.5 text-amber-500" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
              </svg>
              <span class="text-[11px] sm:text-xs font-medium text-amber-600 dark:text-amber-400">Премиум</span>
            </div>

            <button type="button" class="image-model-card h-full w-full block group relative rounded-xl overflow-hidden border-2 border-[var(--bord)] bg-[var(--bg-card)] hover:border-primary transition-all focus:outline-none"
                    data-model="google:4@1"
                    data-selected="0"
                    data-config='{"id": 1, "name": "Nano Banana", "model_id": "google:4@1", "description": "\u043b\u0451\u0433\u043a\u0430\u044f \u0438 \u0431\u044b\u0441\u0442\u0440\u0430\u044f \u043c\u043e\u0434\u0435\u043b\u044c \u0433\u0435\u043d\u0435\u0440\u0430\u0446\u0438\u0438 \u0438\u0437\u043e\u0431\u0440\u0430\u0436\u0435\u043d\u0438\u0439, \u0438\u0434\u0435\u0430\u043b\u044c\u043d\u043e \u043f\u043e\u0434\u0445\u043e\u0434\u044f\u0449\u0430\u044f \u0434\u043b\u044f \u043f\u0440\u043e\u0441\u0442\u044b\u0445 \u0437\u0430\u0434\u0430\u0447 \u0438 \u043c\u0433\u043d\u043e\u0432\u0435\u043d\u043d\u043e\u0433\u043e \u0440\u0435\u0437\u0443\u043b\u044c\u0442\u0430\u0442\u0430 \u043f\u0440\u044f\u043c\u043e \u043d\u0430 \u0441\u0430\u0439\u0442\u0435", "token_cost": 6, "optional_fields": {"seed": true, "steps": false, "prompt": true, "cfg_scale": false, "scheduler": false, "resolution": true, "auto_translate": true, "number_results": true, "negative_prompt": false, "prompt_generator": true, "reference_images": true}, "available_resolutions": [], "available_aspect_ratios": [], "min_width": 512, "max_width": 2048, "min_height": 512, "max_height": 2048, "min_steps": 1, "max_steps": 50, "default_steps": 20, "min_cfg_scale": 1.0, "max_cfg_scale": 20.0, "default_cfg_scale": 7.0, "max_reference_images": 5, "max_number_results": 20, "supports_steps": false, "supports_cfg_scale": false, "supports_scheduler": false, "supports_seed": true, "supports_negative_prompt": false, "supports_reference_images": true, "supports_multiple_results": true}'
                    aria-label="Выбрать модель Nano Banana">
              <div class="card-hero relative aspect-[16/9] overflow-hidden bg-gradient-to-br from-gray-800 to-gray-900" style="aspect-ratio:16/9; min-height:180px;">

                <img src="/media/image_models/images_1_XLWPCy1.jpg" alt="Nano Banana" class="absolute inset-0 w-full h-full object-cover" loading="lazy" decoding="async" fetchpriority="low">

                <div class="card-overlay absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-black/20 pointer-events-none"></div>
                <div class="absolute top-2 right-2 z-10">
                  <span class="px-2 py-1 rounded-full text-[10px] sm:text-xs font-semibold bg-primary/90 text-white shadow">
                    6 TOK
                  </span>
                </div>
                <div class="absolute inset-0 card-content flex flex-col items-center justify-center px-2 sm:px-4 text-center gap-1.5 sm:gap-2">
                  <h3 class="text-white font-bold text-base sm:text-lg mb-2 drop-shadow-lg">Nano Banana</h3>

                  <p class="text-white/90 text-xs sm:text-sm leading-snug drop-shadow-md line-clamp-2">
                    лёгкая и быстрая модель генерации изображений, идеально подходящая для простых задач и мгновенного результата прямо на сайте
                  </p>

                </div>
              </div>
            </button>
          </div>

        </div>
      </div>

      <!-- Информация о выбранной модели (скрыта по умолчанию) -->
      <div id="image-model-info-section" class="hidden rounded-xl border border-[var(--bord)] bg-[var(--bg-card)] p-3 sm:p-4 space-y-3 mt-3">
        <!-- Заголовок с иконкой -->
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-lg bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center">
            <svg class="w-5 h-5 sm:w-6 sm:h-6 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
          </div>
          <div class="flex-1 min-w-0">
            <h3 id="image-model-info-name" class="text-sm sm:text-base font-semibold text-[var(--text)] mb-1"></h3>
            <p id="image-model-info-description" class="text-xs sm:text-sm text-[var(--muted)] line-clamp-2"></p>
          </div>
        </div>

        <!-- Параметры модели -->
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 pt-2 border-t border-[var(--bord)]">
          <!-- Стоимость -->
          <div class="flex items-center gap-2 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg bg-[var(--bord)]/40">
            <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-amber-500 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
            </svg>
            <div class="flex-1 min-w-0">
              <div class="text-[10px] sm:text-xs text-[var(--muted)] leading-tight">Стоимость</div>
              <div id="image-model-info-cost" class="text-xs sm:text-sm font-semibold text-[var(--text)] truncate">— TOK</div>
            </div>
          </div>
        </div>

        <!-- Доступные функции -->
        <div id="image-model-info-features" class="pt-2 border-t border-[var(--bord)]">
          <div class="text-[10px] sm:text-xs font-medium text-[var(--muted)] mb-2">Доступные параметры:</div>
          <div class="flex flex-wrap gap-1.5 sm:gap-2" id="image-model-features-list">
            <!-- Будет заполнено JS -->
          </div>
        </div>
      </div>

      <!-- Параметры генерации -->
      <div class="card p-6 mt-6" id="image-params-section">
    <h3 class="text-lg font-semibold mb-4">Параметры генерации</h3>

    <!-- Основные параметры  -->
    <div class="space-y-4 mb-6">
      <!-- Соотношение сторон -->
      <div id="aspect-ratio-field" class="field-container">
        <div id="aspect-ratio-slider-container"></div>
      </div>

      <!-- Качество -->
      <div id="quality-field" class="field-container">
        <label class="block text-sm font-medium mb-2 flex items-center gap-2">
          <svg class="w-4 h-4 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          Качество
        </label>
        <select id="quality-selector" name="quality" class="field w-full px-4 py-2.5 bg-[var(--bg-card)] border-2 border-[var(--bord)] rounded-xl text-[var(--text)] font-medium transition-all duration-200 hover:border-primary/50 focus:border-primary focus:ring-2 focus:ring-primary/20 cursor-pointer">
          <option value="">Сначала выберите соотношение сторон...</option>
        </select>
      </div>

      <!-- Размеры (скрытые поля, автозаполняются) -->
      <input type="hidden" id="id_width" name="width">
      <input type="hidden" id="id_height" name="height">

      <!-- Информация о размерах -->
      <div id="dimensions-info" class="px-4 py-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg" style="display:none;">
        <div class="flex items-center gap-2 text-sm">
          <svg class="w-4 h-4 text-blue-600 dark:text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="12" y1="16" x2="12" y2="12"/>
            <line x1="12" y1="8" x2="12.01" y2="8"/>
          </svg>
          <span class="text-blue-800 dark:text-blue-200">
            Размеры: <strong><span id="dimensions-display">—</span></strong>
          </span>
        </div>
      </div>

      <!-- Reference Images -->


<div class="reference-upload-compact" data-target="image" data-max-refs="5">
  <!-- Header with Beautiful Icon and Description -->
  <div class="flex items-start gap-3 mb-3">
    <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500/10 to-blue-500/5 flex items-center justify-center">
      <svg class="w-5 h-5 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
      </svg>
    </div>
    <div class="flex-1">
      <label class="block text-sm font-semibold text-[var(--text)] mb-1">
        Референсные изображения <span class="text-[var(--muted)] font-normal text-xs">(до <span class="ref-max-count">5</span>)</span>
      </label>
      <p class="text-xs text-[var(--muted)] leading-relaxed">Загрузите образцы для задания стиля, композиции или конкретных элементов будущего изображения.</p>
    </div>
  </div>

  <!-- Compact Upload Zone -->
  <div class="ref-compact-zone">
    <input type="file"
           class="ref-file-input-compact"
           accept="image/jpeg,image/jpg,image/png,image/webp"
           data-target="image"
           multiple
           title="Выберите фото">

    <div class="ref-drop-compact">
      <div class="flex flex-col items-center gap-2">
        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-blue-500/10 to-blue-500/5 flex items-center justify-center">
          <svg class="w-6 h-6 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
          </svg>
        </div>
        <div class="text-center">
          <p class="text-sm font-medium text-[var(--text)]">Нажмите для выбора</p>
          <p class="text-xs text-[var(--muted)] mt-0.5">или перетащите файлы сюда</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Compact Preview Grid -->
  <div class="ref-preview-compact hidden mt-2"></div>

  <!-- Compact Info -->
  <div class="flex items-center gap-1.5 mt-3 text-xs text-[var(--muted)]">
    <svg class="w-3.5 h-3.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="12" cy="12" r="10"/>
      <path d="M12 16v-4M12 8h.01"/>
    </svg>
    <span>JPG, PNG, WEBP • Макс. 10MB на файл • Рекомендуется 1024x1024</span>
  </div>
</div>

<style>
/* Compact Reference Upload - Tailwind-style with CSS Variables */
.reference-upload-compact {
  width: 100%;
}

/* Hidden File Input */
.ref-file-input-compact {
  position: absolute;
  width: 0.1px;
  height: 0.1px;
  opacity: 0;
  overflow: hidden;
  z-index: -1;
}

/* Compact Upload Zone */
.ref-compact-zone {
  position: relative;
  width: 100%;
}

.ref-drop-compact {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  padding: 1.5rem 1rem;
  border: 2px dashed var(--bord);
  border-radius: 0.75rem;
  background-color: var(--bg-card);
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Hover States */
.ref-drop-compact:hover {
  border-color: #3b82f6;
  background-color: rgba(59, 130, 246, 0.05);
  transform: translateY(-1px);
}

html[data-theme="dark"] .ref-drop-compact:hover {
  border-color: #3b82f6;
  background-color: rgba(59, 130, 246, 0.1);
}

/* Drag Over State */
.ref-drop-compact.drag-over {
  border-color: #3b82f6;
  background-color: rgba(59, 130, 246, 0.1);
  transform: scale(1.02);
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
}

html[data-theme="dark"] .ref-drop-compact.drag-over {
  background-color: rgba(59, 130, 246, 0.15);
}

/* Compact Preview Grid */
.ref-preview-compact {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
  gap: 0.5rem;
}

.ref-preview-compact.hidden {
  display: none;
}

/* Preview Item */
.ref-preview-item-compact {
  position: relative;
  aspect-ratio: 1;
  border-radius: 0.375rem;
  overflow: hidden;
  border: 1.5px solid #e5e7eb;
  background-color: #f3f4f6;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

html[data-theme="dark"] .ref-preview-item-compact {
  border-color: #374151;
  background-color: #1f2937;
}

.ref-preview-item-compact:hover {
  border-color: #6366f1;
  transform: scale(1.05);
}

.ref-preview-img-compact {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Remove Button */
.ref-remove-btn-compact {
  position: absolute;
  top: 0.125rem;
  right: 0.125rem;
  width: 1.25rem;
  height: 1.25rem;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(0, 0, 0, 0.75);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 9999px;
  color: white;
  cursor: pointer;
  opacity: 0;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.ref-preview-item-compact:hover .ref-remove-btn-compact {
  opacity: 1;
}

.ref-remove-btn-compact:hover {
  background-color: rgba(239, 68, 68, 0.9);
  transform: scale(1.15);
}

.ref-remove-btn-compact svg {
  width: 0.75rem;
  height: 0.75rem;
}

/* Responsive Adjustments */
@media (min-width: 480px) {
  .ref-preview-compact {
    grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
  }

  .ref-drop-compact {
    padding: 0.875rem 1.125rem;
  }
}

@media (min-width: 640px) {
  .ref-preview-compact {
    grid-template-columns: repeat(5, 1fr);
    gap: 0.625rem;
  }

  .ref-remove-btn-compact {
    width: 1.5rem;
    height: 1.5rem;
  }

  .ref-remove-btn-compact svg {
    width: 0.875rem;
    height: 0.875rem;
  }
}

@media (max-width: 375px) {
  .ref-drop-compact {
    padding: 0.625rem 0.75rem;
    gap: 0.5rem;
  }

  .ref-preview-compact {
    grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
    gap: 0.375rem;
  }
}

@media (max-width: 320px) {
  .ref-drop-compact {
    padding: 0.5rem 0.625rem;
    gap: 0.375rem;
  }

  .ref-drop-compact svg {
    width: 1rem;
    height: 1rem;
  }

  .ref-preview-compact {
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
  }
}
</style>

<script>
(function() {
  'use strict';

  function initCompactReferenceUpload(container) {
    if (container.dataset.initialized === 'true') {
      return;
    }
    container.dataset.initialized = 'true';

    const targetId = container.dataset.target || 'image';
    const fileInput = container.querySelector('.ref-file-input-compact');
    const dropArea = container.querySelector('.ref-drop-compact');
    const previewGrid = container.querySelector('.ref-preview-compact');
    const maxCountSpan = container.querySelector('.ref-max-count');

    let MAX_FILES = parseInt(container.dataset.maxRefs) || 5;
    const MAX_SIZE = 10 * 1024 * 1024; // 10MB
    let files = [];

    // Update max count display
    if (maxCountSpan) {
      maxCountSpan.textContent = MAX_FILES;
    }

    // Click to upload
    dropArea.addEventListener('click', () => {
      fileInput.click();
    });

    // File selection
    fileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files.length > 0) {
        handleFiles(Array.from(e.target.files));
      }
    });

    // Drag & Drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => {
        dropArea.classList.add('drag-over');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, () => {
        dropArea.classList.remove('drag-over');
      }, false);
    });

    dropArea.addEventListener('drop', (e) => {
      const droppedFiles = Array.from(e.dataTransfer.files);
      handleFiles(droppedFiles);
    }, false);

    function handleFiles(newFiles) {
      const validFiles = newFiles.filter(file => {
        if (!file.type.match(/^image\/(jpeg|jpg|png|webp)$/)) {
          showError(`${file.name}: неподдерживаемый формат`);
          return false;
        }
        if (file.size > MAX_SIZE) {
          showError(`${file.name}: превышен размер (макс. 10MB)`);
          return false;
        }
        return true;
      });

      if (validFiles.length === 0) return;

      const totalCount = files.length + validFiles.length;
      if (totalCount > MAX_FILES) {
        const canAdd = MAX_FILES - files.length;
        if (canAdd > 0) {
          showError(`Можно добавить ещё ${canAdd} фото (макс. ${MAX_FILES})`);
          files = files.concat(validFiles.slice(0, canAdd));
        } else {
          showError(`Достигнут лимит: ${MAX_FILES} фото`);
          return;
        }
      } else {
        files = files.concat(validFiles);
      }

      updatePreview();
      dispatchChange();
    }

    function updatePreview() {
      if (files.length === 0) {
        previewGrid.classList.add('hidden');
        previewGrid.innerHTML = '';
        return;
      }

      previewGrid.classList.remove('hidden');
      previewGrid.innerHTML = '';

      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const item = document.createElement('div');
          item.className = 'ref-preview-item-compact';
          item.innerHTML = `
            <img src="${e.target.result}" alt="Референс ${index + 1}" class="ref-preview-img-compact">
            <button type="button" class="ref-remove-btn-compact" data-index="${index}" aria-label="Удалить">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M6 6l12 12M18 6L6 18"/>
              </svg>
            </button>
          `;

          item.querySelector('.ref-remove-btn-compact').addEventListener('click', (e) => {
            e.stopPropagation();
            removeFile(index);
          });

          previewGrid.appendChild(item);
        };
        reader.readAsDataURL(file);
      });
    }

    function removeFile(index) {
      files.splice(index, 1);
      updatePreview();
      dispatchChange();
    }

    function dispatchChange() {
      container.dispatchEvent(new CustomEvent('referenceFilesChanged', {
        detail: { files, targetId },
        bubbles: true
      }));
    }

    function showError(message) {
      alert(message);
    }

    // Public API
    container.getReferenceFiles = () => files;
    container.clearReferenceFiles = () => {
      files = [];
      updatePreview();
      fileInput.value = '';
    };
    container.updateMaxRefs = (newMax) => {
      MAX_FILES = newMax;
      container.dataset.maxRefs = newMax;
      if (maxCountSpan) {
        maxCountSpan.textContent = newMax;
      }
      // Trim files if needed
      if (files.length > MAX_FILES) {
        files = files.slice(0, MAX_FILES);
        updatePreview();
        dispatchChange();
      }
    };
  }

  function init() {
    document.querySelectorAll('.reference-upload-compact').forEach(initCompactReferenceUpload);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  document.addEventListener('referenceUploadCompactInit', init);
})();
</script>

    </div>

    <!-- Дополнительные параметры (в шторке) -->
    <div class="border-t border-[var(--bord)] pt-4">
      <button type="button" id="toggle-advanced-params" class="w-full flex items-center justify-between px-4 py-3 bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors">
        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Дополнительные параметры</span>
        <svg class="w-5 h-5 text-gray-500 dark:text-gray-400 transition-transform duration-200" id="advanced-params-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </button>

      <div id="advanced-params-content" class="hidden mt-4 space-y-4 pl-4 border-l-2 border-gray-200 dark:border-gray-700">
        <!-- Steps -->
        <div id="steps-field" class="field-container">
          <label class="block text-sm font-medium mb-2">Steps (шаги)</label>
          <input type="number" id="steps-input" name="steps" class="field w-full" value="20" min="1" max="50">
        </div>

        <!-- CFG Scale -->
        <div id="cfg-scale-field" class="field-container">
          <label class="block text-sm font-medium mb-2">CFG Scale</label>
          <input type="number" id="cfg-scale-input" name="cfg_scale" class="field w-full" value="7.0" min="1.0" max="20.0" step="0.1">
        </div>

        <!-- Scheduler -->
        <div id="scheduler-field" class="field-container">
          <label class="block text-sm font-medium mb-2">Scheduler</label>
          <select id="scheduler-select" name="scheduler" class="field w-full">
            <option value="euler">Euler</option>
            <option value="euler_a" selected>Euler A</option>
            <option value="ddim">DDIM</option>
            <option value="dpm">DPM</option>
          </select>
        </div>

        <!-- Seed -->
        <div id="seed-field" class="field-container">
          <label class="block text-sm font-medium mb-2">Seed (опционально)</label>
          <input type="number" id="seed-input" name="seed" class="field w-full" placeholder="Случайный">
        </div>

        <!-- Negative Prompt -->
        <div id="negative-prompt-field" class="field-container">
          <label class="block text-sm font-medium mb-2">Negative Prompt</label>
          <textarea id="negative-prompt" name="negative_prompt" class="field w-full" rows="2" placeholder="Что не должно быть на изображении"></textarea>
        </div>

        <!-- Number of Results -->
        <div id="number-results-field" class="field-container">
          <label class="block text-sm font-medium mb-2">Количество изображений</label>
          <input type="number" id="number-results" name="number_results" class="field w-full" value="1" min="1" max="4">
        </div>
      </div>
    </div>
  </div>

      <style>
        /* Image model cards — responsive, dark/light, 320px-ready */
        .image-model-card { display:block; width:100%; position:relative; border-radius: 0.75rem; }
        .image-model-card:focus-visible { outline: 2px solid var(--primary); outline-offset: 2px; }
        .image-model-card[data-selected="1"] {
          outline: 2px solid var(--primary);
          outline-offset: -2px;
          box-shadow: 0 0 0 4px rgba(99,102,241,.12);
        }

        .card-hero { aspect-ratio: 16/9; min-height: clamp(140px, 28vw, 220px); }

        /* Fallback for older browsers without aspect-ratio */
        @supports not (aspect-ratio: 1 / 1) {
          .card-hero { position: relative; }
          .card-hero::before { content: ""; display: block; padding-top: 56.25%; }
          .card-hero > * { position: absolute; inset: 0; }
        }

        /* Ensure overlay readability */
        .image-model-card .card-overlay {
          background: linear-gradient(to top, rgba(0,0,0,.78) 10%, rgba(0,0,0,.35) 45%, transparent 70%);
        }
        html[data-theme="light"] .image-model-card .card-overlay {
          background: linear-gradient(to top, rgba(0,0,0,.70) 15%, rgba(0,0,0,.25) 45%, rgba(0,0,0,.10) 70%);
        }

        /* Scalable typography for headings/descriptions on the card */
        .image-model-card h3 { font-size: clamp(0.95rem, 1.5vw, 1.125rem); line-height: 1.25; }
        .image-model-card p { font-size: clamp(0.72rem, 1.35vw, 0.95rem); }

        /* Content wrapper sizing and text flow */
        .image-model-card .card-content { width: min(92%, 800px); margin-inline: auto; }
        .image-model-card p { overflow-wrap: anywhere; hyphens: auto; }

        /* Token badge polish */
        .image-model-card .token-badge { backdrop-filter: saturate(130%) blur(2px); }

        /* Small screens */
        @media (max-width: 480px) {
          .card-hero { min-height: 160px; }
          .image-model-card h3 { font-size: 0.95rem; }
          .image-model-card p { font-size: 0.8rem; }
        }
        @media (max-width: 375px) {
          .card-hero { min-height: 150px; }
          .image-model-card h3 { font-size: 0.9rem; }
          .image-model-card p { font-size: 0.75rem; }
        }
        @media (max-width: 320px) {
          .card-hero { min-height: 140px; }
          .image-model-card h3 { font-size: 0.85rem; }
          .image-model-card p { font-size: 0.72rem; }
        }
      </style>
      <style>
        .model-nav-btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          width: 2rem;
          height: 2rem;
          border-radius: 9999px;
          border: 1px solid var(--bord);
          background: var(--bg-card);
          color: var(--text);
          transition: all .2s ease;
        }
        .model-nav-btn:hover {
          border-color: rgba(99,102,241,.6);
          color: var(--primary);
          transform: translateY(-1px);
        }
        .model-nav-btn[aria-disabled="true"] {
          opacity: .5;
          pointer-events: none;
        }
      </style>

      <!-- Generate Button -->
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center flex-wrap justify-center gap-3 w-full sm:w-auto">
          <button class="btn btn-primary text-base px-8 py-3 w-full sm:w-auto" id="genBtn" type="submit">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
            Сгенерировать
          </button>
          <span class="inline-flex items-center gap-1.5 text-sm text-[var(--muted)]">
            <svg class="w-4 h-4 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 2M12 6a9 9 0 100 18 9 9 0 000-18zM12 2v2" />
            </svg>
            Обычно до 30 сек.
          </span>
        </div>


      </div>
    </div>

  <!-- Очередь генерации (создаётся динамически через JS) -->
  <div id="image-queue-placeholder" class="mt-6"></div>

  <style>
    /* Унификация размеров карточек фото с видео */
    .image-result-tile {
      width: 100%;
    }

    /* Улучшенное отображение на мобильных */
    @media (max-width: 640px) {
      #image-queue-card .grid {
        gap: 0.5rem;
      }

      .image-result-tile .aspect-square {
        min-height: 150px;
      }

      /* Оптимизация кнопок для тач-устройств */
      .image-result-tile a[target="_blank"] {
          width: 2rem !important;
          height: 2rem !important;
          right: 1rem!important;
      }

      .image-result-tile a[target="_blank"] svg {
        width: 0.875rem !important;
        height: 0.875rem !important;
      }

      /* Кнопка persist компактнее для 2 колонок */
      .image-result-tile .persist-btn {
        padding: 0.5rem 0.625rem;
        font-size: 0.75rem;
        min-height: 38px;
        line-height: 1.2;
      }

      /* Puzzle loader меньше на мобильных */
      .image-result-tile .puzzle-grid {
        width: 4rem !important;
        height: 4rem !important;
      }

      /* Текст генерации компактнее */
      .image-result-tile [data-role="tile-phase"] {
        font-size: 0.75rem !important;
      }

      .image-result-tile [data-role="tile-status"] {
        font-size: 0.625rem !important;
      }

      /* Padding карточки меньше */
      .image-result-tile > div:last-child {
        padding: 0.5rem !important;
      }
    }

      /* Компактные размеры для видео кнопок на мобильных */
      .video-play-btn {
        touch-action: manipulation !important;
      }

      .video-play-btn .play-btn-inner {
        width: 2.75rem !important;
        height: 2.75rem !important;
        background: rgba(0,0,0,0.55) !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.25) !important;
      }

      /* Маленькие иконки play и pause */
      .video-play-btn .play-icon,
      .video-play-btn .pause-icon {
        width: 1.125rem !important;
        height: 1.125rem !important;
      }

      /* Пауза должна быть видна */
      .video-play-btn .pause-icon {
        opacity: 1 !important;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
      }

      .volume-toggle-btn,
      a[target="_blank"] {
        touch-action: manipulation !important;
        width: 2.25rem !important;
        height: 2.25rem !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.25) !important;
        background: rgba(0,0,0,0.55) !important;
      }

      /* Кнопки по углам - Volume слева внизу, Open справа вверху */
      .volume-toggle-btn {
        bottom: 0.5rem !important;
        left: 0.5rem !important;
        right: auto !important;
      }

      .volume-toggle-btn svg {
        width: 1rem !important;
        height: 1rem !important;
      }

      a[target="_blank"] {
        top: 0.5rem !important;
        right: 0.5rem !important;
      }

      a[target="_blank"] svg {
        width: 1rem !important;
        height: 1rem !important;
      }
    }

    /* Для очень маленьких экранов */
    @media (max-width: 375px) {
      .image-result-tile .aspect-square {
        min-height: 180px;
      }

      .video-play-btn .play-btn-inner {
        width: 2.5rem !important;
        height: 2.5rem !important;
      }

      .video-play-btn .play-icon,
      .video-play-btn .pause-icon {
        width: 1rem !important;
        height: 1rem !important;
      }

      .volume-toggle-btn,
      a[target="_blank"] {
        width: 2rem !important;
        height: 2rem !important;
      }

      .volume-toggle-btn svg,
      a[target="_blank"] svg {
        width: 0.875rem !important;
        height: 0.875rem !important;
      }
    }


    @media (min-width: 641px) and (max-width: 1024px) {
      #image-queue-card .grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>

  <!-- Параметры генерации (под очередью) -->

  </form>

  <!-- ФОРМА ГЕНЕРАЦИИ ВИДЕО -->
  <div id="video-form-container" class="space-y-8" style="display: none;">
    <div class="card p-2">
      <!-- Форма генерации видео -->
<div id="video-generation-form" class="space-y-6">

  <!-- Переключатель I2V / T2V -->
  <div id="video-mode-block">
    <label class="block text-sm font-medium mb-2 sm:mb-3">Режим генерации</label>
    <div class="inline-flex rounded-xl bg-[var(--bord)] p-1 gap-1 w-full sm:w-auto">
      <!-- I2V - Фото/Видео (по умолчанию) -->
      <button type="button" class="video-source-tab video-source-i2v active flex-1 sm:flex-initial px-2.5 xs:px-3 sm:px-4 py-2 sm:py-2.5 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 text-xs sm:text-sm font-medium" data-source="i2v" title="Фото/Видео">
        <div class="relative flex-shrink-0">
          <!-- Photo icon -->
          <svg class="source-icon w-4 h-4 sm:w-5 sm:h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" aria-hidden="true">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
            <circle cx="8.5" cy="8.5" r="1.5" fill="currentColor"/>
            <polyline points="21 15 16 10 5 21"/>
          </svg>
          <!-- Elegant orange sparkle -->
          <svg class="sparkle-icon absolute -top-1 -left-1 w-2.5 h-2.5 sm:w-3 sm:h-3" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
            <path d="M12 2l2.2 4.6L19 9l-4.8 2.4L12 16l-2.2-4.6L5 9l4.8-2.4L12 2z"></path>
          </svg>
        </div>
        <span class="whitespace-nowrap" style="display: inline-block !important; visibility: visible !important; opacity: 1 !important; max-width: none !important; overflow: visible !important;">Фото/Видео</span>
      </button>

      <!-- T2V - Текст/Видео -->
      <button type="button" class="video-source-tab flex-1 sm:flex-initial px-2.5 xs:px-3 sm:px-4 py-2 sm:py-2.5 rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5 sm:gap-2 text-xs sm:text-sm font-medium" data-source="t2v" title="Текст/Видео">
        <svg class="source-icon w-4 h-4 sm:w-5 sm:h-5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M23 7l-7 5 7 5V7z"/>
          <rect x="1" y="5" width="15" height="14" rx="2" ry="2"/>
        </svg>
        <span class="whitespace-nowrap" style="display: inline-block !important; visibility: visible !important; opacity: 1 !important; max-width: none !important; overflow: visible !important;">Текст/Видео</span>
      </button>
    </div>
  </div>

  <style id="video-tab-force-visible-v3">
    /* Video source tabs - ULTRA FORCED VISIBILITY - v3 */
    .video-source-tab,
    button.video-source-tab,
    .video-source-tab.active,
    button.video-source-tab.active {
      cursor: pointer !important;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1) !important;
      background: transparent !important;
      border: none !important;
      position: relative !important;
      overflow: visible !important;
      max-width: none !important;
      width: auto !important;
    }

    .video-source-tab span,
    .video-source-tab span.whitespace-nowrap,
    .video-source-tab.active span,
    .video-source-tab.active span.whitespace-nowrap,
    button.video-source-tab span,
    button.video-source-tab span.whitespace-nowrap,
    button.video-source-tab.active span,
    button.video-source-tab.active span.whitespace-nowrap {
      display: inline-block !important;
      visibility: visible !important;
      opacity: 1 !important;
      font-size: 0.75rem !important;
      color: inherit !important;
      max-width: none !important;
      width: auto !important;
      overflow: visible !important;
      text-overflow: clip !important;
      white-space: nowrap !important;
      content: attr(data-text) !important;
    }

    @media (min-width: 640px) {
      .video-source-tab span,
      .video-source-tab span.whitespace-nowrap {
        font-size: 0.875rem !important;
      }
    }

    .video-source-tab .source-icon {
      color: var(--muted);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .video-source-tab.active {
      background: var(--bg-card);
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }

    :root[data-theme="dark"] .video-source-tab.active {
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
    }

    /* Default T2V styling */
    .video-source-tab.active .source-icon {
      color: var(--primary);
      filter: drop-shadow(0 0 6px rgba(99, 102, 241, 0.4));
    }

    /* Special I2V "Оживить фото" styling with elegant orange sparkle */
    .video-source-i2v .sparkle-icon {
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      color: #f59e0b; /* amber-500 */
      filter: drop-shadow(0 0 2px rgba(245, 158, 11, 0.6));
    }

    .video-source-i2v.active .source-icon {
      color: #f97316; /* orange-500 */
      filter: drop-shadow(0 0 8px rgba(249, 115, 22, 0.5));
    }

    .video-source-i2v.active .sparkle-icon {
      opacity: 1;
      color: #fbbf24; /* amber-400 */
      filter: drop-shadow(0 0 6px rgba(251, 191, 36, 0.9));
      animation: sparkle 2s ease-in-out infinite;
    }

    @keyframes sparkle {
      0%, 100% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
      }
      50% {
        transform: scale(1.15) rotate(10deg);
        opacity: 0.92;
      }
    }

    /* Hover states */
    .video-source-tab:hover:not(.active) {
      background: rgba(0, 0, 0, 0.05);
    }

    :root[data-theme="dark"] .video-source-tab:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
    }

    .video-source-tab:hover:not(.active) .source-icon {
      color: var(--fg);
    }

    /* Responsive breakpoint for xs (475px) */
    @media (min-width: 475px) {
      .xs\:inline {
        display: inline !important;
      }
      .xs\:px-3 {
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }
    }

    /* Ultra-small screens (320px) - keep text visible */
    @media (max-width: 374px) {
      .video-source-tab {
        font-size: 0.65rem;
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
      }
      .video-source-tab .source-icon {
        width: 0.75rem;
        height: 0.75rem;
      }
      .video-source-i2v .sparkle-icon {
        width: 0.5rem;
        height: 0.5rem;
      }
      .video-source-tab span {
        font-size: 0.65rem;
      }
    }
  </style>

  <!-- Описание сцены -->
  <div>
    <div class="flex items-center justify-between mb-3">
      <label class="block text-sm font-medium" for="video-prompt">Описание сцены</label>
      <div class="inline-flex items-center gap-2">
        <span class="text-[11px] sm:text-xs text-[var(--muted)]">Автоперевод</span>
        <button
          type="button"
          id="auto-translate-toggle"
          class="relative inline-flex h-6 w-11 items-center rounded-full bg-[var(--bord)] ring-1 ring-[var(--bord)] transition focus:outline-none focus:ring-2 focus:ring-primary/50"
          aria-pressed="true"
          aria-label="Автоперевод">
          <span class="sr-only">Автоперевод</span>
          <span class="dot translate-x-5 inline-block h-5 w-5 transform rounded-full bg-white shadow transition"></span>
        </button>
      </div>
    </div>
    <textarea
      id="video-prompt"
      class="field w-full min-h-28 resize-none"
      placeholder="Пример: cinematic dusk city, neon reflections, slow orbit camera, moody atmosphere"
      maxlength="1500"></textarea>

    <div class="mt-3">
      <div class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-[var(--bord)]/60">
        <svg class="w-4 h-4 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M12 2a10 10 0 100 20 10 10 0 000-20z"/>
        </svg>
        <span class="text-[var(--text)]">Совет: опишите действие, движение камеры и атмосферу</span>
      </div>
    </div>

    <!-- Enhanced Prompt Generator for Video - Simplified UI -->
    <div id="pg-video" class="mt-2 flex items-center justify-end gap-3">
      <span id="pg-video-status" class="text-xs text-[var(--muted)] hidden"></span>
      <button
        type="button"
        id="pg-video-btn"
        class="btn btn-primary text-sm"
        title="Улучшить промпт с помощью AI">
        <svg id="pg-video-loading" class="hidden animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <circle cx="12" cy="12" r="10" stroke-width="4" class="opacity-25"/>
          <path d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor"/>
        </svg>
        <svg id="pg-video-icon" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"/>
        </svg>
        <span>Улучшить промпт</span>
      </button>
    </div>


  </div>

  <!-- I2V: Компактная загрузка фото под промптом -->
  <!-- I2V: Исходное фото -->
  <div id="i2v-upload-compact" style="display:none" class="space-y-3 p-4 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)]">
    <div class="flex items-start gap-3">
      <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-gradient-to-br from-primary/10 to-primary/5 flex items-center justify-center">
        <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
      </div>
      <div class="flex-1">
        <label class="block text-sm font-semibold text-[var(--text)] mb-1">
          Исходное фото
        </label>
        <p class="text-xs text-[var(--muted)] leading-relaxed">Загрузите изображение, которое будет анимировано. AI создаст видео на основе этого фото.</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <input type="file" id="video-source-image" accept="image/*" class="hidden">
      <button type="button" onclick="document.getElementById('video-source-image').click()" class="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg border-2 border-dashed border-[var(--bord)] hover:border-primary hover:bg-primary/5 transition-all duration-200 text-sm font-medium group">
        <svg class="w-4 h-4 text-[var(--muted)] group-hover:text-primary transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
        </svg>
        <span id="i2v-file-name" class="text-[var(--text)]">Выбрать файл</span>
      </button>
      <button type="button" id="remove-video-image" class="hidden p-2.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 transition-colors">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="flex items-center gap-1.5 text-xs text-[var(--muted)]">
      <svg class="w-3.5 h-3.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 16v-4M12 8h.01"/>
      </svg>
      <span>JPG, PNG, WEBP • Макс. 10MB • Рекомендуется 1024x1024</span>
    </div>
  </div>

  <!-- T2V: Референсное изображение -->
  <div id="t2v-references-section" style="display:none" class="space-y-3 p-4 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] mt-4">
    <div class="flex items-start gap-3">
      <div class="flex-shrink-0 w-10 h-10 rounded-lg bg-gradient-to-br from-purple-500/10 to-purple-500/5 flex items-center justify-center">
        <svg class="w-5 h-5 text-purple-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
      </div>
      <div class="flex-1">
        <label class="block text-sm font-semibold text-[var(--text)] mb-1">
          Референсное фото <span class="text-[var(--muted)] font-normal">(опционально)</span>
        </label>
        <p class="text-xs text-[var(--muted)] leading-relaxed">Добавьте изображение для задания стиля, композиции и настроения будущего видео.</p>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <input type="file" id="t2v-reference-images" accept="image/*" class="hidden">
      <button type="button" onclick="document.getElementById('t2v-reference-images').click()" class="flex-1 flex items-center justify-center gap-2 px-4 py-2.5 rounded-lg border-2 border-dashed border-[var(--bord)] hover:border-purple-500 hover:bg-purple-500/5 transition-all duration-200 text-sm font-medium group">
        <svg class="w-4 h-4 text-[var(--muted)] group-hover:text-purple-500 transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
        </svg>
        <span id="t2v-file-name" class="text-[var(--text)]">Выбрать файл</span>
      </button>
      <button type="button" id="remove-t2v-reference" class="hidden p-2.5 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 transition-colors">
        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="flex items-center gap-1.5 text-xs text-[var(--muted)]">
      <svg class="w-3.5 h-3.5 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 16v-4M12 8h.01"/>
      </svg>
      <span>JPG, PNG, WEBP • Макс. 10MB • Влияет на стиль и композицию</span>
    </div>
  </div>

  <!-- Параметры генерации - Компактный блок -->
  <div class="space-y-2 sm:space-y-3">

    <!-- Модель с описанием -->
    <div class="space-y-1" id="video-model-section">
      <label class="block text-xs sm:text-sm font-medium mb-1.5">
        <span class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 flex-shrink-0 text-primary dark:text-primary/90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          <span class="text-xs sm:text-sm">Модель</span>
        </span>
      </label>

      <!-- Храним выбранную модель для сабмита -->
      <input type="hidden" id="video-model" value="">

      <!-- Грид карточек моделей -->
      <div id="model-cards" class="grid grid-cols-1 xs:grid-cols-2 lg:grid-cols-3 gap-2 sm:gap-3"></div>
    </div>

    <!-- Информация о выбранной модели -->
    <div id="model-info-section" class="hidden rounded-xl border border-[var(--bord)] bg-[var(--bg-card)] p-3 sm:p-4 space-y-3">
      <!-- Заголовок с иконкой -->
      <div class="flex items-start gap-3">
        <div class="flex-shrink-0 w-10 h-10 sm:w-12 sm:h-12 rounded-lg bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center">
          <svg class="w-5 h-5 sm:w-6 sm:h-6 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
        </div>
        <div class="flex-1 min-w-0">
          <h3 id="model-info-name" class="text-sm sm:text-base font-semibold text-[var(--text)] mb-1"></h3>
          <p id="model-info-description" class="text-xs sm:text-sm text-[var(--muted)] line-clamp-2"></p>
        </div>
      </div>

      <!-- Параметры модели -->
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 pt-2 border-t border-[var(--bord)]">
        <!-- Стоимость -->
        <div class="flex items-center gap-2 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg bg-[var(--bord)]/40">
          <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-amber-500 flex-shrink-0" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .84.65 1.39 2.67 1.91s4.18 1.39 4.18 3.91c-.01 1.83-1.38 2.83-3.12 3.16z"/>
          </svg>
          <div class="flex-1 min-w-0">
            <div class="text-[10px] sm:text-xs text-[var(--muted)] leading-tight">Стоимость</div>
            <div id="model-info-cost" class="text-xs sm:text-sm font-semibold text-[var(--text)] truncate">— TOK</div>
          </div>
        </div>

        <!-- Макс. длительность -->
        <div class="flex items-center gap-2 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg bg-[var(--bord)]/40">
          <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-500 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 6v6l4 2"/>
          </svg>
          <div class="flex-1 min-w-0">
            <div class="text-[10px] sm:text-xs text-[var(--muted)] leading-tight">Макс. время</div>
            <div id="model-info-duration" class="text-xs sm:text-sm font-semibold text-[var(--text)] truncate">— сек</div>
          </div>
        </div>

        <!-- Разрешение -->
        <div class="flex items-center gap-2 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg bg-[var(--bord)]/40">
          <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-purple-500 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="2" y="3" width="20" height="14" rx="2"/>
            <path d="M8 21h8M12 17v4"/>
          </svg>
          <div class="flex-1 min-w-0">
            <div class="text-[10px] sm:text-xs text-[var(--muted)] leading-tight">Разрешение</div>
            <div id="model-info-resolution" class="text-xs sm:text-sm font-semibold text-[var(--text)] truncate">—</div>
          </div>
        </div>

        <!-- Категория -->
        <div class="flex items-center gap-2 px-2 sm:px-3 py-1.5 sm:py-2 rounded-lg bg-[var(--bord)]/40">
          <svg class="w-3.5 h-3.5 sm:w-4 sm:h-4 text-green-500 flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343"/>
            <path d="M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
          </svg>
          <div class="flex-1 min-w-0">
            <div class="text-[10px] sm:text-xs text-[var(--muted)] leading-tight">Тип</div>
            <div id="model-info-category" class="text-xs sm:text-sm font-semibold text-[var(--text)] truncate">—</div>
          </div>
        </div>
      </div>

      <!-- Доступные функции -->
      <div id="model-info-features" class="pt-2 border-t border-[var(--bord)]">
        <div class="text-[10px] sm:text-xs font-medium text-[var(--muted)] mb-2">Доступные параметры:</div>
        <div class="flex flex-wrap gap-1.5 sm:gap-2" id="model-features-list">
          <!-- Будет заполнено JS -->
        </div>
      </div>
    </div>

    <!-- Сетка параметров 2 колонки на больших экранах -->
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 sm:gap-3">

      <!-- Длительность -->
      <div id="duration-section" class="space-y-1">
        <label class="block text-xs sm:text-sm font-medium mb-1.5">Длительность</label>
        <div id="duration-options" class="flex flex-wrap gap-2">
          <!-- Кнопки длительности будут сгенерированы JS в зависимости от модели -->
        </div>
        <!-- Храним выбранное значение -->
        <input type="hidden" id="video-duration" value="5">
      </div>

      <!-- Разрешение с иконками -->
      <div class="space-y-1">
        <label class="block text-xs sm:text-sm font-medium mb-1.5" for="video-resolution">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 flex-shrink-0 text-primary dark:text-primary/90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <rect x="2" y="3" width="20" height="14" rx="2" stroke-width="2"/>
              <path d="M8 21h8" stroke-width="2" stroke-linecap="round"/>
              <path d="M12 17v4" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="text-xs sm:text-sm">Разрешение</span>
          </span>
        </label>
        <select id="video-resolution" class="field w-full text-xs sm:text-sm h-9 sm:h-10 rounded-md border border-[var(--bord)] bg-[var(--bg-card)] dark:bg-gray-900 px-2.5 sm:px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary/50 transition-all duration-200 appearance-none text-white dark:text-white light:text-black shadow-inner">
          <optgroup label="📺 Ландшафт 16:9">
            <option value="1920x1080">1920×1080 (Full HD)</option>
            <option value="1280x720">1280×720 (HD)</option>
            <option value="854x480">854×480 (SD)</option>
          </optgroup>
          <optgroup label="📱 Портрет 9:16">
            <option value="1080x1920">1080×1920 (Full HD)</option>
            <option value="720x1280">720×1280 (HD)</option>
            <option value="480x854">480×854 (SD)</option>
          </optgroup>
          <optgroup label="⬜ Квадрат 1:1">
            <option value="1080x1080">1080×1080 (Full HD)</option>
            <option value="720x720">720×720 (HD)</option>
            <option value="480x480">480×480 (SD)</option>
          </optgroup>
        </select>
      </div>

      <!-- Камера -->
      <div class="space-y-1">
        <label class="block text-xs sm:text-sm font-medium mb-1.5" for="video-camera">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 flex-shrink-0 text-primary dark:text-primary/90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M23 7l-7 5 7 5V7z" stroke-width="2"/>
              <rect x="1" y="5" width="15" height="14" rx="2" stroke-width="2"/>
            </svg>
            <span class="text-xs sm:text-sm">Движение камеры</span>
          </span>
        </label>
        <select id="video-camera" class="field w-full text-xs sm:text-sm h-9 sm:h-10 rounded-md border border-[var(--bord)] bg-[var(--bg-card)] dark:bg-gray-900 px-2.5 sm:px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary/50 transition-all duration-200 appearance-none text-white dark:text-white light:text-black shadow-inner">
          <option value="">Авто</option>
          <option value="static">Static (статичная)</option>
          <option value="slow pan">Slow Pan (панорама)</option>
          <option value="orbit">Orbit (орбита)</option>
          <option value="dolly">Dolly (наезд/отъезд)</option>
        </select>
      </div>

      <!-- Seed -->
      <div class="space-y-1">
        <label class="block text-xs sm:text-sm font-medium mb-1.5" for="video-seed">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 flex-shrink-0 text-primary dark:text-primary/90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
            </svg>
            <span class="text-xs sm:text-sm">Seed</span> <span class="text-[11px] sm:text-xs text-[var(--muted)] font-normal">(опционально)</span>
          </span>
        </label>
        <input type="text" id="video-seed" class="field w-full text-xs sm:text-sm h-9 sm:h-10 rounded-md border border-[var(--bord)] bg-[var(--bg-card)] px-2.5 sm:px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary/50 transition-all duration-200" placeholder="Случайный">
      </div>
    </div>

    <!-- Video Quantity Selector -->
    <div id="video-quantity-container" class="sm:col-span-2 space-y-1.5" style="display: none;">
      <label class="block text-xs sm:text-sm font-medium mb-1.5">
        <span class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 flex-shrink-0 text-primary dark:text-primary/90" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
          </svg>
          <span class="text-xs sm:text-sm">Количество видео</span>
        </span>
      </label>
      <div class="moon-slider-container">
        <div class="flex items-center gap-3 sm:gap-4">
          <input
            type="range"
            id="video-quantity"
            name="number_videos"
            class="moon-slider flex-1"
            min="1"
            max="4"
            value="1"
            step="1"
            data-value-id="video-quantity-value"
          >
          <div class="moon-slider-value">
            <span id="video-quantity-value" class="moon-slider-value-number">1</span>
            <span class="moon-slider-value-unit">видео</span>
          </div>
        </div>
        <p class="text-[10px] sm:text-xs text-[var(--muted)] mt-1">
          💡 Цена умножается на количество видео
        </p>
      </div>
    </div>
  </div>

  <style>
    /* Улучшенные стили для select - читаемость на обеих темах */
    .field select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%236366f1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1.25rem;
      padding-right: 2.5rem;
      color: var(--text) !important;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.5);
    }

    :root[data-theme="dark"] .field select {
      color: #ffffff !important;
      background-color: #1f2937 !important;
    }

    :root[data-theme="light"] .field select {
      color: #000000 !important;
      background-color: #ffffff !important;
    }

    /* Усиление для выбранного значения */
    .field select option:checked {
      color: white !important;
      background: #6366f1 !important;
    }

    /* Optgroup стили для лучшей читаемости */
    .field select optgroup {
      font-weight: 600;
      font-size: 0.875rem;
      padding: 0.5rem 0;
      background: transparent;
      color: inherit !important;
    }

    :root[data-theme="dark"] .field select optgroup {
      background: rgba(255, 255, 255, 0.08) !important;
      color: #e5e7eb !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    :root[data-theme="light"] .field select optgroup {
      background: rgba(0, 0, 0, 0.04) !important;
      color: #374151 !important;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .field select option {
      padding: 0.75rem 0.5rem;
      font-size: 0.875rem;
      color: inherit !important;
    }

    :root[data-theme="dark"] .field select option {
      background: #1f2937 !important;
      color: #f9fafb !important;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    :root[data-theme="dark"] .field select option:checked {
      background: #6366f1 !important;
      color: white !important;
    }

    :root[data-theme="light"] .field select option {
      background: #ffffff !important;
      color: #111827 !important;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    :root[data-theme="light"] .field select option:checked {
      background: #6366f1 !important;
      color: white !important;
    }

    /* Slider стили — «синяя луна», перекатывающаяся по линии */
    .slider-thumb {
      appearance: none;
      background: transparent;
      width: 100%;
      height: 8px;
      border-radius: 9999px;
    }

    /* WebKit thumb */
    .slider-thumb::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background:
        radial-gradient(closest-side, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.8) 40%, rgba(255,255,255,0.0) 60%),
        radial-gradient(circle at 30% 30%, #93c5fd 0%, #60a5fa 35%, #3b82f6 65%, #2563eb 100%);
      border: 2px solid rgba(255,255,255,0.75);
      box-shadow:
        0 0 0 3px rgba(59,130,246,0.15),
        0 8px 18px rgba(59,130,246,0.35),
        inset 0 -2px 4px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: transform .15s ease, box-shadow .2s ease;
    }
    .slider-thumb::-webkit-slider-thumb:hover {
      transform: translateY(-1px) scale(1.05);
      box-shadow:
        0 0 0 4px rgba(59,130,246,0.2),
        0 10px 22px rgba(59,130,246,0.45),
        inset 0 -2px 4px rgba(0,0,0,0.2);
    }
    .slider-thumb::-webkit-slider-thumb:active {
      transform: scale(0.98);
      box-shadow:
        0 0 0 2px rgba(59,130,246,0.25),
        0 6px 16px rgba(59,130,246,0.35),
        inset 0 -1px 3px rgba(0,0,0,0.25);
    }

    /* Firefox thumb */
    .slider-thumb::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background:
        radial-gradient(closest-side, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.8) 40%, rgba(255,255,255,0.0) 60%),
        radial-gradient(circle at 30% 30%, #93c5fd 0%, #60a5fa 35%, #3b82f6 65%, #2563eb 100%);
      border: 2px solid rgba(255,255,255,0.75);
      box-shadow:
        0 0 0 3px rgba(59,130,246,0.15),
        0 8px 18px rgba(59,130,246,0.35),
        inset 0 -2px 4px rgba(0,0,0,0.15);
      cursor: pointer;
      transition: transform .15s ease, box-shadow .2s ease;
    }
    .slider-thumb::-moz-range-thumb:hover {
      transform: translateY(-1px) scale(1.05);
      box-shadow:
        0 0 0 4px rgba(59,130,246,0.2),
        0 10px 22px rgba(59,130,246,0.45),
        inset 0 -2px 4px rgba(0,0,0,0.2);
    }
    .slider-thumb::-moz-range-thumb:active {
      transform: scale(0.98);
      box-shadow:
        0 0 0 2px rgba(59,130,246,0.25),
        0 6px 16px rgba(59,130,246,0.35),
        inset 0 -1px 3px rgba(0,0,0,0.25);
    }

    /* Трек с «заполнением» слева направо */
    .slider-thumb::-webkit-slider-runnable-track {
      height: 8px;
      border-radius: 9999px;
      background:
        linear-gradient(to right, rgba(59,130,246,0.85) 0%, rgba(59,130,246,0.85) var(--value, 50%), rgba(255,255,255,0.08) var(--value, 50%), rgba(255,255,255,0.08) 100%);
      box-shadow: inset 0 1px 1px rgba(255,255,255,0.06);
    }
    .slider-thumb::-moz-range-track {
      height: 8px;
      border-radius: 9999px;
      background: rgba(255,255,255,0.08);
      box-shadow: inset 0 1px 1px rgba(255,255,255,0.06);
    }
    .slider-thumb::-moz-range-progress {
      height: 8px;
      border-radius: 9999px;
      background: rgba(59,130,246,0.85);
    }

    /* Адаптив для маленьких экранов (320px+) */
    @media (max-width: 374px) {
      .field select,
      .field input,
      .field textarea {
        font-size: 0.75rem;
        padding-left: 0.75rem !important;
        padding-right: 0.75rem !important;
      }

      label {
        font-size: 0.75rem;
      }

      .grid {
        gap: 0.75rem !important;
      }

      .space-y-2 > * + * {
        margin-top: 0.5rem !important;
      }

      svg {
        width: 0.875rem !important;
        height: 0.875rem !important;
      }
    }

    /* Улучшения видимости в темах для selects */
    :root[data-theme="dark"] .field select option:hover,
    :root[data-theme="dark"] .field select optgroup:hover {
      background: rgba(99, 102, 241, 0.2) !important;
      color: #ffffff !important;
    }

    :root[data-theme="light"] .field select option:hover,
    :root[data-theme="light"] .field select optgroup:hover {
      background: rgba(99, 102, 241, 0.1) !important;
      color: #111827 !important;
    }

    /* Placeholder стили для лучшей видимости */
    .field input::placeholder,
    .field textarea::placeholder,
    .field select option[value=""] {
      color: #9ca3af !important;
    }

    :root[data-theme="dark"] .field input::placeholder,
    :root[data-theme="dark"] .field textarea::placeholder,
    :root[data-theme="dark"] .field select option[value=""] {
      color: #d1d5db !important;
    }

    :root[data-theme="light"] .field input::placeholder,
    :root[data-theme="light"] .field textarea::placeholder,
    :root[data-theme="light"] .field select option[value=""] {
      color: #6b7280 !important;
    }

    /* Текст в inputs для тем */
    .field input,
    .field textarea,
    .field select {
      color: var(--text) !important;
    }

    :root[data-theme="dark"] .field input,
    :root[data-theme="dark"] .field textarea,
    :root[data-theme="dark"] .field select {
      color: #f9fafb !important;
    }

    :root[data-theme="light"] .field input,
    :root[data-theme="light"] .field textarea,
    :root[data-theme="light"] .field select {
      color: #111827 !important;
    }

    /* I2V compact square upload */
    #i2v-upload-compact .i2v-square {
      aspect-ratio: 1 / 1;
      width: clamp(100px, 22vw, 140px); /* ещё компактнее: маленький квадратный блок */
      position: relative;
      overflow: hidden;
      border-radius: 0.75rem;
      flex: 0 0 auto; /* не растягиваться во флексе */
    }
    #i2v-upload-compact .i2v-square img {
      width: 100%;
      height: 100%;
      object-fit: contain; /* показываем всю фотографию, без обрезки */
      background: var(--bg-card);
    }
    /* Подсказка внутри области загрузки — центрируем по квадрату */
    #i2v-upload-compact #video-upload-area > .h-full {
      height: 100%;
    }
    /* Сделать внутренности реально компактными в маленьком квадрате */
    #i2v-upload-compact #video-upload-area { padding: 0.5rem !important; }
    #i2v-upload-compact #video-upload-area svg { width: 20px; height: 20px; }

    /* Overlay remove button on preview */
    #i2v-upload-compact .i2v-remove-btn {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 28px;
      height: 28px;
      border-radius: 9999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.25);
      color: #fff;
      cursor: pointer;
      transition: all .15s ease;
    }
    #i2v-upload-compact .i2v-remove-btn:hover {
      background: rgba(0,0,0,0.75);
      transform: scale(1.04);
      box-shadow: 0 2px 8px rgba(0,0,0,0.35);
    }
    html[data-theme="light"] #i2v-upload-compact .i2v-remove-btn {
      background: rgba(0,0,0,0.5);
      border-color: rgba(0,0,0,0.2);
    }

    /* Компоновка: компактный квадрат слева от текста/подсказок */
    #i2v-upload-compact {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    /* ===== VIDEO MODEL CARDS - В СТИЛЕ САЙТА ===== */

    /* Grid System - Equal Height Cards */
    #model-cards {
      display: grid;
      grid-template-columns: 1fr;
      gap: 1rem;
      align-items: stretch;
    }

    @media (min-width: 480px) {
      #model-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
      }
    }

    @media (min-width: 1024px) {
      #model-cards {
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
      }
    }

    /* Model Card Wrapper */
    .model-card-wrap {
      position: relative;
      display: flex;
      flex-direction: column;
    }

    /* Model Card - Full Height */
    .model-card {
      display: flex;
      flex-direction: column;
      height: 100%;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .model-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    [data-theme="dark"] .model-card {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    [data-theme="dark"] .model-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    /* Selected state - blue border only for chosen card (supports data-selected and ARIA) */
    .model-card[data-selected="1"],
    .model-card.selected,
    .model-card[aria-selected="true"] {
      border-color: var(--primary) !important;
      box-shadow: 0 0 0 2px rgba(99,102,241,0.35) inset, 0 6px 16px rgba(99,102,241,0.15);
    }
    .model-card[data-selected="0"],
    .model-card[aria-selected="false"] {
      border-color: var(--bord) !important;
      box-shadow: none;
    }

    /* Responsive */
    @media (max-width: 640px) {
      #model-cards {
        gap: 0.75rem;
      }

      .model-card {
        border-radius: 0.75rem;
      }
    }

    @media (max-width: 374px) {
      #model-cards {
        gap: 0.5rem;
      }

      .model-card {
        border-radius: 0.625rem;
      }

      .model-card .grid-cols-3 {
        gap: 0.375rem;
      }
    }

    /* Line Clamp */
    .line-clamp-1 {
      display: -webkit-box;
      -webkit-line-clamp: 1;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>

  <!-- I2V специфичные поля (скрыты по умолчанию) -->
  <div id="i2v-fields" style="display: none;">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">


      <!-- Сила движения -->
      <div class="md:col-span-2">
        <label class="block text-sm font-medium mb-2">Сила движения</label>
        <div id="motion-options" class="flex flex-wrap gap-2">
          <button type="button" class="px-3 py-1.5 rounded-xl border border-[var(--bord)] bg-[var(--bg-card)] text-xs sm:text-sm hover:border-primary/60 hover:text-primary motion-pill" data-value="20">Нежно</button>
          <button type="button" class="px-3 py-1.5 rounded-xl border border-[var(--bord)] bg-[var(--bg-card)] text-xs sm:text-sm hover:border-primary/60 hover:text-primary motion-pill" data-value="40">Мягко</button>
          <button type="button" class="px-3 py-1.5 rounded-xl border border-[var(--bord)] bg-[var(--bg-card)] text-xs sm:text-sm hover:border-primary/60 hover:text-primary motion-pill" data-value="60">Средне</button>
          <button type="button" class="px-3 py-1.5 rounded-xl border border-[var(--bord)] bg-[var(--bg-card)] text-xs sm:text-sm hover:border-primary/60 hover:text-primary motion-pill" data-value="80">Активно</button>
          <button type="button" class="px-3 py-1.5 rounded-xl border border-[var(--bord)] bg-[var(--bg-card)] text-xs sm:text-sm hover:border-primary/60 hover:text-primary motion-pill" data-value="100">Макс</button>
        </div>
        <!-- Храним выбранное значение -->
        <input type="hidden" id="video-motion-strength" value="45">
      </div>
    </div>
  </div>

  <!-- Дополнительные параметры модели -->
  <div id="advanced-params-section" class="rounded-xl border border-[var(--bord)] bg-[var(--bg-card)] p-4 sm:p-5 space-y-4" style="display: none;">
    <div class="flex items-center gap-2 pb-3 border-b border-[var(--bord)]">
      <svg class="w-5 h-5 text-primary flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
      </svg>
      <h3 class="text-sm sm:text-base font-semibold text-[var(--text)]">Дополнительные параметры</h3>
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">

      <!-- FPS -->
      <div id="fps-param" class="space-y-1.5" style="display: none;">
        <label class="block text-xs sm:text-sm font-medium text-[var(--text)]" for="video-fps">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 text-primary flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <span>FPS (кадров в секунду)</span>
          </span>
        </label>
        <select id="video-fps" class="field w-full text-xs sm:text-sm h-9 sm:h-10 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary/50 transition-all appearance-none">
          <!-- Опции будут заполнены динамически из JS на основе конфигурации модели -->
          <option value="15">15 FPS</option>
          <option value="24">24 FPS</option>
          <option value="30" selected>30 FPS</option>
          <option value="60">60 FPS</option>
          <option value="90">90 FPS</option>
          <option value="120">120 FPS</option>
        </select>
        <p id="fps-hint" class="text-[10px] sm:text-xs text-[var(--muted)] mt-1" style="display: none;">
          Доступные значения FPS определяются выбранной моделью
        </p>
      </div>

      <!-- Guidance Scale -->
      <div id="guidance-scale-param" class="space-y-1.5" style="display: none;">
        <label class="block text-xs sm:text-sm font-medium text-[var(--text)]" for="video-guidance-scale">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 text-primary flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2v20M2 12h20"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            <span>Guidance Scale</span>
          </span>
        </label>
        <input type="number" id="video-guidance-scale" class="field w-full text-xs sm:text-sm h-9 sm:h-10 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary/50 transition-all" placeholder="7.5" min="1" max="20" step="0.1">
      </div>

      <!-- Inference Steps -->
      <div id="inference-steps-param" class="space-y-1.5" style="display: none;">
        <label class="block text-xs sm:text-sm font-medium text-[var(--text)]">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 text-primary flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12h4l3 9 4-18 3 9h4"/>
            </svg>
            <span>Шаги генерации</span>
          </span>
        </label>
        <div class="moon-slider-container">
          <div class="flex items-center gap-3 sm:gap-4">
            <input
              type="range"
              id="video-inference-steps"
              class="moon-slider flex-1"
              min="10"
              max="100"
              value="50"
              step="1"
              data-value-id="video-inference-steps-value"
            >
            <div class="moon-slider-value">
              <span id="video-inference-steps-value" class="moon-slider-value-number">50</span>
              <span class="moon-slider-value-unit">шагов</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Quality -->
      <div id="quality-param" class="space-y-1.5" style="display: none;">
        <label class="block text-xs sm:text-sm font-medium text-[var(--text)]">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 text-primary flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            <span>Качество</span>
          </span>
        </label>
        <div class="moon-slider-container">
          <div class="flex items-center gap-3 sm:gap-4">
            <input
              type="range"
              id="video-quality"
              class="moon-slider flex-1"
              min="0"
              max="4"
              value="2"
              step="1"
              data-value-id="video-quality-value"
              data-labels='["По умолчанию", "Низкое", "Среднее", "Высокое", "Ультра"]'
            >
            <div class="moon-slider-value">
              <span id="video-quality-value" class="moon-slider-value-number">Среднее</span>
            </div>
          </div>
        </div>
        <input type="hidden" id="video-quality-hidden" value="medium">
      </div>

      <!-- Style -->
      <div id="style-param" class="space-y-1.5" style="display: none;">
        <label class="block text-xs sm:text-sm font-medium text-[var(--text)]" for="video-style">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 text-primary flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343"/>
              <path d="M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
            </svg>
            <span>Стиль</span>
          </span>
        </label>
        <select id="video-style" class="field w-full text-xs sm:text-sm h-9 sm:h-10 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary/50 transition-all appearance-none">
          <option value="">По умолчанию</option>
          <option value="realistic">Реалистичный</option>
          <option value="anime">Аниме</option>
          <option value="cartoon">Мультяшный</option>
          <option value="cinematic">Кинематографичный</option>
          <option value="artistic">Художественный</option>
        </select>
      </div>

      <!-- Output Format -->
      <div id="output-format-param" class="space-y-1.5" style="display: none;">
        <label class="block text-xs sm:text-sm font-medium text-[var(--text)]" for="video-output-format">
          <span class="flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5 text-primary flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
              <path d="M14 2v6h6"/>
              <path d="M12 18v-6"/>
              <path d="M9 15l3 3 3-3"/>
            </svg>
            <span>Формат вывода</span>
          </span>
        </label>
        <select id="video-output-format" class="field w-full text-xs sm:text-sm h-9 sm:h-10 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary/50 transition-all appearance-none">
          <option value="mp4">MP4</option>
          <option value="webm">WebM</option>
          <option value="gif">GIF</option>
        </select>
      </div>
    </div>

    <!-- Negative Prompt -->
    <div id="negative-prompt-param" class="space-y-1.5" style="display: none;">
      <label class="block text-xs sm:text-sm font-medium text-[var(--text)]" for="video-negative-prompt">
        <span class="flex items-center gap-1.5">
          <svg class="w-3.5 h-3.5 text-primary flex-shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M15 9l-6 6M9 9l6 6"/>
          </svg>
          <span>Негативный промпт</span>
          <span class="text-[10px] sm:text-[11px] text-[var(--muted)] font-normal">(что не должно быть в видео)</span>
        </span>
      </label>
      <textarea id="video-negative-prompt" class="field w-full min-h-20 resize-none text-xs sm:text-sm rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary/50 transition-all" placeholder="Например: blurry, low quality, distorted, watermark"></textarea>
    </div>
  </div>

  <!-- Подсказка для пользователя -->
  <div class="mt-2 rounded-xl border border-[var(--bord)] bg-[var(--bg-card)] p-3 text-xs text-[var(--muted)]">
        Результаты (фото) хранятся локально 24 часа. По истечении срока очередь очищается автоматически. Данные не покидают ваш браузер.
      </div>

  <!-- Результаты генерации (плитки) -->
  <div class="flex items-center justify-between mt-2">
    <h4 class="text-sm font-medium">Очередь и результаты</h4>
    <button type="button" id="clear-video-queue-btn" class="px-3 py-1.5 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] text-xs sm:text-sm hover:border-primary/60 hover:text-primary transition">
      Очистить очередь
    </button>
  </div>
  <div id="video-results-grid" class="grid grid-cols-1 xs:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4"></div>

  <style>
    /* Умное масштабирование видео карточек */
    #video-results-grid .video-result-tile {
      width: 100%;
    }

    /* Контейнер видео - aspect-ratio 16:9 для правильных пропорций */
    .video-tile-container {
      aspect-ratio: 16/9;
      position: relative;
      overflow: hidden;
    }

    /* Hover эффект для кнопки play */
    .play-btn-inner:hover {
      background: rgba(0,0,0,0.7) !important;
      transform: scale(1.1);
    }

    /* Hover для кнопки открыть */
    a[target="_blank"]:hover {
      background: rgba(0,0,0,0.8) !important;
    }

    /* Hover для кнопки звука */
    .volume-toggle-btn:hover {
      background: rgba(0,0,0,0.7) !important;
    }

    /* Hover для кнопки сохранить */
    .persist-btn:hover {
      background: rgba(var(--primary-rgb, 99, 102, 241), 1) !important;
    }

    /* Мобильные устройства */
    @media (max-width: 640px) {
      #video-results-grid {
        gap: 0.875rem;
      }

      /* Компактные размеры кнопок для тача */
      .video-play-btn .play-btn-inner {
        width: 2.75rem !important;
        height: 2.75rem !important;
        background: rgba(0,0,0,0.55) !important;
      }

      .video-play-btn .play-btn-inner svg {
        width: 1.125rem !important;
        height: 1.125rem !important;
      }

      .volume-toggle-btn {
        width: 2.25rem !important;
        height: 2.25rem !important;
        bottom: 0.5rem !important;
        left: 0.5rem !important;
        right: auto !important;
        background: rgba(0,0,0,0.55) !important;
      }

      .volume-toggle-btn svg {
        width: 1rem !important;
        height: 1rem !important;
      }

      a[target="_blank"] {
        width: 2.25rem !important;
        height: 2.25rem !important;
        top: 0.5rem !important;
        right: 0.5rem !important;
        background: rgba(0,0,0,0.55) !important;
      }

      a[target="_blank"] svg {
        width: 1rem !important;
        height: 1rem !important;
      }

      /* Компактные отступы */
      .video-tile-container {
        padding: 0;
      }

      /* Кнопка сохранить - компактный текст на мобильных */
      .persist-btn-text-full {
        display: none !important;
      }

      .persist-btn-text {
        display: inline !important;
      }

      .persist-btn {
        font-size: 0.875rem !important;
        padding: 0.625rem 0.875rem !important;
        min-height: 44px !important;
      }
    }

    /* Десктоп - полный текст */
    @media (min-width: 641px) {
      .persist-btn-text {
        display: none !important;
      }

      .persist-btn-text-full {
        display: inline !important;
      }
    }

    /* Очень маленькие экраны */
    @media (max-width: 375px) {
      .video-play-btn .play-btn-inner {
        width: 4rem !important;
        height: 4rem !important;
      }

      .volume-toggle-btn,
      a[target="_blank"] {
        width: 2.25rem !important;
        height: 2.25rem !important;
      }
    }
  </style>

  <!-- Кнопка генерации -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pt-4 border-t border-[var(--bord)]">
    <div class="flex items-center gap-3 text-sm text-[var(--muted)]">
      <svg class="w-4 h-4 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 2M12 6a9 9 0 100 18 9 9 0 000-18zM12 2v2" />
      </svg>
      <span>Обычно от 1 до 3 минут</span>
    </div>
    <button type="button" id="generate-video-btn" class="btn btn-primary px-8 py-3 w-full sm:w-auto text-base">
      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/>
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Сгенерировать видео
    </button>
  </div>

</div>

    </div>

    <!-- Категории промптов для видео -->


<!-- Категории промптов для видео -->
<div id="videoPromptCats" class="prompt-categories-section">
  <div class="section-header">
    <h2 class="section-title">Категории подсказок</h2>
    <p class="section-subtitle">Выберите категорию для быстрого старта</p>
  </div>


  <!-- Admin: Create Video Prompt Category -->
  <div class="pc-admin-create">
    <div class="pc-admin-grid">
      <input type="text" id="vpcName" class="field" placeholder="Название категории" maxlength="100">
      <input type="text" id="vpcDesc" class="field" placeholder="Описание (необязательно)">
      <input type="number" id="vpcOrder" class="field" placeholder="Порядок" value="0">
      <select id="vpcMode" class="field">
        <option value="i2v">Image-to-Video</option>
        <option value="t2v" selected>Text-to-Video</option>
      </select>
      <label class="pc-inline">
        <input type="checkbox" id="vpcActive" checked>
        <span>Активна</span>
      </label>
      <label class="pc-file">
        <input type="file" id="vpcImage" accept="image/*">
        <span>Изображение</span>
      </label>
      <button class="btn btn-primary" id="vpcCreateBtn" type="button">+ Категория</button>
    </div>
    <div class="text-xs text-[var(--muted)] mt-2">Картинка используется как обложка карточки категории.</div>
    <div id="vpcStatus" class="text-xs mt-2"></div>
  </div>


  <!-- Categories Container (loaded via JS) -->
  <div id="videoCategoriesContainer">
    <p class="text-center text-muted">Загрузка категорий...</p>
  </div>
</div>

<!-- Showcase Section -->
<div id="videoShowcaseSection" class="mt-6">
  <div class="section-header">
    <h2 class="section-title">Примеры результатов</h2>
    <p class="section-subtitle">Вдохновляйтесь работами других пользователей</p>
  </div>

  <!-- Server-rendered showcase (no dynamic fetching) -->
  <div id="videoShowcaseGrid" class="grid grid-cols-1 xs:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-6 mt-6">

      <div class="showcase-item">
        <div class="showcase-media">
          <video
            class="showcase-video w-full h-full object-cover"
            src="/media/showcase_videos/2025/12/user-j1weqxmo7zvpazsffaaz0vio_gen_01k803g84ced389yezzr1010k0_HgICVdM.mp4"

            preload="metadata"
            controls
            playsinline
            title="test"
          ></video>
        </div>
        <div class="showcase-content">
          <h3 class="showcase-title">test</h3>

            <div class="showcase-prompt-header" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9h8M8 13h5M4 6h16a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V8a2 2 0 012-2z"></path>
              </svg>
              <span>Промпт</span>
            </div>
            <div class="showcase-prompt-box">
              <p class="showcase-prompt">23132 123132</p>
            </div>
            <button class="showcase-use-btn" data-prompt="23132 123132">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              <span>Использовать промпт</span>
            </button>

        </div>
      </div>

  </div>



  <script>
  // Lightweight binding for "Использовать промпт" buttons (no dynamic fetch)
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('#videoShowcaseSection .showcase-use-btn').forEach(function(btn){
      btn.addEventListener('click', function(){
        var prompt = this.getAttribute('data-prompt') || '';
        var field = document.getElementById('video-prompt');
        if (field) {
          field.value = prompt;
          try { field.focus(); } catch(_) {}
        }
        var self = this, html = self.innerHTML;
        self.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg><span>Добавлено!</span>';
        self.classList.add('success');
        setTimeout(function(){ self.innerHTML = html; self.classList.remove('success'); }, 2000);
      });
    });
  });
  </script>
</div>

<!-- Why Choose Us (Video) -->
<div class="card p-6 mt-6">
  <h2 class="text-lg font-semibold mb-6">Почему именно мы</h2>
  <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
    <div>
      <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L4 21l1.5-6L2 10l6-.75L12 3l2 6.25 6 .75-3.5 5 1.5 6z"/>
        </svg>
      </div>
      <h3 class="font-semibold mb-2">Фотореализм без «мыла»</h3>
      <p class="text-sm text-[var(--muted)]">Подбор моделей и параметров под задачу: портреты, предметка, интерьер, арт-стили.</p>
    </div>

    <div>
      <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
        </svg>
      </div>
      <h3 class="font-semibold mb-2">Честная стоимость</h3>
      <p class="text-sm text-[var(--muted)]">Прозрачные токены: 1 обработка = 10 TOK. Без скрытых платежей.</p>
    </div>

    <div>
      <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
        </svg>
      </div>
      <h3 class="font-semibold mb-2">Кеш и прямые ссылки</h3>
      <p class="text-sm text-[var(--muted)]">Файлы доступны по прямому URL. Если CDN уходит в 5xx — отдаём внешний URL.</p>
    </div>

    <div>
      <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
        </svg>
      </div>
      <h3 class="font-semibold mb-2">Гостевой бонус</h3>
      <p class="text-sm text-[var(--muted)]">Гости получают 30 TOK. Остаток безопасно «доезжает» до аккаунта.</p>
    </div>

    <div>
      <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
        </svg>
      </div>
      <h3 class="font-semibold mb-2">Защита от NSFW</h3>
      <p class="text-sm text-[var(--muted)]">Фильтрация по настройке, чтобы проект был дружелюбным к публике.</p>
    </div>

    <div>
      <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
      </div>
      <h3 class="font-semibold mb-2">Стабильная очередь</h3>
      <p class="text-sm text-[var(--muted)]">Асинхронный провайдер + резервный поллинг, чтобы заказы не «зависали».</p>
    </div>
  </div>
</div>

<!-- Modal for Video Prompts -->
<div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4" id="videoPromptCategoryModal">
  <div class="bg-[var(--bg-card)] rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden border border-[var(--bord)] shadow-2xl animate-modal-in">
    <div class="sticky top-0 bg-[var(--bg-card)] border-b border-[var(--bord)] p-4 sm:p-6 flex items-center justify-between z-10">
      <h3 class="text-lg sm:text-xl font-bold" id="videoModalCategoryTitle">Промпты видео</h3>
      <button class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-[var(--bord)] transition-colors" id="closeVideoPromptModal" aria-label="Закрыть">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="p-4 sm:p-6 overflow-y-auto max-h-[calc(90vh-88px)] custom-scrollbar" id="videoModalPromptsContainer">
      <div class="text-center text-[var(--muted)] py-8">Загрузка...</div>
    </div>
  </div>
</div>


<!-- Edit Video Category Modal -->
<div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4" id="vpcEditModal">
  <div class="bg-[var(--bg-card)] rounded-2xl max-w-xl w-full overflow-hidden border border-[var(--bord)] shadow-2xl">
    <div class="p-4 sm:p-6 border-b border-[var(--bord)] flex items-center justify-between">
      <h3 class="text-lg font-bold">Редактирование категории</h3>
      <button class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-[var(--bord)]" id="vpcEditClose" type="button">✕</button>
    </div>
    <div class="p-4 sm:p-6 space-y-3">
      <input type="hidden" id="vpcEditId">
      <input id="vpcEditName" class="field w-full" type="text" placeholder="Название">
      <textarea id="vpcEditDesc" class="field w-full" rows="3" placeholder="Описание"></textarea>
      <div class="grid grid-cols-2 gap-3">
        <input id="vpcEditOrder" class="field" type="number" placeholder="Порядок">
        <label class="pc-inline"><input id="vpcEditActive" type="checkbox"><span>Активна</span></label>
      </div>
      <label class="pc-file w-full">
        <input type="file" id="vpcEditImage" accept="image/*">
        <span>Заменить изображение</span>
      </label>
      <div class="flex items-center justify-end gap-2 pt-2">
        <button class="btn btn-ghost" id="vpcEditCancel" type="button">Отмена</button>
        <button class="btn btn-primary" id="vpcEditSave" type="button">Сохранить</button>
      </div>
    </div>
  </div>
</div>


<style>
/* ===== Стили из prompts.html для видео ===== */
.prompt-categories-section {
  width: 100%;
}

#videoPromptCats {
  scroll-margin-top: clamp(56px, 8vh, 96px);
}

.section-header {
  margin-bottom: 1.5rem;
}

.section-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text, #ffffff);
  margin: 0 0 0.25rem 0;
}

.section-subtitle {
  font-size: 0.875rem;
  color: var(--muted, rgba(255, 255, 255, 0.6));
  margin: 0;
}

.pc-admin-create {
  margin: 1rem 0 1.25rem 0;
  padding: 0.75rem;
  border: 1px solid var(--bord);
  border-radius: 0.75rem;
  background: rgba(0,0,0,.03);
}
html[data-theme="light"] .pc-admin-create { background: rgba(0,0,0,.02); }
.pc-admin-grid {
  display: grid;
  gap: 0.5rem;
  grid-template-columns: 2fr 3fr 1fr 1fr auto auto auto;
}
.pc-inline { display: inline-flex; align-items: center; gap: .5rem; padding: .5rem .75rem; border:1px dashed var(--bord); border-radius:.5rem; }
.pc-file { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px dashed var(--bord); border-radius:.5rem; cursor:pointer; }
.pc-file input[type="file"]{ display:none; }

.categories-grid-compact {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 0.75rem;
}

.categories-grid-full {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 0.75rem;
}

.category-card-compact {
  position: relative;
  cursor: pointer;
  border-radius: 0.75rem;
  overflow: hidden;
  transition: all 0.3s ease;
  background: transparent;
  border: none;
  padding: 0;
  width: 100%;
}

.category-card-compact:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 16px rgba(99, 102, 241, 0.2);
}

.category-image-wrapper-compact {
  position: relative;
  width: 100%;
  padding-bottom: 100%;
  overflow: hidden;
  border-radius: 0.75rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.category-image-compact {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.category-card-compact:hover .category-image-compact {
  transform: scale(1.1);
}

.category-overlay-compact {
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, transparent 40%, rgba(0,0,0,0.85) 100%);
  z-index: 1;
  transition: background 0.3s ease;
}

.category-card-compact:hover .category-overlay-compact {
  background: linear-gradient(180deg, transparent 30%, rgba(0,0,0,0.9) 100%);
}

.category-name-compact {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 0.875rem 0.625rem;
  font-size: 0.9375rem;
  font-weight: 700;
  color: #ffffff;
  text-align: center;
  z-index: 2;
  margin: 0;
  text-shadow:
    0 2px 8px rgba(0,0,0,0.9),
    0 1px 3px rgba(0,0,0,0.8),
    -1px -1px 0 rgba(0,0,0,0.5),
    1px -1px 0 rgba(0,0,0,0.5),
    -1px 1px 0 rgba(0,0,0,0.5),
    1px 1px 0 rgba(0,0,0,0.5);
  line-height: 1.3;
  letter-spacing: 0.02em;
}

.pc-card-actions{
  position:absolute; top:6px; right:6px; z-index:3; display:flex; gap:6px;
}
.pc-btn{ background:rgba(0,0,0,.6); color:#fff; border:1px solid rgba(255,255,255,.25); width:28px; height:28px; line-height:26px; text-align:center; border-radius:8px; cursor:pointer; font-weight:700; }
.pc-btn:hover{ background:rgba(0,0,0,.8); }

.category-show-all {
  background: transparent;
}

.category-show-all .category-image-wrapper-compact {
  background: var(--primary);
  position: relative;
  isolation: isolate;
}

.show-all-content {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.375rem;
  padding: 0.75rem;
  z-index: 1;
}

.show-all-icon {
  width: 1.75rem;
  height: 1.75rem;
  color: #ffffff;
  transition: transform 0.3s ease;
}

.category-show-all .category-image-wrapper-compact::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 0.75rem;
  background: linear-gradient(135deg, rgba(0,0,0,.18), rgba(0,0,0,.28));
  z-index: 0;
}

html[data-theme="light"] .category-show-all .category-image-wrapper-compact::before {
  background: linear-gradient(135deg, rgba(0,0,0,.22), rgba(0,0,0,.35));
}

.category-show-all:hover .show-all-icon {
  transform: translateY(4px);
}

.show-all-text {
  font-size: 0.8125rem;
  font-weight: 600;
  color: #ffffff;
  text-align: center;
  line-height: 1.2;
}

.show-all-count {
  font-size: 0.6875rem;
  color: rgba(255,255,255,0.8);
}

/* Showcase стили */
.showcase-item {
  background: var(--bg-card);
  border-radius: 1rem;
  overflow: hidden;
  border: 1px solid var(--bord);
  transition: all 0.3s ease;
}

.showcase-item:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
}

.showcase-media {
  position: relative;
  aspect-ratio: 3/4; /* match image showcase card size */
  background: var(--bord);
  overflow: hidden;
}

.showcase-video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.video-play-btn {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 64px;
  height: 64px;
  background: rgba(0,0,0,0.7);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  border: none;
}

.video-play-btn:hover {
  background: rgba(0,0,0,0.9);
  transform: translate(-50%, -50%) scale(1.1);
}

.video-play-btn svg {
  width: 24px;
  height: 24px;
  color: white;
  margin-left: 4px;
}

.showcase-content {
  padding: 1rem;
}

.showcase-title {
  font-size: 1rem;
  font-weight: 600;
  margin-bottom: 0.75rem;
}

/* use global styles from static/css/showcase.css for prompt header */
.showcase-prompt-header { }

/* use global styles from static/css/showcase.css for prompt header icon */
.showcase-prompt-header svg { }

/* use global styles from static/css/showcase.css for prompt box */
.showcase-prompt-box { }

/* use global styles from static/css/showcase.css for prompt text */
.showcase-prompt { }

.showcase-use-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  width: 100%;
  padding: 0.75rem;
  background: var(--primary);
  color: white;
  border: none;
  border-radius: 0.5rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.showcase-use-btn:hover {
  background: var(--primary-hover);
  transform: translateY(-2px);
}

.showcase-use-btn.success {
  background: #10b981;
}

.showcase-use-btn svg {
  width: 18px;
  height: 18px;
}

/* Modal стили */
#videoPromptCategoryModal.active {
  display: flex;
}

.custom-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: #6366f1 transparent;
}

.custom-scrollbar::-webkit-scrollbar {
  width: 10px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
  border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #6366f1 0%, #8b5cf6 100%);
  border-radius: 10px;
  border: 2px solid var(--bg-card, #1e293b);
}

.prompt-item-modal {
  background: var(--bg-2, #11121a);
  border: 1px solid var(--border, rgba(255,255,255,.08));
  border-radius: 14px;
  padding: 1.25rem;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.prompt-item-modal:hover {
  background: var(--bg-3, #151625);
  border-color: #6366f1;
  transform: translateX(8px);
}

html[data-theme="light"] .section-title {
  color: #0f1419;
}

html[data-theme="light"] .section-subtitle {
  color: #6b7280;
}

html[data-theme="light"] .showcase-item:hover {
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
}

/* Адаптив */
@media (max-width: 1024px) {
  .categories-grid-compact,
  .categories-grid-full {
    grid-template-columns: repeat(4, 1fr);
  }
  .pc-admin-grid { grid-template-columns: 2fr 3fr 1fr 1fr auto auto auto; }
}

@media (max-width: 768px) {
  .categories-grid-compact,
  .categories-grid-full {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.625rem;
  }
  .pc-admin-grid { grid-template-columns: 1fr 1fr 1fr auto; }

  .category-name-compact {
    font-size: 0.8125rem;
    padding: 0.75rem 0.5rem;
  }
}

@media (max-width: 640px) {
  .categories-grid-compact,
  .categories-grid-full {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }

  .category-name-compact {
    font-size: 0.75rem;
    padding: 0.625rem 0.375rem;
  }
}

@media (max-width: 480px) {
  .categories-grid-compact,
  .categories-grid-full {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }

  .category-name-compact {
    font-size: 0.8125rem;
    padding: 0.75rem 0.5rem;
  }
}

@media (max-width: 320px) {
  .categories-grid-compact,
  .categories-grid-full {
    gap: 0.375rem;
  }

  .category-name-compact {
    font-size: 0.6875rem;
    padding: 0.5rem 0.25rem;
    letter-spacing: 0;
  }

  .section-title {
    font-size: 1rem;
  }

  .section-subtitle {
    font-size: 0.8125rem;
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#allVideoCategoriesSection:not(.hidden) {
  animation: fadeIn 0.3s ease-out;
}
/* Mobile ratio to mirror image showcase (4/5 on small screens) */
@media (max-width: 479px) {
  .showcase-media { aspect-ratio: 4/5; }
}
</style>

<script>
(function() {
  'use strict';

  // Helper function for POST requests
  async function postFD(url, fd) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '' },
      body: fd
    });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(text || `HTTP ${res.status}`);
    }
    return res.json();
  }

  async function postJSON(url, data) {
    const res = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
      },
      body: JSON.stringify(data)
    });
    if (!res.ok) {
      const text = await res.text();
      throw new Error(text || `HTTP ${res.status}`);
    }
    return res.json();
  }

  // Check if user is staff
  const IS_STAFF = true;

  if (IS_STAFF) {
    // Admin: create video category
    document.getElementById('vpcCreateBtn')?.addEventListener('click', async () => {
      const name = (document.getElementById('vpcName')?.value || '').trim();
      const desc = (document.getElementById('vpcDesc')?.value || '').trim();
      const order = document.getElementById('vpcOrder')?.value || '0';
      const mode = document.getElementById('vpcMode')?.value || 't2v';
      const active = document.getElementById('vpcActive')?.checked ? '1' : '0';
      const imgInput = document.getElementById('vpcImage');

      if (!name) {
        alert('Введите название категории');
        return;
      }

      const fd = new FormData();
      fd.append('name', name);
      if (desc) fd.append('description', desc);
      fd.append('order', order);
      fd.append('mode', mode);
      fd.append('is_active', active);
      if (imgInput?.files?.[0]) fd.append('image', imgInput.files[0]);

      try {
        const statusEl = document.getElementById('vpcStatus');
        if (statusEl) statusEl.textContent = 'Создание...';

        await postFD('/generate/api/video/categories/create/', fd);

        if (statusEl) statusEl.textContent = 'Категория создана! Обновление страницы...';

        setTimeout(() => location.reload(), 500);
      } catch (e) {
        const statusEl = document.getElementById('vpcStatus');
        if (statusEl) statusEl.textContent = 'Ошибка: ' + (e.message || String(e));
        alert('Ошибка: ' + (e.message || String(e)));
      }
    });
  }
})();
</script>




    <!-- Admin: Video Showcase Examples Creator (I2V / T2V) -->
    <div id="video-admin-examples" class="card p-6">
      <div class="flex items-center justify-between gap-3 mb-4">
        <div>
          <h2 class="text-lg sm:text-xl font-bold">Примеры видео (админ)</h2>
          <p class="text-xs sm:text-sm text-[var(--muted)]">Создавайте и публикуйте примеры для I2V/T2V прямо со страницы</p>
        </div>
        <button id="vaToggle" type="button" class="btn btn-ghost text-sm">Свернуть</button>
      </div>

      <div id="vaFormWrap" class="rounded-xl border border-[var(--bord)] bg-[var(--bg-card)] p-4 sm:p-5 mb-5">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-medium mb-1">Название</label>
            <input id="vaTitle" type="text" class="field w-full" placeholder="Animated Portrait" maxlength="140">
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Режим</label>
            <select id="vaMode" class="field w-full">
              <option value="i2v">Фото/Видео (I2V)</option>
              <option value="t2v">Текст/Видео (T2V)</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Категория (опционально)</label>
            <select id="vaCategory" class="field w-full">
              <option value="">Без категории</option>
            </select>
          </div>

          <div class="sm:col-span-2 lg:col-span-3">
            <label class="block text-sm font-medium mb-1">Промпт</label>
            <textarea id="vaPrompt" class="field w-full min-h-[88px]" placeholder="Короткий английский промпт для примера"></textarea>
          </div>

          <div class="sm:col-span-2">
            <label class="block text-sm font-medium mb-1">Видео</label>
            <div class="flex items-center gap-3">
              <label for="vaVideoFile" class="btn btn-primary shrink-0">Выбрать файл</label>
              <input id="vaVideoFile" type="file" accept="video/mp4" class="hidden">
              <span id="vaVideoFileName" class="text-sm text-[var(--muted)]">Файл не выбран</span>
            </div>
            <div class="text-xs text-[var(--muted)] mt-1">Загрузите MP4 — файл автоматически сожмётся (H.264, faststart).</div>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Порядок</label>
            <input id="vaOrder" type="number" class="field w-full" value="0" min="0" step="1">
          </div>
        </div>

        <div class="mt-4 flex items-center gap-3">
          <button id="vaCreate" type="button" class="btn btn-primary">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            Создать пример
          </button>
          <div id="vaMsg" class="text-xs text-[var(--muted)]"></div>
        </div>
      </div>

      <div class="flex items-center justify-between mb-3">
        <h3 class="text-base font-semibold">Галерея примеров</h3>
        <div class="inline-flex items-center gap-2">
          <span class="text-xs text-[var(--muted)]">Режим:</span>
          <div class="inline-flex rounded-xl bg-[var(--bord)] p-1 gap-1">
            <button type="button" class="vaModeTab px-2 py-1 rounded-lg text-xs font-medium active" data-mode="i2v">I2V</button>
            <button type="button" class="vaModeTab px-2 py-1 rounded-lg text-xs font-medium" data-mode="t2v">T2V</button>
          </div>
        </div>
      </div>

      <div id="vaGrid" class="grid grid-cols-1 xs:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 sm:gap-4">
        <!-- cards -->
      </div>
    </div>

    <script>
    (function(){
      const root = document.getElementById('gen-root');
      const isStaff = (root?.dataset.isStaff || 'false') === 'true';
      const wrap = document.getElementById('video-admin-examples');
      if (!isStaff || !wrap) { if (wrap) wrap.style.display = 'none'; return; }

      const api = {
        list: (mode) => `/generate/api/video/showcase/?mode=${mode}`,
        cats: (mode) => `/generate/api/video/categories/?mode=${mode}`,
        create: '/generate/api/video/showcase/create/',
        del: (id) => `/generate/api/video/showcase/${id}/delete/`,
      };

      const title = document.getElementById('vaTitle');
      const prompt = document.getElementById('vaPrompt');
      const videoFile = document.getElementById('vaVideoFile');
      const order = document.getElementById('vaOrder');
      const modeSel = document.getElementById('vaMode');
      const catSel = document.getElementById('vaCategory');
      const createBtn = document.getElementById('vaCreate');
      const msg = document.getElementById('vaMsg');
      // File chooser binding for video file
      const vfLabel = wrap.querySelector('label[for="vaVideoFile"]');
      const vfName = document.getElementById('vaVideoFileName');
      if (vfLabel && videoFile) {
        vfLabel.addEventListener('click', (e) => { e.preventDefault(); videoFile.click(); });
        videoFile.addEventListener('change', () => {
          if (vfName) vfName.textContent = (videoFile.files && videoFile.files[0]) ? videoFile.files[0].name : 'Файл не выбран';
        });
      }

      const grid = document.getElementById('vaGrid');
      const tabs = wrap.querySelectorAll('.vaModeTab');
      const toggle = document.getElementById('vaToggle');
      const formWrap = document.getElementById('vaFormWrap');

      let currentMode = (document.querySelector('.video-source-tab.active')?.dataset.source || 'i2v');

      function escapeHtml(s){ const d=document.createElement('div'); d.textContent = s ?? ''; return d.innerHTML; }
      function csrf(){ return (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value || ''; }
      function setMsg(text, ok=false){ msg.textContent = text||''; msg.className = 'text-xs ' + (ok ? 'text-emerald-500' : 'text-[var(--muted)]'); }

      async function loadCategories(mode){
        try{
          const r = await fetch(api.cats(mode));
          const j = await r.json();
          const items = (j.categories||[]);
          catSel.innerHTML = '<option value=\"\">Без категории</option>' + items.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
        }catch(e){ /* silent */ }
      }

      function renderCards(list){
        if (!list || list.length===0){
          grid.innerHTML = '<div class="text-xs sm:text-sm text-[var(--muted)] col-span-full">Пока нет примеров</div>';
          return;
        }
        grid.innerHTML = list.map(v => `
          <div class="rounded-xl border border-[var(--bord)] bg-[var(--bg-card)] overflow-hidden group">
            <div class="relative aspect-[16/9] bg-black">
              <video src="${escapeHtml(v.video_url)}" class="absolute inset-0 w-full h-full object-cover" preload="metadata" controls></video>
              <div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                <a href="${escapeHtml(v.video_url)}" target="_blank" class="px-2 py-1 rounded-md bg-black/60 text-white text-[10px] sm:text-xs font-semibold hover:bg-black/70">Открыть</a>
                <button data-id="${v.id}" class="vaDel px-2 py-1 rounded-md bg-red-500/80 text-white text-[10px] sm:text-xs font-semibold hover:bg-red-600">Удалить</button>
              </div>
            </div>
            <div class="p-3">
              <div class="text-sm font-semibold mb-1 line-clamp-1">${escapeHtml(v.title)}</div>
              ${v.prompt ? `<pre class="text-[11px] sm:text-xs bg-[var(--bord)]/60 p-2 rounded-md whitespace-pre-wrap leading-snug">${escapeHtml(v.prompt)}</pre>` : ''}
            </div>
          </div>
        `).join('');
        grid.querySelectorAll('.vaDel').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            if (!id) return;
            if (!confirm('Удалить пример?')) return;
            try{
              const fd = new FormData();
              fd.append('csrfmiddlewaretoken', csrf());
              const r = await fetch(api.del(id), { method:'POST', body: fd, headers:{'X-Requested-With':'fetch'} });
              const j = await r.json();
              if (j && j.success) {
                setMsg('Удалено', true);
                await refresh();
              } else {
                alert(j.error || 'Ошибка удаления');
              }
            }catch(e){ alert('Ошибка сети'); }
          });
        });
      }

      async function load(mode){
        try{
          const r = await fetch(api.list(mode));
          const j = await r.json();
          renderCards(j.examples || []);
        }catch(e){
          grid.innerHTML = '<div class="text-xs sm:text-sm text-red-500 col-span-full">Ошибка загрузки примеров</div>';
        }
      }

      async function refresh(){
        await load(currentMode);
      }

      createBtn.addEventListener('click', async () => {
        const t = (title.value||'').trim();
        const p = (prompt.value||'').trim();
        const file = (videoFile && videoFile.files && videoFile.files[0]) ? videoFile.files[0] : null;
        const m = (modeSel.value||currentMode||'i2v'); // сохраняем выбор для категорий/видимости
        const c = (catSel.value||'').trim();
        const o = parseInt(order.value||'0')||0;

        if (!t || !p || !file){ setMsg('Заполните название, промпт и выберите MP4 файл'); return; }

        const fd = new FormData();
        fd.append('csrfmiddlewaretoken', csrf());
        fd.append('title', t);
        fd.append('prompt', p);
        fd.append('video_file', file);
        fd.append('order', String(o));
        fd.append('mode', m);
        if (c) fd.append('category_id', c);

        try{
          const r = await fetch(api.create, { method:'POST', body: fd, headers:{'X-Requested-With':'fetch'} });
          const j = await r.json();
          if (j && j.success){
            setMsg('Создано', true);
            title.value=''; prompt.value=''; order.value='0';
            if (videoFile) { videoFile.value=''; const n = document.getElementById('vaVideoFileName'); if (n) n.textContent = 'Файл не выбран'; }
            await refresh();
          } else {
            setMsg(j.error || 'Ошибка создания');
          }
        }catch(e){ setMsg('Ошибка сети'); }
      });

      tabs.forEach(btn => btn.addEventListener('click', () => {
        tabs.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentMode = btn.dataset.mode || 'i2v';
        modeSel.value = currentMode;
        loadCategories(currentMode);
        refresh();
      }));

      // collapse
      toggle.addEventListener('click', () => {
        const hidden = formWrap.style.display === 'none';
        formWrap.style.display = hidden ? '' : 'none';
        toggle.textContent = hidden ? 'Свернуть' : 'Развернуть';
      });

      // listen outer video mode changes
      document.addEventListener('videoModeChanged', (e) => {
        const m = (e?.detail?.mode) || 'i2v';
        currentMode = m;
        tabs.forEach(b => b.classList.toggle('active', (b.dataset.mode===m)));
        modeSel.value = currentMode;
        loadCategories(currentMode);
        refresh();
      });

      // bootstrap
      tabs.forEach(b => b.classList.toggle('active', (b.dataset.mode===currentMode)));
      modeSel.value = currentMode;
      loadCategories(currentMode);
      refresh();
    })();
    </script>

  </div>

  <!-- Prompt Categories Section (New Beautiful Block) -->

  <div id="image-prompts-card" class="card p-6 mt-6" style="">


<!-- Prompt Categories Section -->
<div id="promptCats" class="prompt-categories-section">
  <div class="section-header">
    <h2 class="section-title">Категории подсказок</h2>
    <p class="section-subtitle">Выберите категорию для быстрого старта</p>
  </div>


  <!-- Admin: Create Prompt Category -->
  <div class="pc-admin-create">
    <div class="pc-admin-grid">
      <form id="pcForm" method="post" action="/en/generate/api/prompt-categories/create" enctype="multipart/form-data" onsubmit="return (window.__pcSubmit ? window.__pcSubmit(event) : true)" style="display:contents">
        <input type="hidden" name="csrfmiddlewaretoken" value="l8loxdnyNvSnvVrbCELsBqrG6yD1b4N723o86ogOCWrm9QnWm5rPGUGwByV2EyBx">
        <input type="text" id="pcName" name="name" class="field" placeholder="Название категории" maxlength="100" required>
        <input type="text" id="pcDesc" name="description" class="field" placeholder="Описание (необязательно)">
        <input type="number" id="pcOrder" name="order" class="field" placeholder="Порядок" value="0">
        <label class="pc-inline">
          <input type="checkbox" id="pcActive" name="is_active" checked>
          <span>Активна</span>
        </label>
        <label class="pc-file">
          <input type="file" id="pcImage" name="image" accept="image/*">
          <span>Изображение</span>
        </label>
        <button class="btn btn-primary" id="pcCreateBtn" type="submit">+ Категория</button>
      </form>
    </div>
    <div class="text-xs text-[var(--muted)] mt-2">Картинка используется как обложка карточки категории.</div>
    <div id="pcStatus" class="text-xs mt-2"></div>
  </div>


  <!-- First Row: 5 categories + "Show All" button (always visible) -->

  <div class="categories-grid-compact">


      <div class="category-card-compact" data-category-id="46" data-name="Портрет" data-desc="Реалистичные и художественные портреты людей" data-order="1" data-active="1" data-image-url="/media/prompt_categories/%D0%9F%D0%BE%D1%80%D1%82%D1%80%D0%B5%D1%82_fkz62SG_Ps1tc3T.jpg">
        <div class="category-image-wrapper-compact">

          <img
            src="/media/prompt_categories/%D0%9F%D0%BE%D1%80%D1%82%D1%80%D0%B5%D1%82_fkz62SG_Ps1tc3T.jpg"
            alt="Портрет"
            class="category-image-compact"
            loading="lazy"
            decoding="async"
            fetchpriority="low"
            width="600"
            height="600"
          >

          <div class="category-overlay-compact"></div>
          <h3 class="category-name-compact">Портрет</h3>


          <div class="pc-card-actions">
            <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="46">✎</button>
            <button class="pc-btn pc-del" type="button" title="Удалить" data-id="46">✕</button>
          </div>

        </div>
      </div>



      <div class="category-card-compact" data-category-id="51" data-name="Архитектура" data-desc="Здания, сооружения и архитектурные детали" data-order="2" data-active="1" data-image-url="/media/prompt_categories/%D0%90%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0_AcFHjo9_gB48Nl1.jpg">
        <div class="category-image-wrapper-compact">

          <img
            src="/media/prompt_categories/%D0%90%D1%80%D1%85%D0%B8%D1%82%D0%B5%D0%BA%D1%82%D1%83%D1%80%D0%B0_AcFHjo9_gB48Nl1.jpg"
            alt="Архитектура"
            class="category-image-compact"
            loading="lazy"
            decoding="async"
            fetchpriority="low"
            width="600"
            height="600"
          >

          <div class="category-overlay-compact"></div>
          <h3 class="category-name-compact">Архитектура</h3>


          <div class="pc-card-actions">
            <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="51">✎</button>
            <button class="pc-btn pc-del" type="button" title="Удалить" data-id="51">✕</button>
          </div>

        </div>
      </div>



      <div class="category-card-compact" data-category-id="47" data-name="Пейзаж" data-desc="Красивые природные и городские пейзажи" data-order="2" data-active="1" data-image-url="/media/prompt_categories/%D0%9F%D0%B5%D0%B9%D0%B7%D0%B0%D0%B6_bS2UJ7F.jpg">
        <div class="category-image-wrapper-compact">

          <img
            src="/media/prompt_categories/%D0%9F%D0%B5%D0%B9%D0%B7%D0%B0%D0%B6_bS2UJ7F.jpg"
            alt="Пейзаж"
            class="category-image-compact"
            loading="lazy"
            decoding="async"
            fetchpriority="low"
            width="600"
            height="600"
          >

          <div class="category-overlay-compact"></div>
          <h3 class="category-name-compact">Пейзаж</h3>


          <div class="pc-card-actions">
            <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="47">✎</button>
            <button class="pc-btn pc-del" type="button" title="Удалить" data-id="47">✕</button>
          </div>

        </div>
      </div>



      <div class="category-card-compact" data-category-id="48" data-name="Для разработки" data-desc="Технологические и IT-тематические изображения" data-order="3" data-active="1" data-image-url="/media/prompt_categories/%D0%94%D0%BB%D1%8F_%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B8_6FxTsie_XNZzzDu.jpg">
        <div class="category-image-wrapper-compact">

          <img
            src="/media/prompt_categories/%D0%94%D0%BB%D1%8F_%D1%80%D0%B0%D0%B7%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%BA%D0%B8_6FxTsie_XNZzzDu.jpg"
            alt="Для разработки"
            class="category-image-compact"
            loading="lazy"
            decoding="async"
            fetchpriority="low"
            width="600"
            height="600"
          >

          <div class="category-overlay-compact"></div>
          <h3 class="category-name-compact">Для разработки</h3>


          <div class="pc-card-actions">
            <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="48">✎</button>
            <button class="pc-btn pc-del" type="button" title="Удалить" data-id="48">✕</button>
          </div>

        </div>
      </div>



      <div class="category-card-compact" data-category-id="52" data-name="Животные" data-desc="Дикие и домашние животные" data-order="7" data-active="1" data-image-url="/media/prompt_categories/-6_4AiwdcN.jpg">
        <div class="category-image-wrapper-compact">

          <img
            src="/media/prompt_categories/-6_4AiwdcN.jpg"
            alt="Животные"
            class="category-image-compact"
            loading="lazy"
            decoding="async"
            fetchpriority="low"
            width="600"
            height="600"
          >

          <div class="category-overlay-compact"></div>
          <h3 class="category-name-compact">Животные</h3>


          <div class="pc-card-actions">
            <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="52">✎</button>
            <button class="pc-btn pc-del" type="button" title="Удалить" data-id="52">✕</button>
          </div>

        </div>
      </div>









































    <!-- Show All Button (6th element in first row) -->

    <button type="button" id="showAllCategoriesBtn" class="category-card-compact category-show-all">
      <div class="category-image-wrapper-compact">
        <div class="show-all-content">
          <svg class="show-all-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
          </svg>
          <span class="show-all-text">Все категории</span>
          <span class="show-all-count">40</span>
        </div>
      </div>
    </button>

  </div>


  <!-- All Categories Section -->
  <div id="allCategoriesSection" class="hidden mt-6">
    <div class="categories-grid-full">












        <div class="category-card-compact" data-category-id="53" data-name="Природа" data-desc="Природные явления и детали" data-order="8" data-active="1" data-image-url="/media/prompt_categories/-7_BUGwoph.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-7_BUGwoph.jpg"
              alt="Природа"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Природа</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="53">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="53">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="54" data-name="Еда" data-desc="Кулинарные шедевры и продукты" data-order="9" data-active="1" data-image-url="/media/prompt_categories/-8_gYgDf2k.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-8_gYgDf2k.jpg"
              alt="Еда"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Еда</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="54">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="54">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="55" data-name="Транспорт" data-desc="Автомобили, самолеты и другой транспорт" data-order="10" data-active="1" data-image-url="/media/prompt_categories/-9_QkjCMnF.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-9_QkjCMnF.jpg"
              alt="Транспорт"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Транспорт</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="55">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="55">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="56" data-name="Космос" data-desc="Космические пейзажи и объекты" data-order="11" data-active="1" data-image-url="/media/prompt_categories/-10_y1d4Cad.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-10_y1d4Cad.jpg"
              alt="Космос"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Космос</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="56">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="56">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="57" data-name="Абстракция" data-desc="Абстрактное искусство и формы" data-order="12" data-active="1" data-image-url="/media/prompt_categories/-11_O80q82S.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-11_O80q82S.jpg"
              alt="Абстракция"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Абстракция</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="57">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="57">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="58" data-name="Мода" data-desc="Модные образы и стиль" data-order="13" data-active="1" data-image-url="/media/prompt_categories/-12_Q7L6pmK.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-12_Q7L6pmK.jpg"
              alt="Мода"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Мода</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="58">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="58">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="59" data-name="Спорт" data-desc="Спортивные моменты и атлеты" data-order="14" data-active="1" data-image-url="/media/prompt_categories/-13_Og1wFPA.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-13_Og1wFPA.jpg"
              alt="Спорт"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Спорт</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="59">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="59">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="60" data-name="Технологии" data-desc="Современные технологии и гаджеты" data-order="15" data-active="1" data-image-url="/media/prompt_categories/-14_44rVmNB.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-14_44rVmNB.jpg"
              alt="Технологии"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Технологии</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="60">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="60">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="61" data-name="Интерьер" data-desc="Дизайн интерьеров и помещений" data-order="16" data-active="1" data-image-url="/media/prompt_categories/-15_6aGiIo6.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-15_6aGiIo6.jpg"
              alt="Интерьер"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Интерьер</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="61">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="61">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="62" data-name="Праздники" data-desc="Праздничные сцены и атмосфера" data-order="17" data-active="1" data-image-url="/media/prompt_categories/-16_OMklSK4.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-16_OMklSK4.jpg"
              alt="Праздники"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Праздники</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="62">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="62">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="63" data-name="Искусство" data-desc="Художественные произведения и творчество" data-order="18" data-active="1" data-image-url="/media/prompt_categories/-17_Cp1XcaK.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-17_Cp1XcaK.jpg"
              alt="Искусство"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Искусство</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="63">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="63">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="64" data-name="Наука" data-desc="Научные открытия и исследования" data-order="19" data-active="1" data-image-url="/media/prompt_categories/-18_yzO0ps1.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-18_yzO0ps1.jpg"
              alt="Наука"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Наука</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="64">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="64">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="65" data-name="Музыка" data-desc="Музыкальные инструменты и выступления" data-order="20" data-active="1" data-image-url="/media/prompt_categories/-19_SL99BwY.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-19_SL99BwY.jpg"
              alt="Музыка"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Музыка</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="65">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="65">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="66" data-name="История" data-desc="Исторические события и эпохи" data-order="21" data-active="1" data-image-url="/media/prompt_categories/-20_aEavTQb.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-20_aEavTQb.jpg"
              alt="История"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">История</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="66">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="66">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="67" data-name="Мифология" data-desc="Мифологические существа и легенды" data-order="22" data-active="1" data-image-url="/media/prompt_categories/-21_et3qOt3.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-21_et3qOt3.jpg"
              alt="Мифология"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Мифология</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="67">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="67">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="68" data-name="Города" data-desc="Городские пейзажи и улицы" data-order="23" data-active="1" data-image-url="/media/prompt_categories/-22_QPR1zkh.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-22_QPR1zkh.jpg"
              alt="Города"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Города</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="68">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="68">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="69" data-name="Подводный мир" data-desc="Морские глубины и обитатели" data-order="24" data-active="1" data-image-url="/media/prompt_categories/-23_DIxw6eq.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-23_DIxw6eq.jpg"
              alt="Подводный мир"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Подводный мир</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="69">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="69">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="70" data-name="Времена года" data-desc="Сезонные пейзажи и атмосфера" data-order="25" data-active="1" data-image-url="/media/prompt_categories/-24_l7dJbIm.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-24_l7dJbIm.jpg"
              alt="Времена года"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Времена года</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="70">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="70">✕</button>
            </div>

          </div>
        </div>



        <div class="category-card-compact" data-category-id="71" data-name="Профессии" data-desc="Люди разных профессий за работой" data-order="26" data-active="1" data-image-url="/media/prompt_categories/-25_IUH242A.jpg">
          <div class="category-image-wrapper-compact">

            <img
              src="/media/prompt_categories/-25_IUH242A.jpg"
              alt="Профессии"
              class="category-image-compact"
              loading="lazy"
              decoding="async"
              fetchpriority="low"
              width="600"
              height="600"
            >

            <div class="category-overlay-compact"></div>
            <h3 class="category-name-compact">Профессии</h3>


            <div class="pc-card-actions">
              <button class="pc-btn pc-edit" type="button" title="Редактировать" data-id="71">✎</button>
              <button class="pc-btn pc-del" type="button" title="Удалить" data-id="71">✕</button>
            </div>

          </div>
        </div>


    </div>

    <!-- Pagination -->

    <nav class="flex items-center justify-center mt-6" aria-label="Пагинация категорий">
      <div class="flex items-center gap-1 flex-wrap justify-center">






                <span class="btn btn-primary px-3 py-2 text-sm" aria-current="page">1</span>





                <a class="btn btn-ghost px-3 py-2 text-sm" href="?prompt_page=2#promptCats">2</a>






          <a class="btn btn-ghost px-3 py-2 text-sm" href="?prompt_page=2#promptCats" aria-label="Вперёд">
            <span class="hidden sm:inline">Вперёд</span>
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </a>
          <a class="btn btn-ghost px-3 py-2 text-sm" href="?prompt_page=2#promptCats" aria-label="Последняя">
            <span class="hidden sm:inline">Последняя</span>
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/>
            </svg>
          </a>

      </div>
    </nav>

  </div>
</div>


<!-- Edit Prompt Category Modal -->
<div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4" id="pcEditModal">
  <div class="bg-[var(--bg-card)] rounded-2xl max-w-xl w-full overflow-hidden border border-[var(--bord)] shadow-2xl">
    <div class="p-4 sm:p-6 border-b border-[var(--bord)] flex items-center justify-between">
      <h3 class="text-lg font-bold">Редактирование категории</h3>
      <button class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-[var(--bord)]" id="pcEditClose" type="button">✕</button>
    </div>
    <div class="p-4 sm:p-6 space-y-3">
      <input type="hidden" id="pcEditId">
      <input id="pcEditName" class="field w-full" type="text" placeholder="Название">
      <textarea id="pcEditDesc" class="field w-full" rows="3" placeholder="Описание"></textarea>
      <div class="grid grid-cols-2 gap-3">
        <input id="pcEditOrder" class="field" type="number" placeholder="Порядок">
        <label class="pc-inline"><input id="pcEditActive" type="checkbox"><span>Активна</span></label>
      </div>
      <label class="pc-file w-full">
        <input type="file" id="pcEditImage" accept="image/*">
        <span>Заменить изображение</span>
      </label>
      <div class="flex items-center justify-end gap-2 pt-2">
        <button class="btn btn-ghost" id="pcEditCancel" type="button">Отмена</button>
        <button class="btn btn-primary" id="pcEditSave" type="button">Сохранить</button>
      </div>
    </div>
  </div>
</div>


<style>
/* ===== Секция категорий ===== */
.prompt-categories-section {
  width: 100%;
}

/* При переходе по якорю фиксируем положение блока вверху вьюпорта
   с учётом возможной фиксированной шапки (адаптивно) */
#promptCats {
  scroll-margin-top: clamp(56px, 8vh, 96px);
}

.section-header {
  margin-bottom: 1.5rem;
}

.section-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text, #ffffff);
  margin: 0 0 0.25rem 0;
}

.section-subtitle {
  font-size: 0.875rem;
  color: var(--muted, rgba(255, 255, 255, 0.6));
  margin: 0;
}

.pc-admin-create {
  margin: 1rem 0 1.25rem 0;
  padding: 0.75rem;
  border: 1px solid var(--bord);
  border-radius: 0.75rem;
  background: rgba(0,0,0,.03);
}
html[data-theme="light"] .pc-admin-create { background: rgba(0,0,0,.02); }
.pc-admin-grid {
  display: grid;
  gap: 0.5rem;
  grid-template-columns: 2fr 3fr 1fr auto auto auto;
}
.pc-inline { display: inline-flex; align-items: center; gap: .5rem; padding: .5rem .75rem; border:1px dashed var(--bord); border-radius:.5rem; }
.pc-file { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border:1px dashed var(--bord); border-radius:.5rem; cursor:pointer; }
.pc-file input[type="file"]{ display:none; }

/* ===== Компактная сетка (6 элементов в ряд) ===== */
.categories-grid-compact {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 0.75rem;
}

.categories-grid-full {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 0.75rem;
}

/* ===== Компактная карточка ===== */
.category-card-compact {
  position: relative;
  cursor: pointer;
  border-radius: 0.75rem;
  overflow: hidden;
  transition: all 0.3s ease;
  background: transparent;
  border: none;
  padding: 0;
  width: 100%;
}

.category-card-compact:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 16px rgba(99, 102, 241, 0.2);
}

.category-image-wrapper-compact {
  position: relative;
  width: 100%;
  padding-bottom: 100%; /* Квадрат */
  overflow: hidden;
  border-radius: 0.75rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.category-image-compact {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.3s ease;
}

.category-card-compact:hover .category-image-compact {
  transform: scale(1.1);
}

.category-overlay-compact {
  position: absolute;
  inset: 0;
  background: linear-gradient(180deg, transparent 40%, rgba(0,0,0,0.85) 100%);
  z-index: 1;
  transition: background 0.3s ease;
}

.category-card-compact:hover .category-overlay-compact {
  background: linear-gradient(180deg, transparent 30%, rgba(0,0,0,0.9) 100%);
}

.category-name-compact {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  padding: 0.875rem 0.625rem;
  font-size: 0.9375rem;
  font-weight: 700;
  color: #ffffff;
  text-align: center;
  z-index: 2;
  margin: 0;
  text-shadow:
    0 2px 8px rgba(0,0,0,0.9),
    0 1px 3px rgba(0,0,0,0.8),
    -1px -1px 0 rgba(0,0,0,0.5),
    1px -1px 0 rgba(0,0,0,0.5),
    -1px 1px 0 rgba(0,0,0,0.5),
    1px 1px 0 rgba(0,0,0,0.5);
  line-height: 1.3;
  letter-spacing: 0.02em;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Admin buttons on card */
.pc-card-actions{
  position:absolute; top:6px; right:6px; z-index:3; display:flex; gap:6px;
}
.pc-btn{ background:rgba(0,0,0,.6); color:#fff; border:1px solid rgba(255,255,255,.25); width:28px; height:28px; line-height:26px; text-align:center; border-radius:8px; cursor:pointer; font-weight:700; }
.pc-btn:hover{ background:rgba(0,0,0,.8); }

/* ===== Кнопка "Показать все" ===== */
.category-show-all {
  background: transparent;
}

.category-show-all .category-image-wrapper-compact {
  /* Цвет как у кнопок сайта */
  background: var(--primary);
  position: relative;
  isolation: isolate; /* создаёт новый контекст наложения для оверлея */
}

.show-all-content {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.375rem;
  padding: 0.75rem;
  z-index: 1; /* контент поверх оверлея */
}

.show-all-icon {
  width: 1.75rem;
  height: 1.75rem;
  color: #ffffff;
  transition: transform 0.3s ease;
}
/* Оверлей для читаемости текста (обе темы) */
.category-show-all .category-image-wrapper-compact::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 0.75rem;
  background: linear-gradient(135deg, rgba(0,0,0,.18), rgba(0,0,0,.28));
  z-index: 0;
}
/* Усиление контраста в светлой теме */
html[data-theme="light"] .category-show-all .category-image-wrapper-compact::before {
  background: linear-gradient(135deg, rgba(0,0,0,.22), rgba(0,0,0,.35));
}
html[data-theme="light"] .category-show-all .category-image-wrapper-compact {
  border: 1px solid rgba(0,0,0,.06);
  box-shadow: 0 6px 16px rgba(0,0,0,.08);
}

.category-show-all:hover .show-all-icon {
  transform: translateY(4px);
}

.show-all-text {
  font-size: 0.8125rem;
  font-weight: 600;
  color: #ffffff;
  text-align: center;
  line-height: 1.2;
}

.show-all-count {
  font-size: 0.6875rem;
  color: rgba(255,255,255,0.8);
}

/* ===== Светлая тема ===== */
html[data-theme="light"] .section-title {
  color: #0f1419;
}

html[data-theme="light"] .section-subtitle {
  color: #6b7280;
}

html[data-theme="light"] .category-card-compact:hover {
  box-shadow: 0 8px 16px rgba(99, 102, 241, 0.15);
}

/* ===== Адаптив ===== */
@media (max-width: 1024px) {
  .categories-grid-compact,
  .categories-grid-full {
    grid-template-columns: repeat(4, 1fr);
  }
  .pc-admin-grid { grid-template-columns: 2fr 3fr 1fr auto auto auto; }
}

@media (max-width: 768px) {
  .categories-grid-compact,
  .categories-grid-full {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.625rem;
  }
  .pc-admin-grid { grid-template-columns: 1fr 1fr 1fr auto; }

  .category-name-compact {
    font-size: 0.8125rem;
    padding: 0.75rem 0.5rem;
  }

  .show-all-text {
    font-size: 0.75rem;
  }
}

@media (max-width: 640px) {
  .categories-grid-compact,
  .categories-grid-full {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
  }

  .category-name-compact {
    font-size: 0.75rem;
    padding: 0.625rem 0.375rem;
  }
}

@media (max-width: 480px) {
  .categories-grid-compact,
  .categories-grid-full {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }

  .category-name-compact {
    font-size: 0.8125rem;
    padding: 0.75rem 0.5rem;
  }

  .show-all-icon {
    width: 1.5rem;
    height: 1.5rem;
  }

  .show-all-text {
    font-size: 0.6875rem;
  }

  .show-all-count {
    font-size: 0.625rem;
  }
}

@media (max-width: 375px) {
  .category-name-compact {
    font-size: 0.75rem;
    padding: 0.625rem 0.375rem;
  }
}

@media (max-width: 320px) {
  .categories-grid-compact,
  .categories-grid-full {
    gap: 0.375rem;
  }

  .category-name-compact {
    font-size: 0.6875rem;
    padding: 0.5rem 0.25rem;
    letter-spacing: 0;
  }

  .show-all-icon {
    width: 1.25rem;
    height: 1.25rem;
  }

  .show-all-text {
    font-size: 0.625rem;
  }

  .section-title {
    font-size: 1rem;
  }

  .section-subtitle {
    font-size: 0.8125rem;
  }
}

/* ===== Анимация ===== */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

#allCategoriesSection:not(.hidden) {
  animation: fadeIn 0.3s ease-out;
}
/* Hide server pagination for prompt categories (client-side "Показать ещё") */
nav[aria-label="Пагинация категорий"] { display: none !important; }
</style>

<script>
(function initImagePrompts() {
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initImagePrompts, { once: true });
    return;
  }
  const IS_STAFF = (document.getElementById('gen-root')?.dataset.isStaff || 'false') === 'true';

  // CSRF helper
  function getCSRF() {
    const input = (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value;
    if (input) return input;
    const cookie = document.cookie.split('; ').find(row => row.startsWith('csrftoken='));
    return cookie ? cookie.split('=')[1] : '';
  }
  async function postFD(url, fd) {
    const r = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCSRF(), 'X-Requested-With': 'fetch' },
      body: fd,
      credentials: 'same-origin'
    });

    // Try to parse JSON when возможно
    let j = {};
    const ctype = (r.headers.get('content-type') || '').toLowerCase();
    if (ctype.includes('application/json')) {
      try { j = await r.json(); } catch(_) { j = {}; }
    } else {
      // Fallback — читаемый текст
      try { const t = await r.text(); j = { ok: r.ok, error: (t || '').slice(0, 300) }; } catch(_) { j = {}; }
    }

    // Если редиректит на страницу логина — явно сообщаем
    if (r.redirected) {
      const to = r.url || '';
      if (to.includes('/accounts/login') || to.includes('/admin/login')) {
        throw new Error('Требуется вход. Войдите под staff (админ) и повторите действие.');
      }
    }

    // Частые случаи с понятными подсказками
    if (r.status === 403) {
      throw new Error(j.error || 'Недостаточно прав (нужен staff) или CSRF-токен недействителен.');
    }
    if (r.status === 400) {
      throw new Error(j.error || 'Неверные данные формы. Проверьте поля.');
    }

    if (!r.ok || j.ok === false) {
      throw new Error(j.error || ('Ошибка ' + r.status));
    }
    return j;
  }
  async function postJSON(url, data) {
    const fd = new FormData();
    Object.entries(data || {}).forEach(([k, v]) => fd.append(k, v));
    return postFD(url, fd);
  }

  // Кнопка "Показать все категории"
  const showAllBtn = document.getElementById('showAllCategoriesBtn');
  const allCategoriesSection = document.getElementById('allCategoriesSection');
  const promptCatsEl = document.getElementById('promptCats');

  // Progressive "Show more" for image categories — 3 rows initially, responsive
  function setupShowMoreImages() {
    const compact = document.querySelector('.categories-grid-compact');
    const fullSection = document.getElementById('allCategoriesSection');
    const full = fullSection ? fullSection.querySelector('.categories-grid-full') : null;
    if (!compact) return;

    // Move all cards into a single grid
    const cards = [];
    compact.querySelectorAll('.category-card-compact').forEach(c => {
      if (!c.classList.contains('category-show-all')) cards.push(c);
    });
    if (full) {
      full.querySelectorAll('.category-card-compact').forEach(c => cards.push(c));
    }

    // Remove "Show all" and merge remaining cards into compact grid
    try { showAllBtn?.remove(); } catch(_) {}
    if (fullSection) {
      if (full) {
        full.querySelectorAll('.category-card-compact').forEach(c => {
          if (!c.classList.contains('category-show-all')) compact.appendChild(c);
        });
      }
      fullSection.remove();
    }

    // Create "Show more" button if not exists
    let btn = document.getElementById('pcShowMore');
    if (!btn) {
      btn = document.createElement('button');
      btn.id = 'pcShowMore';
      btn.type = 'button';
      btn.className = 'btn btn-ghost w-full mt-4 text-sm';
      btn.innerHTML = '<span>Показать ещё</span>';
      // place right after grid
      compact.parentElement.appendChild(btn);
    }

    function getCols() {
      const cs = getComputedStyle(compact);
      const cols = (cs.gridTemplateColumns || '').split(' ').filter(Boolean).length || 3;
      return Math.max(1, cols);
    }

    let extraRows = 0;

    function update() {
      const cols = getCols();
      const base = 3 * cols; // 3 rows initially
      const visible = base + extraRows * cols;
      const allCards = Array.from(compact.querySelectorAll('.category-card-compact'));
      let shown = 0;
      allCards.forEach(card => {
        const hide = shown >= visible;
        card.classList.toggle('hidden', hide);
        if (!hide) shown += 1;
      });
      btn.style.display = shown >= allCards.length ? 'none' : '';
    }

    update();
    btn.addEventListener('click', () => { extraRows += 1; update(); });
    window.addEventListener('resize', () => { update(); });
  }

  // Initialize 3-rows + "Show more" for image categories
  setupShowMoreImages();

  // Оставаться строго на блоке подсказок после перехода по пагинации/якорю
  function stayOnPromptCats() {
    if (!promptCatsEl) return;
    try {
      const usp = new URLSearchParams(window.location.search);
      if (window.location.hash === '#promptCats' || usp.has('prompt_page')) {
        // Даем браузеру отрисовать разметку, затем скроллим к началу блока
        setTimeout(() => {
          try { promptCatsEl.scrollIntoView({ behavior: 'auto', block: 'start' }); }
          catch(_) { window.location.hash = '#promptCats'; }
        }, 0);
      }
    } catch(_) {}
  }
  stayOnPromptCats();

  // Тоггл показа всех категорий (кнопка "Все категории" <-> "Скрыть")
  function setShowAllState(expanded) {
    if (!allCategoriesSection) return;
    const icon = showAllBtn?.querySelector('.show-all-icon');
    const text = showAllBtn?.querySelector('.show-all-text');
    if (expanded) {
      allCategoriesSection.classList.remove('hidden');
      if (text) text.textContent = 'Скрыть';
      if (icon) icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>';
    } else {
      allCategoriesSection.classList.add('hidden');
      if (text) text.textContent = 'Все категории';
      if (icon) icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>';
    }
  }

  let expanded = false;

  if (showAllBtn && allCategoriesSection) {
    showAllBtn.addEventListener('click', function() {
      expanded = !expanded;
      setShowAllState(expanded);
      // Плавная прокрутка
      if (expanded) {
        setTimeout(() => {
          try { allCategoriesSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } catch(_) {}
        }, 100);
      } else {
        try { showAllBtn.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch(_) {}
      }
    });
  }

  // Авторазворачивание отключено: на странице генерации всегда стартуем в свернутом состоянии

  // Обработка кликов по категориям - открытие модального окна с промптами
  const categoryCards = document.querySelectorAll('.category-card-compact:not(.category-show-all)');

  categoryCards.forEach(card => {
    card.addEventListener('click', async function(e) {
      // игнор кликов по админ-кнопкам
      if (e.target.closest('.pc-card-actions')) return;

      const categoryId = this.dataset.categoryId;
      if (!categoryId) return;

      const categoryName = this.querySelector('.category-name-compact').textContent;
      const modal = document.getElementById('promptCategoryModal');
      const modalTitle = document.getElementById('modalCategoryTitle');
      const modalContainer = document.getElementById('modalPromptsContainer');

      if (!modal || !modalTitle || !modalContainer) {
        console.error('Modal elements not found');
        return;
      }

      modalTitle.textContent = categoryName;
      modalContainer.innerHTML = '<div class="text-center text-[var(--muted)] py-8">Загрузка...</div>';
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      try {
        const response = await fetch(`/generate/api/categories/${categoryId}/prompts`);
        const data = await response.json();

        const adminCreate = IS_STAFF ? `
          <div class="p-3 mb-3 rounded-xl border border-[var(--bord)] bg-black/[.03] dark:bg-white/[.03]">
            <div class="grid gap-2 sm:grid-cols-2">
              <input id="cpTitle" class="field" type="text" placeholder="Заголовок" maxlength="150">
              <input id="cpOrder" class="field" type="number" placeholder="Порядок" value="0">
              <select id="cpSubcat" class="field">
                <option value="">Без подкатегории</option>
              </select>
              <textarea id="cpText" class="field sm:col-span-2" rows="3" placeholder="Текст промпта"></textarea>
              <textarea id="cpEn" class="field sm:col-span-2" rows="3" placeholder="Английский промпт (опционально)"></textarea>
              <label class="pc-inline"><input id="cpActive" type="checkbox" checked><span>Активен</span></label>
              <div class="flex items-center justify-end sm:justify-start">
                <button id="cpCreateBtn" class="btn btn-primary" type="button">+ Промпт</button>
              </div>
            </div>
            <div class="mt-3 rounded-lg border border-[var(--bord)] p-3">
              <div class="text-xs text-[var(--muted)] mb-2">Подкатегории (админ)</div>
              <div class="grid gap-2 sm:grid-cols-3">
                <input id="scName" class="field" type="text" placeholder="Название подкатегории" maxlength="120">
                <input id="scOrder" class="field" type="number" placeholder="Порядок" value="0">
                <label class="pc-inline"><input id="scActive" type="checkbox" checked><span>Активна</span></label>
              </div>
              <div class="mt-2 flex justify-end">
                <button id="scCreateBtn" class="btn btn-ghost" type="button">+ Подкатегория</button>
              </div>
            </div>
          </div>
        ` : '';

        const items = (data.prompts || []).map(prompt => `
          <div class="prompt-item-modal" data-id="${prompt.id}" data-prompt="${escapeHtml(prompt.prompt_text)}" data-prompt-en="${escapeHtml(prompt.prompt_en_raw || '')}" data-order="${prompt.order||0}" data-active="${prompt.is_active ? '1':'0'}">
            <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 items-start">
              <p class="text-sm text-[var(--muted)] leading-relaxed flex-1 min-w-0">${escapeHtml(prompt.prompt_text)}</p>
              <div class="flex items-center gap-2">
                ${IS_STAFF ? `<button class="btn btn-ghost text-xs js-cp-edit" type="button">Редактировать</button><button class="btn btn-ghost text-xs js-cp-del" type="button">Удалить</button>` : ''}
                <button class="btn btn-primary shrink-0 w-full sm:w-auto js-use-btn">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                  Использовать
                </button>
              </div>
            </div>
          </div>
        `).join('');

        modalContainer.innerHTML = `
          ${adminCreate}
          <div id="pg-subcats" class="flex flex-wrap gap-2 mb-3"></div>
          <div id="pg-items" class="space-y-3">${items || '<div class="text-center text-[var(--muted)] py-8">Промпты не найдены</div>'}</div>
        `;

        // Load subcategories and render pills + fill admin select
        async function loadSubcategories() {
          try {
            const r = await fetch(`/generate/api/prompt-categories/${categoryId}/subcategories`);
            const j = await r.json();
            const wrap = modalContainer.querySelector('#pg-subcats');
            if (!wrap) return;

            const subs = (j.subcategories || []);

            // Fill admin select for prompt creation
            const sel = modalContainer.querySelector('#cpSubcat');
            if (sel) {
              sel.innerHTML = `<option value="">Без подкатегории</option>` + subs.map(sc => `<option value="${sc.id}">${escapeHtml(sc.name)}</option>`).join('');
            }

            // Render subcategory pills
            const pills = [];
            pills.push(`<button type="button" class="px-3 py-1.5 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] text-xs sm:text-sm pg-subpill" data-id="">Все</button>`);
            subs.forEach(sc => {
              pills.push(`<button type="button" class="px-3 py-1.5 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] hover:border-primary/60 hover:text-primary text-xs sm:text-sm pg-subpill" data-id="${sc.id}">${escapeHtml(sc.name)} <span class="text-[var(--muted)]">(${sc.prompts_count})</span></button>`);
            });
            wrap.innerHTML = pills.join('');

            // Bind pill clicks
            wrap.querySelectorAll('.pg-subpill').forEach(btn => {
              btn.addEventListener('click', async () => {
                const subId = btn.dataset.id || '';
                wrap.querySelectorAll('.pg-subpill').forEach(b => b.classList.remove('bg-primary/15','text-primary','border-primary/30'));
                const itemsWrap = modalContainer.querySelector('#pg-items');

                if (subId === '') {
                  btn.classList.add('bg-primary/15','text-primary','border-primary/30');
                  itemsWrap.innerHTML = `${items || '<div class="text-center text-[var(--muted)] py-8">Промпты не найдены</div>'}`;
                  bindUseButtons(itemsWrap);
                } else {
                  try {
                    const r2 = await fetch(`/generate/api/subcategories/${subId}/prompts`);
                    const j2 = await r2.json();
                    const dataItems = (j2.prompts || []);
                    const itemsHtml = dataItems.map(prompt => `
                      <div class="prompt-item-modal" data-id="${prompt.id}" data-prompt="${escapeHtml(prompt.prompt_text)}" data-prompt-en="${escapeHtml(prompt.prompt_en_raw || '')}" data-order="${prompt.order||0}" data-active="${prompt.is_active ? '1':'0'}">
                        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 items-start">
                          <p class="text-sm text-[var(--muted)] leading-relaxed flex-1 min-w-0">${escapeHtml(prompt.prompt_text)}</p>
                          <div class="flex items-center gap-2">
                            ${IS_STAFF ? `<button class="btn btn-ghost text-xs js-cp-edit" type="button">Редактировать</button><button class="btn btn-ghost text-xs js-cp-del" type="button">Удалить</button>` : ''}
                            <button class="btn btn-primary shrink-0 w-full sm:w-auto prompt-use-btn">
                              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                              Использовать
                            </button>
                          </div>
                        </div>
                      </div>
                    `).join('');
                    itemsWrap.innerHTML = itemsHtml || '<div class="text-center text-[var(--muted)] py-8">Промпты не найдены</div>';
                    bindUseButtons(itemsWrap);
                    btn.classList.add('bg-primary/15','text-primary','border-primary/30');
                  } catch (e) {
                    itemsWrap.innerHTML = '<div class="text-center text-red-500 py-8">Ошибка загрузки подкатегории</div>';
                  }
                }
              });
            });

            // Admin: create subcategory
            modalContainer.querySelector('#scCreateBtn')?.addEventListener('click', async () => {
              const name = (modalContainer.querySelector('#scName')?.value || '').trim();
              const order = modalContainer.querySelector('#scOrder')?.value || '0';
              const active = modalContainer.querySelector('#scActive')?.checked ? '1' : '0';
              if (!name) { alert('Введите название подкатегории'); return; }
              try {
                await postJSON('/generate/api/subcategories/create', { category_id: categoryId, name, order, is_active: active });
                await loadSubcategories();
                (modalContainer.querySelector('#scName') || {}).value = '';
                (modalContainer.querySelector('#scOrder') || {}).value = '0';
              } catch (e) { alert(e.message || String(e)); }
            });

            // Default selection: "Все"
            const first = wrap.querySelector('.pg-subpill[data-id=""]');
            if (first) first.click();
          } catch (e) {
            // silent
          }
        }

        // Local helpers to (re)bind "Use" buttons inside current container
        function bindUseButtons(rootEl) {
          rootEl.querySelectorAll('.prompt-use-btn, .js-use-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              const promptItem = this.closest('.prompt-item-modal');
              const promptTextEn = promptItem?.dataset.promptEn;
              const promptTextRu = promptItem?.dataset.prompt;
              const promptToUse = promptTextEn && promptTextEn.trim() !== '' ? promptTextEn : promptTextRu;

              copyToClipboard(promptToUse || '');

              const originalHTML = this.innerHTML;
              this.innerHTML = `
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Скопировано!
              `;
              this.classList.add('copied');
              setTimeout(() => { this.innerHTML = originalHTML; this.classList.remove('copied'); }, 2000);

              const promptField = document.getElementById('prompt');
              if (promptField && promptToUse) {
                const currentValue = promptField.value.trim();
                promptField.value = currentValue ? (currentValue + ', ' + promptToUse) : promptToUse;
                promptField.focus();
              }
              closePromptModal();
            });
          });
        }

        // Bootstrap subcategories UI
        loadSubcategories();

        // Create prompt
        if (IS_STAFF) {
          modalContainer.querySelector('#cpCreateBtn')?.addEventListener('click', async () => {
            const title = (modalContainer.querySelector('#cpTitle')?.value || '').trim();
            const text = (modalContainer.querySelector('#cpText')?.value || '').trim();
            const en = (modalContainer.querySelector('#cpEn')?.value || '').trim();
            const order = modalContainer.querySelector('#cpOrder')?.value || '0';
            const active = modalContainer.querySelector('#cpActive')?.checked ? '1' : '0';
            if (!title || !text) { alert('Заполните заголовок и текст'); return; }
            try {
              const subSel = modalContainer.querySelector('#cpSubcat');
              const subcategory_id = (subSel && subSel.value) ? subSel.value : '';
              await postJSON('/generate/api/prompts/create', { category_id: categoryId, subcategory_id, title, prompt_text: text, prompt_en: en, order, is_active: active });
              location.reload();
            } catch (e) { alert(e.message || String(e)); }
          });
        }

        // Use buttons
        modalContainer.querySelectorAll('.js-use-btn').forEach(btn => {
          btn.addEventListener('click', function(e) {
            e.stopPropagation();
            const promptItem = this.closest('.prompt-item-modal');

            const promptTextEn = promptItem.dataset.promptEn;
            const promptTextRu = promptItem.dataset.prompt;
            const promptToUse = promptTextEn && promptTextEn.trim() !== '' ? promptTextEn : promptTextRu;

            copyToClipboard(promptToUse);

            const originalHTML = this.innerHTML;
            this.innerHTML = `
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
              </svg>
              Скопировано!
            `;
            this.classList.add('copied');

            setTimeout(() => {
              this.innerHTML = originalHTML;
              this.classList.remove('copied');
            }, 2000);

            const promptField = document.getElementById('prompt');
            if (promptField) {
              const currentValue = promptField.value.trim();
              if (currentValue) {
                promptField.value = currentValue + ', ' + promptToUse;
              } else {
                promptField.value = promptToUse;
              }
              promptField.focus();
            }

            closePromptModal();
          });
        });

        // Edit/delete prompt (admin)
        if (IS_STAFF) {
          modalContainer.addEventListener('click', async (ev) => {
            const editBtn = ev.target.closest('.js-cp-edit');
            const delBtn = ev.target.closest('.js-cp-del');
            const item = ev.target.closest('.prompt-item-modal');
            if (!item) return;

            if (delBtn) {
              ev.preventDefault();
              if (!confirm('Удалить промпт?')) return;
              try {
                await postJSON(`/generate/api/prompts/${item.dataset.id}/delete`, {});
                location.reload();
              } catch (e) { alert(e.message || String(e)); }
              return;
            }
            if (editBtn) {
              ev.preventDefault();
              const title = prompt('Заголовок', item.querySelector('p')?.textContent?.slice(0, 150) || '');
              if (title === null) return;
              const text = prompt('Текст промпта', item.dataset.prompt || '');
              if (text === null) return;
              const en = prompt('Английский промпт', item.dataset.promptEn || '');
              if (en === null) return;
              const order = prompt('Порядок', item.dataset.order || '0');
              if (order === null) return;
              const active = confirm('Сделать активным? ОК=Да, Отмена=Нет');
              try {
                await postJSON(`/generate/api/prompts/${item.dataset.id}/update`, {
                  title, prompt_text: text, prompt_en: en, order, is_active: active ? '1' : '0'
                });
                location.reload();
              } catch (e) { alert(e.message || String(e)); }
              return;
            }
          });
        }
      } catch (error) {
        console.error('Error loading prompts:', error);
        modalContainer.innerHTML = '<div class="text-center text-red-500 py-8">Ошибка загрузки промптов</div>';
      }
    });
  });

  function closePromptModal() {
    const modal = document.getElementById('promptCategoryModal');
    if (modal) {
      modal.classList.remove('active');
      document.body.style.overflow = '';
    }
  }

  // Ensure modal can be closed by the cross, overlay and Escape
  document.getElementById('closePromptModal')?.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    closePromptModal();
  });
  document.getElementById('promptCategoryModal')?.addEventListener('click', (e) => {
    var t = e.target;
    if (t && t.id === 'promptCategoryModal') {
      closePromptModal();
    }
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closePromptModal();
  });

  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text);
    } else {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Admin: create category
  // Provide a global fallback handler so click works even if listener didn't bind
  window.__pcCreate = async function(ev) {
    try {
      const btn = ev?.currentTarget || document.getElementById('pcCreateBtn');
      const name = (document.getElementById('pcName')?.value || '').trim();
      const desc = (document.getElementById('pcDesc')?.value || '').trim();
      const order = document.getElementById('pcOrder')?.value || '0';
      const active = document.getElementById('pcActive')?.checked ? '1' : '0';
      const imgInput = document.getElementById('pcImage');
      const status = document.getElementById('pcStatus');
      if (!name) { alert('Введите название'); return false; }

      const fd = new FormData();
      fd.append('name', name);
      if (desc) fd.append('description', desc);
      fd.append('order', order);
      fd.append('is_active', active);
      if (imgInput?.files?.[0]) fd.append('image', imgInput.files[0]);

      if (btn) { btn.disabled = true; btn.textContent = 'Создание...'; }
      if (status) { status.textContent = 'Отправка запроса...'; status.style.color = 'var(--muted)'; }

      const res = await postFD('/generate/api/prompt-categories/create', fd);
      if (status) { status.textContent = 'Готово: ' + (res?.name || name); status.style.color = '#10b981'; }
      location.reload();
      return false;
    } catch (e) {
      const status = document.getElementById('pcStatus');
      if (status) { status.textContent = 'Ошибка: ' + (e.message || String(e)); status.style.color = '#ef4444'; }
      alert(e.message || String(e));
      const btn = document.getElementById('pcCreateBtn');
      if (btn) { btn.disabled = false; btn.textContent = '+ Категория'; }
      return false;
    }
  };

  // Form submit fallback (progressive enhancement)
  window.__pcSubmit = async function(ev) {
    try {
      ev.preventDefault();
      const form = ev.currentTarget || document.getElementById('pcForm');
      const btn = document.getElementById('pcCreateBtn');
      const status = document.getElementById('pcStatus');
      const fd = new FormData(form);
      const name = (fd.get('name') || '').toString().trim();
      if (!name) { alert('Введите название'); return false; }
      if (btn) { btn.disabled = true; btn.textContent = 'Создание...'; }
      if (status) { status.textContent = 'Отправка запроса...'; status.style.color = 'var(--muted)'; }
      const res = await postFD(form.action, fd);
      if (status) { status.textContent = 'Готово: ' + (res?.name || name); status.style.color = '#10b981'; }
      location.reload();
      return false;
    } catch (e) {
      const btn = document.getElementById('pcCreateBtn');
      const status = document.getElementById('pcStatus');
      if (status) { status.textContent = 'Ошибка: ' + (e.message || String(e)); status.style.color = '#ef4444'; }
      alert(e.message || String(e));
      if (btn) { btn.disabled = false; btn.textContent = '+ Категория'; }
      return false;
    }
  };

  // Bind by presence of staff-only controls in DOM (more robust than relying on dataset)
  if (document.getElementById('pcCreateBtn')) {
    document.getElementById('pcCreateBtn')?.addEventListener('click', async (ev) => {
      const btn = ev.currentTarget;
      const name = (document.getElementById('pcName')?.value || '').trim();
      const desc = (document.getElementById('pcDesc')?.value || '').trim();
      const order = document.getElementById('pcOrder')?.value || '0';
      const active = document.getElementById('pcActive')?.checked ? '1' : '0';
      const imgInput = document.getElementById('pcImage');

      if (!name) { alert('Введите название'); return; }

      const fd = new FormData();
      fd.append('name', name);
      if (desc) fd.append('description', desc);
      fd.append('order', order);
      fd.append('is_active', active);
      if (imgInput?.files?.[0]) fd.append('image', imgInput.files[0]);

      try {
        // Visual feedback while sending
        const status = document.getElementById('pcStatus');
        const oldText = btn.textContent;
        btn.textContent = 'Создание...';
        btn.disabled = true;
        if (status) { status.textContent = 'Отправка запроса...'; status.style.color = 'var(--muted)'; }

        const res = await postFD('/generate/api/prompt-categories/create', fd);
        console.log('PromptCategory created:', res);
        if (status) { status.textContent = 'Готово: ' + (res?.name || name); status.style.color = '#10b981'; }
        // Перезагрузим для обновления списка
        location.reload();
      } catch (e) {
        console.error('Create category failed:', e);
        const status = document.getElementById('pcStatus');
        if (status) { status.textContent = 'Ошибка: ' + (e.message || String(e)); status.style.color = '#ef4444'; }
        alert(e.message || String(e));
      } finally {
        btn.disabled = false;
        btn.textContent = '+ Категория';
      }
    });

    // Admin: edit/delete category
    document.addEventListener('click', async (e) => {
      const btnEdit = e.target.closest('.pc-edit');
      const btnDel = e.target.closest('.pc-del');

      if (btnDel) {
        e.preventDefault(); e.stopPropagation();
        const id = btnDel.dataset.id;
        if (!confirm('Удалить категорию? Все промпты будут удалены вместе с ней.')) return;
        try { await postJSON(`/generate/api/prompt-categories/${id}/delete`, {}); location.reload(); }
        catch (e2) { alert(e2.message || String(e2)); }
        return;
      }

      if (btnEdit) {
        e.preventDefault(); e.stopPropagation();
        const card = btnEdit.closest('.category-card-compact');
        const id = btnEdit.dataset.id;
        // Fill modal
        const modal = document.getElementById('pcEditModal');
        modal?.classList.add('active');
        if (modal) {
          modal.style.display = 'flex';
          document.body.style.overflow = 'hidden';
        }
        document.getElementById('pcEditId').value = id;
        document.getElementById('pcEditName').value = card?.dataset.name || '';
        document.getElementById('pcEditDesc').value = card?.dataset.desc || '';
        document.getElementById('pcEditOrder').value = card?.dataset.order || '0';
        document.getElementById('pcEditActive').checked = (card?.dataset.active === '1');
      }
    });

    function closePcEdit() {
      const modal = document.getElementById('pcEditModal');
      if (modal) { modal.classList.remove('active'); modal.style.display = 'none'; document.body.style.overflow = ''; }
    }
    document.getElementById('pcEditClose')?.addEventListener('click', closePcEdit);
    document.getElementById('pcEditCancel')?.addEventListener('click', closePcEdit);
    document.getElementById('pcEditModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'pcEditModal') closePcEdit();
    });
    document.getElementById('pcEditSave')?.addEventListener('click', async () => {
      const id = document.getElementById('pcEditId').value;
      const name = document.getElementById('pcEditName').value;
      const desc = document.getElementById('pcEditDesc').value;
      const order = document.getElementById('pcEditOrder').value;
      const active = document.getElementById('pcEditActive').checked ? '1' : '0';
      const img = document.getElementById('pcEditImage').files?.[0];
      const fd = new FormData();
      if (name) fd.append('name', name);
      fd.append('description', desc || '');
      fd.append('order', order || '0');
      fd.append('is_active', active);
      if (img) fd.append('image', img);
      try { await postFD(`/generate/api/prompt-categories/${id}/update`, fd); location.reload(); }
      catch (e) { alert(e.message || String(e)); }
    });
  }
})();
</script>

  </div>


  <!-- Suggestions Section -->


  <!-- Showcase Section -->
  <div id="showcaseSection" class="card p-4 sm:p-6 lg:p-8" aria-labelledby="showcaseTitle" style="scroll-margin-top: clamp(56px, 8vh, 96px); ">
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between sm:gap-4 mb-4 sm:mb-6">
      <div>
        <h2 id="showcaseTitle" class="text-lg sm:text-xl lg:text-2xl font-bold">Примеры результатов</h2>
        <p class="text-xs sm:text-sm text-[var(--muted)] mt-1">Вдохновляйтесь работами других пользователей</p>
      </div>

          <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">

          <a href="/admin/generate/showcaseimage/add/" class="btn btn-primary text-xs sm:text-sm whitespace-nowrap" target="_blank">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Добавить пример
          </a>


        <div class="overflow-x-auto no-scrollbar -mx-2 px-2">
          <div class="flex items-center gap-2 min-w-max">
            <a class="pill js-showcase-filter text-xs sm:text-sm" data-category="portrait" href="?scat=portrait#showcaseSection">Портреты</a>
            <a class="pill js-showcase-filter text-xs sm:text-sm" data-category="fashion" href="?scat=fashion#showcaseSection">Мода</a>
            <a class="pill js-showcase-filter text-xs sm:text-sm" data-category="art" href="?scat=art#showcaseSection">Арт</a>
            <a class="pill js-showcase-filter text-xs sm:text-sm" data-category="nature" href="?scat=nature#showcaseSection">Природа</a>
            <a class="pill js-showcase-filter text-xs sm:text-sm" data-category="fantasy" href="?scat=fantasy#showcaseSection">Фэнтези</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Mobile: 1 column (320px), 2 columns (480px+), Tablet: 3 columns, Desktop: 4 columns -->
    <div class="grid grid-cols-1 xs:grid-cols-2 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-5 gap-3 sm:gap-4 lg:gap-6" id="showcaseGrid"></div>



  <!-- Why Choose Us -->
  <div class="card p-6 mt-6">
    <h2 class="text-lg font-semibold mb-6">Почему именно мы</h2>
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
      <div>
        <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L4 21l1.5-6L2 10l6-.75L12 3l2 6.25 6 .75-3.5 5 1.5 6z"/>
          </svg>
        </div>
        <h3 class="font-semibold mb-2">Фотореализм без «мыла»</h3>
        <p class="text-sm text-[var(--muted)]">Подбор моделей и параметров под задачу: портреты, предметка, интерьер, арт-стили.</p>
      </div>

      <div>
        <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
          </svg>
        </div>
        <h3 class="font-semibold mb-2">Честная стоимость</h3>
        <p class="text-sm text-[var(--muted)]">Прозрачные токены: 1 обработка = 10 TOK. Без скрытых платежей.</p>
      </div>

      <div>
        <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/>
          </svg>
        </div>
        <h3 class="font-semibold mb-2">Кеш и прямые ссылки</h3>
        <p class="text-sm text-[var(--muted)]">Файлы доступны по прямому URL. Если CDN уходит в 5xx — отдаём внешний URL.</p>
      </div>

      <div>
        <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z"/>
          </svg>
        </div>
        <h3 class="font-semibold mb-2">Гостевой бонус</h3>
        <p class="text-sm text-[var(--muted)]">Гости получают 30 TOK. Остаток безопасно «доезжает» до аккаунта.</p>
      </div>

      <div>
        <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        <h3 class="font-semibold mb-2">Защита от NSFW</h3>
        <p class="text-sm text-[var(--muted)]">Фильтрация по настройке, чтобы проект был дружелюбным к публике.</p>
      </div>

      <div>
        <div class="flex h-11 w-11 items-center justify-center rounded-2xl bg-primary/15 text-primary mb-4">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
          </svg>
        </div>
        <h3 class="font-semibold mb-2">Стабильная очередь</h3>
        <p class="text-sm text-[var(--muted)]">Асинхронный провайдер + резервный поллинг, чтобы заказы не «зависали».</p>
      </div>
    </div>
  </div>

</div>

<!-- Generation Loader -->
<div class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden" id="glx" aria-hidden="true">
  <div class="card p-8 max-w-md w-full mx-4 text-center" role="dialog" aria-labelledby="glxTitle" aria-live="polite">
    <!-- Animated Ring -->
    <div class="relative w-16 h-16 mx-auto mb-6">
      <div class="absolute inset-0 rounded-full border-4 border-[var(--bord)]"></div>
      <div class="absolute inset-0 rounded-full border-4 border-primary border-t-transparent animate-spin" id="glxArc"></div>
      <!-- <div class="absolute top-0 left-1/2 w-2 h-2 bg-primary rounded-full transform -translate-x-1/2 -translate-y-1"></div> -->
    </div>

    <h2 class="text-xl font-semibold mb-2" id="glxTitle">Генерируем магию…</h2>
    <div class="text-[var(--muted)] mb-4" id="glxPhase">Подготовка</div>

    <!-- Progress Bar -->
    <div class="relative w-full h-2 bg-[var(--bord)] rounded-full mb-3 overflow-hidden">
      <div class="absolute inset-y-0 left-0 bg-primary rounded-full transition-all duration-300" id="glxBar" style="width:0%"></div>
    </div>
    <div class="text-sm font-medium" id="glxPct">0%</div>

    <button class="btn btn-ghost mt-6" id="glxMin" type="button">Свернуть</button>
  </div>
</div>

  </main>


  <footer class="border-t border-[var(--bord)] bg-[var(--bg)]/80 backdrop-blur-sm pt-12 mt-10">
    <div class="container py-10">
      <div class="grid grid-auto-fit gap-6">
        <div>
          <div class="flex items-center gap-2">
            <img src="/static/img/logo.e58a21386e1e.png" alt="Pixera" class="h-9 w-auto" loading="lazy">
            <span class="text-lg font-semibold">Pixera.net</span>
          </div>
          <p class="mt-3 text-sm text-[var(--muted)]">Галерея и генерация ИИ-изображений. Адаптив до 320 px, тёмная/светлая тема.</p>
        </div>
        <div>
          <h4 class="text-sm font-semibold">Sections</h4>
          <ul class="mt-3 space-y-2 text-sm text-[var(--muted)]">
            <li><a href="/en/" class="hover:text-[var(--text)] transition">Home</a></li>
            <li><a href="/en/gallery/" class="hover:text-[var(--text)] transition">Gallery</a></li>
            <li><a href="/en/gallery/trending" class="hover:text-[var(--text)] transition">Trending</a></li>
            <li><a href="/en/generate/photo" class="hover:text-[var(--text)] transition">Generate</a></li>
            <li class="lg:hidden"><a href="/en/blog/" class="hover:text-[var(--text)] transition">Блог</a></li>
          </ul>
        </div>
        <div>
          <h4 class="text-sm font-semibold">Company</h4>
          <ul class="mt-3 space-y-2 text-sm text-[var(--muted)]">
            <li><a href="/en/about" class="hover:text-[var(--text)] transition">About</a></li>
            <li><a href="/en/contact" class="hover:text-[var(--text)] transition">Contact us</a></li>
            <li><a href="/en/privacy" class="hover:text-[var(--text)] transition">Privacy policy</a></li>
          </ul>
        </div>
        <div>
          <h4 class="text-sm font-semibold">Разработчикам</h4>
          <ul class="mt-3 space-y-2 text-sm text-[var(--muted)]">
            <li><a href="/en/dashboard/api/documentation/" class="hover:text-[var(--text)] transition">API Документация</a></li>

            <li><a href="/en/dashboard/api/" class="hover:text-[var(--text)] transition">API Управление</a></li>

          </ul>
        </div>
      </div>
      <div class="mt-8 flex flex-wrap items-center justify-between gap-3 border-t border-[var(--bord)] pt-6 text-xs text-[var(--muted)]">
        <span>© 2025 Pixera — all rights reserved.</span>
        <div class="flex items-center gap-4">
          <a href="/en/privacy" class="hover:text-[var(--text)] transition">Terms</a>
          <a href="/en/privacy" class="hover:text-[var(--text)] transition">Privacy</a>
          <a href="/en/contact" class="hover:text-[var(--text)] transition">Security</a>
        </div>
      </div>
    </div>
  </footer>







  <form id="setlang-fallback" class="sr-only" action="/i18n/setlang/" method="post" aria-hidden="true">
    <input type="hidden" name="csrfmiddlewaretoken" value="l8loxdnyNvSnvVrbCELsBqrG6yD1b4N723o86ogOCWrm9QnWm5rPGUGwByV2EyBx">
    <input type="hidden" name="next" value="/en/generate/video">
    <input type="hidden" name="language" value="">
  </form>


  <script src="/static/js/main.e9d6e6fa5c95.js"></script>
  <script src="/static/js/language-switcher.4fd0646affed.js"></script>
  <script src="/static/js/interactions.099faf558720.js"></script>
  <script src="/static/js/trending.c43f77baab5d.js"></script>
  <script src="/static/js/video-viewer.9c0ad0c851e4.js" defer></script>
  <script>
    (function(){
      var notifHref = "/en/dashboard/notifications";
      var UNREAD_URL = "/en/dashboard/api/notifications/unread-count/";
      var lastUnread = null;
      var notifAudioCtx = null;
      var notifSoundUnlocked = false;

      function unlockNotifSound(){
        if (notifSoundUnlocked) return;
        try{
          if (!notifAudioCtx) {
            notifAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
          }
          var p = notifAudioCtx.resume();
          if (p && typeof p.then === 'function') {
            p.then(function(){ notifSoundUnlocked = true; }).catch(function(){});
          } else {
            notifSoundUnlocked = true;
          }
        }catch(_){}
      }

      function playBeep(){
        try{
          if (!notifAudioCtx) {
            notifAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
          }
          if (notifAudioCtx.state === 'suspended') {
            notifAudioCtx.resume().catch(function(){});
          }
          var ctx = notifAudioCtx;
          var now = ctx.currentTime;

          var osc1 = ctx.createOscillator();
          var osc2 = ctx.createOscillator();
          var gain = ctx.createGain();

          osc1.type = 'sine';
          osc2.type = 'sine';

          // тот же "лунный" двухтональный звон, что и на странице уведомлений
          osc1.frequency.setValueAtTime(880, now);
          osc2.frequency.setValueAtTime(1320, now + 0.02);

          gain.gain.setValueAtTime(0.0, now);
          gain.gain.linearRampToValueAtTime(0.6, now + 0.03);
          gain.gain.exponentialRampToValueAtTime(0.001, now + 0.9);

          osc1.connect(gain);
          osc2.connect(gain);
          gain.connect(ctx.destination);

          osc1.start(now);
          osc2.start(now + 0.02);
          osc1.stop(now + 0.9);
          osc2.stop(now + 0.9);
        }catch(_){}
      }

      function playNotifSound(){
        if (!notifSoundUnlocked) return;
        playBeep();
      }

      function wire(id){
        var el = document.getElementById(id);
        if(!el) return;
        el.addEventListener('click', function(e){
          e.preventDefault();
          try { window.location.href = notifHref; } catch(_) { window.location.assign(notifHref); }
        });
      }
      wire('notifBtn');
      wire('notifBtnM');

      function setBadge(count, dotEl, tinyEl){
        if(!dotEl || !tinyEl) return;
        if(count > 0){
          dotEl.classList.remove('hidden');
          tinyEl.classList.remove('hidden');
          var n = Math.max(1, parseInt(count, 10) || 0);
          tinyEl.textContent = '+' + (n > 99 ? '99' : String(n));
        }else{
          dotEl.classList.add('hidden');
          tinyEl.classList.add('hidden');
        }
      }

      async function refreshUnread(){
        try{
          const r = await fetch(UNREAD_URL, { credentials: 'same-origin' });
          const j = await r.json();
          const c = (j && j.ok) ? (parseInt(j.unread, 10) || 0) : 0;
          setBadge(c, document.getElementById('notifDot'), document.getElementById('notifTiny'));
          setBadge(c, document.getElementById('notifDotM'), document.getElementById('notifTinyM'));

          if (lastUnread !== null && c > lastUnread) {
            playNotifSound();
          }
          lastUnread = c;
        }catch(_){
          // ignore network errors
        }
      }

      // initial + polling
      document.addEventListener('click', unlockNotifSound, { once: true });
      refreshUnread();
      setInterval(refreshUnread, 30000);
    })();
  </script>

  <script>
    // Dynamic header offset: prevent navbar from overlapping first block on all pages.
    (function () {
      function updateNavOffset() {
        try {
          var h = document.getElementById('site-header');
          if (!h) return;
          var pos = getComputedStyle(h).position;
          var needsOffset = pos === 'fixed';
          var height = h.offsetHeight || 0;
          document.documentElement.style.setProperty('--nav-h', needsOffset ? (height + 'px') : '0px');
        } catch (_) {}
      }
      // Initial and reactive updates
      updateNavOffset();
      window.addEventListener('resize', updateNavOffset, { passive: true });
      window.addEventListener('orientationchange', updateNavOffset);
      // If Tailwind responsive classes switch position on breakpoint changes
      window.matchMedia('(min-width: 1024px)').addEventListener('change', updateNavOffset);
      // Recalculate after fonts/styles load which may affect header height
      window.addEventListener('load', updateNavOffset);
    })();
  </script>



<div id="videoViewerModal" class="fixed inset-0 z-[95] hidden">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/70 dark:bg-black/80 backdrop-blur-sm" data-mg-close="1" aria-hidden="true"></div>

  <!-- Modal container -->
  <div class="relative mx-auto my-6 w-[95vw] max-w-[min(1120px,95vw)] rounded-2xl border border-[var(--bord)] bg-[var(--bg)] shadow-2xl overflow-hidden">
    <!-- Header (matches the provided snippet) -->
    <div class="flex items-center justify-between px-4 py-3 border-b border-[var(--bord)]">
      <h3 class="text-base sm:text-lg font-bold">Просмотр видео</h3>
      <div class="flex items-center gap-2">
        <a data-mg-download
           href="#"
           download
           class="btn btn-ghost px-3 py-1.5 inline-flex items-center gap-2"
           aria-label="Скачать видео">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5 5-5M12 15V3"></path>
          </svg>
          <span class="hidden xs:inline">Скачать</span>
        </a>
        <button type="button" class="btn btn-ghost px-3 py-1.5" data-mg-close="1" aria-label="Закрыть">✕</button>
      </div>
    </div>

    <!-- Content -->
    <div class="p-3 sm:p-4">
      <div class="bg-black/5 dark:bg-white/5 rounded-xl border border-[var(--bord)] overflow-hidden">
        <div id="videoViewerBody" class="w-full grid place-items-center">
          <!-- Injected by JS:
               <video controls playsinline class="w-full h-full max-h-[70vh] bg-black">
                 <source src="..." type="video/mp4">
               </video>
          -->
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Ensure proper sizing on small screens */
  @media (max-width: 480px) {
    #videoViewerModal .rounded-2xl {
      border-radius: 1rem;
    }
  }
</style>

  <!-- Global Likers Modal (included site-wide) -->
<div id="likersModal" class="fixed inset-0 z-[80] hidden">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-likers-close="1"></div>
  <div class="relative mx-auto my-8 w-[95vw] max-w-md sm:max-w-lg rounded-2xl bg-[var(--bg)] border border-[var(--bord)] shadow-xl">
    <div class="flex items-center justify-between px-4 py-3 border-b border-[var(--bord)]">
      <h3 class="font-semibold">Оценили</h3>
      <button class="btn btn-ghost px-3 py-1.5" data-likers-close="1" aria-label="Закрыть">✕</button>
    </div>
    <div id="likersBody" class="max-h-[70vh] overflow-y-auto divide-y divide-[var(--bord)]">
      <div class="p-4 text-sm text-[var(--muted)]">Загрузка…</div>
    </div>
  </div>
</div>

<script>
/*
  Global Likers Modal handler:
  - Opens on click of any element inside a [data-open-likers] container (usually the numeric count under the heart)
  - Uses capture-phase listener to prevent like-toggle handlers from consuming the event
  - Works on all pages where base.html is used
*/
(function(){
  // Support multiple instances accidentally rendered on page (pick the last one)
  const modals = document.querySelectorAll('#likersModal');
  const modal = modals.length ? modals[modals.length - 1] : null;
  const body = modal ? modal.querySelector('#likersBody') : null;
  if (!modal || !body) return;

  // Current logged-in username (for "Вы" badge)
  const CURRENT_USER = "admin";

  function getCSRFCookie(){
    try{
      const m = document.cookie.match(/(?:^|;)\s*csrftoken=([^;]+)/);
      if (m) return decodeURIComponent(m[1]);
    }catch(_){}
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta && meta.content) return meta.content;
    const input = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (input && input.value) return input.value;
    return '';
  }

  function openModal(){
    modal.classList.remove('hidden');
    try { document.body.style.overflow = 'hidden'; } catch(_) {}
  }

  function closeModal(){
    modal.classList.add('hidden');
    try { document.body.style.overflow = ''; } catch(_) {}
    body.innerHTML = '';
  }

  modal.addEventListener('click', (e)=>{
    if (e.target && e.target.getAttribute('data-likers-close') === '1') {
      closeModal();
    }
  });

  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
      closeModal();
    }
  });

  async function fetchLikers(url, totalLikes){
    try{
      const res = await fetch(url, { headers:{'X-Requested-With':'XMLHttpRequest'}, credentials:'same-origin' });
      const j = await res.json().catch(()=>null);
      if (!res.ok || !j || j.ok === false) throw new Error('bad response');

      const arr = Array.isArray(j.likers) ? j.likers : [];
      const total = Number(totalLikes);
      const guestCount = (isFinite(total) && total > arr.length) ? (total - arr.length) : 0;

      const registeredHtml = arr.map(item => {
        const initial = (item.name || item.username || '?').slice(0,1).toUpperCase();
        const profileHref = '/dashboard/profile/' + encodeURIComponent(item.username);
        const avatar = item.avatar
          ? `<a href="${profileHref}" class="shrink-0" aria-label="@${item.username}"><img src="${item.avatar}" class="w-10 h-10 rounded-full object-cover" alt="${item.username}"></a>`
          : `<a href="${profileHref}" class="shrink-0" aria-label="@${item.username}"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-primary to-blue-600 text-white grid place-items-center font-bold">${initial}</div></a>`;
        const btnLabel = item.is_following ? 'Отписаться' : 'Подписаться';
        const btnClass = item.is_following ? 'btn-ghost' : 'btn-primary';
        const isMe = !!CURRENT_USER && !!item.username && (item.username === CURRENT_USER);
        const rightCtrl = isMe
          ? `<span class="px-3 py-1.5 text-xs rounded-md bg-black/10 dark:bg-white/10 text-[var(--muted)] select-none">Вы</span>`
          : `<button class="btn ${btnClass} text-xs px-3 py-1.5 js-follow-toggle" data-username="${item.username}">${btnLabel}</button>`;
        return `
          <div class="flex items-center justify-between p-3 sm:p-4">
            <div class="flex items-center gap-3 min-w-0">
              ${avatar}
              <div class="min-w-0">
                <a href="${profileHref}" class="font-medium truncate hover:text-primary transition">${(item.name||'')}</a>
                <a href="${profileHref}" class="text-xs text-[var(--muted)] truncate hover:text-primary transition">@${item.username}</a>
              </div>
            </div>
            ${rightCtrl}
          </div>
        `;
      }).join('');

      const guestHtml = guestCount > 0
        ? Array.from({ length: guestCount }, (_, i) => {
            const n = i + 1;
            return `
              <div class="flex items-center justify-between p-3 sm:p-4">
                <div class="flex items-center gap-3 min-w-0">
                  <div class="w-10 h-10 rounded-full bg-black/10 dark:bg-white/10 grid place-items-center text-[var(--muted)] shrink-0">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z"></path>
                    </svg>
                  </div>
                  <div class="min-w-0">
                    <div class="font-medium truncate">Гость #${n}</div>
                    <div class="text-xs text-[var(--muted)] truncate">@guest${n}</div>
                  </div>
                </div>
              </div>
            `;
          }).join('')
        : '';

      const html = (registeredHtml + guestHtml);
      body.innerHTML = html || '<div class="p-4 text-sm text-[var(--muted)]">Пока нет лайков</div>';
    }catch(_){
      body.innerHTML = '<div class="p-4 text-sm text-[var(--muted)]">Ошибка загрузки</div>';
    }
  }

  // Follow toggle inside likers modal (uses dashboard API)
  body.addEventListener('click', async (e)=>{
    const btn = e.target && e.target.closest('.js-follow-toggle');
    if (!btn) return;
    e.preventDefault();
    const username = btn.getAttribute('data-username');
    if (!username) return;
    try{
      const fd = new FormData();
      fd.append('username', username);
      const res = await fetch("/en/dashboard/api/follow/toggle/", {
        method:'POST',
        headers:{'X-CSRFToken': getCSRFCookie(), 'X-Requested-With':'fetch'},
        body: fd,
        credentials:'same-origin'
      });
      const j = await res.json().catch(()=>null);
      if (res.ok && j && j.ok !== false){
        const following = !!j.following;
        btn.textContent = following ? 'Отписаться' : 'Подписаться';
        btn.classList.toggle('btn-primary', !following);
        btn.classList.toggle('btn-ghost', following);
      }
    }catch(_){}
  });

  // Capture-phase listener to open likers modal before like-toggle handlers run
  document.addEventListener('click', function onCountClick(e){
    const target = e.target && e.target.closest('[data-open-likers]');
    if (!target) return;

    const url = target.getAttribute('data-url');
    if (!url) return;

    // Stop any other click handlers (including like-toggle) from processing this click
    try { e.stopImmediatePropagation && e.stopImmediatePropagation(); } catch(_) {}
    try { e.stopPropagation(); } catch(_) {}
    try { e.preventDefault(); } catch(_) {}

    body.innerHTML = '<div class="p-4 text-sm text-[var(--muted)]">Загрузка…</div>';
    openModal();

    // Determine total likes (for guests = total - registered)
    let totalLikes = 0;
    const ds = target.getAttribute('data-total-likes') || (target.dataset ? target.dataset.totalLikes : '');
    if (ds) {
      totalLikes = Number(ds);
    }
    if (!isFinite(totalLikes) || totalLikes <= 0) {
      try {
        const btn = target.closest('button');
        const countEl = btn && btn.querySelector('[id^="like-count-"], [id^="video-like-count-"]');
        if (countEl) totalLikes = Number((countEl.textContent || '').replace(/[^\d]/g, '')) || 0;
      } catch(_) {}
    }

    fetchLikers(url, totalLikes);
  }, true); // capture phase to win over bubbling listeners
})();
</script>


<script>
// Оптимизированный критический JS с кэшированием и делегированием
(function(){
'use strict';
const root=document.getElementById('gen-root');
if(!root)return;
const hidden=document.getElementById('image-model-id');
const container=document.getElementById('image-model-cards');
if(!container)return;
const cards=container.querySelectorAll('.image-model-card');
if(!cards.length)return;

// Кэшируем классы для быстрого доступа
const SELECTED='border-primary';
const cardsArr=Array.from(cards);

function select(card){
  // Batch DOM updates
  requestAnimationFrame(()=>{
    cardsArr.forEach(c=>{
      c.dataset.selected='0';
      c.classList.remove(SELECTED);
    });
    if(card){
      hidden.value=card.dataset.model||'';
      card.dataset.selected='1';
      card.classList.add(SELECTED);
      try{localStorage.setItem('gen.image.model',card.dataset.model)}catch(_){}

      // Обновляем поля через ImageFieldManager
      if (card.dataset.config) {
        try {
          const config = JSON.parse(card.dataset.config);
          if (window.imageFieldManager) {
            window.imageFieldManager.updateFieldsForModel(config);
          } else if (typeof ImageFieldManager !== 'undefined') {
            window.imageFieldManager = new ImageFieldManager();
            window.imageFieldManager.updateFieldsForModel(config);
          }
        } catch (e) {
          console.error('Error updating image fields:', e);
        }
      }
    }
  });
}

/* Nav buttons (back/forward) next to "Модель" */
const leftNav=document.querySelector('.model-nav-btn.left');
const rightNav=document.querySelector('.model-nav-btn.right');

function currentIndex(){
  return cardsArr.findIndex(c=>c.dataset.selected==='1');
}
function updateNavState(){
  const i=currentIndex();
  if(leftNav) leftNav.setAttribute('aria-disabled', i<=0 ? 'true' : 'false');
  if(rightNav) rightNav.setAttribute('aria-disabled', i>=cardsArr.length-1 ? 'true' : 'false');
}
function selectAndUpdate(card){
  select(card);
  updateNavState();
  try{ card && card.scrollIntoView({behavior:'smooth', block:'nearest', inline:'nearest'}); }catch(_){}
}

// Используем делегирование событий вместо множественных слушателей
container.addEventListener('click',e=>{
  const card=e.target.closest('.image-model-card');
  if(card)selectAndUpdate(card);
},{passive:true});

// Клики по стрелкам
leftNav?.addEventListener('click', (e)=>{
  e.preventDefault();
  const i=currentIndex();
  if(i>0){
    const card=cardsArr[i-1];
    selectAndUpdate(card);
  }
});
rightNav?.addEventListener('click', (e)=>{
  e.preventDefault();
  const i=currentIndex();
  if(i<cardsArr.length-1){
    const card=cardsArr[i+1];
    selectAndUpdate(card);
  }
});

// Восстанавливаем выбор
let pre=cards[0];
try{
  const saved=localStorage.getItem('gen.image.model');
  if(saved)pre=cardsArr.find(c=>c.dataset.model===saved)||pre;
}catch(_){}
if(!pre)pre=cardsArr.find(c=>c.dataset.selected==='1')||cards[0];
if(pre)select(pre);
updateNavState();
})();
</script>
<script src="/static/js/generate-optimized.9b7dce9d5e20.js?v=" defer></script>
<script src="/static/js/generate.7d1cd71a1170.js?v=" defer></script>
<script src="/static/js/image-generation.b576fa884d2b.js?v=" defer></script>
<script src="/static/js/image-models.e19718a652b6.js?v=" defer></script>
<script src="/static/js/image-field-manager.2a42c7522bb0.js?v=" defer></script>
<script src="/static/js/image-price-calculator.98ca5cf2a150.js?v=" defer></script>
<script src="/static/js/update-image-model-info.6d9bc8635f05.js?v=" defer></script>
<script src="/static/js/balance-updater.0faa9f5faa8c.js?v=" defer></script>
<script>
// Оптимизированные данные витрины с ленивой загрузкой
window.showcaseGalleryData = [

];
</script>
<script src="/static/js/showcase.6b2681edf35c.js?v=" defer></script>
<script>
// Оптимизированная витрина с кэшированием и batch updates
(function(){
'use strict';
const init=()=>{
  const pills=document.querySelectorAll('.js-showcase-filter');
  if(!pills.length)return;

  const pillsArr=Array.from(pills);
  const anyActive=pillsArr.some(b=>b.classList.contains('bg-primary/15'));
  if(anyActive)return;

  const scat=(new URLSearchParams(location.search).get('scat')||'all').trim();
  const classes=['bg-primary/15','text-primary','border-primary/30'];

  requestAnimationFrame(()=>{
    pillsArr.forEach(btn=>{
      const on=(btn.dataset.category||'all').trim()===scat;
      classes.forEach(cls=>btn.classList.toggle(cls,on));
    });
  });
};
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init,{once:true,passive:true});
else init();
})();
</script>
<script>
// Оптимизированный скролл с IntersectionObserver
(function(){
'use strict';
const init=()=>{
  const pc=document.getElementById('promptCats');
  if(!pc)return;

  const usp=new URLSearchParams(location.search);
  if(usp.has('prompt_page')||location.hash==='#promptCats'){
    requestAnimationFrame(()=>{
      try{pc.scrollIntoView({behavior:'auto',block:'start'})}
      catch(_){location.hash='#promptCats'}
    });
  }

  const pcNav=document.querySelector('nav[aria-label="Пагинация категорий"]');
  if(pcNav){
    pcNav.addEventListener('click',e=>{
      const link=e.target.closest('a[href*="prompt_page="]');
      if(!link)return;
      e.preventDefault();
      try{
        const url=new URL(link.href,location.origin);
        url.hash='promptCats';
        location.href=url.toString();
      }catch{
        location.href=(link.getAttribute('href')||'')+'#promptCats';
      }
    },{passive:false});
  }
};
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init,{once:true,passive:true});
else init();
})();
</script>

<!-- Prompt Categories Modal & JavaScript -->
<div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4" id="promptCategoryModal">
  <div class="bg-[var(--bg-card)] rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden border border-[var(--bord)] shadow-2xl animate-modal-in">
    <div class="sticky top-0 bg-[var(--bg-card)] border-b border-[var(--bord)] p-4 sm:p-6 flex items-center justify-between z-10">
      <h3 class="text-lg sm:text-xl font-bold" id="modalCategoryTitle">Промпты</h3>
      <button class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-[var(--bord)] transition-colors" id="closePromptModal" aria-label="Закрыть">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="p-4 sm:p-6 overflow-y-auto max-h-[calc(90vh-88px)] custom-scrollbar" id="modalPromptsContainer">
      <div class="text-center text-[var(--muted)] py-8">Загрузка...</div>
    </div>
  </div>
</div>

<style>
/* ===== Категории промптов ===== */
.prompt-category-card {
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s ease;
}

.prompt-category-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
}

html[data-theme="light"] .prompt-category-card:hover {
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
}

.prompt-category-card:active {
  transform: translateY(-2px);
}

.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

/* ===== Модальное окно ===== */
#promptCategoryModal {
  backdrop-filter: blur(12px) saturate(120%);
}

#promptCategoryModal.active {
  display: flex;
}

@keyframes modal-in {
  from {
    opacity: 0;
    transform: scale(0.96) translateY(20px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.animate-modal-in {
  animation: modal-in 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* ===== Кастомный скроллбар (обе темы) ===== */
.custom-scrollbar {
  scrollbar-width: thin;
  scrollbar-color: #6366f1 transparent;
}

.custom-scrollbar::-webkit-scrollbar {
  width: 10px;
}

.custom-scrollbar::-webkit-scrollbar-track {
  background: transparent;
  border-radius: 10px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #6366f1 0%, #8b5cf6 100%);
  border-radius: 10px;
  border: 2px solid var(--bg-card, #1e293b);
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #4f46e5 0%, #7c3aed 100%);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
}

/* Светлая тема - скроллбар */
html[data-theme="light"] .custom-scrollbar::-webkit-scrollbar-thumb {
  background: linear-gradient(180deg, #6366f1 0%, #8b5cf6 100%);
  border-color: #ffffff;
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
}

html[data-theme="light"] .custom-scrollbar::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(180deg, #4f46e5 0%, #7c3aed 100%);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
}

/* ===== Промпты в модальном окне ===== */
.prompt-item-modal {
  background: var(--bg-2, #11121a);
  border: 1px solid var(--border, rgba(255,255,255,.08));
  border-radius: 14px;
  padding: 1.25rem;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.prompt-item-modal::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
  transform: scaleY(0);
  transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.prompt-item-modal:hover {
  background: var(--bg-3, #151625);
  border-color: #6366f1;
  transform: translateX(8px);
  box-shadow: 0 6px 20px rgba(99, 102, 241, 0.2);
}

html[data-theme="light"] .prompt-item-modal {
  background: #f7f7f9;
  border-color: rgba(0,0,0,.10);
}

html[data-theme="light"] .prompt-item-modal:hover {
  background: #ffffff;
  border-color: #6366f1;
  box-shadow: 0 6px 20px rgba(99, 102, 241, 0.15);
}

.prompt-item-modal:hover::before {
  transform: scaleY(1);
}

.prompt-item-modal:active {
  transform: translateX(6px) scale(0.98);
}

.prompt-item-modal h4 {
  color: var(--text-strong, #eef1f6);
  margin: 0 0 8px 0;
}

html[data-theme="light"] .prompt-item-modal h4 {
  color: #0f1419;
}

.prompt-item-modal p {
  color: var(--muted, #a0a8b5);
  margin: 0;
}

html[data-theme="light"] .prompt-item-modal p {
  color: #6b7280;
}

/* ===== Индикатор копирования ===== */
.prompt-copy-indicator {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 10px;
  font-size: 0.875rem;
  font-weight: 700;
  opacity: 0;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  pointer-events: none;
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
  white-space: nowrap;
}

.prompt-item-modal:hover .prompt-copy-indicator {
  opacity: 1;
  transform: translateY(-2px);
}

.prompt-item-modal.copied .prompt-copy-indicator {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  opacity: 1;
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

/* ===== Адаптив для мобильных ===== */
@media (max-width: 640px) {
  .prompt-item-modal {
    padding: 1rem;
  }

  .prompt-copy-indicator {
    position: static;
    display: block;
    margin-top: 0.75rem;
    opacity: 0.8;
    text-align: center;
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
    transform: none !important;
  }

  .prompt-item-modal:hover .prompt-copy-indicator {
    opacity: 1;
  }

  .prompt-item-modal.copied .prompt-copy-indicator {
    opacity: 1;
  }
}

/* ===== Кнопка "Использовать промт" ===== */
.prompt-use-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.625rem 1rem;
  background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.25);
  white-space: nowrap;
  min-height: 38px;
}

.prompt-use-btn:hover {
  background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
  transform: translateY(-2px);
}

.prompt-use-btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 6px rgba(99, 102, 241, 0.3);
}

.prompt-use-btn.copied {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
}

.prompt-use-btn svg {
  flex-shrink: 0;
}

/* ===== Адаптив для мобильных (кнопка) ===== */
@media (max-width: 640px) {
  .prompt-use-btn {
    padding: 0.5rem 0.875rem;
    font-size: 0.8125rem;
    min-height: 36px;
  }
}

/* ===== Адаптив до 480px ===== */
@media (max-width: 480px) {
  #promptCategoryModal > div {
    max-width: 95vw;
    margin: 0 auto;
  }

  .prompt-item-modal {
    padding: 1rem;
  }

  .prompt-item-modal p {
    font-size: 0.875rem;
    line-height: 1.6;
  }
}

/* ===== Адаптив до 375px ===== */
@media (max-width: 375px) {
  .prompt-category-card h4 {
    font-size: 0.8125rem;
  }

  .prompt-category-card p {
    font-size: 0.6875rem;
  }

  .prompt-item-modal {
    padding: 0.875rem;
  }

  .prompt-use-btn {
    padding: 0.5rem 0.875rem;
    font-size: 0.8125rem;
    min-height: 36px;
  }
}

/* ===== Адаптив до 320px ===== */
@media (max-width: 320px) {
  /* Модальное окно */
  #promptCategoryModal {
    padding: 0.5rem;
  }

  #promptCategoryModal > div {
    max-width: 100%;
    border-radius: 1rem;
  }

  .sticky.top-0 {
    padding: 0.75rem 1rem !important;
  }

  #modalCategoryTitle {
    font-size: 1rem;
  }

  /* Категории */
  .prompt-category-card {
    font-size: 0.8125rem;
  }

  .prompt-category-card h4 {
    font-size: 0.75rem;
  }

  .prompt-category-card p {
    font-size: 0.625rem;
  }

  .prompt-category-card .absolute.top-2.right-2 {
    font-size: 0.625rem;
    padding: 0.25rem 0.5rem;
  }

  /* Промпты в модальном окне */
  .prompt-item-modal {
    padding: 0.75rem;
    border-radius: 0.75rem;
  }

  .prompt-item-modal p {
    font-size: 0.75rem;
    line-height: 1.5;
  }

  /* Кнопка использовать */
  .prompt-use-btn {
    padding: 0.5rem 0.625rem;
    font-size: 0.6875rem;
    min-height: 32px;
    gap: 0.25rem;
    border-radius: 0.5rem;
  }

  .prompt-use-btn svg {
    width: 0.75rem;
    height: 0.75rem;
  }

  /* Контейнер промптов */
  .p-4.sm\:p-6 {
    padding: 0.75rem !important;
  }

  .space-y-3 > * + * {
    margin-top: 0.625rem !important;
  }
}

/* ===== Модальное окно - фон и контейнер ===== */
#promptCategoryModal {
  background: rgba(0, 0, 0, 0.75);
}

html[data-theme="light"] #promptCategoryModal {
  background: rgba(0, 0, 0, 0.5);
}

#promptCategoryModal > div {
  background: var(--surface, #0f1117);
  border-color: var(--border, rgba(255,255,255,.08));
}

html[data-theme="light"] #promptCategoryModal > div {
  background: #ffffff;
  border-color: rgba(0,0,0,.10);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Disable legacy image prompts modal JS when the modern block (prompts.html) is present
  if (document.getElementById('image-prompts-card')) {
    return;
  }
  const modal = document.getElementById('promptCategoryModal');
  const modalTitle = document.getElementById('modalCategoryTitle');
  const modalContainer = document.getElementById('modalPromptsContainer');
  const closeBtn = document.getElementById('closePromptModal');
  const categoryCards = document.querySelectorAll('.prompt-category-card');

  // Открытие модального окна при клике на категорию
  categoryCards.forEach(card => {
    card.addEventListener('click', async function() {
      const categoryId = this.dataset.categoryId;

      // Пропускаем кнопку "Смотреть всё"
      if (!categoryId) {
        return;
      }

      const categoryName = this.querySelector('h4').textContent;

      modalTitle.textContent = categoryName;
      modalContainer.innerHTML = '<div class="text-center text-[var(--muted)] py-8">Загрузка...</div>';
      modal.classList.add('active');
      document.body.style.overflow = 'hidden';

      try {
        const response = await fetch(`/generate/api/categories/${categoryId}/prompts`);
        const data = await response.json();

        if (data.prompts && data.prompts.length > 0) {
          modalContainer.innerHTML = `
            <div class="space-y-3">
              ${data.prompts.map(prompt => `
                <div class="prompt-item-modal" data-prompt="${escapeHtml(prompt.prompt_text)}" data-prompt-en="${escapeHtml(prompt.prompt_en)}">
                  <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 items-start">
                    <p class="text-sm text-[var(--muted)] leading-relaxed flex-1 min-w-0">${escapeHtml(prompt.prompt_text)}</p>
                    <button class="prompt-use-btn shrink-0 w-full sm:w-auto">
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      Использовать
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          `;

          // Добавляем обработчики клика на кнопки
          modalContainer.querySelectorAll('.prompt-use-btn').forEach(btn => {
            btn.addEventListener('click', function(e) {
              e.stopPropagation();
              const promptItem = this.closest('.prompt-item-modal');

              const promptTextEn = promptItem.dataset.promptEn;
              const promptTextRu = promptItem.dataset.prompt;
              const promptToUse = promptTextEn && promptTextEn.trim() !== '' ? promptTextEn : promptTextRu;

              copyToClipboard(promptToUse);

              const originalHTML = this.innerHTML;
              this.innerHTML = `
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Скопировано!
              `;
              this.classList.add('copied');

              setTimeout(() => {
                this.innerHTML = originalHTML;
                this.classList.remove('copied');
              }, 2000);

              const promptField = document.getElementById('prompt');
              if (promptField) {
                const currentValue = promptField.value.trim();
                if (currentValue) {
                  promptField.value = currentValue + ', ' + promptToUse;
                } else {
                  promptField.value = promptToUse;
                }
                promptField.focus();
              }

              closeModal();
            });
          });
        } else {
          modalContainer.innerHTML = '<div class="text-center text-[var(--muted)] py-8">Промпты не найдены</div>';
        }
      } catch (error) {
        console.error('Error loading prompts:', error);
        modalContainer.innerHTML = '<div class="text-center text-red-500 py-8">Ошибка загрузки промптов</div>';
      }
    });
  });

  // Закрытие модального окна
  closeBtn.addEventListener('click', closeModal);
  modal.addEventListener('click', function(e) {
    if (e.target === modal) {
      closeModal();
    }
  });

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && modal.classList.contains('active')) {
      closeModal();
    }
  });

  function closeModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
  }

  function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text);
    } else {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
    }
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Управление показом/скрытием всех категорий промптов
  const showAllPromptsBtn = document.getElementById('showAllPromptsBtn');
  const allPromptCategoriesSection = document.getElementById('allPromptCategoriesSection');

  if (showAllPromptsBtn && allPromptCategoriesSection) {
    showAllPromptsBtn.addEventListener('click', function() {
      const isHidden = allPromptCategoriesSection.classList.contains('hidden');
      const btnTitle = this.querySelector('h4');
      const btnIcon = this.querySelector('svg');

      if (isHidden) {
        allPromptCategoriesSection.classList.remove('hidden');
        btnTitle.textContent = 'Скрыть';
        btnIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>';

        setTimeout(() => {
          allPromptCategoriesSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      } else {
        allPromptCategoriesSection.classList.add('hidden');
        btnTitle.textContent = 'Смотреть всё';
        btnIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>';

        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
  }

  // Автоматически показываем секцию, если в URL есть параметр prompt_page или якорь
  const urlParams = new URLSearchParams(window.location.search);
  const hasPromptPage = urlParams.has('prompt_page');
  const hasAnchor = window.location.hash === '#allPromptCategoriesSection';

  if ((hasPromptPage || hasAnchor) && allPromptCategoriesSection) {
    allPromptCategoriesSection.classList.remove('hidden');
    if (hasAnchor) {
      setTimeout(() => {
        allPromptCategoriesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }
  }
});
</script>

<style>
/* Анимация для секции всех категорий */
.animate-fade-in {
  animation: fadeInSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes fadeInSlide {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* ===== Стили для переключателя режимов ===== */
.generation-mode-tab {
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  background: transparent;
  border: none;
  cursor: pointer;
  position: relative;
}

.generation-mode-tab .mode-icon {
  color: var(--muted);
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.generation-mode-tab.active {
  background: var(--bg-card);
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
}

:root[data-theme="dark"] .generation-mode-tab.active {
  background: rgba(255, 255, 255, 0.1);
  box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.3);
}

.generation-mode-tab.active .mode-icon {
  color: var(--primary);
  filter: drop-shadow(0 0 8px rgba(99, 102, 241, 0.5));
}

.generation-mode-tab:hover:not(.active) {
  background: rgba(0, 0, 0, 0.05);
}

:root[data-theme="dark"] .generation-mode-tab:hover:not(.active) {
  background: rgba(255, 255, 255, 0.05);
}

.generation-mode-tab:hover:not(.active) .mode-icon {
  color: var(--fg);
}
</style>

<!-- Модули для генерации видео -->
<!-- Lazy-loaded on demand in the mode switcher -->

<!-- Оптимизированный переключатель режимов -->
<script>
(function(){
'use strict';
const init=()=>{
  const imageModeTab=document.querySelector('[data-mode="image"]');
  const videoModeTab=document.querySelector('[data-mode="video"]');
  const imageForm=document.querySelector('form[method="post"]');
  const videoFormContainer=document.getElementById('video-form-container');
  const pageTitle=document.getElementById('page-title');
  const pageSubtitle=document.getElementById('page-subtitle');

  // Кэшируем элементы
  const els={
    videoPromptCats:document.getElementById('videoPromptCats'),
    videoShowcaseSection:document.getElementById('videoShowcaseSection'),
    imagePromptCats:document.getElementById('promptCats'),
    imageShowcaseSection:document.getElementById('showcaseSection'),
    imagePromptsCard:document.getElementById('image-prompts-card'),
    imageQueue:document.getElementById('image-queue-card'),
    videoQueue:document.getElementById('video-queue-card')
  };

  let __vgLoaded=false;
  const loadVideoAssets=()=>{
    if(__vgLoaded)return;
    __vgLoaded=true;
    const head=document.head;
    const cssId='vg-css';
    if(!document.getElementById(cssId)){
      const l=document.createElement('link');
      l.id=cssId;l.rel='stylesheet';
      l.href="/static/css/video-generation.96a7bd56b763.css?v=";
      head.appendChild(l);
    }
    const scripts=[
      "/static/js/video-cache.2adabb30930e.js?v=",
      "/static/js/video-optimizer.842d54268534.js?v=",
      "/static/js/video-field-manager.2c007b06b9ee.js?v=",
      "/static/js/moon-slider-handler.21f5113fae8c.js?v=",
      "/static/js/video-generation.f42d23ee1d38.js?v=",
      "/static/js/video-prompts.bb62a6f6f629.js?v="
    ];
    const fragment=document.createDocumentFragment();
    scripts.forEach(src=>{
      if(document.querySelector(`script[src="${src}"]`))return;
      const s=document.createElement('script');
      s.src=src;s.defer=true;
      s.onload=()=>{
        if(src.includes('video-generation.js')&&!window.videoGeneration&&typeof VideoGeneration==='function'){
          // Передаем видео модели из Django в JavaScript (точно так же как image_models)
          window.__VIDEO_MODELS__ = [

            {
              id: 3,
              name: "Bytedance",
              model_id: "runware:100@1",
              category: "t2v",
              category_display: "Text-to-Video",
              description: "",
              token_cost: 18,
              image_url: null,
              available_aspect_ratios: ['5:4'],
              available_resolutions: ['600x480'],
              available_durations: [4, 5, 8, 10],
              supports_image_to_video: false,
              supports_camera_movement: true,
              supports_motion_strength: false,
              supports_seed: true
            },

            {
              id: 1,
              name: "Seedance 1.0 Pro",
              model_id: "bytedance:2@1",
              category: "t2v",
              category_display: "Text-to-Video",
              description: "Профессиональная модель генерации танцевальных движений в видео",
              token_cost: 10,
              image_url: "/media/video_models/2025/12/bytedance-2-1.jpg",
              available_aspect_ratios: ['1:1'],
              available_resolutions: ['4320x4320'],
              available_durations: [2, 4, 6, 8, 10, 12],
              supports_image_to_video: false,
              supports_camera_movement: false,
              supports_motion_strength: false,
              supports_seed: true
            },

            {
              id: 2,
              name: "Wan2.5\u002DPreview",
              model_id: "runware:201@1",
              category: "i2v",
              category_display: "Image-to-Video",
              description: "Wan 2.5\u002DPreview — I2V\u002Dмодель генерации видео из изображений с высокой детализацией, плавной анимацией и точным сохранением структуры.",
              token_cost: 20,
              image_url: "/media/video_models/2025/12/runware-201-1.jpg",
              available_aspect_ratios: ['2:3'],
              available_resolutions: ['720x1080'],
              available_durations: [5, 10],
              supports_image_to_video: true,
              supports_camera_movement: false,
              supports_motion_strength: false,
              supports_seed: true
            }

          ];
          window.videoGeneration=new VideoGeneration();
        }
        if(src.includes('video-prompts.js')){
          const tab=document.querySelector('.video-source-tab.active');
          const mode=tab?.dataset.source||'t2v';
          document.dispatchEvent(new CustomEvent('forceLoadVideoContent',{detail:{mode}}));
        }
      };
      fragment.appendChild(s);
    });
    head.appendChild(fragment);
  };

  if(!imageModeTab||!videoModeTab||!imageForm||!videoFormContainer)return;

  const switchMode=mode=>{
    requestAnimationFrame(()=>{
      document.documentElement.classList.toggle('mode-video',mode==='video');
      const isImage=mode==='image';

      imageModeTab.classList.toggle('active',isImage);
      videoModeTab.classList.toggle('active',!isImage);
      imageForm.style.display=isImage?'block':'none';
      videoFormContainer.style.display=isImage?'none':'block';

      const displays={
        imagePromptCats:isImage?'block':'none',
        imageShowcaseSection:isImage?'block':'none',
        imagePromptsCard:isImage?'block':'none',
        imageQueue:isImage?'':'none',
        videoPromptCats:isImage?'none':'block',
        videoShowcaseSection:isImage?'none':'block',
        videoQueue:isImage?'none':''
      };

      Object.entries(displays).forEach(([k,v])=>{
        if(els[k])els[k].style.display=v;
      });

      // Toggle admin panel visibility
      const adminPanel=document.getElementById('video-models-admin-panel');
      const imageAdminPanel=document.getElementById('image-models-admin-panel');
      if(adminPanel)adminPanel.style.display=isImage?'none':'block';
      if(imageAdminPanel)imageAdminPanel.style.display=isImage?'block':'none';

      if(pageTitle)pageTitle.textContent=isImage?'Сгенерировать изображение':'Сгенерировать видео';
      if(pageSubtitle)pageSubtitle.textContent=isImage?'Создавайте уникальные изображения с помощью ИИ':'Создавайте уникальные видео с помощью ИИ';

      try{localStorage.setItem('gen.topMode',mode)}catch(_){}

      // Обновляем URL в браузере для SEO
      const newPath = isImage ? '/generate/photo' : '/generate/video';
      const currentPath = window.location.pathname;
      if (currentPath !== newPath) {
        const newUrl = newPath + window.location.search;
        window.history.pushState({mode: mode}, '', newUrl);
      }

      if(!isImage){
        loadVideoAssets();
        const tab=document.querySelector('.video-source-tab.active');
        const videoMode=tab?.dataset.source||'i2v';
        document.dispatchEvent(new CustomEvent('videoModeChanged',{detail:{mode:videoMode}}));
      }

      // Initialize ImageFieldManager for default image model
      if (isImage && window.ImageFieldManager) {
        const defaultImageCard = document.querySelector('.image-model-card.active');
        if (defaultImageCard && defaultImageCard.dataset.model) {
          try {
            const model = JSON.parse(defaultImageCard.dataset.model || '{}');
            if (!window.imageFieldManager) {
              window.imageFieldManager = new window.ImageFieldManager();
            }
            window.imageFieldManager.updateFieldsForModel(model);
          } catch(e) {
            console.error('Failed to initialize ImageFieldManager:', e);
          }
        }
      }
    });
  };

  imageModeTab.addEventListener('click',()=>switchMode('image'),{passive:true});
  videoModeTab.addEventListener('click',()=>switchMode('video'),{passive:true});

  if(els.videoPromptCats)els.videoPromptCats.style.display='none';
  if(els.videoShowcaseSection)els.videoShowcaseSection.style.display='none';

  const usp=new URLSearchParams(location.search);
  const paramType=usp.get('type');

  // Определяем режим из URL path или параметра type
  const currentPath = window.location.pathname;
  let initialMode = null;

  if (currentPath.includes('/generate/video')) {
    initialMode = 'video';
  } else if (currentPath.includes('/generate/photo')) {
    initialMode = 'image';
  } else if (paramType) {
    initialMode = paramType;
  }


  if(initialMode==='video'){
    const savedSrc=localStorage.getItem('gen.videoSource');
    if(savedSrc){
      const tab=document.querySelector(`.video-source-tab[data-source="${savedSrc}"]`);
      if(tab){
        document.querySelectorAll('.video-source-tab').forEach(t=>t.classList.remove('active'));
        tab.classList.add('active');
      }
    }
    loadVideoAssets();
    switchMode('video');
    localStorage.setItem('gen.topMode','video');

    // Обработка URL параметров для видео
    const promptParam = usp.get('prompt');
    const modelParam = usp.get('model');

    // Вставляем промпт сразу
    if (promptParam) {
      setTimeout(() => {
        const videoPromptInput = document.getElementById('video-prompt');
        if (videoPromptInput) {
          videoPromptInput.value = decodeURIComponent(promptParam);
          videoPromptInput.dispatchEvent(new Event('input', { bubbles: true }));
          console.log('[Video] Prompt set from URL');
        }
      }, 800);
    }

    // Для модели ждем появления карточек с помощью MutationObserver
    if (modelParam) {
      const cardsContainer = document.getElementById('model-cards');
      if (cardsContainer) {
        let attempts = 0;
        const maxAttempts = 20;

        const trySelectModel = () => {
          attempts++;

          // Проверяем наличие карточек
          const cards = cardsContainer.querySelectorAll('.model-card');

          if (cards.length > 0 && window.videoGeneration && window.videoGeneration.models && window.videoGeneration.models.length > 0) {
            // Логируем доступные модели при первой попытке
            if (attempts === 1) {
              console.log('[Video] Available models:', window.videoGeneration.models.map(m => ({id: m.id, model_id: m.model_id, name: m.name})));
              console.log('[Video] Looking for model_id:', modelParam);
            }

            // Ищем точное совпадение
            let videoModel = window.videoGeneration.models.find(m => m.model_id === modelParam);

            if (!videoModel) {
              // Если модель не найдена, выбираем первую доступную
              videoModel = window.videoGeneration.models[0];
              console.warn('[Video] Model', modelParam, 'not found, using default:', videoModel.model_id);
            }

            if (videoModel) {
              const videoCard = cardsContainer.querySelector(`.model-card[data-id="${videoModel.id}"]`);
              if (videoCard) {
                videoCard.click();
                console.log('[Video] ✓ Model selected:', videoModel.model_id, '(id:', videoModel.id, ')');
                return true;
              } else {
                console.warn('[Video] Model found in data but card not in DOM:', videoModel.id);
              }
            }
          }

          // Если не получилось и не превысили лимит попыток
          if (attempts < maxAttempts) {
            if (attempts % 5 === 0) {
              console.log(`[Video] Attempt ${attempts}/${maxAttempts} - cards: ${cards.length}, models: ${window.videoGeneration?.models?.length || 0}`);
            }
            setTimeout(trySelectModel, 300);
          } else {
            console.error('[Video] ✗ Failed to select model after', maxAttempts, 'attempts:', modelParam);
            console.log('[Video] Final state - cards:', cards.length, 'models:', window.videoGeneration?.models?.length || 0);
          }
          return false;
        };

        // Начинаем попытки через 1 секунду после переключения
        setTimeout(trySelectModel, 1000);
      }
    }
  }else if(paramType==='image'){
    switchMode('image');
    localStorage.setItem('gen.topMode','image');

    // Обработка URL параметров для изображений
    const promptParam = usp.get('prompt');
    const modelParam = usp.get('model');

    if (promptParam) {
      setTimeout(() => {
        const promptInput = document.getElementById('prompt');
        if (promptInput) {
          promptInput.value = decodeURIComponent(promptParam);
          promptInput.dispatchEvent(new Event('input', { bubbles: true }));
          console.log('[Image] Prompt set from URL');
        }
      }, 300);
    }

    if (modelParam) {
      let attempts = 0;
      const maxAttempts = 10;

      const trySelectImageModel = () => {
        attempts++;
        const allCards = document.querySelectorAll('.image-model-card');

        if (allCards.length > 0) {
          if (attempts === 1) {
            console.log('[Image] Available models:', Array.from(allCards).map(c => c.dataset.model));
            console.log('[Image] Looking for model:', modelParam);
          }

          // Пробуем найти точное совпадение
          let modelCard = document.querySelector(`.image-model-card[data-model="${modelParam}"]`);

          if (!modelCard) {
            // Если не нашли точное совпадение, пробуем с CSS.escape
            const escapedModel = CSS.escape(modelParam);
            modelCard = document.querySelector(`.image-model-card[data-model="${escapedModel}"]`);
          }

          if (!modelCard) {
            // Если всё равно не нашли, берем первую доступную
            modelCard = allCards[0];
            console.warn('[Image] Model', modelParam, 'not found, using default:', modelCard.dataset.model);
          }

          if (modelCard) {
            modelCard.click();
            console.log('[Image] ✓ Model selected:', modelCard.dataset.model);
            return true;
          }
        }

        if (attempts < maxAttempts) {
          setTimeout(trySelectImageModel, 200);
        } else {
          console.error('[Image] ✗ Failed to select model after', maxAttempts, 'attempts');
        }
        return false;
      };

      setTimeout(trySelectImageModel, 500);
    }
  }else if(initialMode==='image'){
    switchMode('image');
    localStorage.setItem('gen.topMode','image');

    // Обработка URL параметров для изображений
    const promptParam = usp.get('prompt');
    const modelParam = usp.get('model');

    if (promptParam) {
      setTimeout(() => {
        const promptInput = document.getElementById('prompt');
        if (promptInput) {
          promptInput.value = decodeURIComponent(promptParam);
          promptInput.dispatchEvent(new Event('input', { bubbles: true }));
          console.log('[Image] Prompt set from URL');
        }
      }, 300);
    }

    if (modelParam) {
      let attempts = 0;
      const maxAttempts = 10;

      const trySelectImageModel = () => {
        attempts++;
        const allCards = document.querySelectorAll('.image-model-card');

        if (allCards.length > 0) {
          if (attempts === 1) {
            console.log('[Image] Available models:', Array.from(allCards).map(c => c.dataset.model));
            console.log('[Image] Looking for model:', modelParam);
          }

          // Пробуем найти точное совпадение
          let modelCard = document.querySelector(`.image-model-card[data-model="${modelParam}"]`);

          if (!modelCard) {
            // Если не нашли точное совпадение, пробуем с CSS.escape
            const escapedModel = CSS.escape(modelParam);
            modelCard = document.querySelector(`.image-model-card[data-model="${escapedModel}"]`);
          }

          if (!modelCard) {
            // Если всё равно не нашли, берем первую доступную
            modelCard = allCards[0];
            console.warn('[Image] Model', modelParam, 'not found, using default:', modelCard.dataset.model);
          }

          if (modelCard) {
            modelCard.click();
            console.log('[Image] ✓ Model selected:', modelCard.dataset.model);
            return true;
          }
        }

        if (attempts < maxAttempts) {
          setTimeout(trySelectImageModel, 200);
        } else {
          console.error('[Image] ✗ Failed to select model after', maxAttempts, 'attempts');
        }
        return false;
      };

      setTimeout(trySelectImageModel, 500);
    }
  }else{
    // Если нет type, но есть prompt или model - переключаем на image
    const promptParam = usp.get('prompt');
    const modelParam = usp.get('model');

    if (promptParam || modelParam) {
      switchMode('image');
      localStorage.setItem('gen.topMode','image');

      setTimeout(() => {
        if (promptParam) {
          const promptInput = document.getElementById('prompt');
          if (promptInput) {
            promptInput.value = decodeURIComponent(promptParam);
            promptInput.dispatchEvent(new Event('input', { bubbles: true }));
            console.log('[Image] Prompt set from URL (no type param)');
          }
        }

        if (modelParam) {
          let attempts = 0;
          const maxAttempts = 10;

          const trySelectImageModel = () => {
            attempts++;
            const allCards = document.querySelectorAll('.image-model-card');

            if (allCards.length > 0) {
              // Пробуем найти точное совпадение
              let modelCard = document.querySelector(`.image-model-card[data-model="${modelParam}"]`);

              if (!modelCard) {
                // Если не нашли, пробуем с CSS.escape
                const escapedModel = CSS.escape(modelParam);
                modelCard = document.querySelector(`.image-model-card[data-model="${escapedModel}"]`);
              }

              if (!modelCard && allCards.length > 0) {
                // Берем первую доступную
                modelCard = allCards[0];
                if (attempts === 1) {
                  console.warn('[Image] Model', modelParam, 'not found, using default');
                }
              }

              if (modelCard) {
                modelCard.click();
                console.log('[Image] ✓ Model selected (no type param)');
                return true;
              }
            }

            if (attempts < maxAttempts) {
              setTimeout(trySelectImageModel, 200);
            }
            return false;
          };

          setTimeout(trySelectImageModel, 300);
        }
      }, 500);
    } else {
      // Стандартное поведение без URL параметров
      const savedTop=localStorage.getItem('gen.topMode');
      if(savedTop==='video'){
        const savedSrc=localStorage.getItem('gen.videoSource');
        if(savedSrc){
          const tab=document.querySelector(`.video-source-tab[data-source="${savedSrc}"]`);
          if(tab){
            document.querySelectorAll('.video-source-tab').forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
          }
        }
        switchMode('video');
      }else{
        switchMode('image');
      }
    }
  }
};
if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init,{once:true,passive:true});
else init();
})();
</script>

<!-- Модальное окно для категорий промптов ВИДЕО -->
<div class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4" id="videoPromptCategoryModal">
  <div class="bg-[var(--bg-card)] rounded-2xl max-w-3xl w-full max-h-[90vh] overflow-hidden border border-[var(--bord)] shadow-2xl animate-modal-in">
    <div class="sticky top-0 bg-[var(--bg-card)] border-b border-[var(--bord)] p-4 sm:p-6 flex items-center justify-between z-10">
      <h3 class="text-lg sm:text-xl font-bold" id="videoModalCategoryTitle">Промпты видео</h3>
      <button class="w-10 h-10 flex items-center justify-center rounded-lg hover:bg-[var(--bord)] transition-colors" id="closeVideoPromptModal" aria-label="Закрыть">
        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="p-4 sm:p-6 overflow-y-auto max-h-[calc(90vh-88px)] custom-scrollbar" id="videoModalPromptsContainer">
      <div class="text-center text-[var(--muted)] py-8">Загрузка...</div>
    </div>
  </div>
</div>

<!-- JavaScript для категорий промптов видео -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const videoModal = document.getElementById('videoPromptCategoryModal');
  const videoModalTitle = document.getElementById('videoModalCategoryTitle');
  const videoModalContainer = document.getElementById('videoModalPromptsContainer');
  const videoCloseBtn = document.getElementById('closeVideoPromptModal');
  const videoCategoryCards = document.querySelectorAll('.video-prompt-category-card');

  // Открытие модального окна при клике на категорию видео
  videoCategoryCards.forEach(card => {
    card.addEventListener('click', async function() {
      const categoryId = this.dataset.categoryId;

      // Пропускаем кнопку "Смотреть всё"
      if (!categoryId) {
        return;
      }

      const categoryName = this.querySelector('h4').textContent;

      videoModalTitle.textContent = categoryName;
      videoModalContainer.innerHTML = '<div class="text-center text-[var(--muted)] py-8">Загрузка...</div>';
      videoModal.classList.add('active');
      document.body.style.overflow = 'hidden';

      try {
        const response = await fetch(`/generate/api/video/categories/${categoryId}/prompts`);
        const data = await response.json();

        if (data.prompts && data.prompts.length > 0) {
          // Local helpers (csrf + post)
          const getCSRF = () => (document.querySelector('[name=csrfmiddlewaretoken]') || {}).value || '';
          const postFD = async (url, fd) => {
            const r = await fetch(url, { method: 'POST', headers: { 'X-CSRFToken': getCSRF(), 'X-Requested-With': 'fetch' }, body: fd });
            let j = {}; try { j = await r.json(); } catch(_) {}
            if (!r.ok || j.ok === false) throw new Error(j.error || ('Ошибка ' + r.status));
            return j;
          };
          const postJSON = async (url, data) => {
            const fd = new FormData(); Object.entries(data || {}).forEach(([k,v]) => fd.append(k, v));
            return postFD(url, fd);
          };

          const IS_STAFF_V = (document.getElementById('gen-root')?.dataset.isStaff || 'false') === 'true';
          const adminCreate = IS_STAFF_V ? `
            <div class="p-3 mb-3 rounded-xl border border-[var(--bord)] bg-black/[.03] dark:bg-white/[.03]">
              <div class="text-xs text-[var(--muted)] mb-2">Подкатегории (админ)</div>
              <div class="grid gap-2 sm:grid-cols-3">
                <input id="vscName" class="field" type="text" placeholder="Название подкатегории" maxlength="120">
                <input id="vscOrder" class="field" type="number" placeholder="Порядок" value="0">
                <label class="pc-inline"><input id="vscActive" type="checkbox" checked><span>Активна</span></label>
              </div>
              <div class="mt-2 flex justify-end">
                <button id="vscCreateBtn" class="btn btn-ghost" type="button">+ Подкатегория</button>
              </div>
            </div>
          ` : '';

          videoModalContainer.innerHTML = `
            ${adminCreate}
            <div id="vpg-subcats" class="flex flex-wrap gap-2 mb-3"></div>
            <div id="vpg-items" class="space-y-3">
              ${data.prompts.map(prompt => `
                <div class="prompt-item-modal" data-prompt="${escapeHtml(prompt.prompt_text)}" data-prompt-en="${escapeHtml(prompt.prompt_en)}">
                  <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 items-start">
                    <p class="text-sm text-[var(--muted)] leading-relaxed flex-1 min-w-0">${escapeHtml(prompt.prompt_text)}</p>
                    <button class="video-prompt-use-btn shrink-0 w-full sm:w-auto">
                      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                      </svg>
                      Использовать
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          `;

          // Helper to bind "Use" buttons
          function bindVideoUseButtons(rootEl) {
            rootEl.querySelectorAll('.video-prompt-use-btn').forEach(btn => {
              btn.addEventListener('click', function(e) {
                e.stopPropagation();
                const promptItem = this.closest('.prompt-item-modal');
                const promptTextEn = promptItem?.dataset.promptEn;
                const promptTextRu = promptItem?.dataset.prompt;
                const promptToUse = promptTextEn && promptTextEn.trim() !== '' ? promptTextEn : promptTextRu;

                const originalHTML = this.innerHTML;
                this.innerHTML = `
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                  Скопировано!
                `;
                this.classList.add('copied');
                setTimeout(() => { this.innerHTML = originalHTML; this.classList.remove('copied'); }, 2000);

                const videoPromptField = document.getElementById('video-prompt');
                if (videoPromptField && promptToUse) {
                  const currentValue = videoPromptField.value.trim();
                  videoPromptField.value = currentValue ? (currentValue + ', ' + promptToUse) : promptToUse;
                  videoPromptField.focus();
                }
                closeVideoModal();
              });
            });
          }

          bindVideoUseButtons(videoModalContainer);

          // Load and render subcategories (pills), fill admin select (if needed)
          async function loadVideoSubcategories() {
            try {
              const r = await fetch(`/generate/api/video/categories/${categoryId}/subcategories`);
              const j = await r.json();
              const wrap = videoModalContainer.querySelector('#vpg-subcats');
              if (!wrap) return;

              const subs = (j.subcategories || []);
              const pills = [];
              pills.push(`<button type="button" class="px-3 py-1.5 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] text-xs sm:text-sm vpg-subpill" data-id="">Все</button>`);
              subs.forEach(sc => {
                pills.push(`<button type="button" class="px-3 py-1.5 rounded-lg border border-[var(--bord)] bg-[var(--bg-card)] hover:border-primary/60 hover:text-primary text-xs sm:text-sm vpg-subpill" data-id="${sc.id}">${escapeHtml(sc.name)} <span class="text-[var(--muted)]">(${sc.prompts_count})</span></button>`);
              });
              wrap.innerHTML = pills.join('');

              // Bind pill clicks
              wrap.querySelectorAll('.vpg-subpill').forEach(btn => {
                btn.addEventListener('click', async () => {
                  const subId = btn.dataset.id || '';
                  wrap.querySelectorAll('.vpg-subpill').forEach(b => b.classList.remove('bg-primary/15','text-primary','border-primary/30'));
                  const itemsWrap = videoModalContainer.querySelector('#vpg-items');
                  if (subId === '') {
                    btn.classList.add('bg-primary/15','text-primary','border-primary/30');
                    // Rebuild initial list from data.prompts
                    itemsWrap.innerHTML = `${data.prompts.map(prompt => `
                      <div class="prompt-item-modal" data-prompt="${escapeHtml(prompt.prompt_text)}" data-prompt-en="${escapeHtml(prompt.prompt_en)}">
                        <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 items-start">
                          <p class="text-sm text-[var(--muted)] leading-relaxed flex-1 min-w-0">${escapeHtml(prompt.prompt_text)}</p>
                          <button class="video-prompt-use-btn shrink-0 w-full sm:w-auto">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                            Использовать
                          </button>
                        </div>
                      </div>
                    `).join('')}`;
                    bindVideoUseButtons(itemsWrap);
                  } else {
                    try {
                      const r2 = await fetch(`/generate/api/video/subcategories/${subId}/prompts`);
                      const j2 = await r2.json();
                      const dataItems = (j2.prompts || []);
                      const itemsHtml = dataItems.map(prompt => `
                        <div class="prompt-item-modal" data-prompt="${escapeHtml(prompt.prompt_text)}" data-prompt-en="${escapeHtml(prompt.prompt_en)}">
                          <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 items-start">
                            <p class="text-sm text-[var(--muted)] leading-relaxed flex-1 min-w-0">${escapeHtml(prompt.prompt_text)}</p>
                            <button class="video-prompt-use-btn shrink-0 w-full sm:w-auto">
                              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                              Использовать
                            </button>
                          </div>
                        </div>
                      `).join('');
                      itemsWrap.innerHTML = itemsHtml || '<div class="text-center text-[var(--muted)] py-8">Промпты не найдены</div>';
                      bindVideoUseButtons(itemsWrap);
                      btn.classList.add('bg-primary/15','text-primary','border-primary/30');
                    } catch (e) {
                      itemsWrap.innerHTML = '<div class="text-center text-red-500 py-8">Ошибка загрузки подкатегории</div>';
                    }
                  }
                });
              });

              // Admin: create subcategory
              videoModalContainer.querySelector('#vscCreateBtn')?.addEventListener('click', async () => {
                const name = (videoModalContainer.querySelector('#vscName')?.value || '').trim();
                const order = videoModalContainer.querySelector('#vscOrder')?.value || '0';
                const active = videoModalContainer.querySelector('#vscActive')?.checked ? '1' : '0';
                if (!name) { alert('Введите название подкатегории'); return; }
                try {
                  await postJSON('/generate/api/video/subcategories/create', { category_id: categoryId, name, order, is_active: active });
                  await loadVideoSubcategories();
                  (videoModalContainer.querySelector('#vscName') || {}).value = '';
                  (videoModalContainer.querySelector('#vscOrder') || {}).value = '0';
                } catch (e) { alert(e.message || String(e)); }
              });

              // Default select "Все"
              const first = wrap.querySelector('.vpg-subpill[data-id=""]');
              if (first) first.click();
            } catch (e) {
              // silent
            }
          }
          loadVideoSubcategories();
        } else {
          videoModalContainer.innerHTML = '<div class="text-center text-[var(--muted)] py-8">Промпты не найдены</div>';
        }
      } catch (error) {
        console.error('Error loading video prompts:', error);
        videoModalContainer.innerHTML = '<div class="text-center text-red-500 py-8">Ошибка загрузки промптов</div>';
      }
    });
  });

  // Закрытие модального окна
  if (videoCloseBtn) {
    videoCloseBtn.addEventListener('click', closeVideoModal);
  }

  if (videoModal) {
    videoModal.addEventListener('click', function(e) {
      if (e.target === videoModal) {
        closeVideoModal();
      }
    });
  }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && videoModal && videoModal.classList.contains('active')) {
      closeVideoModal();
    }
  });

  function closeVideoModal() {
    if (videoModal) {
      videoModal.classList.remove('active');
      document.body.style.overflow = '';
    }
  }

  // Кнопка "Смотреть всё" для категорий видео
  const showAllVideoPromptsBtn = document.getElementById('showAllVideoPromptsBtn');
  const allVideoPromptCategoriesSection = document.getElementById('allVideoPromptCategoriesSection');

  if (showAllVideoPromptsBtn && allVideoPromptCategoriesSection) {
    showAllVideoPromptsBtn.addEventListener('click', function() {
      const isHidden = allVideoPromptCategoriesSection.classList.contains('hidden');
      const btnTitle = this.querySelector('h4');
      const btnIcon = this.querySelector('svg');

      if (isHidden) {
        allVideoPromptCategoriesSection.classList.remove('hidden');
        btnTitle.textContent = 'Скрыть';
        btnIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>';
        setTimeout(() => {
          allVideoPromptCategoriesSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
      } else {
        allVideoPromptCategoriesSection.classList.add('hidden');
        btnTitle.textContent = 'Смотреть всё';
        btnIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>';
        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    });
  }

  // Инициализация селектора соотношения сторон и качества
  const qualitySelector = document.getElementById('quality-selector');
  const widthInput = document.getElementById('id_width');
  const heightInput = document.getElementById('id_height');

  // Инициализация слайдера соотношений сторон
  let aspectRatioSlider = null;

  function initializeAspectRatioSelector(modelId) {
    if (!qualitySelector || !widthInput || !heightInput) {
      console.warn('Aspect ratio selector elements not found');
      return;
    }

    const sliderContainer = document.getElementById('aspect-ratio-slider-container');
    if (!sliderContainer) {
      console.warn('Aspect ratio slider container not found');
      return;
    }

    if (!modelId) {
      sliderContainer.innerHTML = '<div class="text-sm text-gray-400">Сначала выберите модель</div>';
      qualitySelector.innerHTML = '<option value="">Выберите соотношение сторон</option>';
      qualitySelector.disabled = true;
      return;
    }

    // Создаем новый экземпляр слайдера
    if (aspectRatioSlider) {
      aspectRatioSlider = null;
    }

    aspectRatioSlider = new AspectRatioSlider({
      container: sliderContainer,
      modelType: 'image',
      modelId: modelId,
      qualitySelect: qualitySelector,
      widthInput: widthInput,
      heightInput: heightInput,
      onChange: (ratio) => {
        console.log('Aspect ratio changed to:', ratio);
      }
    });
  }

  // Слушаем клики по карточкам моделей изображений
  document.addEventListener('click', function(e) {
    const card = e.target.closest('.image-model-card');
    if (card) {
      const modelId = card.getAttribute('data-model');
      if (modelId) {
        // Небольшая задержка, чтобы скрытое поле обновилось
        setTimeout(function() {
          initializeAspectRatioSelector(modelId);
        }, 100);
      }
    }
  });

  // Инициализируем при загрузке, если модель уже выбрана
  window.addEventListener('load', function() {
    const selectedCard = document.querySelector('.image-model-card[data-selected="1"]');
    if (selectedCard) {
      const modelId = selectedCard.getAttribute('data-model');
      if (modelId) {
        initializeAspectRatioSelector(modelId);
      }
    }
  });

  // Логика раскрывающейся шторки "Дополнительные параметры"
  const toggleAdvancedBtn = document.getElementById('toggle-advanced-params');
  const advancedParamsContent = document.getElementById('advanced-params-content');

  if (toggleAdvancedBtn && advancedParamsContent) {
    toggleAdvancedBtn.addEventListener('click', function() {
      const isHidden = advancedParamsContent.classList.contains('hidden');
      const btnIcon = this.querySelector('svg');

      if (isHidden) {
        advancedParamsContent.classList.remove('hidden');
        btnIcon.style.transform = 'rotate(180deg)';
      } else {
        advancedParamsContent.classList.add('hidden');
        btnIcon.style.transform = 'rotate(0deg)';
      }
    });
  }
});
</script>

<!-- Подключение скриптов для работы с соотношениями сторон -->
<script src="/static/js/aspect-ratio-slider.81d6f95c0185.js"></script>
<script src="/static/js/aspect-ratio-selector.2d22f420054a.js"></script>

<style>
/* Стили для слайдера соотношений сторон */
.aspect-ratio-slider {
  -webkit-appearance: none;
  appearance: none;
  background: linear-gradient(to right,
    #3b82f6 0%,
    #8b5cf6 50%,
    #a855f7 100%
  );
  outline: none;
  transition: all 0.3s ease;
}

.aspect-ratio-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 24px;
  height: 24px;
  background: white;
  cursor: pointer;
  border-radius: 50%;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  transition: all 0.2s ease;
}

.aspect-ratio-slider::-webkit-slider-thumb:hover {
  transform: scale(1.2);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
}

.aspect-ratio-slider::-moz-range-thumb {
  width: 24px;
  height: 24px;
  background: white;
  cursor: pointer;
  border-radius: 50%;
  border: none;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
  transition: all 0.2s ease;
}

.aspect-ratio-slider::-moz-range-thumb:hover {
  transform: scale(1.2);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
}

.aspect-ratio-badge {
  animation: pulse-badge 2s ease-in-out infinite;
}

@keyframes pulse-badge {
  0%, 100% {
    box-shadow: 0 2px 8px rgba(139, 92, 246, 0.4);
  }
  50% {
    box-shadow: 0 4px 16px rgba(139, 92, 246, 0.6);
  }
}

/* Стили для кнопки использования промпта видео */
.video-prompt-use-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.625rem 1rem;
  background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 100%);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 2px 8px rgba(168, 85, 247, 0.25);
  white-space: nowrap;
  min-height: 38px;
}

.video-prompt-use-btn:hover {
  background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
  box-shadow: 0 4px 12px rgba(168, 85, 247, 0.35);
  transform: translateY(-2px);
}

.video-prompt-use-btn.copied {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  box-shadow: 0 4px 12px rgba(16, 185, 129, 0.35);
}
</style>




</body>
</html>
